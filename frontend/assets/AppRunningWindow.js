import{a4 as pe,d as Z,r as D,l as Q,ad as Me,n as j,o as y,b as G,k as X,a0 as me,C as Ne,K as fe,D as H,J as Ee,c as L,m as V,a as h,z as m,q as O,w as d,h as T,t as w,G as Re,R as se,f as ze,a6 as Oe,a7 as Ce,a8 as ge,N as ie,T as Le,M as xe,I as ve,a9 as Ve,F as Y,a2 as Be,a5 as $e,L as le,p as te,ae as q,af as Se,ag as Pe,a3 as We,S as Ue,ah as he,ai as we,V as Ae,g as Fe,i as Ge,j as He,aj as je,ak as qe,al as Ke,am as Ye,an as Ze,ao as Qe}from"./index.js";import{u as Je}from"./lmapp.js";import{a as Xe,b as et}from"./_commonjsHelpers.js";import{I as re}from"./IPCChannelName.js";import{A as tt}from"./AppScriptType.js";var ce={exports:{}},be;function nt(){return be||(be=1,function(s,e){(function(t,i){s.exports=i()})(self,()=>(()=>{var t={};return(()=>{var i=t;Object.defineProperty(i,"__esModule",{value:!0}),i.FitAddon=void 0,i.FitAddon=class{activate(o){this._terminal=o}dispose(){}fit(){const o=this.proposeDimensions();if(!o||!this._terminal||isNaN(o.cols)||isNaN(o.rows))return;const n=this._terminal._core;this._terminal.rows===o.rows&&this._terminal.cols===o.cols||(n._renderService.clear(),this._terminal.resize(o.cols,o.rows))}proposeDimensions(){if(!this._terminal||!this._terminal.element||!this._terminal.element.parentElement)return;const o=this._terminal._core,n=o._renderService.dimensions;if(n.css.cell.width===0||n.css.cell.height===0)return;const l=this._terminal.options.scrollback===0?0:o.viewport.scrollBarWidth,a=window.getComputedStyle(this._terminal.element.parentElement),f=parseInt(a.getPropertyValue("height")),S=Math.max(0,parseInt(a.getPropertyValue("width"))),g=window.getComputedStyle(this._terminal.element),r=f-(parseInt(g.getPropertyValue("padding-top"))+parseInt(g.getPropertyValue("padding-bottom"))),p=S-(parseInt(g.getPropertyValue("padding-right"))+parseInt(g.getPropertyValue("padding-left")))-l;return{cols:Math.max(2,Math.floor(p/n.css.cell.width)),rows:Math.max(1,Math.floor(r/n.css.cell.height))}}}})(),t})())}(ce)),ce.exports}var at=nt(),de={exports:{}},_e;function st(){return _e||(_e=1,function(s,e){(function(t,i){s.exports=i()})(self,()=>(()=>{var t={};return(()=>{var i=t;function o(n,l,a){return n.addEventListener(l,a),{dispose:()=>{a&&n.removeEventListener(l,a)}}}Object.defineProperty(i,"__esModule",{value:!0}),i.AttachAddon=void 0,i.AttachAddon=class{constructor(n,l){this._disposables=[],this._socket=n,this._socket.binaryType="arraybuffer",this._bidirectional=!(l&&l.bidirectional===!1)}activate(n){this._disposables.push(o(this._socket,"message",l=>{const a=l.data;n.write(typeof a=="string"?a:new Uint8Array(a))})),this._bidirectional&&(this._disposables.push(n.onData(l=>this._sendData(l))),this._disposables.push(n.onBinary(l=>this._sendBinary(l)))),this._disposables.push(o(this._socket,"close",()=>this.dispose())),this._disposables.push(o(this._socket,"error",()=>this.dispose()))}dispose(){for(const n of this._disposables)n.dispose()}_sendData(n){this._checkOpenSocket()&&this._socket.send(n)}_sendBinary(n){if(!this._checkOpenSocket())return;const l=new Uint8Array(n.length);for(let a=0;a<n.length;++a)l[a]=255&n.charCodeAt(a);this._socket.send(l)}_checkOpenSocket(){switch(this._socket.readyState){case WebSocket.OPEN:return!0;case WebSocket.CONNECTING:throw new Error("Attach addon was loaded before socket was open");case WebSocket.CLOSING:return console.warn("Attach addon socket is closing"),!1;case WebSocket.CLOSED:throw new Error("Attach addon socket is closed");default:throw new Error("Unexpected socket state")}}}})(),t})())}(de)),de.exports}var it=st(),ue={exports:{}},ye;function lt(){return ye||(ye=1,function(s,e){(function(t,i){s.exports=i()})(self,()=>(()=>{var t={6:(l,a)=>{function f(g){try{const r=new URL(g),p=r.password&&r.username?`${r.protocol}//${r.username}:${r.password}@${r.host}`:r.username?`${r.protocol}//${r.username}@${r.host}`:`${r.protocol}//${r.host}`;return g.toLocaleLowerCase().startsWith(p.toLocaleLowerCase())}catch{return!1}}Object.defineProperty(a,"__esModule",{value:!0}),a.LinkComputer=a.WebLinkProvider=void 0,a.WebLinkProvider=class{constructor(g,r,p,A={}){this._terminal=g,this._regex=r,this._handler=p,this._options=A}provideLinks(g,r){const p=S.computeLink(g,this._regex,this._terminal,this._handler);r(this._addCallbacks(p))}_addCallbacks(g){return g.map(r=>(r.leave=this._options.leave,r.hover=(p,A)=>{if(this._options.hover){const{range:N}=r;this._options.hover(p,A,N)}},r))}};class S{static computeLink(r,p,A,N){const z=new RegExp(p.source,(p.flags||"")+"g"),[x,R]=S._getWindowedLineStrings(r-1,A),v=x.join("");let b;const _=[];for(;b=z.exec(v);){const C=b[0];if(!f(C))continue;const[$,U]=S._mapStrIdx(A,R,0,b.index),[F,B]=S._mapStrIdx(A,$,U,C.length);if($===-1||U===-1||F===-1||B===-1)continue;const K={start:{x:U+1,y:$+1},end:{x:B,y:F+1}};_.push({range:K,text:C,activate:N})}return _}static _getWindowedLineStrings(r,p){let A,N=r,z=r,x=0,R="";const v=[];if(A=p.buffer.active.getLine(r)){const b=A.translateToString(!0);if(A.isWrapped&&b[0]!==" "){for(x=0;(A=p.buffer.active.getLine(--N))&&x<2048&&(R=A.translateToString(!0),x+=R.length,v.push(R),A.isWrapped&&R.indexOf(" ")===-1););v.reverse()}for(v.push(b),x=0;(A=p.buffer.active.getLine(++z))&&A.isWrapped&&x<2048&&(R=A.translateToString(!0),x+=R.length,v.push(R),R.indexOf(" ")===-1););}return[v,N]}static _mapStrIdx(r,p,A,N){const z=r.buffer.active,x=z.getNullCell();let R=A;for(;N;){const v=z.getLine(p);if(!v)return[-1,-1];for(let b=R;b<v.length;++b){v.getCell(b,x);const _=x.getChars();if(x.getWidth()&&(N-=_.length||1,b===v.length-1&&_==="")){const C=z.getLine(p+1);C&&C.isWrapped&&(C.getCell(0,x),x.getWidth()===2&&(N+=1))}if(N<0)return[p,b]}p++,R=0}return[p,R]}}a.LinkComputer=S}},i={};function o(l){var a=i[l];if(a!==void 0)return a.exports;var f=i[l]={exports:{}};return t[l](f,f.exports,o),f.exports}var n={};return(()=>{var l=n;Object.defineProperty(l,"__esModule",{value:!0}),l.WebLinksAddon=void 0;const a=o(6),f=/(https?|HTTPS?):[/]{2}[^\s"'!*(){}|\\\^<>`]*[^\s"':,.!?{}|\\\^~\[\]`()<>]/;function S(g,r){const p=window.open();if(p){try{p.opener=null}catch{}p.location.href=r}else console.warn("Opening link blocked as opener could not be cleared")}l.WebLinksAddon=class{constructor(g=S,r={}){this._handler=g,this._options=r}activate(g){this._terminal=g;const r=this._options,p=r.urlRegex||f;this._linkProvider=this._terminal.registerLinkProvider(new a.WebLinkProvider(this._terminal,p,this._handler,r))}dispose(){this._linkProvider?.dispose()}}})(),n})())}(ue)),ue.exports}var ot=lt(),ae={exports:{}},De;function rt(){if(De)return ae.exports;De=1;function s(e,t=100,i={}){if(typeof e!="function")throw new TypeError(`Expected the first parameter to be a function, got \`${typeof e}\`.`);if(t<0)throw new RangeError("`wait` must not be negative.");const{immediate:o}=typeof i=="boolean"?{immediate:i}:i;let n,l,a,f,S;function g(){const A=n,N=l;return n=void 0,l=void 0,S=e.apply(A,N),S}function r(){const A=Date.now()-f;A<t&&A>=0?a=setTimeout(r,t-A):(a=void 0,o||(S=g()))}const p=function(...A){if(n&&this!==n&&Object.getPrototypeOf(this)===Object.getPrototypeOf(n))throw new Error("Debounced method called with different contexts of the same prototype.");n=this,l=A,f=Date.now();const N=o&&!a;return a||(a=setTimeout(r,t)),N&&(S=g()),S};return Object.defineProperty(p,"isPending",{get(){return a!==void 0}}),p.clear=()=>{a&&(clearTimeout(a),a=void 0)},p.flush=()=>{a&&p.trigger()},p.trigger=()=>{S=g(),p.clear()},p}return ae.exports.debounce=s,ae.exports=s,ae.exports}var ct=rt();const dt=Xe(ct),ut=()=>"",pt=s=>{let e="";if(s)for(const t in s)e+=`${t}=${s[t]}
`;return e},mt=async s=>{const e=s.installName;return`
export LMD_BASE_INSTALL_SCRIPT_DIR="${(await pe()).LMD_SCRIPTS_DIR}/lmd-install-scripts"
git clone --depth=1 https://gitee.com/lmdown/lmd-install-scripts $LMD_BASE_INSTALL_SCRIPT_DIR
cd $LMD_BASE_INSTALL_SCRIPT_DIR && git fetch origin master && git reset --hard origin/master
sh $LMD_BASE_INSTALL_SCRIPT_DIR/apps/${e}/install.sh`},ft=async s=>{const e=s.installName;return`
export LMD_BASE_INSTALL_SCRIPT_DIR="${(await pe()).LMD_SCRIPTS_DIR}/lmd-install-scripts"
sh $LMD_BASE_INSTALL_SCRIPT_DIR/apps/${e}/start.sh`},gt=async s=>{const e=s.installName;return`
export LMD_BASE_INSTALL_SCRIPT_DIR="${(await pe()).LMD_SCRIPTS_DIR}/lmd-install-scripts"
sh $LMD_BASE_INSTALL_SCRIPT_DIR/apps/${e}/update.sh
`},Ie=Z({__name:"index",props:{socketURI:{},initCommand:{},commandExecuteEndKeywords:{}},emits:["executeEnd"],setup(s,{expose:e,emit:t}){const i=t,o=D([]),n=D(!1),l=s,a=D(null),f=D(null),S=D(null),g=D(null);let r;Q(()=>{b(),v()}),Me(()=>{a.value?.close(),f.value?.dispose(),r&&g.value&&(r.unobserve(g.value),r.disconnect())});const p=I=>{console.log("runCommand",I),console.log("runCommand socket.value",a.value),a.value?.send(I+`
`)};e({runCommand:p,runStopCommand:()=>{const I=ut();p(I)},exitTerminal:()=>{p("exit")}});const z=()=>{if(!g.value||!a.value)return;const I=new window.Terminal({fontSize:14,cursorBlink:!0}),c=new it.AttachAddon(a.value),k=new at.FitAddon,u=new ot.WebLinksAddon((E,M)=>{const P=document.createElement("a");P.setAttribute("href",M),P.setAttribute("target","_blank"),P.setAttribute("id","lmdTempLink");const ne=document.getElementById("lmdTempLink");ne&&document.body.removeChild(ne),document.body.appendChild(P),P.click()});I.loadAddon(c),I.loadAddon(k),I.loadAddon(u),I.open(g.value),k.fit(),I.focus(),f.value=I},R=dt(I=>{for(const c of I)K(c.contentRect.width,c.contentRect.height)},50),v=()=>{S.value&&(r=new ResizeObserver(R),r.observe(S.value))},b=()=>{a.value=new WebSocket(l.socketURI),$(),C(),U(),_()},_=()=>{if(l.commandExecuteEndKeywords&&a.value){const I=l.commandExecuteEndKeywords;a.value.onmessage=c=>{const k=c.data;I.forEach(u=>{k.includes(u)&&!o.value.includes(u)&&o.value.push(u)}),o.value.length===I.length&&(n.value||(i("executeEnd"),n.value=!0))}}},C=()=>{a.value&&(a.value.onopen=()=>{z(),l.initCommand&&p(l.initCommand)})},$=()=>{a.value&&(a.value.onclose=I=>{console.log("close socket",I)})},U=()=>{a.value&&(a.value.onerror=I=>{console.log("socket 链接失败",I)})},F=D(80),B=D(30),K=(I,c)=>{const k=Math.floor(I/8.5),u=Math.round(c/16);if(console.log("cols",I,k),console.log("rows",c,u),!(u===0||k===0)&&(F.value!==k||B.value!==u)){F.value=k,B.value=u,f.value?.resize(k,u);const E=`lmd_action:resize:${k},${u}`;a.value?.send(E)}};return(I,c)=>(y(),j("div",{ref_key:"terminalOutContainer",ref:S,class:"mb-2",style:{height:"100%",width:"100%"}},[G("div",{ref_key:"terminalContainer",ref:g,class:"terminal",style:{height:"300px",width:"100%"}},null,512)],512))}}),vt=async s=>{let e;try{return(await X.post("/self-manage/common-util/app-running-base-env-info",{keys:s})).data}catch(t){return console.log("err",t),e}},St=async s=>{let e;try{return(await X.post("/self-manage/common-util/save-app-running-base-env-info",{envObj:s})).data}catch(t){return console.log("err",t),e}},ht=async()=>{let s;try{s=(await X.get("/self-manage/common-util/lan-ip")).data?.ip}catch(e){console.log("err",e)}return s},wt=async()=>{let s;try{s=(await X.get("/self-manage/common-util/user-home-dir")).data?.userHomeDir}catch(e){console.log("err",e)}return s},At=async s=>{let e=0;try{e=(await X.get(`/self-manage/common-util/dir-file-size?dirPath=${s}`)).data?.fileSize}catch(t){console.log("err",t)}return e},bt=async s=>{let e=[];try{e=(await X.get(`/self-manage/common-util/installed-model-files/${s}`)).data?.models}catch(t){console.log("err",t)}return e},_t=async(s,e=!1)=>{if(window.ipcRenderer)return await window.ipcRenderer?.invoke(me.SELECT_DIR,s,e)},ke="OLLAMA_MODELS",yt="OLLAMA_HOST",Dt={DISPLAY_ENV:["OLLAMA_MODELS","OLLAMA_HOST"]},It=[{displayName:"Deepseek-R1",installName:"deepseek-r1",tags:[{parameterSize:"1.5b",fileSize:"1.1GB"},{parameterSize:"7b",fileSize:"4.7GB"},{parameterSize:"8b",fileSize:"4.9GB"},{parameterSize:"14b",fileSize:"9.0GB"},{parameterSize:"32b",fileSize:"20GB"},{parameterSize:"70b",fileSize:"43GB"},{parameterSize:"671b",fileSize:"404GB"}]},{displayName:"Llama 3.1",installName:"llama3.1",tags:[{parameterSize:"8b",fileSize:"4.9GB"},{parameterSize:"70b",fileSize:"43GB"},{parameterSize:"405b",fileSize:"243GB"}]},{displayName:"Qwen 2.5",installName:"qwen2.5",tags:[{parameterSize:"0.5b",fileSize:"398MB"},{parameterSize:"1.5b",fileSize:"986MB"},{parameterSize:"3b",fileSize:"1.9GB "},{parameterSize:"7b",fileSize:"4.7GB"},{parameterSize:"14b",fileSize:"9.0GB"},{parameterSize:"32b",fileSize:"20GB"},{parameterSize:"72b",fileSize:"47GB"}]},{displayName:"Mistral",installName:"mistral",tags:[{parameterSize:"7b",fileSize:"4.1GB"}]},{displayName:"Phi-4",installName:"phi4",tags:[{parameterSize:"14b",fileSize:"9.1GB"}]},{displayName:"Qwen 2.5 Coder",installName:"qwen2.5-coder",tags:[{parameterSize:"0.5b",fileSize:"531MB"},{parameterSize:"1.5b",fileSize:"986MB"},{parameterSize:"3b",fileSize:"1.9GB"},{parameterSize:"7b",fileSize:"4.7GB"},{parameterSize:"14b",fileSize:"9.0GB"},{parameterSize:"32b",fileSize:"20GB"}]}],kt=async()=>{if(window.ipcRenderer)return await window.ipcRenderer?.invoke(me.RESTART_APP)},Tt=async s=>{if(window.ipcRenderer)return await window.ipcRenderer?.invoke(me.KILL_PROCESSES,s)},Et=["B","kB","MB","GB","TB","PB","EB","ZB","YB"],Ct=["B","KiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"],Lt=["b","kbit","Mbit","Gbit","Tbit","Pbit","Ebit","Zbit","Ybit"],xt=["b","kibit","Mibit","Gibit","Tibit","Pibit","Eibit","Zibit","Yibit"],Te=(s,e,t)=>{let i=s;return typeof e=="string"||Array.isArray(e)?i=s.toLocaleString(e,t):(e===!0||t!==void 0)&&(i=s.toLocaleString(void 0,t)),i};function Mt(s,e){if(!Number.isFinite(s))throw new TypeError(`Expected a finite number, got ${typeof s}: ${s}`);e={bits:!1,binary:!1,space:!0,...e};const t=e.bits?e.binary?xt:Lt:e.binary?Ct:Et,i=e.space?" ":"";if(e.signed&&s===0)return` 0${i}${t[0]}`;const o=s<0,n=o?"-":e.signed?"+":"";o&&(s=-s);let l;if(e.minimumFractionDigits!==void 0&&(l={minimumFractionDigits:e.minimumFractionDigits}),e.maximumFractionDigits!==void 0&&(l={maximumFractionDigits:e.maximumFractionDigits,...l}),s<1){const g=Te(s,e.locale,l);return n+g+i+t[0]}const a=Math.min(Math.floor(e.binary?Math.log(s)/Math.log(1024):Math.log10(s)/3),t.length-1);s/=(e.binary?1024:1e3)**a,l||(s=s.toPrecision(3));const f=Te(Number(s),e.locale,l),S=t[a];return n+f+i+S}class W{static appIsOllama(e){return e==="ollama"}static async getModelFileSize(e,t){if(this.appIsOllama(e)&&t){const i=t[ke];if(i){const o=await At(i);return Mt(o)}}return""}static async getModelsDir(e,t){return this.appIsOllama(e)&&t?t[ke]:""}static genModelDownloadCommand(e,t){return this.appIsOllama(e)&&t?`ollama pull ${t}`:""}static async mergeModelsList(e,t){if(e){const i=await bt(e);console.log("installedModelList",i),i.forEach(o=>{const[n,l]=o.name.split(":"),a=t.find(f=>f.installName===n);if(a){const f=a.tags.find(S=>S.parameterSize===l);f?f.installed=!0:a.tags.push({parameterSize:l,fileSize:o.size||"",installed:!0})}else t.push({displayName:n,installName:n,tags:[{parameterSize:l,fileSize:o.size||"",installed:!0}]})})}return t}static killAppProcessed(e){this.appIsOllama(e)&&Tt(["ollama.exe","ollama app.exe"])}static needPreStartApp(e){return!!this.appIsOllama(e)}}class J{static async getAppSettings(){const e=await this.getOSEnvObj();return{modelsDir:e.OLLAMA_MODELS,externalAccessHost:e.OLLAMA_HOST}}static async getOSEnvObj(){return await vt(Dt.DISPLAY_ENV)}static async getAccessHosts(e){const t="11434",i=[`http://127.0.0.1:${t}`];if(!(!e||e==="127.0.0.1")){const o=e.split(":"),n=o[0];let l=[n];const a=o[1]||t;n==="0.0.0.0"&&(l=await ht()),l&&l.length>0&&l.forEach(f=>{i.push(`http://${f}:${a}`)})}return i}static async saveAppSettings(e,t){e.modelsDir===t&&(e.modelsDir="");const i={OLLAMA_MODELS:e.modelsDir,OLLAMA_HOST:e.externalAccessHost};return await St(i)}static filterSpecialFiles(e){if(!e)return e;const t=["desktop.ini",".ds_store","thumbs.db"];return e.filter(i=>{const o=i.toLowerCase();return!t.includes(o)})}static checkModelsDirValid(e,t){if(e.subdirs=this.filterSpecialFiles(e.subdirs),e.files=this.filterSpecialFiles(e.files),(!e.subdirs||e.subdirs.length===0)&&(!e.files||e.files.length===0))return!0;const i=new Set(e.subdirs);return t.every(n=>i.has(n))}static getDownloadableModels(){return It}}const oe=Ne("runningInstance",{state:()=>({runningInstances:[],appSettingsSaved:!1,terminals:[],currentTerminalTab:""}),actions:{addRunningInstance(s){this.runningInstances.find(t=>t.id===s.id)||this.runningInstances.push(s)},removeRunningInstance(s){const e=this.runningInstances.findIndex(t=>t.id===s.id);e!=-1&&this.runningInstances.splice(e,1)},resetAppSettingsSavedStatus(){this.appSettingsSaved=!1},onAppSettingsSaved(){this.appSettingsSaved=!0},initTerminal(s){this.terminals=[s],this.currentTerminalTab=s.tabName},addTerminal(s,e,t){this.terminals.find(o=>o.tabName===s)||this.terminals.push({text:e,tabName:s,initCommand:t,closable:!0,commandExecuteEndKeywords:["digest","writing manifest","success"]}),this.currentTerminalTab=s},removeTerminal(s,e){this.terminals.splice(e,1)}}});class ee{static isWindows(){const e=navigator.userAgentData;return e&&e.platform?e.platform==="Windows":navigator.userAgent?/Win(dows )?NT/.test(navigator.userAgent):!1}static isMacOS(){const e=navigator.userAgentData;return e&&e.platform?e.platform==="macOS"||e.platform==="MacOS":navigator.userAgent?/Macintosh|Mac OS X/i.test(navigator.userAgent):!1}}const Nt={style:{"font-size":"12px"}},Rt={style:{"font-size":"12px"}},zt=Z({__name:"app-settings-btn",props:{installedInstance:{}},setup(s){const{t:e}=fe(),t=D(!1),i=D(!1),o=D(!1),n=D(!1),l=D(""),a=oe(),f=Be("showToastMessage"),S=D({}),g=D(!0),r=s;H(()=>r.installedInstance,()=>{p()});const p=()=>{B()?t.value=!0:t.value=!1};Q(()=>{p()});const A=async()=>{i.value=!0,await z(),await F()},N=()=>{i.value=!1},z=async()=>{const c=await wt();l.value=c+"/.ollama/models"},x=async()=>{if(!o.value||!S)return;if(l.value===""){const E=e("AppSettingDialog.DataNotValid");f&&f(E,"error");return}n.value=!0;const c=Object.assign({},S.value),k=await J.saveAppSettings(c,l.value);console.log("save result ",k);const u=e("Common.saveSuccess");f&&f(u,"success"),n.value=!1,a.onAppSettingsSaved(),setTimeout(()=>{a.resetAppSettingsSavedStatus()},100),N(),ee.isWindows()&&(W.killAppProcessed(r.installedInstance?.installName),setTimeout(()=>{kt()},1500))},R=c=>!!c||e("Common.fieldRequired"),v=async()=>{const c=await _t(S.value.modelsDir,!0);c&&c.path&&(S.value.modelsDir=c.path,console.log("dirInfo",c),g.value=J.checkModelsDirValid(c,["blobs"]),console.log("dirValid.value",g.value))},b=[R,()=>g.value||e("AppSettingDialog.ModelsDirNotValid")],_=/^(\d{1,3}\.){3}\d{1,3}(:\d{1,5})?$/,C=[c=>c===""?!0:_.test(c)||e("AppSettingDialog.HostNotValid")],$=async()=>{S.value.modelsDir=l.value},U=Ee(()=>{if(B())return e("AppSettingDialog.OllamaModelsDirInfoIconTip")}),F=async()=>{if(B()){const c=await J.getAppSettings();console.log("getOSEnvForCurrentApp",c),S.value=Object.assign({},c),c.modelsDir===""&&(console.log("getOSEnvForCurrentApp",c),S.value.modelsDir=l.value)}},B=()=>W.appIsOllama(r.installedInstance?.installName),K=()=>{let c=e("AppSettingDialog.ModelsDirTip");return ee.isWindows()?c+=e("AppSettingDialog.ModelsDirTipExtraWindows"):c+=e("AppSettingDialog.ModelsDirTipExtraMac"),c},I=()=>{let c=e("AppSettingDialog.ServerHostTip");return ee.isWindows()?c+=e("AppSettingDialog.ServerHostTipExtraWindows"):c+=e("AppSettingDialog.ServerHostTipExtraMac"),c};return(c,k)=>(y(),j(Y,null,[m(t)?(y(),L(O,{key:0,"prepend-icon":"mdi-cog",stacked:"",onClick:A},{default:d(()=>[T(w(c.$t("AppRunningWindow.Settings")),1)]),_:1})):V("",!0),h(Re,{modelValue:m(i),"onUpdate:modelValue":k[5]||(k[5]=u=>se(i)?i.value=u:null),"min-width":"400","max-width":"800"},{default:d(()=>[c.installedInstance?(y(),L(ze,{key:0,class:"mx-auto px-0 py-0 window-no-drag",width:"100%",title:c.$t("AppSettingDialog.Title")+c.installedInstance.name},{append:d(()=>[h(O,{icon:"mdi-close",class:"ms-auto",size:"compact",text:"Ok",elevation:"0",onClick:k[0]||(k[0]=u=>i.value=!1)})]),default:d(()=>[m(S)?(y(),L(Oe,{key:0,class:"pt-0 pb-3 px-6",modelValue:m(o),"onUpdate:modelValue":k[4]||(k[4]=u=>se(o)?o.value=u:null),onSubmit:Ce(x,["prevent"])},{default:d(()=>[h(ge,{modelValue:m(S).modelsDir,"onUpdate:modelValue":k[1]||(k[1]=u=>m(S).modelsDir=u),density:"comfortable",readonly:m(n),rules:b,label:c.$t("AppSettingDialog.ModelsDirLabel")},{append:d(()=>[h(ie,{location:"bottom"},{activator:d(({props:u})=>[h(Le,xe(u,{icon:"mdi-information-slab-circle-outline"}),null,16)]),default:d(()=>[G("pre",null,w(m(U)),1)]),_:1}),h(O,{class:"ml-1",onClick:v},{default:d(()=>[T(w(c.$t("AppSettingDialog.Browse")),1)]),_:1}),h(O,{class:"ml-1",onClick:$},{default:d(()=>[T(w(c.$t("AppSettingDialog.UseDefaultValue")),1)]),_:1})]),_:1},8,["modelValue","readonly","label"]),h(ve,{class:"pt-0"},{default:d(()=>[G("pre",Nt,w(K()),1)]),_:1}),h(ge,{modelValue:m(S).externalAccessHost,"onUpdate:modelValue":k[2]||(k[2]=u=>m(S).externalAccessHost=u),density:"comfortable",readonly:m(n),rules:C,label:c.$t("AppSettingDialog.ServerHostLabel")},null,8,["modelValue","readonly","label"]),h(ve,{class:"pt-0"},{default:d(()=>[G("pre",Rt,w(I()),1)]),_:1}),h(Ve,{class:"text-center justify-center"},{default:d(()=>[h(O,{variant:"outlined",onClick:k[3]||(k[3]=u=>i.value=!1)},{default:d(()=>[T(w(c.$t("AppSettingDialog.close")),1)]),_:1}),h(O,{color:"primary",variant:"flat",type:"submit",loading:m(n)},{default:d(()=>[T(w(c.$t("AppSettingDialog.saveConfig")),1)]),_:1},8,["loading"])]),_:1})]),_:1},8,["modelValue"])):V("",!0)]),_:1},8,["title"])):V("",!0)]),_:1},8,["modelValue"])],64))}}),Ot=Z({__name:"app-env-row",props:{installedInstance:{},appEnv:{}},setup(s){const e=D(null);return Q(async()=>{e.value=await $e()}),(t,i)=>(y(),L(le,{class:"my-1 py-1 mx-3"},{default:d(()=>[T(w(t.$t("AppRunningWindow.EnvVars"))+": ",1),(y(!0),j(Y,null,te(m(e),(o,n)=>(y(),L(q,{variant:"tonal",size:"x-small",style:{"min-width":"50px","max-width":"120px","margin-left":"4px"},key:n},{default:d(()=>[T(w(n)+" ",1),h(ie,{activator:"parent",location:"bottom"},{default:d(()=>[T(w(o),1)]),_:2},1024)]),_:2},1024))),128)),(y(!0),j(Y,null,te(t.appEnv,(o,n)=>(y(),L(q,{variant:"tonal",size:"x-small",color:"orange-darken-4",style:{"min-width":"50px","max-width":"120px","margin-left":"4px"},key:n},{default:d(()=>[T(w(n)+" ",1),h(ie,{activator:"parent",location:"bottom"},{default:d(()=>[T(w(o),1)]),_:2},1024)]),_:2},1024))),128))]),_:1}))}}),Vt=["href"],Bt=Z({__name:"app-access-row",props:{lmAppData:{},installedInstance:{},appEnv:{}},setup(s){const e=s,t=D([]),i=D(!1),o=async()=>{if(e.lmAppData?.accessInfo){const n=e.lmAppData.accessInfo,{accessType:l}=n;if(!l)return!1;if(l==="browser")return t.value.push(e.lmAppData.accessInfo?.webUrl||""),!0;if(l==="exec"&&W.appIsOllama(e.installedInstance?.installName)){if(e.appEnv){const a=e.appEnv[yt];t.value=await J.getAccessHosts(a)}return!0}}return!1};return Q(async()=>{i.value=await o()}),H(()=>e.appEnv,async()=>{i.value=await o()}),(n,l)=>n.lmAppData&&m(i)?(y(),L(le,{key:0,class:"my-1 py-1 mx-3"},{default:d(()=>[T(w(n.$t("AppRunningWindow.Access"))+": ",1),m(t)&&m(t).length>0?(y(!0),j(Y,{key:0},te(m(t),a=>(y(),j("a",{class:"mx-2",key:a,href:a,target:"_blank"},w(a),9,Vt))),128)):V("",!0)]),_:1})):V("",!0)}}),$t=Z({__name:"model-download-row",props:{lmAppData:{},installedInstance:{},appEnv:{}},setup(s){const e=oe(),t=D([]),i=D([]),o=D(!1),n=D(null),l=D(null),a=D(null),f=D(!1),{t:S}=fe(),g=s,r=async()=>{const v=await W.getModelsDir(g.installedInstance?.installName,g.appEnv);We(v)};Q(async()=>{p(),z(),await x()}),H(()=>g.lmAppData,()=>{p()}),H(()=>g.installedInstance,()=>{z(),x()}),H(()=>g.appEnv,()=>{z(),x()});const p=()=>{o.value=W.appIsOllama(g.lmAppData?.installName)};H(n,()=>{N()}),H(l,v=>{A(v)});const A=v=>{const b=i.value.find(_=>_.parameterSize===v);b&&(b.installed===void 0?f.value=!0:f.value=!b.installed)},N=()=>{const v=n.value,_=t.value.find(C=>C.installName===v)?.tags||[];if(i.value=_,_.length>0){const C=_[0].parameterSize;l.value=C,A(C)}},z=async()=>{a.value=await W.getModelFileSize(g.installedInstance?.installName,g.appEnv)},x=async()=>{const v=g.installedInstance?.installName;if(v&&o.value){const b=J.getDownloadableModels(),_=await W.mergeModelsList(v,b);if(t.value=_,t.value&&t.value.length>0){const C=t.value[0];n.value=C.installName}}},R=async()=>{const v=`${n.value}:${l.value}`,b=W.genModelDownloadCommand(g.installedInstance?.installName,v),_=S("AppRunningWindow.ModelDownloadBtnLabel")+" "+v;b&&n.value&&e.addTerminal(v,_,b)};return(v,b)=>v.lmAppData&&m(o)?(y(),L(le,{key:0,class:"my-0 py-0 mx-3 d-flex flex-row",style:{gap:"0.5rem","align-items":"center"}},{default:d(()=>[G("div",null,w(v.$t("AppRunningWindow.ModelDownload"))+": ",1),h(Se,{class:"flex-1",items:m(t),"item-title":"displayName","item-value":"installName",modelValue:m(n),"onUpdate:modelValue":b[0]||(b[0]=_=>se(n)?n.value=_:null),density:"compact","hide-details":"",label:v.$t("AppRunningWindow.ModelName")},null,8,["items","modelValue","label"]),h(Se,{class:"flex-1",items:m(i),"item-title":"parameterSize","item-value":"parameterSize",modelValue:m(l),"onUpdate:modelValue":b[1]||(b[1]=_=>se(l)?l.value=_:null),density:"compact","hide-details":"",label:v.$t("AppRunningWindow.ParameterSize")},{selection:d(({item:_})=>[T(w(_.title)+" ",1),h(q,{density:"compact",class:"mx-1",variant:"flat",color:"yellow-darken-2"},{default:d(()=>[T(w(_.raw.fileSize),1)]),_:2},1024),_.raw.installed?(y(),L(q,{key:0,density:"compact",variant:"flat",color:"green"},{default:d(()=>[G("span",null,w(v.$t("AppRunningWindow.ModelDownloaded")),1)]),_:1})):(y(),L(q,{key:1,density:"compact"},{default:d(()=>[G("span",null,w(v.$t("AppRunningWindow.ModelNotDownloaded")),1)]),_:1}))]),item:d(({props:_,item:C})=>[h(Pe,xe(_,{density:"compact"}),{title:d(()=>[T(w(C.title)+" ",1),h(q,{density:"compact",class:"mx-1",variant:"flat",color:"yellow-darken-2"},{default:d(()=>[T(w(C.raw.fileSize),1)]),_:2},1024),C.raw.installed?(y(),L(q,{key:0,density:"compact",variant:"flat",color:"green"},{default:d(()=>[G("span",null,w(v.$t("AppRunningWindow.ModelDownloaded")),1)]),_:1})):(y(),L(q,{key:1,density:"compact"},{default:d(()=>[G("span",null,w(v.$t("AppRunningWindow.ModelNotDownloaded")),1)]),_:1}))]),_:2},1040)]),_:1},8,["items","modelValue","label"]),m(f)?(y(),L(O,{key:0,"prepend-icon":"mdi-download-outline",onClick:R,color:"green-lighten-5"},{default:d(()=>[T(w(v.$t("AppRunningWindow.ModelDownloadBtnLabel")),1)]),_:1})):V("",!0),h(O,{"prepend-icon":"mdi-folder-file-outline",color:"amber-lighten-5",onClick:r},{default:d(()=>[T(w(m(a))+" ",1),h(ie,{activator:"parent",location:"top"},{default:d(()=>[T(w(v.$t("AppRunningWindow.StorageBtnTip")),1)]),_:1})]),_:1})]),_:1})):V("",!0)}}),Pt=Z({__name:"app-env-and-access",props:{installedInstance:{},lmAppData:{}},emits:["appEnvSavedAndUpdated"],setup(s,{expose:e,emit:t}){const i=s,o=oe(),n=D({}),l=t;Q(async()=>{a()});const a=async()=>{const f=i.installedInstance?.installName;W.appIsOllama(f)&&(n.value=await J.getOSEnvObj()||{})};return e({updateAppEnvData:a}),H(()=>i.installedInstance,()=>{a()}),H(()=>o.appSettingsSaved,async f=>{f&&(n.value=null,await a(),l("appEnvSavedAndUpdated",n.value))}),(f,S)=>m(n)&&f.installedInstance?(y(),j(Y,{key:0},[h(Bt,{appEnv:m(n),lmAppData:f.lmAppData,installedInstance:f.installedInstance},null,8,["appEnv","lmAppData","installedInstance"]),h(Ot,{appEnv:m(n),installedInstance:f.installedInstance},null,8,["appEnv","installedInstance"]),h($t,{appEnv:m(n),installedInstance:f.installedInstance,lmAppData:f.lmAppData},null,8,["appEnv","installedInstance","lmAppData"])],64)):V("",!0)}}),qt=Z({__name:"AppRunningWindow",setup(s){const e=Ue(),t=Je(),i=D(null),o=D(),n=D(),l=D(null),a=D(!1),f=D(!1),S=D("--"),{t:g}=fe(),r=oe(),p=Ee(()=>!(a.value&&!t.currentLmApp.runtimeUpdateAllowed));Q(async()=>{A();const u=e.params.id,E=await et(u);l.value=E;const M=E.appId;await t.fetchApp(M),i.value=t.currentLmApp,window.ipcRenderer?.on(re.STOP_AI_RUNNING_INSTANCE,(ne,...Wt)=>{_(),C()}),B();const P=i?.value.name;document.title=P,I()});const A=()=>{const u={icon:"mdi-application-brackets-outline",text:g("AppRunningWindow.MainProcessTab"),tabName:"main-process",closable:!1,commandExecuteEndKeywords:["lmd start script end."]};r.initTerminal(u)},N=()=>{_(),z()},z=async()=>{if(a.value=!0,i.value){const u=await ft(i.value);b(u),window.ipcRenderer?.send(re.RUNNING_STATUS_CHANGE,!0)}},x=async()=>{if(i.value){const u=await gt(i.value);b(u)}},R=()=>{$()},v=()=>Array.isArray(o.value)?o.value[0]:o.value,b=u=>{const E=v();console.log("terminalComponent",E,u),E?.runCommand(u)},_=()=>{a.value=!1,F(),v()?.runStopCommand(),window.ipcRenderer.send(re.RUNNING_STATUS_CHANGE,!1)},C=()=>{v()?.exitTerminal()},$=async()=>{if(i.value){const u=await mt(i.value);b(u)}},U=(u,E)=>{r.removeTerminal(u,E)},F=()=>{S.value="--"},B=()=>{e.query.script===tt.INSTALL&&$()},K=u=>{if(ee.isWindows())return;_();const E=pt(u);v()?.runCommand(E),z()},I=async()=>{if(W.needPreStartApp(l.value?.installName)){if(z(),ee.isMacOS()){setTimeout(()=>{c()},1e3);return}return}c()},c=()=>{f.value=!0},k=()=>{n.value?.updateAppEnvData()};return(u,E)=>(y(),L(Ye,null,{default:d(()=>[h(He,{elevation:"1",class:"px-2"},{prepend:d(()=>[h(Ae,{src:m(i)?.icon,width:"60",height:"60"},null,8,["src"]),h(Fe,null,{default:d(()=>[T(w(m(i)?.name),1)]),_:1}),m(l)?.version&&m(l)?.version!=="--"?(y(),L(Ge,{key:0},{default:d(()=>[T(w(u.$t("AppRunningWindow.Version"))+" "+w(m(l)?.version),1)]),_:1})):V("",!0)]),append:d(()=>[he(h(O,{stacked:"",onClick:R},{prepend:d(()=>[h(Ae,{src:"./images/icons/lmd-logo.png",size:"20",width:"25",height:"25"})]),default:d(()=>[T(" "+w(u.$t("AppRunningWindow.Install")),1)]),_:1},512),[[we,m(p)]]),he(h(O,{"prepend-icon":"mdi-autorenew",stacked:"",onClick:x},{default:d(()=>[T(w(u.$t("AppRunningWindow.Update")),1)]),_:1},512),[[we,m(p)]]),m(a)?(y(),L(O,{key:0,stacked:"","prepend-icon":"mdi-stop",onClick:E[0]||(E[0]=M=>_())},{default:d(()=>[T(w(u.$t("AppRunningWindow.Stop")),1)]),_:1})):(y(),L(O,{key:1,stacked:"","prepend-icon":"mdi-play",onClick:E[1]||(E[1]=M=>z())},{default:d(()=>[T(w(u.$t("AppRunningWindow.Start")),1)]),_:1})),m(a)?(y(),L(O,{key:2,stacked:"","prepend-icon":"mdi-refresh-circle",onClick:E[2]||(E[2]=M=>N())},{default:d(()=>[T(w(u.$t("AppRunningWindow.Restart")),1)]),_:1})):V("",!0),h(zt,{installedInstance:m(l)},null,8,["installedInstance"])]),_:1}),h(Ke,{class:"mx-1 running-window-main mb-3"},{default:d(()=>[h(le,{fluid:"",class:"d-flex flex-column",style:{height:"100%"}},{default:d(()=>[m(l)&&m(i)&&m(f)?(y(),L(Pt,{key:0,ref_key:"appEnvAndAccessComponent",ref:n,onAppEnvSavedAndUpdated:K,lmAppData:m(i),installedInstance:m(l)},null,8,["lmAppData","installedInstance"])):V("",!0),h(je,{class:"mx-2",modelValue:m(r).currentTerminalTab,"onUpdate:modelValue":E[3]||(E[3]=M=>m(r).currentTerminalTab=M),"align-tabs":"start",color:"primary"},{default:d(()=>[(y(!0),j(Y,null,te(m(r).terminals,(M,P)=>(y(),L(Ze,{value:M.tabName,key:M.tabName},{append:d(()=>[M.closable?(y(),L(Le,{key:0,icon:"mdi-close-circle-outline",onClick:Ce(ne=>U(M,P),["stop"])},null,8,["onClick"])):V("",!0)]),default:d(()=>[T(" "+w(M.text),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"]),h(qe,{modelValue:m(r).currentTerminalTab,"onUpdate:modelValue":E[4]||(E[4]=M=>m(r).currentTerminalTab=M),class:"mx-2 my-0 px-0 pt-0 mb-0",style:{flex:"1","background-color":"black"}},{default:d(()=>[(y(!0),j(Y,null,te(m(r).terminals,(M,P)=>(y(),L(Qe,{style:{flex:"1"},key:M.text,value:M.tabName,eager:""},{default:d(()=>[M.tabName==="main-process"?(y(),L(Ie,{key:0,onExecuteEnd:c,"command-execute-end-keywords":M.commandExecuteEndKeywords,ref_for:!0,ref_key:"generalTerminal",ref:o,socketURI:"ws://localhost:19312"},null,8,["command-execute-end-keywords"])):(y(),L(Ie,{key:1,onExecuteEnd:k,"command-execute-end-keywords":M.commandExecuteEndKeywords,initCommand:M.initCommand,socketURI:"ws://localhost:19312"},null,8,["command-execute-end-keywords","initCommand"]))]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}))}});export{qt as default};
