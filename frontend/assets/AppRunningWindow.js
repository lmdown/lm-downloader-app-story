import{a6 as pe,d as Z,r as D,o as Q,ae as xe,e as j,i as y,p as F,X as ke,v as Me,K as ue,x as H,G as Te,c as L,b as V,g as h,u as m,V as O,w as d,I as T,t as w,z as Ne,O as ae,B as ze,a8 as Re,a3 as Ee,a9 as me,a2 as se,Q as Ce,a1 as Le,E as fe,aa as Oe,F as Y,Z as Ve,a7 as Be,L as ie,f as J,af as q,ag as ge,ah as $e,$ as Pe,P as We,ai as ve,aj as Se,k as he,H as Ue,J as Ge,R as Fe,ak as He,al as je,am as qe,an as Ke,ao as Ye,ap as Ze}from"./index.js";import{u as Qe}from"./lmapp.js";import{a as Xe,b as Je}from"./_commonjsHelpers.js";import{a as et,b as tt,c as nt,d as at,e as st,g as it,s as lt,D as ot,I as oe}from"./common-util.js";import{A as rt}from"./AppScriptType.js";var re={exports:{}},we;function ct(){return we||(we=1,function(l,e){(function(n,i){l.exports=i()})(self,()=>(()=>{var n={};return(()=>{var i=n;Object.defineProperty(i,"__esModule",{value:!0}),i.FitAddon=void 0,i.FitAddon=class{activate(o){this._terminal=o}dispose(){}fit(){const o=this.proposeDimensions();if(!o||!this._terminal||isNaN(o.cols)||isNaN(o.rows))return;const a=this._terminal._core;this._terminal.rows===o.rows&&this._terminal.cols===o.cols||(a._renderService.clear(),this._terminal.resize(o.cols,o.rows))}proposeDimensions(){if(!this._terminal||!this._terminal.element||!this._terminal.element.parentElement)return;const o=this._terminal._core,a=o._renderService.dimensions;if(a.css.cell.width===0||a.css.cell.height===0)return;const s=this._terminal.options.scrollback===0?0:o.viewport.scrollBarWidth,t=window.getComputedStyle(this._terminal.element.parentElement),f=parseInt(t.getPropertyValue("height")),S=Math.max(0,parseInt(t.getPropertyValue("width"))),g=window.getComputedStyle(this._terminal.element),r=f-(parseInt(g.getPropertyValue("padding-top"))+parseInt(g.getPropertyValue("padding-bottom"))),u=S-(parseInt(g.getPropertyValue("padding-right"))+parseInt(g.getPropertyValue("padding-left")))-s;return{cols:Math.max(2,Math.floor(u/a.css.cell.width)),rows:Math.max(1,Math.floor(r/a.css.cell.height))}}}})(),n})())}(re)),re.exports}var dt=ct(),ce={exports:{}},Ae;function pt(){return Ae||(Ae=1,function(l,e){(function(n,i){l.exports=i()})(self,()=>(()=>{var n={};return(()=>{var i=n;function o(a,s,t){return a.addEventListener(s,t),{dispose:()=>{t&&a.removeEventListener(s,t)}}}Object.defineProperty(i,"__esModule",{value:!0}),i.AttachAddon=void 0,i.AttachAddon=class{constructor(a,s){this._disposables=[],this._socket=a,this._socket.binaryType="arraybuffer",this._bidirectional=!(s&&s.bidirectional===!1)}activate(a){this._disposables.push(o(this._socket,"message",s=>{const t=s.data;a.write(typeof t=="string"?t:new Uint8Array(t))})),this._bidirectional&&(this._disposables.push(a.onData(s=>this._sendData(s))),this._disposables.push(a.onBinary(s=>this._sendBinary(s)))),this._disposables.push(o(this._socket,"close",()=>this.dispose())),this._disposables.push(o(this._socket,"error",()=>this.dispose()))}dispose(){for(const a of this._disposables)a.dispose()}_sendData(a){this._checkOpenSocket()&&this._socket.send(a)}_sendBinary(a){if(!this._checkOpenSocket())return;const s=new Uint8Array(a.length);for(let t=0;t<a.length;++t)s[t]=255&a.charCodeAt(t);this._socket.send(s)}_checkOpenSocket(){switch(this._socket.readyState){case WebSocket.OPEN:return!0;case WebSocket.CONNECTING:throw new Error("Attach addon was loaded before socket was open");case WebSocket.CLOSING:return console.warn("Attach addon socket is closing"),!1;case WebSocket.CLOSED:throw new Error("Attach addon socket is closed");default:throw new Error("Unexpected socket state")}}}})(),n})())}(ce)),ce.exports}var ut=pt(),de={exports:{}},be;function mt(){return be||(be=1,function(l,e){(function(n,i){l.exports=i()})(self,()=>(()=>{var n={6:(s,t)=>{function f(g){try{const r=new URL(g),u=r.password&&r.username?`${r.protocol}//${r.username}:${r.password}@${r.host}`:r.username?`${r.protocol}//${r.username}@${r.host}`:`${r.protocol}//${r.host}`;return g.toLocaleLowerCase().startsWith(u.toLocaleLowerCase())}catch{return!1}}Object.defineProperty(t,"__esModule",{value:!0}),t.LinkComputer=t.WebLinkProvider=void 0,t.WebLinkProvider=class{constructor(g,r,u,A={}){this._terminal=g,this._regex=r,this._handler=u,this._options=A}provideLinks(g,r){const u=S.computeLink(g,this._regex,this._terminal,this._handler);r(this._addCallbacks(u))}_addCallbacks(g){return g.map(r=>(r.leave=this._options.leave,r.hover=(u,A)=>{if(this._options.hover){const{range:N}=r;this._options.hover(u,A,N)}},r))}};class S{static computeLink(r,u,A,N){const R=new RegExp(u.source,(u.flags||"")+"g"),[x,z]=S._getWindowedLineStrings(r-1,A),v=x.join("");let b;const _=[];for(;b=R.exec(v);){const C=b[0];if(!f(C))continue;const[$,U]=S._mapStrIdx(A,z,0,b.index),[G,B]=S._mapStrIdx(A,$,U,C.length);if($===-1||U===-1||G===-1||B===-1)continue;const K={start:{x:U+1,y:$+1},end:{x:B,y:G+1}};_.push({range:K,text:C,activate:N})}return _}static _getWindowedLineStrings(r,u){let A,N=r,R=r,x=0,z="";const v=[];if(A=u.buffer.active.getLine(r)){const b=A.translateToString(!0);if(A.isWrapped&&b[0]!==" "){for(x=0;(A=u.buffer.active.getLine(--N))&&x<2048&&(z=A.translateToString(!0),x+=z.length,v.push(z),A.isWrapped&&z.indexOf(" ")===-1););v.reverse()}for(v.push(b),x=0;(A=u.buffer.active.getLine(++R))&&A.isWrapped&&x<2048&&(z=A.translateToString(!0),x+=z.length,v.push(z),z.indexOf(" ")===-1););}return[v,N]}static _mapStrIdx(r,u,A,N){const R=r.buffer.active,x=R.getNullCell();let z=A;for(;N;){const v=R.getLine(u);if(!v)return[-1,-1];for(let b=z;b<v.length;++b){v.getCell(b,x);const _=x.getChars();if(x.getWidth()&&(N-=_.length||1,b===v.length-1&&_==="")){const C=R.getLine(u+1);C&&C.isWrapped&&(C.getCell(0,x),x.getWidth()===2&&(N+=1))}if(N<0)return[u,b]}u++,z=0}return[u,z]}}t.LinkComputer=S}},i={};function o(s){var t=i[s];if(t!==void 0)return t.exports;var f=i[s]={exports:{}};return n[s](f,f.exports,o),f.exports}var a={};return(()=>{var s=a;Object.defineProperty(s,"__esModule",{value:!0}),s.WebLinksAddon=void 0;const t=o(6),f=/(https?|HTTPS?):[/]{2}[^\s"'!*(){}|\\\^<>`]*[^\s"':,.!?{}|\\\^~\[\]`()<>]/;function S(g,r){const u=window.open();if(u){try{u.opener=null}catch{}u.location.href=r}else console.warn("Opening link blocked as opener could not be cleared")}s.WebLinksAddon=class{constructor(g=S,r={}){this._handler=g,this._options=r}activate(g){this._terminal=g;const r=this._options,u=r.urlRegex||f;this._linkProvider=this._terminal.registerLinkProvider(new t.WebLinkProvider(this._terminal,u,this._handler,r))}dispose(){this._linkProvider?.dispose()}}})(),a})())}(de)),de.exports}var ft=mt(),ne={exports:{}},_e;function gt(){if(_e)return ne.exports;_e=1;function l(e,n=100,i={}){if(typeof e!="function")throw new TypeError(`Expected the first parameter to be a function, got \`${typeof e}\`.`);if(n<0)throw new RangeError("`wait` must not be negative.");const{immediate:o}=typeof i=="boolean"?{immediate:i}:i;let a,s,t,f,S;function g(){const A=a,N=s;return a=void 0,s=void 0,S=e.apply(A,N),S}function r(){const A=Date.now()-f;A<n&&A>=0?t=setTimeout(r,n-A):(t=void 0,o||(S=g()))}const u=function(...A){if(a&&this!==a&&Object.getPrototypeOf(this)===Object.getPrototypeOf(a))throw new Error("Debounced method called with different contexts of the same prototype.");a=this,s=A,f=Date.now();const N=o&&!t;return t||(t=setTimeout(r,n)),N&&(S=g()),S};return Object.defineProperty(u,"isPending",{get(){return t!==void 0}}),u.clear=()=>{t&&(clearTimeout(t),t=void 0)},u.flush=()=>{t&&u.trigger()},u.trigger=()=>{S=g(),u.clear()},u}return ne.exports.debounce=l,ne.exports=l,ne.exports}var vt=gt();const St=Xe(vt),ht=()=>"",wt=l=>{let e="";if(l)for(const n in l)e+=`${n}=${l[n]}
`;return e},At=async l=>{const e=l.installName;return`
export LMD_BASE_INSTALL_SCRIPT_DIR="${(await pe()).LMD_SCRIPTS_DIR}/lmd-install-scripts"
git clone --depth=1 https://gitee.com/lmdown/lmd-install-scripts $LMD_BASE_INSTALL_SCRIPT_DIR
cd $LMD_BASE_INSTALL_SCRIPT_DIR && git fetch origin master && git reset --hard origin/master
sh $LMD_BASE_INSTALL_SCRIPT_DIR/apps/${e}/install.sh`},bt=async l=>{const e=l.installName;return`
export LMD_BASE_INSTALL_SCRIPT_DIR="${(await pe()).LMD_SCRIPTS_DIR}/lmd-install-scripts"
sh $LMD_BASE_INSTALL_SCRIPT_DIR/apps/${e}/start.sh`},_t=async l=>{const e=l.installName;return`
export LMD_BASE_INSTALL_SCRIPT_DIR="${(await pe()).LMD_SCRIPTS_DIR}/lmd-install-scripts"
sh $LMD_BASE_INSTALL_SCRIPT_DIR/apps/${e}/update.sh
`},ye=Z({__name:"index",props:{socketURI:{},initCommand:{},commandExecuteEndKeywords:{}},emits:["executeEnd"],setup(l,{expose:e,emit:n}){const i=n,o=D([]),a=D(!1),s=l,t=D(null),f=D(null),S=D(null),g=D(null);let r;Q(()=>{b(),v()}),xe(()=>{t.value?.close(),f.value?.dispose(),r&&g.value&&(r.unobserve(g.value),r.disconnect())});const u=I=>{console.log("runCommand",I),console.log("runCommand socket.value",t.value),t.value?.send(I+`
`)};e({runCommand:u,runStopCommand:()=>{const I=ht();u(I)},exitTerminal:()=>{u("exit")}});const R=()=>{if(!g.value||!t.value)return;const I=new window.Terminal({fontSize:14,cursorBlink:!0}),c=new ut.AttachAddon(t.value),k=new dt.FitAddon,p=new ft.WebLinksAddon((E,M)=>{const P=document.createElement("a");P.setAttribute("href",M),P.setAttribute("target","_blank"),P.setAttribute("id","lmdTempLink");const te=document.getElementById("lmdTempLink");te&&document.body.removeChild(te),document.body.appendChild(P),P.click()});I.loadAddon(c),I.loadAddon(k),I.loadAddon(p),I.open(g.value),k.fit(),I.focus(),f.value=I},z=St(I=>{for(const c of I)K(c.contentRect.width,c.contentRect.height)},50),v=()=>{S.value&&(r=new ResizeObserver(z),r.observe(S.value))},b=()=>{t.value=new WebSocket(s.socketURI),$(),C(),U(),_()},_=()=>{if(s.commandExecuteEndKeywords&&t.value){const I=s.commandExecuteEndKeywords;t.value.onmessage=c=>{const k=c.data;I.forEach(p=>{k.includes(p)&&!o.value.includes(p)&&o.value.push(p)}),o.value.length===I.length&&(a.value||(i("executeEnd"),a.value=!0))}}},C=()=>{t.value&&(t.value.onopen=()=>{R(),s.initCommand&&u(s.initCommand)})},$=()=>{t.value&&(t.value.onclose=I=>{console.log("close socket",I)})},U=()=>{t.value&&(t.value.onerror=I=>{console.log("socket 链接失败",I)})},G=D(80),B=D(30),K=(I,c)=>{const k=Math.floor(I/8.5),p=Math.round(c/16);if(console.log("cols",I,k),console.log("rows",c,p),!(p===0||k===0)&&(G.value!==k||B.value!==p)){G.value=k,B.value=p,f.value?.resize(k,p);const E=`lmd_action:resize:${k},${p}`;t.value?.send(E)}};return(I,c)=>(y(),j("div",{ref_key:"terminalOutContainer",ref:S,class:"mb-2",style:{height:"100%",width:"100%"}},[F("div",{ref_key:"terminalContainer",ref:g,class:"terminal",style:{height:"300px",width:"100%"}},null,512)],512))}}),De="OLLAMA_MODELS",yt="OLLAMA_HOST",Dt={DISPLAY_ENV:["OLLAMA_MODELS","OLLAMA_HOST"]},It=[{displayName:"Deepseek-R1",installName:"deepseek-r1",tags:[{parameterSize:"1.5b",fileSize:"1.1GB"},{parameterSize:"7b",fileSize:"4.7GB"},{parameterSize:"8b",fileSize:"4.9GB"},{parameterSize:"14b",fileSize:"9.0GB"},{parameterSize:"32b",fileSize:"20GB"},{parameterSize:"70b",fileSize:"43GB"},{parameterSize:"671b",fileSize:"404GB"}]},{displayName:"Llama 3.1",installName:"llama3.1",tags:[{parameterSize:"8b",fileSize:"4.9GB"},{parameterSize:"70b",fileSize:"43GB"},{parameterSize:"405b",fileSize:"243GB"}]},{displayName:"Qwen 2.5",installName:"qwen2.5",tags:[{parameterSize:"0.5b",fileSize:"398MB"},{parameterSize:"1.5b",fileSize:"986MB"},{parameterSize:"3b",fileSize:"1.9GB "},{parameterSize:"7b",fileSize:"4.7GB"},{parameterSize:"14b",fileSize:"9.0GB"},{parameterSize:"32b",fileSize:"20GB"},{parameterSize:"72b",fileSize:"47GB"}]},{displayName:"Mistral",installName:"mistral",tags:[{parameterSize:"7b",fileSize:"4.1GB"}]},{displayName:"Phi-4",installName:"phi4",tags:[{parameterSize:"14b",fileSize:"9.1GB"}]},{displayName:"Qwen 2.5 Coder",installName:"qwen2.5-coder",tags:[{parameterSize:"0.5b",fileSize:"531MB"},{parameterSize:"1.5b",fileSize:"986MB"},{parameterSize:"3b",fileSize:"1.9GB"},{parameterSize:"7b",fileSize:"4.7GB"},{parameterSize:"14b",fileSize:"9.0GB"},{parameterSize:"32b",fileSize:"20GB"}]}],kt=async()=>{if(window.ipcRenderer)return await window.ipcRenderer?.invoke(ke.EXIT_APP)},Tt=async l=>{if(window.ipcRenderer)return await window.ipcRenderer?.invoke(ke.KILL_PROCESSES,l)},Et=["B","kB","MB","GB","TB","PB","EB","ZB","YB"],Ct=["B","KiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"],Lt=["b","kbit","Mbit","Gbit","Tbit","Pbit","Ebit","Zbit","Ybit"],xt=["b","kibit","Mibit","Gibit","Tibit","Pibit","Eibit","Zibit","Yibit"],Ie=(l,e,n)=>{let i=l;return typeof e=="string"||Array.isArray(e)?i=l.toLocaleString(e,n):(e===!0||n!==void 0)&&(i=l.toLocaleString(void 0,n)),i};function Mt(l,e){if(!Number.isFinite(l))throw new TypeError(`Expected a finite number, got ${typeof l}: ${l}`);e={bits:!1,binary:!1,space:!0,...e};const n=e.bits?e.binary?xt:Lt:e.binary?Ct:Et,i=e.space?" ":"";if(e.signed&&l===0)return` 0${i}${n[0]}`;const o=l<0,a=o?"-":e.signed?"+":"";o&&(l=-l);let s;if(e.minimumFractionDigits!==void 0&&(s={minimumFractionDigits:e.minimumFractionDigits}),e.maximumFractionDigits!==void 0&&(s={maximumFractionDigits:e.maximumFractionDigits,...s}),l<1){const g=Ie(l,e.locale,s);return a+g+i+n[0]}const t=Math.min(Math.floor(e.binary?Math.log(l)/Math.log(1024):Math.log10(l)/3),n.length-1);l/=(e.binary?1024:1e3)**t,s||(l=l.toPrecision(3));const f=Ie(Number(l),e.locale,s),S=n[t];return a+f+i+S}class W{static appIsOllama(e){return e==="ollama"}static async getModelFileSize(e,n){if(this.appIsOllama(e)&&n){const i=n[De];if(i){const o=await et(i);return Mt(o)}}return""}static async getModelsDir(e,n){return this.appIsOllama(e)&&n?n[De]:""}static genModelDownloadCommand(e,n){return this.appIsOllama(e)&&n?`ollama pull ${n}`:""}static async mergeModelsList(e,n){if(e){const i=await tt(e);console.log("installedModelList",i),i.forEach(o=>{const[a,s]=o.name.split(":"),t=n.find(f=>f.installName===a);if(t){const f=t.tags.find(S=>S.parameterSize===s);f?f.installed=!0:t.tags.push({parameterSize:s,fileSize:o.size||"",installed:!0})}else n.push({displayName:a,installName:a,tags:[{parameterSize:s,fileSize:o.size||"",installed:!0}]})})}return n}static killAppProcessed(e){this.appIsOllama(e)&&Tt(["ollama.exe","ollama app.exe"])}static needPreStartApp(e){return!!this.appIsOllama(e)}}class ee{static async getAppSettings(){const e=await this.getOSEnvObj();return{modelsDir:e.OLLAMA_MODELS,externalAccessHost:e.OLLAMA_HOST}}static async getOSEnvObj(){return await nt(Dt.DISPLAY_ENV)}static async getAccessHosts(e){const n="11434",i=[`http://127.0.0.1:${n}`];if(!(!e||e==="127.0.0.1")){const o=e.split(":"),a=o[0];let s=[a];const t=o[1]||n;a==="0.0.0.0"&&(s=await at()),s&&s.length>0&&s.forEach(f=>{i.push(`http://${f}:${t}`)})}return i}static async saveAppSettings(e,n){e.modelsDir===n&&(e.modelsDir="");const i={OLLAMA_MODELS:e.modelsDir,OLLAMA_HOST:e.externalAccessHost};return await st(i)}static getDownloadableModels(){return It}}const le=Me("runningInstance",{state:()=>({runningInstances:[],appSettingsSaved:!1,terminals:[],currentTerminalTab:""}),actions:{addRunningInstance(l){this.runningInstances.find(n=>n.id===l.id)||this.runningInstances.push(l)},removeRunningInstance(l){const e=this.runningInstances.findIndex(n=>n.id===l.id);e!=-1&&this.runningInstances.splice(e,1)},resetAppSettingsSavedStatus(){this.appSettingsSaved=!1},onAppSettingsSaved(){this.appSettingsSaved=!0},initTerminal(l){this.terminals=[l],this.currentTerminalTab=l.tabName},addTerminal(l,e,n){this.terminals.find(o=>o.tabName===l)||this.terminals.push({text:e,tabName:l,initCommand:n,closable:!0,commandExecuteEndKeywords:["digest","writing manifest","success"]}),this.currentTerminalTab=l},removeTerminal(l,e){this.terminals.splice(e,1)}}});class X{static isWindows(){const e=navigator.userAgentData;return e&&e.platform?e.platform==="Windows":navigator.userAgent?/Win(dows )?NT/.test(navigator.userAgent):!1}static isMacOS(){const e=navigator.userAgentData;return e&&e.platform?e.platform==="macOS"||e.platform==="MacOS":navigator.userAgent?/Macintosh|Mac OS X/i.test(navigator.userAgent):!1}}const Nt={style:{"font-size":"12px"}},zt={style:{"font-size":"12px"}},Rt=Z({__name:"app-settings-btn",props:{installedInstance:{}},setup(l){const{t:e}=ue(),n=D(!1),i=D(!1),o=D(!1),a=D(!1),s=D(""),t=le(),f=Ve("showToastMessage"),S=D({}),g=D(!0),r=l;H(()=>r.installedInstance,()=>{u()});const u=()=>{B()?n.value=!0:n.value=!1};Q(()=>{u()});const A=async()=>{i.value=!0,await R(),await G()},N=()=>{i.value=!1},R=async()=>{const c=await it();s.value=c+"/.ollama/models"},x=async()=>{if(!o.value||!S)return;if(s.value===""){const E=e("AppSettingDialog.DataNotValid");f&&f(E,"error");return}a.value=!0;const c=Object.assign({},S.value),k=await ee.saveAppSettings(c,s.value);console.log("save result ",k);const p=e("Common.saveSuccess");f&&f(p,"success"),a.value=!1,t.onAppSettingsSaved(),setTimeout(()=>{t.resetAppSettingsSavedStatus()},100),N(),X.isWindows()&&(W.killAppProcessed(r.installedInstance?.installName),setTimeout(()=>{kt()},1500))},z=c=>!!c||e("Common.fieldRequired"),v=async()=>{const c=await lt(S.value.modelsDir,!0);c&&c.path&&(S.value.modelsDir=c.path,console.log("dirInfo",c),g.value=ot.checkModelsDirValid(c,["blobs"]),console.log("dirValid.value",g.value))},b=[z,()=>g.value||e("AppSettingDialog.ModelsDirNotValid")],_=/^(\d{1,3}\.){3}\d{1,3}(:\d{1,5})?$/,C=[c=>c===""?!0:_.test(c)||e("AppSettingDialog.HostNotValid")],$=async()=>{S.value.modelsDir=s.value},U=Te(()=>{if(B())return e("AppSettingDialog.OllamaModelsDirInfoIconTip")}),G=async()=>{if(B()){const c=await ee.getAppSettings();console.log("getOSEnvForCurrentApp",c),S.value=Object.assign({},c),c.modelsDir===""&&(console.log("getOSEnvForCurrentApp",c),S.value.modelsDir=s.value)}},B=()=>W.appIsOllama(r.installedInstance?.installName),K=()=>{let c=e("AppSettingDialog.ModelsDirTip");return X.isWindows()?c+=e("AppSettingDialog.ModelsDirTipExtraWindows"):c+=e("AppSettingDialog.ModelsDirTipExtraMac"),c},I=()=>{let c=e("AppSettingDialog.ServerHostTip");return X.isWindows()?c+=e("AppSettingDialog.ServerHostTipExtraWindows"):c+=e("AppSettingDialog.ServerHostTipExtraMac"),c};return(c,k)=>(y(),j(Y,null,[m(n)?(y(),L(O,{key:0,"prepend-icon":"mdi-cog",stacked:"",onClick:A},{default:d(()=>[T(w(c.$t("AppRunningWindow.Settings")),1)]),_:1})):V("",!0),h(Ne,{modelValue:m(i),"onUpdate:modelValue":k[5]||(k[5]=p=>ae(i)?i.value=p:null),"min-width":"400","max-width":"800"},{default:d(()=>[c.installedInstance?(y(),L(ze,{key:0,class:"mx-auto px-0 py-0 window-no-drag",width:"100%",title:c.$t("AppSettingDialog.Title")+c.installedInstance.name},{append:d(()=>[h(O,{icon:"mdi-close",class:"ms-auto",size:"compact",text:"Ok",elevation:"0",onClick:k[0]||(k[0]=p=>i.value=!1)})]),default:d(()=>[m(S)?(y(),L(Re,{key:0,class:"pt-0 pb-3 px-6",modelValue:m(o),"onUpdate:modelValue":k[4]||(k[4]=p=>ae(o)?o.value=p:null),onSubmit:Ee(x,["prevent"])},{default:d(()=>[h(me,{modelValue:m(S).modelsDir,"onUpdate:modelValue":k[1]||(k[1]=p=>m(S).modelsDir=p),density:"comfortable",readonly:m(a),rules:b,label:c.$t("AppSettingDialog.ModelsDirLabel")},{append:d(()=>[h(se,{location:"bottom"},{activator:d(({props:p})=>[h(Ce,Le(p,{icon:"mdi-information-slab-circle-outline"}),null,16)]),default:d(()=>[F("pre",null,w(m(U)),1)]),_:1}),h(O,{class:"ml-1",onClick:v},{default:d(()=>[T(w(c.$t("AppSettingDialog.Browse")),1)]),_:1}),h(O,{class:"ml-1",onClick:$},{default:d(()=>[T(w(c.$t("AppSettingDialog.UseDefaultValue")),1)]),_:1})]),_:1},8,["modelValue","readonly","label"]),h(fe,{class:"pt-0"},{default:d(()=>[F("pre",Nt,w(K()),1)]),_:1}),h(me,{modelValue:m(S).externalAccessHost,"onUpdate:modelValue":k[2]||(k[2]=p=>m(S).externalAccessHost=p),density:"comfortable",readonly:m(a),rules:C,label:c.$t("AppSettingDialog.ServerHostLabel")},null,8,["modelValue","readonly","label"]),h(fe,{class:"pt-0"},{default:d(()=>[F("pre",zt,w(I()),1)]),_:1}),h(Oe,{class:"text-center justify-center"},{default:d(()=>[h(O,{variant:"outlined",onClick:k[3]||(k[3]=p=>i.value=!1)},{default:d(()=>[T(w(c.$t("AppSettingDialog.close")),1)]),_:1}),h(O,{color:"primary",variant:"flat",type:"submit",loading:m(a)},{default:d(()=>[T(w(c.$t("AppSettingDialog.saveConfig")),1)]),_:1},8,["loading"])]),_:1})]),_:1},8,["modelValue"])):V("",!0)]),_:1},8,["title"])):V("",!0)]),_:1},8,["modelValue"])],64))}}),Ot=Z({__name:"app-env-row",props:{installedInstance:{},appEnv:{}},setup(l){const e=D(null);return Q(async()=>{e.value=await Be()}),(n,i)=>(y(),L(ie,{class:"my-1 py-1 mx-3"},{default:d(()=>[T(w(n.$t("AppRunningWindow.EnvVars"))+": ",1),(y(!0),j(Y,null,J(m(e),(o,a)=>(y(),L(q,{variant:"tonal",size:"x-small",style:{"min-width":"50px","max-width":"120px","margin-left":"4px"},key:a},{default:d(()=>[T(w(a)+" ",1),h(se,{activator:"parent",location:"bottom"},{default:d(()=>[T(w(o),1)]),_:2},1024)]),_:2},1024))),128)),(y(!0),j(Y,null,J(n.appEnv,(o,a)=>(y(),L(q,{variant:"tonal",size:"x-small",color:"orange-darken-4",style:{"min-width":"50px","max-width":"120px","margin-left":"4px"},key:a},{default:d(()=>[T(w(a)+" ",1),h(se,{activator:"parent",location:"bottom"},{default:d(()=>[T(w(o),1)]),_:2},1024)]),_:2},1024))),128))]),_:1}))}}),Vt=["href"],Bt=Z({__name:"app-access-row",props:{lmAppData:{},installedInstance:{},appEnv:{}},setup(l){const e=l,n=D([]),i=D(!1),o=async()=>{if(e.lmAppData?.accessInfo){const a=e.lmAppData.accessInfo,{accessType:s}=a;if(!s)return!1;if(s==="browser")return n.value.push(e.lmAppData.accessInfo?.webUrl||""),!0;if(s==="exec"&&W.appIsOllama(e.installedInstance?.installName)){if(e.appEnv){const t=e.appEnv[yt];n.value=await ee.getAccessHosts(t)}return!0}}return!1};return Q(async()=>{i.value=await o()}),H(()=>e.appEnv,async()=>{i.value=await o()}),(a,s)=>a.lmAppData&&m(i)?(y(),L(ie,{key:0,class:"my-1 py-1 mx-3"},{default:d(()=>[T(w(a.$t("AppRunningWindow.Access"))+": ",1),m(n)&&m(n).length>0?(y(!0),j(Y,{key:0},J(m(n),t=>(y(),j("a",{class:"mx-2",key:t,href:t,target:"_blank"},w(t),9,Vt))),128)):V("",!0)]),_:1})):V("",!0)}}),$t=Z({__name:"model-download-row",props:{lmAppData:{},installedInstance:{},appEnv:{}},setup(l){const e=le(),n=D([]),i=D([]),o=D(!1),a=D(null),s=D(null),t=D(null),f=D(!1),{t:S}=ue(),g=l,r=async()=>{const v=await W.getModelsDir(g.installedInstance?.installName,g.appEnv);Pe(v)};Q(async()=>{u(),R(),await x()}),H(()=>g.lmAppData,()=>{u()}),H(()=>g.installedInstance,()=>{R(),x()}),H(()=>g.appEnv,()=>{R(),x()});const u=()=>{o.value=W.appIsOllama(g.lmAppData?.installName)};H(a,()=>{N()}),H(s,v=>{A(v)});const A=v=>{const b=i.value.find(_=>_.parameterSize===v);b&&(b.installed===void 0?f.value=!0:f.value=!b.installed)},N=()=>{const v=a.value,_=n.value.find(C=>C.installName===v)?.tags||[];if(i.value=_,_.length>0){const C=_[0].parameterSize;s.value=C,A(C)}},R=async()=>{t.value=await W.getModelFileSize(g.installedInstance?.installName,g.appEnv)},x=async()=>{const v=g.installedInstance?.installName;if(v&&o.value){const b=ee.getDownloadableModels(),_=await W.mergeModelsList(v,b);if(n.value=_,n.value&&n.value.length>0){const C=n.value[0];a.value=C.installName}}},z=async()=>{const v=`${a.value}:${s.value}`,b=W.genModelDownloadCommand(g.installedInstance?.installName,v),_=S("AppRunningWindow.ModelDownloadBtnLabel")+" "+v;b&&a.value&&e.addTerminal(v,_,b)};return(v,b)=>v.lmAppData&&m(o)?(y(),L(ie,{key:0,class:"my-0 py-0 mx-3 d-flex flex-row",style:{gap:"0.5rem","align-items":"center"}},{default:d(()=>[F("div",null,w(v.$t("AppRunningWindow.ModelDownload"))+": ",1),h(ge,{class:"flex-1",items:m(n),"item-title":"displayName","item-value":"installName",modelValue:m(a),"onUpdate:modelValue":b[0]||(b[0]=_=>ae(a)?a.value=_:null),density:"compact","hide-details":"",label:v.$t("AppRunningWindow.ModelName")},null,8,["items","modelValue","label"]),h(ge,{class:"flex-1",items:m(i),"item-title":"parameterSize","item-value":"parameterSize",modelValue:m(s),"onUpdate:modelValue":b[1]||(b[1]=_=>ae(s)?s.value=_:null),density:"compact","hide-details":"",label:v.$t("AppRunningWindow.ParameterSize")},{selection:d(({item:_})=>[T(w(_.title)+" ",1),h(q,{density:"compact",class:"mx-1",variant:"flat",color:"yellow-darken-2"},{default:d(()=>[T(w(_.raw.fileSize),1)]),_:2},1024),_.raw.installed?(y(),L(q,{key:0,density:"compact",variant:"flat",color:"green"},{default:d(()=>[F("span",null,w(v.$t("AppRunningWindow.ModelDownloaded")),1)]),_:1})):(y(),L(q,{key:1,density:"compact"},{default:d(()=>[F("span",null,w(v.$t("AppRunningWindow.ModelNotDownloaded")),1)]),_:1}))]),item:d(({props:_,item:C})=>[h($e,Le(_,{density:"compact"}),{title:d(()=>[T(w(C.title)+" ",1),h(q,{density:"compact",class:"mx-1",variant:"flat",color:"yellow-darken-2"},{default:d(()=>[T(w(C.raw.fileSize),1)]),_:2},1024),C.raw.installed?(y(),L(q,{key:0,density:"compact",variant:"flat",color:"green"},{default:d(()=>[F("span",null,w(v.$t("AppRunningWindow.ModelDownloaded")),1)]),_:1})):(y(),L(q,{key:1,density:"compact"},{default:d(()=>[F("span",null,w(v.$t("AppRunningWindow.ModelNotDownloaded")),1)]),_:1}))]),_:2},1040)]),_:1},8,["items","modelValue","label"]),m(f)?(y(),L(O,{key:0,"prepend-icon":"mdi-download-outline",onClick:z,color:"green-lighten-5"},{default:d(()=>[T(w(v.$t("AppRunningWindow.ModelDownloadBtnLabel")),1)]),_:1})):V("",!0),h(O,{"prepend-icon":"mdi-folder-file-outline",color:"amber-lighten-5",onClick:r},{default:d(()=>[T(w(m(t))+" ",1),h(se,{activator:"parent",location:"top"},{default:d(()=>[T(w(v.$t("AppRunningWindow.StorageBtnTip")),1)]),_:1})]),_:1})]),_:1})):V("",!0)}}),Pt=Z({__name:"app-env-and-access",props:{installedInstance:{},lmAppData:{}},emits:["appEnvSavedAndUpdated"],setup(l,{expose:e,emit:n}){const i=l,o=le(),a=D({}),s=n;Q(async()=>{t()});const t=async()=>{const f=i.installedInstance?.installName;W.appIsOllama(f)&&(a.value=await ee.getOSEnvObj()||{})};return e({updateAppEnvData:t}),H(()=>i.installedInstance,()=>{t()}),H(()=>o.appSettingsSaved,async f=>{f&&(a.value=null,await t(),s("appEnvSavedAndUpdated",a.value))}),(f,S)=>m(a)&&f.installedInstance?(y(),j(Y,{key:0},[h(Bt,{appEnv:m(a),lmAppData:f.lmAppData,installedInstance:f.installedInstance},null,8,["appEnv","lmAppData","installedInstance"]),h(Ot,{appEnv:m(a),installedInstance:f.installedInstance},null,8,["appEnv","installedInstance"]),h($t,{appEnv:m(a),installedInstance:f.installedInstance,lmAppData:f.lmAppData},null,8,["appEnv","installedInstance","lmAppData"])],64)):V("",!0)}}),qt=Z({__name:"AppRunningWindow",setup(l){const e=We(),n=Qe(),i=D(null),o=D(),a=D(),s=D(null),t=D(!1),f=D(!1),S=D("--"),{t:g}=ue(),r=le(),u=Te(()=>!(t.value&&!n.currentLmApp.runtimeUpdateAllowed));Q(async()=>{A();const p=e.params.id,E=await Je(p);s.value=E;const M=E.appId;await n.fetchApp(M),i.value=n.currentLmApp,window.ipcRenderer?.on(oe.STOP_AI_RUNNING_INSTANCE,(te,...Wt)=>{_(),C()}),B();const P=i?.value.name;document.title=P,I()});const A=()=>{const p={icon:"mdi-application-brackets-outline",text:g("AppRunningWindow.MainProcessTab"),tabName:"main-process",closable:!1,commandExecuteEndKeywords:["lmd start script end."]};r.initTerminal(p)},N=()=>{_(),R()},R=async()=>{if(t.value=!0,i.value){const p=await bt(i.value);b(p),window.ipcRenderer?.send(oe.RUNNING_STATUS_CHANGE,!0)}},x=async()=>{if(i.value){const p=await _t(i.value);b(p)}},z=()=>{$()},v=()=>Array.isArray(o.value)?o.value[0]:o.value,b=p=>{const E=v();console.log("terminalComponent",E,p),E?.runCommand(p)},_=()=>{t.value=!1,G(),v()?.runStopCommand(),window.ipcRenderer.send(oe.RUNNING_STATUS_CHANGE,!1)},C=()=>{v()?.exitTerminal()},$=async()=>{if(i.value){const p=await At(i.value);b(p)}},U=(p,E)=>{r.removeTerminal(p,E)},G=()=>{S.value="--"},B=()=>{e.query.script===rt.INSTALL&&$()},K=p=>{if(X.isWindows())return;_();const E=wt(p);v()?.runCommand(E),R()},I=async()=>{if(W.needPreStartApp(s.value?.installName)){if(R(),X.isMacOS()){setTimeout(()=>{c()},1e3);return}return}c()},c=()=>{f.value=!0},k=()=>{a.value?.updateAppEnvData()};return(p,E)=>(y(),L(Ke,null,{default:d(()=>[h(Fe,{elevation:"1",class:"px-2"},{prepend:d(()=>[h(he,{src:m(i)?.icon,width:"60",height:"60"},null,8,["src"]),h(Ue,null,{default:d(()=>[T(w(m(i)?.name),1)]),_:1}),m(s)?.version&&m(s)?.version!=="--"?(y(),L(Ge,{key:0},{default:d(()=>[T(w(p.$t("AppRunningWindow.Version"))+" "+w(m(s)?.version),1)]),_:1})):V("",!0)]),append:d(()=>[ve(h(O,{stacked:"",onClick:z},{prepend:d(()=>[h(he,{src:"./images/icons/lmd-logo.png",size:"20",width:"25",height:"25"})]),default:d(()=>[T(" "+w(p.$t("AppRunningWindow.Install")),1)]),_:1},512),[[Se,m(u)]]),ve(h(O,{"prepend-icon":"mdi-autorenew",stacked:"",onClick:x},{default:d(()=>[T(w(p.$t("AppRunningWindow.Update")),1)]),_:1},512),[[Se,m(u)]]),m(t)?(y(),L(O,{key:0,stacked:"","prepend-icon":"mdi-stop",onClick:E[0]||(E[0]=M=>_())},{default:d(()=>[T(w(p.$t("AppRunningWindow.Stop")),1)]),_:1})):(y(),L(O,{key:1,stacked:"","prepend-icon":"mdi-play",onClick:E[1]||(E[1]=M=>R())},{default:d(()=>[T(w(p.$t("AppRunningWindow.Start")),1)]),_:1})),m(t)?(y(),L(O,{key:2,stacked:"","prepend-icon":"mdi-refresh-circle",onClick:E[2]||(E[2]=M=>N())},{default:d(()=>[T(w(p.$t("AppRunningWindow.Restart")),1)]),_:1})):V("",!0),h(Rt,{installedInstance:m(s)},null,8,["installedInstance"])]),_:1}),h(qe,{class:"mx-1 running-window-main mb-3"},{default:d(()=>[h(ie,{fluid:"",class:"d-flex flex-column",style:{height:"100%"}},{default:d(()=>[m(s)&&m(i)&&m(f)?(y(),L(Pt,{key:0,ref_key:"appEnvAndAccessComponent",ref:a,onAppEnvSavedAndUpdated:K,lmAppData:m(i),installedInstance:m(s)},null,8,["lmAppData","installedInstance"])):V("",!0),h(He,{class:"mx-2",modelValue:m(r).currentTerminalTab,"onUpdate:modelValue":E[3]||(E[3]=M=>m(r).currentTerminalTab=M),"align-tabs":"start",color:"primary"},{default:d(()=>[(y(!0),j(Y,null,J(m(r).terminals,(M,P)=>(y(),L(Ye,{value:M.tabName,key:M.tabName},{append:d(()=>[M.closable?(y(),L(Ce,{key:0,icon:"mdi-close-circle-outline",onClick:Ee(te=>U(M,P),["stop"])},null,8,["onClick"])):V("",!0)]),default:d(()=>[T(" "+w(M.text),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"]),h(je,{modelValue:m(r).currentTerminalTab,"onUpdate:modelValue":E[4]||(E[4]=M=>m(r).currentTerminalTab=M),class:"mx-2 my-0 px-0 pt-0 mb-0",style:{flex:"1","background-color":"black"}},{default:d(()=>[(y(!0),j(Y,null,J(m(r).terminals,(M,P)=>(y(),L(Ze,{style:{flex:"1"},key:M.text,value:M.tabName,eager:""},{default:d(()=>[M.tabName==="main-process"?(y(),L(ye,{key:0,onExecuteEnd:c,"command-execute-end-keywords":M.commandExecuteEndKeywords,ref_for:!0,ref_key:"generalTerminal",ref:o,socketURI:"ws://localhost:19312"},null,8,["command-execute-end-keywords"])):(y(),L(ye,{key:1,onExecuteEnd:k,"command-execute-end-keywords":M.commandExecuteEndKeywords,initCommand:M.initCommand,socketURI:"ws://localhost:19312"},null,8,["command-execute-end-keywords","initCommand"]))]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}))}});export{qt as default};
