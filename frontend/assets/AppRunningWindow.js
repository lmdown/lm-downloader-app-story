import{e,b as a,G as t,R as n,a6 as l,a3 as s,a5 as i,o,c as r,a2 as d,a8 as p,j as c,u as m,a4 as u,Q as v,V as f,k as g,U as S,m as A,F as w,d as y,a7 as _,aa as I,y as b,A as D}from"./vue.js";import{u as h}from"./lmapp.js";import{r as k,a as x,b as z,g as E}from"./xterm.js";import{r as T}from"./debounce.js";import{g as N,I as R,d as M,o as L}from"./index.js";import{a as C,b as O,c as $,d as B,e as V,g as W,s as G,D as U,I as P}from"./common-util.js";import{a as j}from"./install-instance.js";import{A as H}from"./AppScriptType.js";import{p as K}from"./pretty-bytes.js";import{d as F}from"./pinia.js";import{C as q,h as Q,u as X,w as J,I as Y,J as Z,d as ee,F as ae,z as te,K as ne,D as le,L as se,M as ie,a as oe,b as re,A as de,B as pe,G as ce,N as me,O as ue,f as ve,P as fe,Q as ge,R as Se}from"./vuetify.js";import"./vuei18n.js";import"./lmd-locales.js";var Ae=k(),we=x(),ye=z();const _e=E(T()),Ie=e({__name:"index",props:{socketURI:{},initCommand:{},commandExecuteEndKeywords:{}},emits:["executeEnd"],setup(e,{expose:o,emit:r}){const d=r,p=a([]),c=a(!1),m=e,u=a(null),v=a(null),f=a(null),g=a(null);let S;t((()=>{_(),y()})),n((()=>{u.value?.close(),v.value?.dispose(),S&&g.value&&(S.unobserve(g.value),S.disconnect())}));const A=e=>{console.log("runCommand",e),console.log("runCommand socket.value",u.value),u.value?.send(e+"\n")};o({runCommand:A,runStopCommand:()=>{A("")},exitTerminal:()=>{A("exit")}});const w=_e((e=>{for(const a of e)z(a.contentRect.width,a.contentRect.height)}),50),y=()=>{f.value&&(S=new ResizeObserver(w),S.observe(f.value))},_=()=>{u.value=new WebSocket(m.socketURI),D(),b(),h(),I()},I=()=>{if(m.commandExecuteEndKeywords&&u.value){const e=m.commandExecuteEndKeywords;u.value.onmessage=a=>{const t=a.data;e.forEach((e=>{t.includes(e)&&!p.value.includes(e)&&p.value.push(e)})),p.value.length===e.length&&(c.value||(d("executeEnd"),c.value=!0))}}},b=()=>{u.value&&(u.value.onopen=()=>{(()=>{if(!g.value)return;if(!u.value)return;const e=new window.Terminal({fontSize:14,cursorBlink:!0}),a=new we.AttachAddon(u.value),t=new Ae.FitAddon,n=new ye.WebLinksAddon(((e,a)=>{const t=document.createElement("a");t.setAttribute("href",a),t.setAttribute("target","_blank"),t.setAttribute("id","lmdTempLink");const n=document.getElementById("lmdTempLink");n&&document.body.removeChild(n),document.body.appendChild(t),t.click()}));e.loadAddon(a),e.loadAddon(t),e.loadAddon(n),e.open(g.value),t.fit(),e.focus(),v.value=e})(),m.initCommand&&A(m.initCommand)})},D=()=>{u.value&&(u.value.onclose=e=>{console.log("close socket",e)})},h=()=>{u.value&&(u.value.onerror=e=>{console.log("socket 链接失败",e)})},k=a(80),x=a(30),z=(e,a)=>{const t=Math.floor(e/8.5),n=Math.round(a/16);if(console.log("cols",e,t),console.log("rows",a,n),0!==n&&0!==t&&(k.value!==t||x.value!==n)){k.value=t,x.value=n,v.value?.resize(t,n);const e=`lmd_action:resize:${t},${n}`;u.value?.send(e)}};return(e,a)=>(s(),l("div",{ref_key:"terminalOutContainer",ref:f,class:"mb-2",style:{height:"100%",width:"100%"}},[i("div",{ref_key:"terminalContainer",ref:g,class:"terminal",style:{height:"300px",width:"100%"}},null,512)],512))}}),be="OLLAMA_MODELS",De=["OLLAMA_MODELS","OLLAMA_HOST"],he=[{displayName:"Deepseek-R1",installName:"deepseek-r1",tags:[{parameterSize:"1.5b",fileSize:"1.1GB"},{parameterSize:"7b",fileSize:"4.7GB"},{parameterSize:"8b",fileSize:"4.9GB"},{parameterSize:"14b",fileSize:"9.0GB"},{parameterSize:"32b",fileSize:"20GB"},{parameterSize:"70b",fileSize:"43GB"},{parameterSize:"671b",fileSize:"404GB"}]},{displayName:"Llama 3.1",installName:"llama3.1",tags:[{parameterSize:"8b",fileSize:"4.9GB"},{parameterSize:"70b",fileSize:"43GB"},{parameterSize:"405b",fileSize:"243GB"}]},{displayName:"Qwen 2.5",installName:"qwen2.5",tags:[{parameterSize:"0.5b",fileSize:"398MB"},{parameterSize:"1.5b",fileSize:"986MB"},{parameterSize:"3b",fileSize:"1.9GB "},{parameterSize:"7b",fileSize:"4.7GB"},{parameterSize:"14b",fileSize:"9.0GB"},{parameterSize:"32b",fileSize:"20GB"},{parameterSize:"72b",fileSize:"47GB"}]},{displayName:"Mistral",installName:"mistral",tags:[{parameterSize:"7b",fileSize:"4.1GB"}]},{displayName:"Phi-4",installName:"phi4",tags:[{parameterSize:"14b",fileSize:"9.1GB"}]},{displayName:"Qwen 2.5 Coder",installName:"qwen2.5-coder",tags:[{parameterSize:"0.5b",fileSize:"531MB"},{parameterSize:"1.5b",fileSize:"986MB"},{parameterSize:"3b",fileSize:"1.9GB"},{parameterSize:"7b",fileSize:"4.7GB"},{parameterSize:"14b",fileSize:"9.0GB"},{parameterSize:"32b",fileSize:"20GB"}]}];class ke{static appIsOllama(e){return"ollama"===e}static async getModelFileSize(e,a){if(this.appIsOllama(e)&&a){const e=a[be];if(e){const a=await C(e);return K(a)}}return""}static async getModelsDir(e,a){return this.appIsOllama(e)&&a?a[be]:""}static genModelDownloadCommand(e,a){return this.appIsOllama(e)&&a?`ollama pull ${a}`:""}static async mergeModelsList(e,a){if(e){const t=await O(e);console.log("installedModelList",t),t.forEach((e=>{const[t,n]=e.name.split(":"),l=a.find((e=>e.installName===t));if(l){const a=l.tags.find((e=>e.parameterSize===n));a?a.installed=!0:l.tags.push({parameterSize:n,fileSize:e.size||"",installed:!0})}else a.push({displayName:t,installName:t,tags:[{parameterSize:n,fileSize:e.size||"",installed:!0}]})}))}return a}static killAppProcessed(e){if(this.appIsOllama(e)){(async e=>{if(window.ipcRenderer)await(window.ipcRenderer?.invoke(R.KILL_PROCESSES,e))})(["ollama.exe","ollama app.exe"])}}static needPreStartApp(e){return!!this.appIsOllama(e)}}class xe{static async getAppSettings(){const e=await this.getOSEnvObj();return{modelsDir:e.OLLAMA_MODELS,externalAccessHost:e.OLLAMA_HOST}}static async getOSEnvObj(){return await $(De)}static async getAccessHosts(e){const a="11434",t=[`http://127.0.0.1:${a}`];if(e&&"127.0.0.1"!==e){const n=e.split(":"),l=n[0];let s=[l];const i=n[1]||a;"0.0.0.0"===l&&(s=await B()),s&&s.length>0&&s.forEach((e=>{t.push(`http://${e}:${i}`)}))}else;return t}static async saveAppSettings(e,a){e.modelsDir===a&&(e.modelsDir="");const t={OLLAMA_MODELS:e.modelsDir,OLLAMA_HOST:e.externalAccessHost};return await V(t)}static getDownloadableModels(){return he}}const ze=F("runningInstance",{state:()=>({runningInstances:[],appSettingsSaved:!1,terminals:[],currentTerminalTab:""}),actions:{addRunningInstance(e){this.runningInstances.find((a=>a.id===e.id))||this.runningInstances.push(e)},removeRunningInstance(e){const a=this.runningInstances.findIndex((a=>a.id===e.id));-1!=a&&this.runningInstances.splice(a,1)},resetAppSettingsSavedStatus(){this.appSettingsSaved=!1},onAppSettingsSaved(){this.appSettingsSaved=!0},initTerminal(e){this.terminals=[e],this.currentTerminalTab=e.tabName},addTerminal(e,a,t){this.terminals.find((a=>a.tabName===e))||this.terminals.push({text:a,tabName:e,initCommand:t,closable:!0,commandExecuteEndKeywords:["digest","writing manifest","success"]}),this.currentTerminalTab=e},removeTerminal(e,a){this.terminals.splice(a,1)}}});class Ee{static isWindows(){const e=navigator.userAgentData;return e&&e.platform?"Windows"===e.platform:!!navigator.userAgent&&/Win(dows )?NT/.test(navigator.userAgent)}static isMacOS(){const e=navigator.userAgentData;return e&&e.platform?"macOS"===e.platform||"MacOS"===e.platform:!!navigator.userAgent&&/Macintosh|Mac OS X/i.test(navigator.userAgent)}}const Te={style:{"font-size":"12px"}},Ne={style:{"font-size":"12px"}},Re=e({__name:"app-settings-btn",props:{installedInstance:{}},setup(e){const{t:n}=q(),_=a(!1),I=a(!1),b=a(!1),D=a(!1),h=a(""),k=ze(),x=y("showToastMessage"),z=a({}),E=a(!0),T=e;o((()=>T.installedInstance),(()=>{N()}));const N=()=>{K()?_.value=!0:_.value=!1};t((()=>{N()}));const M=async()=>{I.value=!0,await L(),await H()},L=async()=>{const e=await W();h.value=e+"/.ollama/models"},C=async()=>{if(!b.value)return;if(!z)return;if(""===h.value){const e=n("AppSettingDialog.DataNotValid");return void(x&&x(e,"error"))}D.value=!0;const e=Object.assign({},z.value),a=await xe.saveAppSettings(e,h.value);console.log("save result ",a);const t=n("Common.saveSuccess");x&&x(t,"success"),D.value=!1,k.onAppSettingsSaved(),setTimeout((()=>{k.resetAppSettingsSavedStatus()}),100),I.value=!1,Ee.isWindows()&&(ke.killAppProcessed(T.installedInstance?.installName),setTimeout((()=>{(async()=>{if(window.ipcRenderer)await(window.ipcRenderer?.invoke(R.EXIT_APP))})()}),1500))},O=async()=>{const e=await G(z.value.modelsDir,!0);e&&e.path&&(z.value.modelsDir=e.path,console.log("dirInfo",e),E.value=U.checkModelsDirValid(e,["blobs"]),console.log("dirValid.value",E.value))},$=[e=>!!e||n("Common.fieldRequired"),()=>E.value||n("AppSettingDialog.ModelsDirNotValid")],B=/^(\d{1,3}\.){3}\d{1,3}(:\d{1,5})?$/,V=[e=>""===e||(B.test(e)||n("AppSettingDialog.HostNotValid"))],P=async()=>{z.value.modelsDir=h.value},j=r((()=>{if(K())return n("AppSettingDialog.OllamaModelsDirInfoIconTip")})),H=async()=>{if(K()){const e=await xe.getAppSettings();console.log("getOSEnvForCurrentApp",e),z.value=Object.assign({},e),""===e.modelsDir&&(console.log("getOSEnvForCurrentApp",e),z.value.modelsDir=h.value)}},K=()=>ke.appIsOllama(T.installedInstance?.installName),F=()=>{let e=n("AppSettingDialog.ModelsDirTip");return Ee.isWindows()?e+=n("AppSettingDialog.ModelsDirTipExtraWindows"):e+=n("AppSettingDialog.ModelsDirTipExtraMac"),e},le=()=>{let e=n("AppSettingDialog.ServerHostTip");return Ee.isWindows()?e+=n("AppSettingDialog.ServerHostTipExtraWindows"):e+=n("AppSettingDialog.ServerHostTipExtraMac"),e};return(e,a)=>(s(),l(w,null,[m(_)?(s(),d(Q,{key:0,"prepend-icon":"mdi-cog",stacked:"",onClick:M},{default:u((()=>[v(f(e.$t("AppRunningWindow.Settings")),1)])),_:1})):p("",!0),c(X,{modelValue:m(I),"onUpdate:modelValue":a[5]||(a[5]=e=>g(I)?I.value=e:null),"min-width":"400","max-width":"800"},{default:u((()=>[e.installedInstance?(s(),d(J,{key:0,class:"mx-auto px-0 py-0 window-no-drag",width:"100%",title:e.$t("AppSettingDialog.Title")+e.installedInstance.name},{append:u((()=>[c(Q,{icon:"mdi-close",class:"ms-auto",size:"compact",text:"Ok",elevation:"0",onClick:a[0]||(a[0]=e=>I.value=!1)})])),default:u((()=>[m(z)?(s(),d(Y,{key:0,class:"pt-0 pb-3 px-6",modelValue:m(b),"onUpdate:modelValue":a[4]||(a[4]=e=>g(b)?b.value=e:null),onSubmit:S(C,["prevent"])},{default:u((()=>[c(Z,{modelValue:m(z).modelsDir,"onUpdate:modelValue":a[1]||(a[1]=e=>m(z).modelsDir=e),density:"comfortable",readonly:m(D),rules:$,label:e.$t("AppSettingDialog.ModelsDirLabel")},{append:u((()=>[c(ee,{location:"bottom"},{activator:u((({props:e})=>[c(ae,A(e,{icon:"mdi-information-slab-circle-outline"}),null,16)])),default:u((()=>[i("pre",null,f(m(j)),1)])),_:1}),c(Q,{class:"ml-1",onClick:O},{default:u((()=>[v(f(e.$t("AppSettingDialog.Browse")),1)])),_:1}),c(Q,{class:"ml-1",onClick:P},{default:u((()=>[v(f(e.$t("AppSettingDialog.UseDefaultValue")),1)])),_:1})])),_:1},8,["modelValue","readonly","label"]),c(te,{class:"pt-0"},{default:u((()=>[i("pre",Te,f(F()),1)])),_:1}),c(Z,{modelValue:m(z).externalAccessHost,"onUpdate:modelValue":a[2]||(a[2]=e=>m(z).externalAccessHost=e),density:"comfortable",readonly:m(D),rules:V,label:e.$t("AppSettingDialog.ServerHostLabel")},null,8,["modelValue","readonly","label"]),c(te,{class:"pt-0"},{default:u((()=>[i("pre",Ne,f(le()),1)])),_:1}),c(ne,{class:"text-center justify-center"},{default:u((()=>[c(Q,{variant:"outlined",onClick:a[3]||(a[3]=e=>I.value=!1)},{default:u((()=>[v(f(e.$t("AppSettingDialog.close")),1)])),_:1}),c(Q,{color:"primary",variant:"flat",type:"submit",loading:m(D)},{default:u((()=>[v(f(e.$t("AppSettingDialog.saveConfig")),1)])),_:1},8,["loading"])])),_:1})])),_:1},8,["modelValue"])):p("",!0)])),_:1},8,["title"])):p("",!0)])),_:1},8,["modelValue"])],64))}}),Me=e({__name:"app-env-row",props:{installedInstance:{},appEnv:{}},setup(e){const n=a(null);return t((async()=>{n.value=await M()})),(e,a)=>(s(),d(le,{class:"my-1 py-1 mx-3"},{default:u((()=>[v(f(e.$t("AppRunningWindow.EnvVars"))+": ",1),(s(!0),l(w,null,_(m(n),((e,a)=>(s(),d(se,{variant:"tonal",size:"x-small",style:{"min-width":"50px","max-width":"120px","margin-left":"4px"},key:a},{default:u((()=>[v(f(a)+" ",1),c(ee,{activator:"parent",location:"bottom"},{default:u((()=>[v(f(e),1)])),_:2},1024)])),_:2},1024)))),128)),(s(!0),l(w,null,_(e.appEnv,((e,a)=>(s(),d(se,{variant:"tonal",size:"x-small",color:"orange-darken-4",style:{"min-width":"50px","max-width":"120px","margin-left":"4px"},key:a},{default:u((()=>[v(f(a)+" ",1),c(ee,{activator:"parent",location:"bottom"},{default:u((()=>[v(f(e),1)])),_:2},1024)])),_:2},1024)))),128))])),_:1}))}}),Le=["href"],Ce=e({__name:"app-access-row",props:{lmAppData:{},installedInstance:{},appEnv:{}},setup(e){const n=e,i=a([]),r=a(!1),c=async()=>{if(n.lmAppData?.accessInfo){const e=n.lmAppData.accessInfo,{accessType:a}=e;if(!a)return!1;if("browser"===a)return i.value.push(n.lmAppData.accessInfo?.webUrl||""),!0;if("exec"===a&&ke.appIsOllama(n.installedInstance?.installName)){if(n.appEnv){const e=n.appEnv.OLLAMA_HOST;i.value=await xe.getAccessHosts(e)}return!0}}return!1};return t((async()=>{r.value=await c()})),o((()=>n.appEnv),(async()=>{r.value=await c()})),(e,a)=>e.lmAppData&&m(r)?(s(),d(le,{key:0,class:"my-1 py-1 mx-3"},{default:u((()=>[v(f(e.$t("AppRunningWindow.Access"))+": ",1),m(i)&&m(i).length>0?(s(!0),l(w,{key:0},_(m(i),(e=>(s(),l("a",{class:"mx-2",key:e,href:e,target:"_blank"},f(e),9,Le)))),128)):p("",!0)])),_:1})):p("",!0)}}),Oe=e({__name:"model-download-row",props:{lmAppData:{},installedInstance:{},appEnv:{}},setup(e){const n=ze(),l=a([]),r=a([]),S=a(!1),w=a(null),y=a(null),_=a(null),I=a(!1),{t:b}=q(),D=e,h=async()=>{const e=await ke.getModelsDir(D.installedInstance?.installName,D.appEnv);L(e)};t((async()=>{k(),E(),await T()})),o((()=>D.lmAppData),(()=>{k()})),o((()=>D.installedInstance),(()=>{E(),T()})),o((()=>D.appEnv),(()=>{E(),T()}));const k=()=>{S.value=ke.appIsOllama(D.lmAppData?.installName)};o(w,(()=>{z()})),o(y,(e=>{x(e)}));const x=e=>{const a=r.value.find((a=>a.parameterSize===e));a&&(void 0===a.installed?I.value=!0:I.value=!a.installed)},z=()=>{const e=w.value,a=l.value.find((a=>a.installName===e)),t=a?.tags||[];if(r.value=t,t.length>0){const e=t[0].parameterSize;y.value=e,x(e)}},E=async()=>{_.value=await ke.getModelFileSize(D.installedInstance?.installName,D.appEnv)},T=async()=>{const e=D.installedInstance?.installName;if(e&&S.value){const a=xe.getDownloadableModels(),t=await ke.mergeModelsList(e,a);if(l.value=t,l.value&&l.value.length>0){const e=l.value[0];w.value=e.installName}}},N=async()=>{const e=`${w.value}:${y.value}`,a=ke.genModelDownloadCommand(D.installedInstance?.installName,e),t=b("AppRunningWindow.ModelDownloadBtnLabel")+" "+e;a&&w.value&&n.addTerminal(e,t,a)};return(e,a)=>e.lmAppData&&m(S)?(s(),d(le,{key:0,class:"my-0 py-0 mx-3 d-flex flex-row",style:{gap:"0.5rem","align-items":"center"}},{default:u((()=>[i("div",null,f(e.$t("AppRunningWindow.ModelDownload"))+": ",1),c(ie,{class:"flex-1",items:m(l),"item-title":"displayName","item-value":"installName",modelValue:m(w),"onUpdate:modelValue":a[0]||(a[0]=e=>g(w)?w.value=e:null),density:"compact","hide-details":"",label:e.$t("AppRunningWindow.ModelName")},null,8,["items","modelValue","label"]),c(ie,{class:"flex-1",items:m(r),"item-title":"parameterSize","item-value":"parameterSize",modelValue:m(y),"onUpdate:modelValue":a[1]||(a[1]=e=>g(y)?y.value=e:null),density:"compact","hide-details":"",label:e.$t("AppRunningWindow.ParameterSize")},{selection:u((({item:a})=>[v(f(a.title)+" ",1),c(se,{density:"compact",class:"mx-1",variant:"flat",color:"yellow-darken-2"},{default:u((()=>[v(f(a.raw.fileSize),1)])),_:2},1024),a.raw.installed?(s(),d(se,{key:0,density:"compact",variant:"flat",color:"green"},{default:u((()=>[i("span",null,f(e.$t("AppRunningWindow.ModelDownloaded")),1)])),_:1})):(s(),d(se,{key:1,density:"compact"},{default:u((()=>[i("span",null,f(e.$t("AppRunningWindow.ModelNotDownloaded")),1)])),_:1}))])),item:u((({props:a,item:t})=>[c(oe,A(a,{density:"compact"}),{title:u((()=>[v(f(t.title)+" ",1),c(se,{density:"compact",class:"mx-1",variant:"flat",color:"yellow-darken-2"},{default:u((()=>[v(f(t.raw.fileSize),1)])),_:2},1024),t.raw.installed?(s(),d(se,{key:0,density:"compact",variant:"flat",color:"green"},{default:u((()=>[i("span",null,f(e.$t("AppRunningWindow.ModelDownloaded")),1)])),_:1})):(s(),d(se,{key:1,density:"compact"},{default:u((()=>[i("span",null,f(e.$t("AppRunningWindow.ModelNotDownloaded")),1)])),_:1}))])),_:2},1040)])),_:1},8,["items","modelValue","label"]),m(I)?(s(),d(Q,{key:0,"prepend-icon":"mdi-download-outline",onClick:N,color:"green-lighten-5"},{default:u((()=>[v(f(e.$t("AppRunningWindow.ModelDownloadBtnLabel")),1)])),_:1})):p("",!0),c(Q,{"prepend-icon":"mdi-folder-file-outline",color:"amber-lighten-5",onClick:h},{default:u((()=>[v(f(m(_))+" ",1),c(ee,{activator:"parent",location:"top"},{default:u((()=>[v(f(e.$t("AppRunningWindow.StorageBtnTip")),1)])),_:1})])),_:1})])),_:1})):p("",!0)}}),$e=e({__name:"app-env-and-access",props:{installedInstance:{},lmAppData:{}},emits:["appEnvSavedAndUpdated"],setup(e,{expose:n,emit:i}){const r=e,d=ze(),u=a({}),v=i;t((async()=>{f()}));const f=async()=>{const e=r.installedInstance?.installName;ke.appIsOllama(e)&&(u.value=await xe.getOSEnvObj()||{})};return n({updateAppEnvData:f}),o((()=>r.installedInstance),(()=>{f()})),o((()=>d.appSettingsSaved),(async e=>{e&&(u.value=null,await f(),v("appEnvSavedAndUpdated",u.value))})),(e,a)=>m(u)&&e.installedInstance?(s(),l(w,{key:0},[c(Ce,{appEnv:m(u),lmAppData:e.lmAppData,installedInstance:e.installedInstance},null,8,["appEnv","lmAppData","installedInstance"]),c(Me,{appEnv:m(u),installedInstance:e.installedInstance},null,8,["appEnv","installedInstance"]),c(Oe,{appEnv:m(u),installedInstance:e.installedInstance,lmAppData:e.lmAppData},null,8,["appEnv","installedInstance","lmAppData"])],64)):p("",!0)}}),Be=e({__name:"AppRunningWindow",setup(e){const n=I(),i=h(),o=a(null),g=a(),A=a(),y=a(null),k=a(!1),x=a(!1),z=a("--"),{t:E}=q(),T=ze(),R=r((()=>!(k.value&&!i.currentLmApp.runtimeUpdateAllowed)));t((async()=>{M();const e=n.params.id,a=await j(e);y.value=a;const t=a.appId;await i.fetchApp(t),o.value=i.currentLmApp,window.ipcRenderer?.on(P.STOP_AI_RUNNING_INSTANCE,((e,...a)=>{V(),W()})),K();const l=o?.value.name;document.title=l,X()}));const M=()=>{const e={icon:"mdi-application-brackets-outline",text:E("AppRunningWindow.MainProcessTab"),tabName:"main-process",closable:!1,commandExecuteEndKeywords:["lmd start script end."]};T.initTerminal(e)},L=async()=>{if(k.value=!0,o.value){const e=await(async e=>{const a=e.installName;return`\nexport LMD_BASE_INSTALL_SCRIPT_DIR="${(await N()).LMD_SCRIPTS_DIR}/lmd-install-scripts"\nsh $LMD_BASE_INSTALL_SCRIPT_DIR/apps/${a}/start.sh`})(o.value);B(e),window.ipcRenderer?.send(P.RUNNING_STATUS_CHANGE,!0)}},C=async()=>{if(o.value){const e=await(async e=>{const a=e.installName;return`\nexport LMD_BASE_INSTALL_SCRIPT_DIR="${(await N()).LMD_SCRIPTS_DIR}/lmd-install-scripts"\nsh $LMD_BASE_INSTALL_SCRIPT_DIR/apps/${a}/update.sh\n`})(o.value);B(e)}},O=()=>{G()},$=()=>Array.isArray(g.value)?g.value[0]:g.value,B=e=>{const a=$();console.log("terminalComponent",a,e),a?.runCommand(e)},V=()=>{k.value=!1,U(),$()?.runStopCommand(),window.ipcRenderer.send(P.RUNNING_STATUS_CHANGE,!1)},W=()=>{$()?.exitTerminal()},G=async()=>{if(o.value){const e=await(async e=>{const a=e.installName;return`\nexport LMD_BASE_INSTALL_SCRIPT_DIR="${(await N()).LMD_SCRIPTS_DIR}/lmd-install-scripts"\ngit clone --depth=1 https://gitee.com/lmdown/lmd-install-scripts $LMD_BASE_INSTALL_SCRIPT_DIR\ncd $LMD_BASE_INSTALL_SCRIPT_DIR && git fetch origin master && git reset --hard origin/master\nsh $LMD_BASE_INSTALL_SCRIPT_DIR/apps/${a}/install.sh`})(o.value);B(e)}},U=()=>{z.value="--"},K=()=>{n.query.script===H.INSTALL&&G()},F=e=>{if(Ee.isWindows())return;V();const a=(e=>{let a="";if(e)for(const t in e)a+=`${t}=${e[t]}\n`;return a})(e);$()?.runCommand(a),L()},X=async()=>{if(ke.needPreStartApp(y.value?.installName))return L(),Ee.isMacOS()?void setTimeout((()=>{J()}),1e3):void 0;J()},J=()=>{x.value=!0},Y=()=>{A.value?.updateAppEnvData()};return(e,a)=>(s(),d(fe,null,{default:u((()=>[c(ce,{elevation:"1",class:"px-2"},{prepend:u((()=>[c(re,{src:m(o)?.icon,width:"60",height:"60"},null,8,["src"]),c(de,null,{default:u((()=>[v(f(m(o)?.name),1)])),_:1}),m(y)?.version&&"--"!==m(y)?.version?(s(),d(pe,{key:0},{default:u((()=>[v(f(e.$t("AppRunningWindow.Version"))+" "+f(m(y)?.version),1)])),_:1})):p("",!0)])),append:u((()=>[b(c(Q,{stacked:"",onClick:O},{prepend:u((()=>[c(re,{src:"./images/icons/lmd-logo.png",size:"20",width:"25",height:"25"})])),default:u((()=>[v(" "+f(e.$t("AppRunningWindow.Install")),1)])),_:1},512),[[D,m(R)]]),b(c(Q,{"prepend-icon":"mdi-autorenew",stacked:"",onClick:C},{default:u((()=>[v(f(e.$t("AppRunningWindow.Update")),1)])),_:1},512),[[D,m(R)]]),m(k)?(s(),d(Q,{key:0,stacked:"","prepend-icon":"mdi-stop",onClick:a[0]||(a[0]=e=>V())},{default:u((()=>[v(f(e.$t("AppRunningWindow.Stop")),1)])),_:1})):(s(),d(Q,{key:1,stacked:"","prepend-icon":"mdi-play",onClick:a[1]||(a[1]=e=>L())},{default:u((()=>[v(f(e.$t("AppRunningWindow.Start")),1)])),_:1})),m(k)?(s(),d(Q,{key:2,stacked:"","prepend-icon":"mdi-refresh-circle",onClick:a[2]||(a[2]=e=>(V(),void L()))},{default:u((()=>[v(f(e.$t("AppRunningWindow.Restart")),1)])),_:1})):p("",!0),c(Re,{installedInstance:m(y)},null,8,["installedInstance"])])),_:1}),c(ve,{class:"mx-1 running-window-main mb-3"},{default:u((()=>[c(le,{fluid:"",class:"d-flex flex-column",style:{height:"100%"}},{default:u((()=>[m(y)&&m(o)&&m(x)?(s(),d($e,{key:0,ref_key:"appEnvAndAccessComponent",ref:A,onAppEnvSavedAndUpdated:F,lmAppData:m(o),installedInstance:m(y)},null,8,["lmAppData","installedInstance"])):p("",!0),c(me,{class:"mx-2",modelValue:m(T).currentTerminalTab,"onUpdate:modelValue":a[3]||(a[3]=e=>m(T).currentTerminalTab=e),"align-tabs":"start",color:"primary"},{default:u((()=>[(s(!0),l(w,null,_(m(T).terminals,((e,a)=>(s(),d(ge,{value:e.tabName,key:e.tabName},{append:u((()=>[e.closable?(s(),d(ae,{key:0,icon:"mdi-close-circle-outline",onClick:S((t=>((e,a)=>{T.removeTerminal(e,a)})(e,a)),["stop"])},null,8,["onClick"])):p("",!0)])),default:u((()=>[v(" "+f(e.text),1)])),_:2},1032,["value"])))),128))])),_:1},8,["modelValue"]),c(ue,{modelValue:m(T).currentTerminalTab,"onUpdate:modelValue":a[4]||(a[4]=e=>m(T).currentTerminalTab=e),class:"mx-2 my-0 px-0 pt-0 mb-0 pb-2",style:{flex:"1","background-color":"black"}},{default:u((()=>[(s(!0),l(w,null,_(m(T).terminals,((e,a)=>(s(),d(Se,{style:{flex:"1"},key:e.text,value:e.tabName,eager:""},{default:u((()=>["main-process"===e.tabName?(s(),d(Ie,{key:0,onExecuteEnd:J,"command-execute-end-keywords":e.commandExecuteEndKeywords,ref_for:!0,ref_key:"generalTerminal",ref:g,socketURI:"ws://localhost:19312"},null,8,["command-execute-end-keywords"])):(s(),d(Ie,{key:1,onExecuteEnd:Y,"command-execute-end-keywords":e.commandExecuteEndKeywords,initCommand:e.initCommand,socketURI:"ws://localhost:19312"},null,8,["command-execute-end-keywords","initCommand"]))])),_:2},1032,["value"])))),128))])),_:1},8,["modelValue"])])),_:1})])),_:1})])),_:1}))}});export{Be as default};
