import{a2 as pe,d as Y,r as I,l as Z,ab as Me,o as D,n as F,a as U,k as X,W as me,C as Re,L as fe,Z as Ne,P as H,E as Le,z as f,c as E,w as c,g as T,t as A,m as V,s as O,b as w,a7 as Ve,I as ae,a6 as Ce,a4 as ge,T as se,Q as Ee,a1 as xe,G as ve,a5 as Oe,i as ze,J as $e,F as K,a3 as Be,p as te,ac as ie,K as G,ad as he,ae as Pe,$ as We,N as Ue,af as Fe,V as Se,f as Ge,h as He,ag as we,ah as Ae,j as je,ai as qe,aj as Ke,ak as Ye,al as Ze,am as Qe}from"./index.js";import{u as Je}from"./lmapp.js";import{I as re}from"./IPCChannelName.js";import{a as Xe}from"./install-instance.js";import{A as et}from"./AppScriptType.js";function tt(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var ce={exports:{}},be;function nt(){return be||(be=1,function(n,e){(function(t,i){n.exports=i()})(self,()=>(()=>{var t={};return(()=>{var i=t;Object.defineProperty(i,"__esModule",{value:!0}),i.FitAddon=void 0,i.FitAddon=class{activate(o){this._terminal=o}dispose(){}fit(){const o=this.proposeDimensions();if(!o||!this._terminal||isNaN(o.cols)||isNaN(o.rows))return;const a=this._terminal._core;this._terminal.rows===o.rows&&this._terminal.cols===o.cols||(a._renderService.clear(),this._terminal.resize(o.cols,o.rows))}proposeDimensions(){if(!this._terminal||!this._terminal.element||!this._terminal.element.parentElement)return;const o=this._terminal._core,a=o._renderService.dimensions;if(a.css.cell.width===0||a.css.cell.height===0)return;const l=this._terminal.options.scrollback===0?0:o.viewport.scrollBarWidth,s=window.getComputedStyle(this._terminal.element.parentElement),m=parseInt(s.getPropertyValue("height")),S=Math.max(0,parseInt(s.getPropertyValue("width"))),g=window.getComputedStyle(this._terminal.element),r=m-(parseInt(g.getPropertyValue("padding-top"))+parseInt(g.getPropertyValue("padding-bottom"))),p=S-(parseInt(g.getPropertyValue("padding-right"))+parseInt(g.getPropertyValue("padding-left")))-l;return{cols:Math.max(2,Math.floor(p/a.css.cell.width)),rows:Math.max(1,Math.floor(r/a.css.cell.height))}}}})(),t})())}(ce)),ce.exports}var at=nt(),de={exports:{}},_e;function st(){return _e||(_e=1,function(n,e){(function(t,i){n.exports=i()})(self,()=>(()=>{var t={};return(()=>{var i=t;function o(a,l,s){return a.addEventListener(l,s),{dispose:()=>{s&&a.removeEventListener(l,s)}}}Object.defineProperty(i,"__esModule",{value:!0}),i.AttachAddon=void 0,i.AttachAddon=class{constructor(a,l){this._disposables=[],this._socket=a,this._socket.binaryType="arraybuffer",this._bidirectional=!(l&&l.bidirectional===!1)}activate(a){this._disposables.push(o(this._socket,"message",l=>{const s=l.data;a.write(typeof s=="string"?s:new Uint8Array(s))})),this._bidirectional&&(this._disposables.push(a.onData(l=>this._sendData(l))),this._disposables.push(a.onBinary(l=>this._sendBinary(l)))),this._disposables.push(o(this._socket,"close",()=>this.dispose())),this._disposables.push(o(this._socket,"error",()=>this.dispose()))}dispose(){for(const a of this._disposables)a.dispose()}_sendData(a){this._checkOpenSocket()&&this._socket.send(a)}_sendBinary(a){if(!this._checkOpenSocket())return;const l=new Uint8Array(a.length);for(let s=0;s<a.length;++s)l[s]=255&a.charCodeAt(s);this._socket.send(l)}_checkOpenSocket(){switch(this._socket.readyState){case WebSocket.OPEN:return!0;case WebSocket.CONNECTING:throw new Error("Attach addon was loaded before socket was open");case WebSocket.CLOSING:return console.warn("Attach addon socket is closing"),!1;case WebSocket.CLOSED:throw new Error("Attach addon socket is closed");default:throw new Error("Unexpected socket state")}}}})(),t})())}(de)),de.exports}var it=st(),ue={exports:{}},ye;function lt(){return ye||(ye=1,function(n,e){(function(t,i){n.exports=i()})(self,()=>(()=>{var t={6:(l,s)=>{function m(g){try{const r=new URL(g),p=r.password&&r.username?`${r.protocol}//${r.username}:${r.password}@${r.host}`:r.username?`${r.protocol}//${r.username}@${r.host}`:`${r.protocol}//${r.host}`;return g.toLocaleLowerCase().startsWith(p.toLocaleLowerCase())}catch{return!1}}Object.defineProperty(s,"__esModule",{value:!0}),s.LinkComputer=s.WebLinkProvider=void 0,s.WebLinkProvider=class{constructor(g,r,p,b={}){this._terminal=g,this._regex=r,this._handler=p,this._options=b}provideLinks(g,r){const p=S.computeLink(g,this._regex,this._terminal,this._handler);r(this._addCallbacks(p))}_addCallbacks(g){return g.map(r=>(r.leave=this._options.leave,r.hover=(p,b)=>{if(this._options.hover){const{range:M}=r;this._options.hover(p,b,M)}},r))}};class S{static computeLink(r,p,b,M){const N=new RegExp(p.source,(p.flags||"")+"g"),[x,R]=S._getWindowedLineStrings(r-1,b),v=x.join("");let _;const y=[];for(;_=N.exec(v);){const C=_[0];if(!m(C))continue;const[$,P]=S._mapStrIdx(b,R,0,_.index),[W,z]=S._mapStrIdx(b,$,P,C.length);if($===-1||P===-1||W===-1||z===-1)continue;const j={start:{x:P+1,y:$+1},end:{x:z,y:W+1}};y.push({range:j,text:C,activate:M})}return y}static _getWindowedLineStrings(r,p){let b,M=r,N=r,x=0,R="";const v=[];if(b=p.buffer.active.getLine(r)){const _=b.translateToString(!0);if(b.isWrapped&&_[0]!==" "){for(x=0;(b=p.buffer.active.getLine(--M))&&x<2048&&(R=b.translateToString(!0),x+=R.length,v.push(R),b.isWrapped&&R.indexOf(" ")===-1););v.reverse()}for(v.push(_),x=0;(b=p.buffer.active.getLine(++N))&&b.isWrapped&&x<2048&&(R=b.translateToString(!0),x+=R.length,v.push(R),R.indexOf(" ")===-1););}return[v,M]}static _mapStrIdx(r,p,b,M){const N=r.buffer.active,x=N.getNullCell();let R=b;for(;M;){const v=N.getLine(p);if(!v)return[-1,-1];for(let _=R;_<v.length;++_){v.getCell(_,x);const y=x.getChars();if(x.getWidth()&&(M-=y.length||1,_===v.length-1&&y==="")){const C=N.getLine(p+1);C&&C.isWrapped&&(C.getCell(0,x),x.getWidth()===2&&(M+=1))}if(M<0)return[p,_]}p++,R=0}return[p,R]}}s.LinkComputer=S}},i={};function o(l){var s=i[l];if(s!==void 0)return s.exports;var m=i[l]={exports:{}};return t[l](m,m.exports,o),m.exports}var a={};return(()=>{var l=a;Object.defineProperty(l,"__esModule",{value:!0}),l.WebLinksAddon=void 0;const s=o(6),m=/(https?|HTTPS?):[/]{2}[^\s"'!*(){}|\\\^<>`]*[^\s"':,.!?{}|\\\^~\[\]`()<>]/;function S(g,r){const p=window.open();if(p){try{p.opener=null}catch{}p.location.href=r}else console.warn("Opening link blocked as opener could not be cleared")}l.WebLinksAddon=class{constructor(g=S,r={}){this._handler=g,this._options=r}activate(g){this._terminal=g;const r=this._options,p=r.urlRegex||m;this._linkProvider=this._terminal.registerLinkProvider(new s.WebLinkProvider(this._terminal,p,this._handler,r))}dispose(){this._linkProvider?.dispose()}}})(),a})())}(ue)),ue.exports}var ot=lt(),ne={exports:{}},De;function rt(){if(De)return ne.exports;De=1;function n(e,t=100,i={}){if(typeof e!="function")throw new TypeError(`Expected the first parameter to be a function, got \`${typeof e}\`.`);if(t<0)throw new RangeError("`wait` must not be negative.");const{immediate:o}=typeof i=="boolean"?{immediate:i}:i;let a,l,s,m,S;function g(){const b=a,M=l;return a=void 0,l=void 0,S=e.apply(b,M),S}function r(){const b=Date.now()-m;b<t&&b>=0?s=setTimeout(r,t-b):(s=void 0,o||(S=g()))}const p=function(...b){if(a&&this!==a&&Object.getPrototypeOf(this)===Object.getPrototypeOf(a))throw new Error("Debounced method called with different contexts of the same prototype.");a=this,l=b,m=Date.now();const M=o&&!s;return s||(s=setTimeout(r,t)),M&&(S=g()),S};return Object.defineProperty(p,"isPending",{get(){return s!==void 0}}),p.clear=()=>{s&&(clearTimeout(s),s=void 0)},p.flush=()=>{s&&p.trigger()},p.trigger=()=>{S=g(),p.clear()},p}return ne.exports.debounce=n,ne.exports=n,ne.exports}var ct=rt();const dt=tt(ct),ut=()=>"",pt=n=>{let e="";if(n)for(const t in n)e+=`${t}=${n[t]}
`;return e},mt=async n=>{const e=n.installName;return`
export LMD_BASE_INSTALL_SCRIPT_DIR="${(await pe()).LMD_SCRIPTS_DIR}/lmd-install-scripts"
git clone --depth=1 https://gitee.com/lmdown/lmd-install-scripts $LMD_BASE_INSTALL_SCRIPT_DIR
cd $LMD_BASE_INSTALL_SCRIPT_DIR && git fetch origin master && git reset --hard origin/master
sh $LMD_BASE_INSTALL_SCRIPT_DIR/apps/${e}/install.sh`},ft=async n=>{const e=n.installName;return`
export LMD_BASE_INSTALL_SCRIPT_DIR="${(await pe()).LMD_SCRIPTS_DIR}/lmd-install-scripts"
sh $LMD_BASE_INSTALL_SCRIPT_DIR/apps/${e}/start.sh`},gt=async n=>{const e=n.installName;return`
export LMD_BASE_INSTALL_SCRIPT_DIR="${(await pe()).LMD_SCRIPTS_DIR}/lmd-install-scripts"
sh $LMD_BASE_INSTALL_SCRIPT_DIR/apps/${e}/update.sh
`},Ie=Y({__name:"index",props:{socketURI:{},initCommand:{},commandExecuteEndKeywords:{}},emits:["executeEnd"],setup(n,{expose:e,emit:t}){const i=t,o=I([]),a=I(!1),l=n,s=I(null),m=I(null),S=I(null),g=I(null);let r;Z(()=>{_(),v()}),Me(()=>{s.value?.close(),m.value?.dispose(),r&&g.value&&(r.unobserve(g.value),r.disconnect())});const p=k=>{console.log("runCommand",k),console.log("runCommand socket.value",s.value),s.value?.send(k+`
`)};e({runCommand:p,runStopCommand:()=>{const k=ut();p(k)},exitTerminal:()=>{p("exit")}});const N=()=>{if(!g.value||!s.value)return;const k=new window.Terminal({fontSize:14,cursorBlink:!0}),d=new it.AttachAddon(s.value),u=new at.FitAddon,h=new ot.WebLinksAddon((L,Q)=>{const q=document.createElement("a");q.setAttribute("href",Q),q.setAttribute("target","_blank"),q.setAttribute("id","lmdTempLink");const oe=document.getElementById("lmdTempLink");oe&&document.body.removeChild(oe),document.body.appendChild(q),q.click()});k.loadAddon(d),k.loadAddon(u),k.loadAddon(h),k.open(g.value),u.fit(),k.focus(),m.value=k},R=dt(k=>{for(const d of k)j(d.contentRect.width,d.contentRect.height)},50),v=()=>{S.value&&(r=new ResizeObserver(R),r.observe(S.value))},_=()=>{s.value=new WebSocket(l.socketURI),$(),C(),P(),y()},y=()=>{if(l.commandExecuteEndKeywords&&s.value){const k=l.commandExecuteEndKeywords;s.value.onmessage=d=>{const u=d.data;k.forEach(h=>{u.includes(h)&&!o.value.includes(h)&&o.value.push(h)}),o.value.length===k.length&&(a.value||(i("executeEnd"),a.value=!0))}}},C=()=>{s.value&&(s.value.onopen=()=>{N(),l.initCommand&&p(l.initCommand)})},$=()=>{s.value&&(s.value.onclose=k=>{console.log("close socket",k)})},P=()=>{s.value&&(s.value.onerror=k=>{console.log("socket 链接失败",k)})},W=I(80),z=I(30),j=(k,d)=>{const u=Math.floor(k/8.5),h=Math.round(d/16);if(console.log("cols",k,u),console.log("rows",d,h),!(h===0||u===0)&&(W.value!==u||z.value!==h)){W.value=u,z.value=h,m.value?.resize(u,h);const L=`lmd_action:resize:${u},${h}`;s.value?.send(L)}};return(k,d)=>(D(),F("div",{ref_key:"terminalOutContainer",ref:S,class:"mb-2",style:{height:"100%",width:"100%"}},[U("div",{ref_key:"terminalContainer",ref:g,class:"terminal",style:{height:"300px",width:"100%"}},null,512)],512))}}),vt=async n=>{let e;try{return(await X.post("/self-manage/common-util/app-running-base-env-info",{keys:n})).data}catch(t){return console.log("err",t),e}},ht=async n=>{let e;try{return(await X.post("/self-manage/common-util/save-app-running-base-env-info",{envObj:n})).data}catch(t){return console.log("err",t),e}},St=async()=>{let n;try{n=(await X.get("/self-manage/common-util/lan-ip")).data?.ip}catch(e){console.log("err",e)}return n},wt=async()=>{let n;try{n=(await X.get("/self-manage/common-util/user-home-dir")).data?.userHomeDir}catch(e){console.log("err",e)}return n},At=async n=>{let e=0;try{e=(await X.get(`/self-manage/common-util/dir-file-size?dirPath=${n}`)).data?.fileSize}catch(t){console.log("err",t)}return e},bt=async n=>{let e=[];try{e=(await X.get(`/self-manage/common-util/installed-model-files/${n}`)).data?.models}catch(t){console.log("err",t)}return e},_t=async(n,e=!1)=>{if(window.ipcRenderer)return await window.ipcRenderer?.invoke(me.SELECT_DIR,n,e)},ke="OLLAMA_MODELS",yt="OLLAMA_HOST",Dt={DISPLAY_ENV:["OLLAMA_MODELS","OLLAMA_HOST"]},It=[{displayName:"Deepseek-R1",installName:"deepseek-r1",tags:[{parameterSize:"1.5b",fileSize:"1.1GB"},{parameterSize:"7b",fileSize:"4.7GB"},{parameterSize:"8b",fileSize:"4.9GB"},{parameterSize:"14b",fileSize:"9.0GB"},{parameterSize:"32b",fileSize:"20GB"},{parameterSize:"70b",fileSize:"43GB"},{parameterSize:"671b",fileSize:"404GB"}]},{displayName:"Llama 3.1",installName:"llama3.1",tags:[{parameterSize:"8b",fileSize:"4.9GB"},{parameterSize:"70b",fileSize:"43GB"},{parameterSize:"405b",fileSize:"243GB"}]},{displayName:"Qwen 2.5",installName:"qwen2.5",tags:[{parameterSize:"0.5b",fileSize:"398MB"},{parameterSize:"1.5b",fileSize:"986MB"},{parameterSize:"3b",fileSize:"1.9GB "},{parameterSize:"7b",fileSize:"4.7GB"},{parameterSize:"14b",fileSize:"9.0GB"},{parameterSize:"32b",fileSize:"20GB"},{parameterSize:"72b",fileSize:"47GB"}]}],kt=async()=>{if(window.ipcRenderer)return await window.ipcRenderer?.invoke(me.RESTART_APP)},Tt=async n=>{if(window.ipcRenderer)return await window.ipcRenderer?.invoke(me.KILL_PROCESSES,n)},Lt=["B","kB","MB","GB","TB","PB","EB","ZB","YB"],Ct=["B","KiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"],Et=["b","kbit","Mbit","Gbit","Tbit","Pbit","Ebit","Zbit","Ybit"],xt=["b","kibit","Mibit","Gibit","Tibit","Pibit","Eibit","Zibit","Yibit"],Te=(n,e,t)=>{let i=n;return typeof e=="string"||Array.isArray(e)?i=n.toLocaleString(e,t):(e===!0||t!==void 0)&&(i=n.toLocaleString(void 0,t)),i};function Mt(n,e){if(!Number.isFinite(n))throw new TypeError(`Expected a finite number, got ${typeof n}: ${n}`);e={bits:!1,binary:!1,space:!0,...e};const t=e.bits?e.binary?xt:Et:e.binary?Ct:Lt,i=e.space?" ":"";if(e.signed&&n===0)return` 0${i}${t[0]}`;const o=n<0,a=o?"-":e.signed?"+":"";o&&(n=-n);let l;if(e.minimumFractionDigits!==void 0&&(l={minimumFractionDigits:e.minimumFractionDigits}),e.maximumFractionDigits!==void 0&&(l={maximumFractionDigits:e.maximumFractionDigits,...l}),n<1){const g=Te(n,e.locale,l);return a+g+i+t[0]}const s=Math.min(Math.floor(e.binary?Math.log(n)/Math.log(1024):Math.log10(n)/3),t.length-1);n/=(e.binary?1024:1e3)**s,l||(n=n.toPrecision(3));const m=Te(Number(n),e.locale,l),S=t[s];return a+m+i+S}class B{static appIsOllama(e){return e==="ollama"}static async getModelFileSize(e,t){if(this.appIsOllama(e)&&t){const i=t[ke];if(i){const o=await At(i);return Mt(o)}}return""}static async getModelsDir(e,t){return this.appIsOllama(e)&&t?t[ke]:""}static genModelDownloadCommand(e,t){return this.appIsOllama(e)&&t?`ollama pull ${t}`:""}static async mergeModelsList(e,t){if(e){const i=await bt(e);console.log("installedModelList",i),i.forEach(o=>{const[a,l]=o.name.split(":"),s=t.find(m=>m.installName===a);if(s){const m=s.tags.find(S=>S.parameterSize===l);m?m.installed=!0:s.tags.push({parameterSize:l,fileSize:o.size||"",installed:!0})}else t.push({displayName:a,installName:a,tags:[{parameterSize:l,fileSize:o.size||"",installed:!0}]})})}return t}static killAppProcessed(e){this.appIsOllama(e)&&Tt(["ollama.exe","ollama app.exe"])}static needPreStartApp(e){return!!this.appIsOllama(e)}}class J{static async getAppSettings(){const e=await this.getOSEnvObj();return{modelsDir:e.OLLAMA_MODELS,externalAccessHost:e.OLLAMA_HOST}}static async getOSEnvObj(){return await vt(Dt.DISPLAY_ENV)}static async getAccessHosts(e){const t="11434",i=[`http://127.0.0.1:${t}`];if(!(!e||e==="127.0.0.1")){const o=e.split(":"),a=o[0];let l=[a];const s=o[1]||t;a==="0.0.0.0"&&(l=await St()),l&&l.length>0&&l.forEach(m=>{i.push(`http://${m}:${s}`)})}return i}static async saveAppSettings(e,t){e.modelsDir===t&&(e.modelsDir="");const i={OLLAMA_MODELS:e.modelsDir,OLLAMA_HOST:e.externalAccessHost};return await ht(i)}static filterSpecialFiles(e){if(!e)return e;const t=["desktop.ini",".ds_store","thumbs.db"];return e.filter(i=>{const o=i.toLowerCase();return!t.includes(o)})}static checkModelsDirValid(e,t){if(e.subdirs=this.filterSpecialFiles(e.subdirs),e.files=this.filterSpecialFiles(e.files),(!e.subdirs||e.subdirs.length===0)&&(!e.files||e.files.length===0))return!0;const i=new Set(e.subdirs);return t.every(a=>i.has(a))}static getDownloadableModels(){return It}}const le=Re("runningInstance",{state:()=>({runningInstances:[],appSettingsSaved:!1,terminals:[],currentTerminalTab:""}),actions:{addRunningInstance(n){this.runningInstances.find(t=>t.id===n.id)||this.runningInstances.push(n)},removeRunningInstance(n){const e=this.runningInstances.findIndex(t=>t.id===n.id);e!=-1&&this.runningInstances.splice(e,1)},resetAppSettingsSavedStatus(){this.appSettingsSaved=!1},onAppSettingsSaved(){this.appSettingsSaved=!0},initTerminal(n){this.terminals=[n],this.currentTerminalTab=n.tabName},addTerminal(n,e,t){this.terminals.find(o=>o.tabName===n)||this.terminals.push({text:e,tabName:n,initCommand:t,closable:!0,commandExecuteEndKeywords:["digest","writing manifest","success"]}),this.currentTerminalTab=n},removeTerminal(n,e){this.terminals.splice(e,1)}}});class ee{static isWindows(){const e=navigator.userAgentData;return e&&e.platform?e.platform==="Windows":navigator.userAgent?/Win(dows )?NT/.test(navigator.userAgent):!1}}const Rt={style:{"font-size":"12px"}},Nt={style:{"font-size":"12px"}},Vt=Y({__name:"app-settings-btn",props:{installedInstance:{}},setup(n){const{t:e}=fe(),t=I(!1),i=I(!1),o=I(!1),a=I(!1),l=I(""),s=le(),m=Ne("showToastMessage"),S=I({}),g=I(!0),r=n;H(()=>r.installedInstance,()=>{p()});const p=()=>{z()?t.value=!0:t.value=!1};Z(()=>{p()});const b=async()=>{i.value=!0,await N(),await W()},M=()=>{i.value=!1},N=async()=>{const d=await wt();l.value=d+"/.ollama/models"},x=async()=>{if(!o.value||!S)return;if(l.value===""){const L=e("AppSettingDialog.DataNotValid");m&&m(L,"error");return}a.value=!0;const d=Object.assign({},S.value),u=await J.saveAppSettings(d,l.value);console.log("save result ",u);const h=e("Common.saveSuccess");m&&m(h,"success"),a.value=!1,s.onAppSettingsSaved(),setTimeout(()=>{s.resetAppSettingsSavedStatus()},100),M(),ee.isWindows()&&(B.killAppProcessed(r.installedInstance?.installName),setTimeout(()=>{kt()},1500))},R=d=>!!d||e("Common.fieldRequired"),v=async()=>{const d=await _t(S.value.modelsDir,!0);d&&d.path&&(S.value.modelsDir=d.path,console.log("dirInfo",d),g.value=J.checkModelsDirValid(d,["blobs"]),console.log("dirValid.value",g.value))},_=[R,()=>g.value||e("AppSettingDialog.ModelsDirNotValid")],y=/^(\d{1,3}\.){3}\d{1,3}(:\d{1,5})?$/,C=[d=>d===""?!0:y.test(d)||e("AppSettingDialog.HostNotValid")],$=async()=>{S.value.modelsDir=l.value},P=Le(()=>{if(z())return e("AppSettingDialog.OllamaModelsDirInfoIconTip")}),W=async()=>{if(z()){const d=await J.getAppSettings();console.log("getOSEnvForCurrentApp",d),S.value=Object.assign({},d),d.modelsDir===""&&(console.log("getOSEnvForCurrentApp",d),S.value.modelsDir=l.value)}},z=()=>B.appIsOllama(r.installedInstance?.installName),j=()=>{let d=e("AppSettingDialog.ModelsDirTip");return ee.isWindows()?d+=e("AppSettingDialog.ModelsDirTipExtraWindows"):d+=e("AppSettingDialog.ModelsDirTipExtraMac"),d},k=()=>{let d=e("AppSettingDialog.ServerHostTip");return ee.isWindows()?d+=e("AppSettingDialog.ServerHostTipExtraWindows"):d+=e("AppSettingDialog.ServerHostTipExtraMac"),d};return(d,u)=>(D(),F(K,null,[f(t)?(D(),E(V,{key:0,"prepend-icon":"mdi-cog",stacked:"",onClick:b},{default:c(()=>[T(A(d.$t("AppRunningWindow.Settings")),1)]),_:1})):O("",!0),w($e,{modelValue:f(i),"onUpdate:modelValue":u[5]||(u[5]=h=>ae(i)?i.value=h:null),"min-width":"400","max-width":"800"},{default:c(()=>[d.installedInstance?(D(),E(ze,{key:0,class:"mx-auto px-0 py-0 window-no-drag",width:"100%",title:d.$t("AppSettingDialog.Title")+d.installedInstance.name},{append:c(()=>[w(V,{icon:"mdi-close",class:"ms-auto",size:"compact",text:"Ok",elevation:"0",onClick:u[0]||(u[0]=h=>i.value=!1)})]),default:c(()=>[f(S)?(D(),E(Ve,{key:0,class:"pt-0 pb-3 px-6",modelValue:f(o),"onUpdate:modelValue":u[4]||(u[4]=h=>ae(o)?o.value=h:null),onSubmit:Ce(x,["prevent"])},{default:c(()=>[w(ge,{modelValue:f(S).modelsDir,"onUpdate:modelValue":u[1]||(u[1]=h=>f(S).modelsDir=h),density:"comfortable",readonly:f(a),rules:_,label:d.$t("AppSettingDialog.ModelsDirLabel")},{append:c(()=>[w(se,{location:"bottom"},{activator:c(({props:h})=>[w(Ee,xe(h,{icon:"mdi-information-slab-circle-outline"}),null,16)]),default:c(()=>[U("pre",null,A(f(P)),1)]),_:1}),w(V,{class:"ml-1",onClick:v},{default:c(()=>[T(A(d.$t("AppSettingDialog.Browse")),1)]),_:1}),w(V,{class:"ml-1",onClick:$},{default:c(()=>[T(A(d.$t("AppSettingDialog.UseDefaultValue")),1)]),_:1})]),_:1},8,["modelValue","readonly","label"]),w(ve,{class:"pt-0"},{default:c(()=>[U("pre",Rt,A(j()),1)]),_:1}),w(ge,{modelValue:f(S).externalAccessHost,"onUpdate:modelValue":u[2]||(u[2]=h=>f(S).externalAccessHost=h),density:"comfortable",readonly:f(a),rules:C,label:d.$t("AppSettingDialog.ServerHostLabel")},null,8,["modelValue","readonly","label"]),w(ve,{class:"pt-0"},{default:c(()=>[U("pre",Nt,A(k()),1)]),_:1}),w(Oe,{class:"text-center justify-center"},{default:c(()=>[w(V,{variant:"outlined",onClick:u[3]||(u[3]=h=>i.value=!1)},{default:c(()=>[T(A(d.$t("AppSettingDialog.close")),1)]),_:1}),w(V,{color:"primary",variant:"flat",type:"submit",loading:f(a)},{default:c(()=>[T(A(d.$t("AppSettingDialog.saveConfig")),1)]),_:1},8,["loading"])]),_:1})]),_:1},8,["modelValue"])):O("",!0)]),_:1},8,["title"])):O("",!0)]),_:1},8,["modelValue"])],64))}}),Ot=Y({__name:"app-env-row",props:{installedInstance:{},appEnv:{}},setup(n){const e=I(null);return Z(async()=>{e.value=await Be()}),(t,i)=>(D(),E(ie,{class:"my-1 py-1 mx-3"},{default:c(()=>[T(A(t.$t("AppRunningWindow.EnvVars"))+": ",1),(D(!0),F(K,null,te(f(e),(o,a)=>(D(),E(G,{variant:"tonal",size:"x-small",style:{"min-width":"50px","max-width":"120px","margin-left":"4px"},key:a},{default:c(()=>[T(A(a)+" ",1),w(se,{activator:"parent",location:"bottom"},{default:c(()=>[T(A(o),1)]),_:2},1024)]),_:2},1024))),128)),(D(!0),F(K,null,te(t.appEnv,(o,a)=>(D(),E(G,{variant:"tonal",size:"x-small",color:"orange-darken-4",style:{"min-width":"50px","max-width":"120px","margin-left":"4px"},key:a},{default:c(()=>[T(A(a)+" ",1),w(se,{activator:"parent",location:"bottom"},{default:c(()=>[T(A(o),1)]),_:2},1024)]),_:2},1024))),128))]),_:1}))}}),zt=["href"],$t=Y({__name:"app-access-row",props:{lmAppData:{},installedInstance:{},appEnv:{}},setup(n){const e=n,t=I([]),i=I(!1),o=async()=>{if(e.lmAppData?.accessInfo){const a=e.lmAppData.accessInfo,{accessType:l}=a;if(!l)return!1;if(l==="browser")return t.value.push(e.lmAppData.accessInfo?.webUrl||""),!0;if(l==="exec"&&B.appIsOllama(e.installedInstance?.installName)){if(e.appEnv){const s=e.appEnv[yt];t.value=await J.getAccessHosts(s)}return!0}}return!1};return Z(async()=>{i.value=await o()}),H(()=>e.appEnv,async()=>{i.value=await o()}),(a,l)=>a.lmAppData&&f(i)?(D(),E(ie,{key:0,class:"my-1 py-1 mx-3"},{default:c(()=>[T(A(a.$t("AppRunningWindow.Access"))+": ",1),f(t)&&f(t).length>0?(D(!0),F(K,{key:0},te(f(t),s=>(D(),F("a",{class:"mx-2",key:s,href:s,target:"_blank"},A(s),9,zt))),128)):O("",!0)]),_:1})):O("",!0)}}),Bt=Y({__name:"model-download-row",props:{lmAppData:{},installedInstance:{},appEnv:{}},setup(n){const e=le(),t=I([]),i=I([]),o=I(!1),a=I(null),l=I(null),s=I(null),m=I(!1),{t:S}=fe(),g=n,r=async()=>{const v=await B.getModelsDir(g.installedInstance?.installName,g.appEnv);We(v)};Z(async()=>{p(),N(),await x()}),H(()=>g.lmAppData,()=>{p()}),H(()=>g.installedInstance,()=>{N(),x()}),H(()=>g.appEnv,()=>{N(),x()});const p=()=>{o.value=B.appIsOllama(g.lmAppData?.installName)};H(a,()=>{M()}),H(l,v=>{b(v)});const b=v=>{const _=i.value.find(y=>y.parameterSize===v);_&&(_.installed===void 0?m.value=!0:m.value=!_.installed)},M=()=>{const v=a.value,y=t.value.find(C=>C.installName===v)?.tags||[];if(i.value=y,y.length>0){const C=y[0].parameterSize;l.value=C,b(C)}},N=async()=>{s.value=await B.getModelFileSize(g.installedInstance?.installName,g.appEnv)},x=async()=>{const v=g.installedInstance?.installName;if(v&&o.value){const _=J.getDownloadableModels(),y=await B.mergeModelsList(v,_);if(t.value=y,t.value&&t.value.length>0){const C=t.value[0];a.value=C.installName}}},R=async()=>{const v=`${a.value}:${l.value}`,_=B.genModelDownloadCommand(g.installedInstance?.installName,v),y=S("AppRunningWindow.ModelDownloadBtnLabel")+" "+v;_&&a.value&&e.addTerminal(v,y,_)};return(v,_)=>v.lmAppData&&f(o)?(D(),E(ie,{key:0,class:"my-0 py-0 mx-3 d-flex flex-row",style:{gap:"0.5rem","align-items":"center"}},{default:c(()=>[U("div",null,A(v.$t("AppRunningWindow.ModelDownload"))+": ",1),w(he,{class:"flex-1",items:f(t),"item-title":"displayName","item-value":"installName",modelValue:f(a),"onUpdate:modelValue":_[0]||(_[0]=y=>ae(a)?a.value=y:null),density:"compact","hide-details":"",label:v.$t("AppRunningWindow.ModelName")},null,8,["items","modelValue","label"]),w(he,{class:"flex-1",items:f(i),"item-title":"parameterSize","item-value":"parameterSize",modelValue:f(l),"onUpdate:modelValue":_[1]||(_[1]=y=>ae(l)?l.value=y:null),density:"compact","hide-details":"",label:v.$t("AppRunningWindow.ParameterSize")},{selection:c(({item:y})=>[T(A(y.title)+" ",1),w(G,{density:"compact",class:"mx-1",variant:"flat",color:"yellow-darken-2"},{default:c(()=>[T(A(y.raw.fileSize),1)]),_:2},1024),y.raw.installed?(D(),E(G,{key:0,density:"compact",variant:"flat",color:"green"},{default:c(()=>[U("span",null,A(v.$t("AppRunningWindow.ModelDownloaded")),1)]),_:1})):(D(),E(G,{key:1,density:"compact"},{default:c(()=>[U("span",null,A(v.$t("AppRunningWindow.ModelNotDownloaded")),1)]),_:1}))]),item:c(({props:y,item:C})=>[w(Pe,xe(y,{density:"compact"}),{title:c(()=>[T(A(C.title)+" ",1),w(G,{density:"compact",class:"mx-1",variant:"flat",color:"yellow-darken-2"},{default:c(()=>[T(A(C.raw.fileSize),1)]),_:2},1024),C.raw.installed?(D(),E(G,{key:0,density:"compact",variant:"flat",color:"green"},{default:c(()=>[U("span",null,A(v.$t("AppRunningWindow.ModelDownloaded")),1)]),_:1})):(D(),E(G,{key:1,density:"compact"},{default:c(()=>[U("span",null,A(v.$t("AppRunningWindow.ModelNotDownloaded")),1)]),_:1}))]),_:2},1040)]),_:1},8,["items","modelValue","label"]),f(m)?(D(),E(V,{key:0,"prepend-icon":"mdi-download-outline",onClick:R,color:"green-lighten-5"},{default:c(()=>[T(A(v.$t("AppRunningWindow.ModelDownloadBtnLabel")),1)]),_:1})):O("",!0),w(V,{"prepend-icon":"mdi-folder-file-outline",color:"amber-lighten-5",onClick:r},{default:c(()=>[T(A(f(s))+" ",1),w(se,{activator:"parent",location:"top"},{default:c(()=>[T(A(v.$t("AppRunningWindow.StorageBtnTip")),1)]),_:1})]),_:1})]),_:1})):O("",!0)}}),Pt=Y({__name:"app-env-and-access",props:{installedInstance:{},lmAppData:{}},emits:["appEnvSavedAndUpdated"],setup(n,{expose:e,emit:t}){const i=n,o=le(),a=I({}),l=t;Z(async()=>{s()});const s=async()=>{const m=i.installedInstance?.installName;B.appIsOllama(m)&&(a.value=await J.getOSEnvObj()||{})};return e({updateAppEnvData:s}),H(()=>o.appSettingsSaved,async m=>{m&&(a.value=null,await s(),l("appEnvSavedAndUpdated",a.value))}),(m,S)=>f(a)&&m.installedInstance?(D(),F(K,{key:0},[w($t,{appEnv:f(a),lmAppData:m.lmAppData,installedInstance:m.installedInstance},null,8,["appEnv","lmAppData","installedInstance"]),w(Ot,{appEnv:f(a),installedInstance:m.installedInstance},null,8,["appEnv","installedInstance"]),w(Bt,{appEnv:f(a),installedInstance:m.installedInstance,lmAppData:m.lmAppData},null,8,["appEnv","installedInstance","lmAppData"])],64)):O("",!0)}}),jt=Y({__name:"AppRunningWindow",setup(n){const e=Ue(),t=Je(),i=I(null),o=I(),a=I(),l=I(null),s=I(!1),m=I(!1),S=I("--"),{t:g}=fe(),r=le(),p=Le(()=>!(s.value&&!t.currentLmApp.runtimeUpdateAllowed));Z(async()=>{b();const u=e.params.id,h=await Xe(u);l.value=h;const L=h.appId;await t.fetchApp(L),i.value=t.currentLmApp,window.ipcRenderer?.on(re.STOP_AI_RUNNING_INSTANCE,(q,...oe)=>{y(),C()}),z();const Q=i?.value.name;document.title=Q,k()});const b=()=>{const u={icon:"mdi-application-brackets-outline",text:g("AppRunningWindow.MainProcessTab"),tabName:"main-process",closable:!1};r.initTerminal(u)},M=()=>{y(),N()},N=async()=>{if(s.value=!0,i.value){const u=await ft(i.value);_(u),window.ipcRenderer?.send(re.RUNNING_STATUS_CHANGE,!0)}},x=async()=>{if(i.value){const u=await gt(i.value);_(u)}},R=()=>{$()},v=()=>Array.isArray(o.value)?o.value[0]:o.value,_=u=>{const h=v();console.log("terminalComponent",h,u),h?.runCommand(u)},y=()=>{s.value=!1,W(),v()?.runStopCommand(),window.ipcRenderer.send(re.RUNNING_STATUS_CHANGE,!1)},C=()=>{v()?.exitTerminal()},$=async()=>{if(i.value){const u=await mt(i.value);_(u)}},P=(u,h)=>{r.removeTerminal(u,h)},W=()=>{S.value="--"},z=()=>{e.query.script===et.INSTALL&&$()},j=u=>{if(ee.isWindows())return;y();const h=pt(u);v()?.runCommand(h),N()},k=async()=>{ee.isWindows()?B.needPreStartApp(l.value?.installName)&&(N(),setTimeout(()=>{m.value=!0},200)):m.value=!0},d=()=>{a.value?.updateAppEnvData()};return(u,h)=>(D(),E(Fe,null,{default:c(()=>[w(je,{elevation:"1",class:"px-2"},{prepend:c(()=>[w(Se,{src:f(i)?.icon,width:"60",height:"60"},null,8,["src"]),w(Ge,null,{default:c(()=>[T(A(f(i)?.name),1)]),_:1}),f(l)?.version&&f(l)?.version!=="--"?(D(),E(He,{key:0},{default:c(()=>[T(A(u.$t("AppRunningWindow.Version"))+" "+A(f(l)?.version),1)]),_:1})):O("",!0)]),append:c(()=>[we(w(V,{stacked:"",onClick:R},{prepend:c(()=>[w(Se,{src:"./images/icons/lmd-logo.png",size:"20",width:"25",height:"25"})]),default:c(()=>[T(" "+A(u.$t("AppRunningWindow.Install")),1)]),_:1},512),[[Ae,f(p)]]),we(w(V,{"prepend-icon":"mdi-autorenew",stacked:"",onClick:x},{default:c(()=>[T(A(u.$t("AppRunningWindow.Update")),1)]),_:1},512),[[Ae,f(p)]]),f(s)?(D(),E(V,{key:0,stacked:"","prepend-icon":"mdi-stop",onClick:h[0]||(h[0]=L=>y())},{default:c(()=>[T(A(u.$t("AppRunningWindow.Stop")),1)]),_:1})):(D(),E(V,{key:1,stacked:"","prepend-icon":"mdi-play",onClick:h[1]||(h[1]=L=>N())},{default:c(()=>[T(A(u.$t("AppRunningWindow.Start")),1)]),_:1})),f(s)?(D(),E(V,{key:2,stacked:"","prepend-icon":"mdi-refresh-circle",onClick:h[2]||(h[2]=L=>M())},{default:c(()=>[T(A(u.$t("AppRunningWindow.Restart")),1)]),_:1})):O("",!0),w(Vt,{installedInstance:f(l)},null,8,["installedInstance"])]),_:1}),w(Ye,{class:"mx-1 running-window-main mb-3"},{default:c(()=>[w(ie,{fluid:"",class:"d-flex flex-column",style:{height:"100%"}},{default:c(()=>[f(l)&&f(i)&&f(m)?(D(),E(Pt,{key:0,ref_key:"appEnvAndAccessComponent",ref:a,onAppEnvSavedAndUpdated:j,lmAppData:f(i),installedInstance:f(l)},null,8,["lmAppData","installedInstance"])):O("",!0),w(qe,{class:"mx-2",modelValue:f(r).currentTerminalTab,"onUpdate:modelValue":h[3]||(h[3]=L=>f(r).currentTerminalTab=L),"align-tabs":"start",color:"primary"},{default:c(()=>[(D(!0),F(K,null,te(f(r).terminals,(L,Q)=>(D(),E(Ze,{value:L.tabName,key:L.tabName},{append:c(()=>[L.closable?(D(),E(Ee,{key:0,icon:"mdi-close-circle-outline",onClick:Ce(q=>P(L,Q),["stop"])},null,8,["onClick"])):O("",!0)]),default:c(()=>[T(" "+A(L.text),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"]),w(Ke,{modelValue:f(r).currentTerminalTab,"onUpdate:modelValue":h[4]||(h[4]=L=>f(r).currentTerminalTab=L),class:"mx-2 my-0 px-0 pt-0 mb-0",style:{flex:"1","background-color":"black"}},{default:c(()=>[(D(!0),F(K,null,te(f(r).terminals,(L,Q)=>(D(),E(Qe,{style:{flex:"1"},key:L.text,value:L.tabName,eager:""},{default:c(()=>[L.tabName==="main-process"?(D(),E(Ie,{key:0,ref_for:!0,ref_key:"generalTerminal",ref:o,socketURI:"ws://localhost:19312"},null,512)):(D(),E(Ie,{key:1,onExecuteEnd:d,"command-execute-end-keywords":L.commandExecuteEndKeywords,initCommand:L.initCommand,socketURI:"ws://localhost:19312"},null,8,["command-execute-end-keywords","initCommand"]))]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}))}});export{jt as default};
