import{e as a,$ as e,a1 as l,a2 as n,k as t,ab as s,S as i,K as o,a0 as d,b as p,H as c,a3 as u,F as r,a4 as m,u as v,l as f,a5 as y,j as w,m as g,Y as A,a as x,a9 as _}from"./vue.js";import{u as I}from"./lmapp.js";import{_ as h,O as E,a as S,u as b,D as k,b as D,g as N,c as T,d as R,e as M}from"./delete-confirm-dialog.js";import{g as $,I as F}from"./lmd-system.js";import{a as W,A as C}from"./install-instance.js";import{c as j,o as U,b as z}from"./index.js";import{x as L,B as O,m as V,K as H,I as B,c as P,a as G,A as K,C as q,L as Q,E as Y,o as J,b as X,l as Z,H as aa,M as ea,N as la,g as na,O as ta,P as sa,d as ia,Q as oa}from"./vuetify.js";import{A as da,O as pa}from"./AppInfoUtil.js";import{p as ca}from"./pretty-bytes.js";import"./pinia.js";import"./xterm.js";import"./debounce.js";import"./vuei18n.js";import"./lmd-locales.js";const ua={class:"d-flex"},ra=a({__name:"floating-title-card",props:{title:{}},setup:a=>(a,p)=>(d(),e(L,{class:"floating-title-card mt-4",variant:"outlined"},{default:l((()=>[n("div",ua,[t(O,{class:"floating-title mx-1",style:{flex:"1"}},{default:l((()=>[i(o(a.title),1)])),_:1}),s(a.$slots,"append")]),n("div",null,[s(a.$slots,"default")])])),_:3}))}),ma=a({__name:"app-env-row",props:{installedInstance:{},appEnv:{}},setup(a){const n=p(null);c((async()=>{n.value=await j()}));const s=a=>"HF_MIRROR"===a?"HF_ENDPOINT":a;return(a,p)=>(d(),e(ra,{title:a.$t("AppRunningWindow.EnvVars")},{default:l((()=>[t(V,{class:"my-1 pt-1 pb-5 mx-5"},{default:l((()=>[(d(!0),u(r,null,m(v(n),((a,n)=>(d(),e(H,{variant:"tonal",size:"x-small",style:{"min-width":"50px","max-width":"120px","margin-left":"4px"},key:n},{default:l((()=>[i(o(s(n))+" ",1),t(B,{activator:"parent",location:"bottom"},{default:l((()=>[i(o(a),1)])),_:2},1024)])),_:2},1024)))),128)),(d(!0),u(r,null,m(a.appEnv,((a,n)=>(d(),e(H,{variant:"tonal",size:"x-small",color:"orange-darken-4",style:{"min-width":"50px","max-width":"120px","margin-left":"4px"},key:n},{default:l((()=>[i(o(n)+" ",1),t(B,{activator:"parent",location:"bottom"},{default:l((()=>[i(o(a),1)])),_:2},1024)])),_:2},1024)))),128))])),_:1})])),_:1},8,["title"]))}}),va={key:0,class:"justify-center mr-6 mt-2"},fa=["href"],ya=a({__name:"app-access-row",props:{lmAppData:{},installedInstance:{},appEnv:{}},setup(a){const n=a,s=p([]),i=p(!1),w=p(!1),g=async()=>{if(n.lmAppData?.accessInfo){const a=n.lmAppData.accessInfo,{accessType:e}=a;if(!e)return!1;if("browser"===e)return s.value.push(n.lmAppData.accessInfo?.webUrl||""),!0;if("exec"===e&&da.appIsOllama(n.installedInstance?.installName)){if(n.appEnv){const a=n.appEnv[pa];s.value=await E.getAccessHosts(a)}return!0}}return!1};return c((async()=>{i.value=await g(),w.value=da.displayAccessSettingBtn(n.installedInstance?.installName)})),f((()=>n.appEnv),(async()=>{i.value=await g()})),(a,n)=>a.lmAppData&&v(i)?(d(),e(ra,{key:0,title:a.$t("AppRunningWindow.Access")},{append:l((()=>[v(w)?(d(),u("div",va,[t(h,{installedInstance:a.installedInstance},null,8,["installedInstance"])])):y("",!0)])),default:l((()=>[v(s)&&v(s).length>0?(d(),e(P,{key:0,class:"pt-1 pb-2"},{default:l((()=>[(d(!0),u(r,null,m(v(s),((a,n)=>(d(),e(G,{key:n,density:"compact","min-height":"1.1rem",class:"px-5"},{prepend:l((()=>[t(S,{text:a},null,8,["text"])])),default:l((()=>[(d(),u("a",{class:"mx-2",key:a,href:a,target:"_blank"},o(a),9,fa))])),_:2},1024)))),128))])),_:1})):y("",!0)])),_:1},8,["title"])):y("",!0)}}),wa={class:"justify-center mr-6 mt-2"},ga=a({__name:"model-download-row",props:{lmAppData:{},installedInstance:{},appEnv:{}},setup(a){const s=b(),m=p([]),x=p([]),_=p(!1),I=p(null),h=p(null),S=p(!1),D=p(!1),N=p(!1),T=p(""),{t:R}=K(),M=a;c((async()=>{$(),await C()})),f((()=>M.lmAppData),(()=>{$()})),f((()=>M.installedInstance),(()=>{C()})),f((()=>M.appEnv),(()=>{C()}));const $=()=>{_.value=da.appIsOllama(M.lmAppData?.installName)};f(I,(()=>{W()})),f(h,(a=>{F(a)}));const F=a=>{const e=x.value.find((e=>e.parameterSize===a));e&&(void 0===e.installed?(S.value=!0,D.value=!1):(S.value=!e.installed,D.value=e.installed))},W=()=>{const a=I.value,e=m.value.find((e=>e.installName===a)),l=e?.tags||[];if(x.value=l,l.length>0){const a=l[0].parameterSize;h.value=a,F(a)}},C=async()=>{const a=M.installedInstance?.installName;if(a&&_.value){m.value=[],x.value=[];const e=E.getDownloadableModels(),l=await da.mergeModelsList(a,e);if(m.value=l,console.log("mergedModelsList",l),I.value)W();else if(m.value&&m.value.length>0){const a=m.value[0];I.value=a.installName}}},j=()=>{const a=`${I.value}:${h.value}`;N.value=!0,T.value=a},U=async()=>{const a=`${I.value}:${h.value}`,e=da.genModelDeleteCommand(M.installedInstance?.installName,a),l=R("AppRunningWindow.ModelDeleteBtnLabel")+" "+a;if(e&&I.value&&da.appIsOllama(M.lmAppData?.installName)){const n=l+" "+R("AppRunningWindow.ModelDeleteSuccessful");s.addDeleteModelTerminal(a,l,e,n)}},z=async()=>{const a=`${I.value}:${h.value}`,e=da.genModelDownloadCommand(M.installedInstance?.installName,a),l=R("AppRunningWindow.ModelDownloadBtnLabel")+" "+a;if(e&&I.value&&da.appIsOllama(M.lmAppData?.installName)){const n=l+" "+R("AppRunningWindow.ModelDownloadSuccessful");s.addInstallModelTerminal(a,l,e,n)}};return(a,s)=>(d(),u(r,null,[a.lmAppData&&v(_)?(d(),e(ra,{key:0,title:a.$t("AppRunningWindow.ModelDownload")},{append:l((()=>[n("div",wa,[v(D)?(d(),u("a",{key:0,href:"#",onClick:A(j,["prevent"]),class:"del-btn",style:{color:"#F2313F"}},o(a.$t("AppRunningWindow.ModelDeleteBtnLabel")),1)):y("",!0)])])),default:l((()=>[t(V,{class:"mx-5 model-download-sheet mb-6"},{default:l((()=>[t(q,{class:"px-0 mt-3 mb-1",style:{color:"#4F4F67"}},{default:l((()=>[i(o(a.$t("AppRunningWindow.ModelName")),1)])),_:1}),t(Q,{items:v(m),"item-title":"displayName","item-value":"installName",modelValue:v(I),"onUpdate:modelValue":s[0]||(s[0]=a=>w(I)?I.value=a:null),variant:"outlined",density:"compact","hide-details":""},null,8,["items","modelValue"]),t(q,{class:"px-0 mt-3 mb-1",style:{color:"#4F4F67"}},{default:l((()=>[i(o(a.$t("AppRunningWindow.ParameterSize")),1)])),_:1}),t(Q,{items:v(x),"item-title":"parameterSize","item-value":"parameterSize",modelValue:v(h),"onUpdate:modelValue":s[1]||(s[1]=a=>w(h)?h.value=a:null),variant:"outlined",density:"compact","hide-details":""},{selection:l((({item:s})=>[i(o(s.title)+" ",1),t(H,{density:"default",class:"mx-1 file-size-chip"},{default:l((()=>[i(o(s.raw.fileSize),1)])),_:2},1024),s.raw.installed?(d(),e(H,{key:0,density:"default",class:"installed-chip"},{default:l((()=>[n("span",null,o(a.$t("AppRunningWindow.ModelDownloadedShort")),1)])),_:1})):(d(),e(H,{key:1,density:"default",class:"not-installed-chip"},{default:l((()=>[n("span",null,o(a.$t("AppRunningWindow.ModelNotDownloadedShort")),1)])),_:1}))])),item:l((({props:s,item:p})=>[t(G,g(s,{density:"compact"}),{title:l((()=>[i(o(p.title)+" ",1),t(H,{density:"compact",class:"mx-1 file-size-chip"},{default:l((()=>[i(o(p.raw.fileSize),1)])),_:2},1024),p.raw.installed?(d(),e(H,{key:0,density:"compact",class:"installed-chip"},{default:l((()=>[n("span",null,o(a.$t("AppRunningWindow.ModelDownloaded")),1)])),_:1})):(d(),e(H,{key:1,density:"compact",class:"not-installed-chip"},{default:l((()=>[n("span",null,o(a.$t("AppRunningWindow.ModelNotDownloaded")),1)])),_:1}))])),_:2},1040)])),_:1},8,["items","modelValue"]),v(S)?(d(),e(Y,{key:0,class:"text-center justify-center pt-6"},{default:l((()=>[t(J,{onClick:z,variant:"flat","min-width":"8rem",color:"primary"},{default:l((()=>[i(o(a.$t("AppRunningWindow.ModelDownloadBtnLabel")),1)])),_:1})])),_:1})):y("",!0)])),_:1})])),_:1},8,["title"])):y("",!0),t(k,{"model-value":v(N),"onUpdate:modelValue":s[2]||(s[2]=a=>N.value=a),"item-name":v(T),onConfirm:U},null,8,["model-value","item-name"])],64))}}),Aa={class:"justify-center mr-6 mt-2"},xa={class:"d-flex"},_a={class:"d-flex flex-row ml-9 mt-1",style:{"font-size":"14px"}},Ia={style:{flex:"1"}},ha=a({__name:"app-model-storage-row",props:{installedInstance:{},appEnv:{}},setup(a){const s=a,u=p(""),r=p(""),m=p(""),w=p(0),x=p(null);c((async()=>{da.appIsOllama(s.installedInstance?.installName)&&(await E(),S())}));const _=p(null),{t:I}=K(),E=async()=>{const a=await $();r.value=a+"/.ollama/models"},S=async()=>{const a=await da.getModelsDir(s.installedInstance?.installName,s.appEnv);console.log("dir",a),u.value=a||r.value,console.log("modelDir.value",u.value);const e=await da.getModelFileSize(s.installedInstance?.installName,u.value);_.value=ca(e.dirSize),x.value=e,console.log("dirInfo",e),b()},b=()=>{if(!x.value)return;let a=0;try{a=x.value?.totalSpace-x.value.dirSize-x.value.freeSpace,w.value=x.value?.totalSpace-x.value.freeSpace}catch(t){console.error("calculate error",t)}const e=ca(a),l=ca(x.value.freeSpace),n=`${I("AppRunningWindow.StorageModelsSize")}: ${_.value},\n  ${I("AppRunningWindow.StorageDiskOther")}: ${e},\n  ${I("AppRunningWindow.StorageDiskFreeSpace")}: ${l}\n  `;m.value=n};f((()=>s.appEnv),(a=>{S()})),f((()=>s.installedInstance),(a=>{S()}));const k=async()=>{U(u.value)};return(a,s)=>v(_)?(d(),e(ra,{key:0,title:a.$t("AppRunningWindow.ModelStorageLabel")},{append:l((()=>[n("div",Aa,[t(h,{installedInstance:a.installedInstance},null,8,["installedInstance"])])])),default:l((()=>[t(V,{class:"mt-3 pb-3 px-5"},{default:l((()=>[n("div",xa,[t(X,{src:"./images/icons/harddisk.svg",class:"mr-1",width:"32",height:"16"}),t(B,{text:v(m),location:"top"},{activator:l((({props:a})=>[t(Z,g({class:"custom-progress-bar"},a,{location:null,"bg-color":"#FFFFFF","bg-opacity":"1","buffer-color":"#DFDFEC","buffer-opacity":"1",opacity:"1",color:"#FEF1E5",height:"14",max:v(x)?.totalSpace||10,min:"0","buffer-value":v(w),"model-value":v(x)?.dirSize,rounded:""}),null,16,["max","buffer-value","model-value"])])),_:1},8,["text"])]),n("div",_a,[n("div",Ia,o(v(x)?.diskName),1),n("a",{href:"#",onClick:A(k,["prevent"])},[i(o(v(_))+" > ",1),v(u)?(d(),e(B,{key:0,activator:"parent",location:"top"},{default:l((()=>[i(o(v(u)),1)])),_:1})):y("",!0)])])])),_:1})])),_:1},8,["title"])):y("",!0)}}),Ea=a({__name:"app-env-and-access",props:{installedInstance:{},lmAppData:{}},emits:["appEnvSavedAndUpdated"],setup(a,{expose:e,emit:l}){const n=a,s=b(),i=p({}),o=l;c((async()=>{m()}));const m=async()=>{const a=n.installedInstance?.installName;da.appIsOllama(a)&&(i.value=await E.getOSEnvObj()||{})};return e({updateAppEnvData:m}),f((()=>n.installedInstance),(()=>{m()})),f((()=>s.appSettingsSaved),(async a=>{a&&(i.value=null,await m(),o("appEnvSavedAndUpdated",i.value))})),(a,e)=>v(i)&&a.installedInstance?(d(),u(r,{key:0},[t(ga,{appEnv:v(i),installedInstance:a.installedInstance,lmAppData:a.lmAppData},null,8,["appEnv","installedInstance","lmAppData"]),t(ha,{appEnv:v(i),installedInstance:a.installedInstance},null,8,["appEnv","installedInstance"]),t(ya,{appEnv:v(i),lmAppData:a.lmAppData,installedInstance:a.installedInstance},null,8,["appEnv","lmAppData","installedInstance"]),t(ma,{appEnv:v(i),installedInstance:a.installedInstance},null,8,["appEnv","installedInstance"])],64)):y("",!0)}}),Sa={class:"d-flex flex-row"},ba={class:"d-flex flex-column justify-center"},ka=a({__name:"AppRunningWindow",setup(a){const s=_(),f=I(),w=p(null),g=p(),h=p(),E=p(null),S=p(!1),k=p(!1),$=p("--"),j=p(""),{t:U}=K(),{addToast:L}=z(),H=b();x((()=>!(S.value&&!f.currentLmApp.runtimeUpdateAllowed))),c((async()=>{B();const a=s.params.id,e=await W(a);E.value=e;const l=e.appId;await f.fetchApp(l),w.value=f.currentLmApp,window.ipcRenderer?.on(F.STOP_AI_RUNNING_INSTANCE,((a,...e)=>{Z(),pa()})),ua();const n=w?.value.name;document.title=n}));const B=()=>{const a=U("AppRunningWindow.MainProcessTab");H.initTerminal(a)},P=a=>{j.value=a;let e="";a===C.INSTALL&&(e=U("AppRunningWindow.InstallSuccess")),console.log("changeMainTerminalScriptType",a,e),H.changeMainTerminalScriptType(a,e)},G=async()=>{if(P(C.START),S.value=!0,w.value){const a=await N(w.value);Y(a),window.ipcRenderer?.send(F.RUNNING_STATUS_CHANGE,!0)}},Q=()=>Array.isArray(g.value)?g.value[0]:g.value,Y=a=>{const e=Q();console.log("main terminal run command",e,a),e?.runCommand(a)},Z=()=>{S.value=!1,ca(),Q()?.runStopCommand(),window.ipcRenderer.send(F.RUNNING_STATUS_CHANGE,!1)},pa=()=>{Q()?.exitTerminal()},ca=()=>{$.value="--"},ua=()=>{const a=s.query.script;a===C.INSTALL?((async()=>{if(P(C.INSTALL),w.value){const a=await T(w.value);Y(a)}})(),va()):a===C.START&&ma()},ra=a=>{if(D.isWindows())return;Z();const e=R(a);Q()?.runCommand(e),G()},ma=async()=>{if(G(),da.needPreStartApp(E.value?.installName))return D.isMacOS()?void setTimeout((()=>{va()}),1e3):void 0;va()},va=()=>{k.value=!0},fa=a=>{console.log("onCommandExecuteEnd",a),a&&L(a,"success"),setTimeout((()=>{h.value?.updateAppEnvData()}),400)};return(a,s)=>(d(),e(ta,null,{default:l((()=>[t(aa,{elevation:"0",class:"px-6 running-app-bar",height:"92",style:{"background-color":"#F3F3FA"}},{prepend:l((()=>[n("div",Sa,[t(X,{src:v(w)?.icon,width:"60",height:"60"},null,8,["src"]),n("div",ba,[t(O,{class:"pt-1 pb-0"},{default:l((()=>[i(o(v(w)?.name),1)])),_:1}),v(E)?.version&&"--"!==v(E)?.version?(d(),e(q,{key:0,class:"py-0"},{default:l((()=>[i(o(a.$t("AppRunningWindow.Version"))+" "+o(v(E)?.version),1)])),_:1})):y("",!0)])])])),append:l((()=>[v(S)?(d(),e(J,{key:0,variant:"flat",color:"#F2313F",class:"mx-2",width:"80",height:"40",onClick:s[0]||(s[0]=a=>Z())},{default:l((()=>[i(o(a.$t("AppRunningWindow.Stop")),1)])),_:1})):(d(),e(J,{key:1,color:"primary",variant:"flat",class:"mx-2",width:"80",height:"40",onClick:s[1]||(s[1]=a=>G())},{default:l((()=>[i(o(a.$t("AppRunningWindow.Start")),1)])),_:1}))])),_:1}),t(na,{class:"running-window-main mb-0 d-flex"},{default:l((()=>[t(V,{fluid:"",class:"d-flex flex-column",style:{height:"100%",flex:"1","min-width":"0",overflow:"hidden"}},{default:l((()=>[t(ea,{class:"mx-0",modelValue:v(H).currentTerminalTab,"onUpdate:modelValue":s[2]||(s[2]=a=>v(H).currentTerminalTab=a),"align-tabs":"start",color:"primary"},{default:l((()=>[(d(!0),u(r,null,m(v(H).terminals,((a,n)=>(d(),e(sa,{value:a.tabName,key:a.tabName},{append:l((()=>[a.closable?(d(),e(ia,{key:0,icon:"mdi-close-circle-outline",onClick:A((e=>((a,e)=>{H.removeTerminal(a,e)})(a,n)),["stop"])},null,8,["onClick"])):y("",!0)])),default:l((()=>[i(" "+o(a.text),1)])),_:2},1032,["value"])))),128))])),_:1},8,["modelValue"]),t(la,{modelValue:v(H).currentTerminalTab,"onUpdate:modelValue":s[3]||(s[3]=a=>v(H).currentTerminalTab=a),class:"mx-0 my-0 pt-0 mb-0",style:{flex:"1","padding-left":"4px","background-color":"black","padding-bottom":"6px"}},{default:l((()=>[(d(!0),u(r,null,m(v(H).terminals,((a,n)=>(d(),e(oa,{style:{flex:"1"},key:a.text,value:a.tabName,eager:""},{default:l((()=>["main-process"===a.tabName?(d(),e(M,{key:0,onExecuteEnd:e=>{return l=a.commandExecuteEndToastMsg,va(),console.log("onMainTerminalCommandEnd"),void fa(l);var l},"command-execute-end-keywords":a.commandExecuteEndKeywords,ref_for:!0,ref_key:"generalTerminal",ref:g,socketURI:"ws://localhost:19312"},null,8,["onExecuteEnd","command-execute-end-keywords"])):(d(),e(M,{key:1,onExecuteEnd:e=>fa(a.commandExecuteEndToastMsg),"command-execute-end-keywords":a.commandExecuteEndKeywords,initCommand:a.initCommand,socketURI:"ws://localhost:19312"},null,8,["onExecuteEnd","command-execute-end-keywords","initCommand"]))])),_:2},1032,["value"])))),128))])),_:1},8,["modelValue"])])),_:1}),t(V,{class:"running-app-right-side-bar"},{default:l((()=>[v(E)&&v(w)&&v(k)?(d(),e(Ea,{key:0,ref_key:"appEnvAndAccessComponent",ref:h,onAppEnvSavedAndUpdated:ra,lmAppData:v(w),installedInstance:v(E)},null,8,["lmAppData","installedInstance"])):y("",!0)])),_:1})])),_:1})])),_:1}))}});export{ka as default};
