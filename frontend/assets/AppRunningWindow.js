import{e,b as a,G as t,V as l,a1 as n,_ as s,a0 as i,Z as o,$ as r,j as d,aa as c,Q as p,a3 as u,F as m,a2 as v,u as f,o as g,c as S,W as A,k as w,a4 as h,m as y,d as _,a8 as b}from"./vue.js";import{u as I}from"./lmapp.js";import{r as D,a as x,b as E}from"./xterm.js";import{g as M,e as T,d as L,f as R,I as N,_ as k,o as C}from"./index.js";import{g as z,a as $,s as O,b as V,c as B,d as W,D as F,e as P,I as U}from"./common-util.js";import{a as G,A as j}from"./install-instance.js";import{t as H,z as K,C as q,J as Q,H as J,B as X,s as Z,K as Y,d as ee,E as ae,h as te,y as le,L as ne,M as se,N as ie,b as oe,c as re,a as de,A as ce,O as pe,G as ue,F as me,P as ve,Q as fe,f as ge,R as Se,S as Ae,T as we}from"./vuetify.js";import{d as he}from"./pinia.js";import{p as ye}from"./pretty-bytes.js";import"./debounce.js";import"./vuei18n.js";import"./lmd-locales.js";var _e=D(),be=x(),Ie=E();class De{static getLMDScriptRepoUrl(e){let a="https://gitee.com/lmdown/lmd-install-scripts";if(e?.downloadInfo&&e?.downloadInfo.length>0){a=e.downloadInfo[0].scriptGitRepoUrl}return{repoUrl:a,repoLocalFolderName:this.getLastPathSegment(a)||"lmd-install-scripts"}}static getLastPathSegment(e){const a=e.match(/[^\/?#]+(?=[/?#]*$)/);return a?a[0]:null}}const xe=async e=>{const a=e.installName,t=(await M()).LMD_SCRIPTS_DIR,{repoUrl:l,repoLocalFolderName:n}=De.getLMDScriptRepoUrl(e),s=(e=>"0"===T("UPDATE_INSTALL_SCRIPTS")?"":`\ngit clone --depth=1 ${e} $LMD_BASE_INSTALL_SCRIPT_DIR\ncd $LMD_BASE_INSTALL_SCRIPT_DIR && git fetch origin master && git reset --hard origin/master`)(l);console.log("repoLocalFolderName",n);return`\nexport LMD_BASE_INSTALL_SCRIPT_DIR="${t}/${n}"\n${s}\nsh $LMD_BASE_INSTALL_SCRIPT_DIR/apps/${a}/install.sh`};class Ee{static isWindows(){const e=navigator.userAgentData;return e&&e.platform?"Windows"===e.platform:!!navigator.userAgent&&/Win(dows )?NT/.test(navigator.userAgent)}static isMacOS(){const e=navigator.userAgentData;return e&&e.platform?"macOS"===e.platform||"MacOS"===e.platform:!!navigator.userAgent&&/Macintosh|Mac OS X/i.test(navigator.userAgent)}}const Me=e({__name:"index",props:{socketURI:{},initCommand:{},commandExecuteEndKeywords:{}},emits:["executeEnd"],setup(e,{expose:o,emit:r}){const d=r,c=a([]),p=a(!1),u=e,m=a(null),v=a(null),f=a(null),g=a(null);let S;t((()=>{y(),h()})),l((()=>{m.value?.close(),v.value?.dispose(),S&&g.value&&(S.unobserve(g.value),S.disconnect())}));const A=e=>{console.log("runCommand",e),console.log("runCommand socket.value",m.value),m.value?.send(e+"\n")};o({runCommand:A,runStopCommand:()=>{A("")},exitTerminal:()=>{A("exit")}});const w=L((e=>{for(const a of e){let e=a.contentRect.height;Ee.isMacOS()&&(e-=12),M(a.contentRect.width,e)}}),50),h=()=>{f.value&&(S=new ResizeObserver(w),S.observe(f.value))},y=()=>{m.value=new WebSocket(u.socketURI),I(),b(),D(),_()},_=()=>{m.value&&(m.value.onmessage=e=>{const a=e.data,t=u.commandExecuteEndKeywords;t&&(t.forEach((e=>{a.includes(e)&&!c.value.includes(e)&&c.value.push(e)})),c.value.length===t.length&&(d("executeEnd"),p.value=!0,c.value=[]))})},b=()=>{m.value&&(m.value.onopen=()=>{(()=>{if(!g.value)return;if(!m.value)return;const e=new window.Terminal({fontSize:14,cursorBlink:!0}),a=new be.AttachAddon(m.value),t=new _e.FitAddon,l=new Ie.WebLinksAddon(((e,a)=>{const t=document.createElement("a");t.setAttribute("href",a),t.setAttribute("target","_blank"),t.setAttribute("id","lmdTempLink");const l=document.getElementById("lmdTempLink");l&&document.body.removeChild(l),document.body.appendChild(t),t.click()}));e.loadAddon(a),e.loadAddon(t),e.loadAddon(l),e.open(g.value),t.fit(),e.focus(),v.value=e})(),u.initCommand&&A(u.initCommand)})},I=()=>{m.value&&(m.value.onclose=e=>{console.log("close socket",e)})},D=()=>{m.value&&(m.value.onerror=e=>{console.log("socket 链接失败",e)})},x=a(80),E=a(30),M=(e,a)=>{const t=Math.floor(e/8.5),l=Math.round(a/16);if(console.log("cols",e,t),console.log("rows",a,l),0!==l&&0!==t&&(x.value!==t||E.value!==l)){x.value=t,E.value=l,v.value?.resize(t,l);const e=`lmd_action:resize:${t},${l}`;m.value?.send(e)}};return(e,a)=>(s(),n("div",{ref_key:"terminalOutContainer",ref:f,class:"mb-0",style:{height:"100%",width:"100%"}},[i("div",{ref_key:"terminalContainer",ref:g,class:"terminal",style:{height:"300px",width:"100%"}},null,512)],512))}}),Te=["OLLAMA_MODELS","OLLAMA_HOST","OLLAMA_ACCESS_PATH_LMD"],Le=[{displayName:"Deepseek-R1",installName:"deepseek-r1",tags:[{parameterSize:"1.5b",fileSize:"1.1GB"},{parameterSize:"7b",fileSize:"4.7GB"},{parameterSize:"8b",fileSize:"4.9GB"},{parameterSize:"14b",fileSize:"9.0GB"},{parameterSize:"32b",fileSize:"20GB"},{parameterSize:"70b",fileSize:"43GB"},{parameterSize:"671b",fileSize:"404GB"}]},{displayName:"QwQ",installName:"qwq",tags:[{parameterSize:"32b",fileSize:"20GB"}]},{displayName:"Llama 3.1",installName:"llama3.1",tags:[{parameterSize:"8b",fileSize:"4.9GB"},{parameterSize:"70b",fileSize:"43GB"},{parameterSize:"405b",fileSize:"243GB"}]},{displayName:"Qwen 2.5",installName:"qwen2.5",tags:[{parameterSize:"0.5b",fileSize:"398MB"},{parameterSize:"1.5b",fileSize:"986MB"},{parameterSize:"3b",fileSize:"1.9GB "},{parameterSize:"7b",fileSize:"4.7GB"},{parameterSize:"14b",fileSize:"9.0GB"},{parameterSize:"32b",fileSize:"20GB"},{parameterSize:"72b",fileSize:"47GB"}]},{displayName:"Mistral",installName:"mistral",tags:[{parameterSize:"7b",fileSize:"4.1GB"}]},{displayName:"Phi-4",installName:"phi4",tags:[{parameterSize:"14b",fileSize:"9.1GB"}]},{displayName:"Qwen 2.5 Coder",installName:"qwen2.5-coder",tags:[{parameterSize:"0.5b",fileSize:"531MB"},{parameterSize:"1.5b",fileSize:"986MB"},{parameterSize:"3b",fileSize:"1.9GB"},{parameterSize:"7b",fileSize:"4.7GB"},{parameterSize:"14b",fileSize:"9.0GB"},{parameterSize:"32b",fileSize:"20GB"}]}];class Re{static async getAppSettings(){const e=await this.getOSEnvObj();return{modelsDir:e.OLLAMA_MODELS,externalAccessHost:e.OLLAMA_HOST,externalAccessPath:e.OLLAMA_ACCESS_PATH_LMD}}static async getOSEnvObj(){return await z(Te)}static async getAccessHosts(e){const a="11434",t=[`http://127.0.0.1:${a}`];if(e&&"127.0.0.1"!==e){const l=e.split(":"),n=l[0];let s=[n];const i=l[1]||a;"0.0.0.0"===n&&(s=await $()),s&&s.length>0&&s.forEach((e=>{t.push(`http://${e}:${i}`)}))}else;return t}static async saveAppSettings(e,a){e.modelsDir===a&&(e.modelsDir="");const t={OLLAMA_MODELS:e.modelsDir,OLLAMA_HOST:e.externalAccessHost,OLLAMA_ACCESS_PATH_LMD:e.externalAccessPath};return await O(t)}static getDownloadableModels(){return JSON.parse(JSON.stringify(Le))}}const Ne={class:"d-flex"},ke=e({__name:"floating-title-card",props:{title:{}},setup:e=>(e,a)=>(s(),o(H,{class:"floating-title-card mt-4",variant:"outlined"},{default:r((()=>[i("div",Ne,[d(K,{class:"floating-title mx-1",style:{flex:"1"}},{default:r((()=>[p(u(e.title),1)])),_:1}),c(e.$slots,"append")]),i("div",null,[c(e.$slots,"default")])])),_:3}))}),Ce=e({__name:"app-env-row",props:{installedInstance:{},appEnv:{}},setup(e){const l=a(null);t((async()=>{l.value=await R()}));const i=e=>"HF_MIRROR"===e?"HF_ENDPOINT":e;return(e,a)=>(s(),o(ke,{title:e.$t("AppRunningWindow.EnvVars")},{default:r((()=>[d(q,{class:"my-1 pt-1 pb-5 mx-5"},{default:r((()=>[(s(!0),n(m,null,v(f(l),((e,a)=>(s(),o(Q,{variant:"tonal",size:"x-small",style:{"min-width":"50px","max-width":"120px","margin-left":"4px"},key:a},{default:r((()=>[p(u(i(a))+" ",1),d(J,{activator:"parent",location:"bottom"},{default:r((()=>[p(u(e),1)])),_:2},1024)])),_:2},1024)))),128)),(s(!0),n(m,null,v(e.appEnv,((e,a)=>(s(),o(Q,{variant:"tonal",size:"x-small",color:"orange-darken-4",style:{"min-width":"50px","max-width":"120px","margin-left":"4px"},key:a},{default:r((()=>[p(u(a)+" ",1),d(J,{activator:"parent",location:"bottom"},{default:r((()=>[p(u(e),1)])),_:2},1024)])),_:2},1024)))),128))])),_:1})])),_:1},8,["title"]))}});class ze{static appIsOllama(e){return"ollama"===e}static appIsSillyTavern(e){return"sillytavern"===e}static displayAccessSettingBtn(e){return this.appIsOllama(e)}static async getModelFileSize(e,a){if(console.log("getModelFileSize",e,a),this.appIsOllama(e)&&a&&a){return await V(a)}return{}}static async getModelsDir(e,a){return this.appIsOllama(e)&&a?a.OLLAMA_MODELS:""}static genModelDownloadCommand(e,a){return this.appIsOllama(e)&&a?`\nollama pull ${a}`:""}static genModelDeleteCommand(e,a){return this.appIsOllama(e)&&a?`\nollama rm ${a}`:""}static async mergeModelsList(e,a){if(e){const t=await B(e);console.log("installedModelList",t),t.forEach((e=>{const[t,l]=e.name.split(":"),n=a.find((e=>e.installName===t));if(n){const a=n.tags.find((e=>e.parameterSize===l));a?a.installed=!0:n.tags.push({parameterSize:l,fileSize:e.size||"",installed:!0})}else a.push({displayName:t,installName:t,tags:[{parameterSize:l,fileSize:e.size||"",installed:!0}]})}))}return a}static killAppProcessed(e){if(this.appIsOllama(e)){(async e=>{if(window.ipcRenderer)await(window.ipcRenderer?.invoke(N.KILL_PROCESSES,e))})(["ollama.exe","ollama app.exe","ollama","Ollama"])}}static needPreStartApp(e){return!!this.appIsOllama(e)}}const $e=he("runningInstance",{state:()=>({runningInstances:[],appSettingsSaved:!1,terminals:[],currentTerminalTab:""}),actions:{addRunningInstance(e){this.runningInstances.find((a=>a.id===e.id))||this.runningInstances.push(e)},removeRunningInstance(e){const a=this.runningInstances.findIndex((a=>a.id===e.id));-1!=a&&this.runningInstances.splice(a,1)},resetAppSettingsSavedStatus(){this.appSettingsSaved=!1},onAppSettingsSaved(){this.appSettingsSaved=!0},changeMainTerminalScriptType(e,a){try{const t=this.terminals[0];t.commandExecuteEndKeywords=[`lmd ${e} script end.`],t.commandExecuteEndToastMsg=a}catch(t){console.error(t)}},initTerminal(e){const a={icon:"mdi-application-brackets-outline",text:e,tabName:"main-process",closable:!1};this.terminals=[a],this.currentTerminalTab=a.tabName},addTerminal(e){this.terminals.find((a=>a.tabName===e.tabName))||(console.log("addTerminal",e.commandExecuteEndKeywords),this.terminals.push(e)),this.currentTerminalTab=e.tabName},removeTerminal(e,a){this.currentTerminalTab="main-process",this.terminals.splice(a,1)},addInstallModelTerminal(e,a,t,l){const n={text:a,tabName:a,initCommand:t,closable:!0,commandExecuteEndKeywords:["digest","writing manifest","success"],commandExecuteEndToastMsg:l};this.addTerminal(n)},addDeleteModelTerminal(e,a,t,l){const n={text:a,tabName:a,initCommand:t,closable:!0,commandExecuteEndKeywords:[`deleted '${e}'`],commandExecuteEndToastMsg:l};this.addTerminal(n)}}});class Oe{static generateRandomString(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",a=Math.floor(5*Math.random())+8;let t="";for(let l=0;l<a;l++)t+=e.charAt(Math.floor(62*Math.random()));return/[A-Z]/.test(t)||(t=this.insertRandomChar(t,"ABCDEFGHIJKLMNOPQRSTUVWXYZ")),/[a-z]/.test(t)||(t=this.insertRandomChar(t,"abcdefghijklmnopqrstuvwxyz")),/\d/.test(t)||(t=this.insertRandomChar(t,"0123456789")),t}static insertRandomChar(e,a){const t=a.charAt(Math.floor(Math.random()*a.length)),l=Math.floor(Math.random()*e.length);return e.slice(0,l)+t+e.slice(l)}}class Ve{static LOCAL_ACCESS=1;static REMOTE_ACCESS=2}const Be={style:{"font-size":"12px"}},We=e({__name:"ollama-settings-btn",props:{installedInstance:{}},setup(e){const{t:l}=X(),c=a(!1),v=a(!1),b=a(!1),I=a(!1),D=a(""),x=$e(),E=_("showToastMessage"),M=a({}),T=a(!0),L=a(1),R=e;g((()=>R.installedInstance),(()=>{k()}));const k=()=>{oe()?c.value=!0:c.value=!1};t((()=>{k()}));const C=async()=>{v.value=!0,await z(),await q()},z=async()=>{const e=await P();D.value=e+"/.ollama/models"},$=async()=>{if(!b.value)return;if(!M)return;if(""===D.value){const e=l("AppSettingDialog.DataNotValid");return void(E&&E(e,"error"))}I.value=!0;const e=Object.assign({},M.value),a=await Re.saveAppSettings(e,D.value);console.log("save result ",a);const t=l("Common.saveSuccess");E&&E(t,"success"),I.value=!1,x.onAppSettingsSaved(),setTimeout((()=>{x.resetAppSettingsSavedStatus()}),100),v.value=!1,ze.killAppProcessed(R.installedInstance?.installName),Ee.isWindows()?setTimeout((()=>{(async()=>{if(window.ipcRenderer)await(window.ipcRenderer?.invoke(N.EXIT_APP))})()}),1500):(async()=>{if(window.ipcRenderer)await(window.ipcRenderer?.invoke(N.RESTART_APP))})()},O=async()=>{const e=await W(M.value.modelsDir,!0);e&&e.path&&(M.value.modelsDir=e.path,console.log("dirInfo",e),T.value=F.checkModelsDirValid(e,["blobs"]),console.log("dirValid.value",T.value))},V=[e=>!!e||l("Common.fieldRequired"),()=>T.value||l("AppSettingDialog.ModelsDirNotValid")],B=/^\/(?:[\w\-._~!$&'()*+,;=:@]|%[0-9a-fA-F]{2}){7,}$/,U=[e=>""===e||(B.test(e)&&e.length>=8||l("AppSettingDialog.PathNotValid"))],G=async()=>{M.value.modelsDir=D.value},j=S((()=>{if(oe())return l("AppSettingDialog.OllamaModelsDirInfoIconTip")})),q=async()=>{if(oe()){const e=await Re.getAppSettings();console.log("getOSEnvForCurrentApp",e),M.value=Object.assign({},e),""===e.modelsDir&&(console.log("getOSEnvForCurrentApp",e),M.value.modelsDir=D.value),Q()}},Q=()=>{const e=M.value.externalAccessHost;!e||e.startsWith("127.0.0.1")?L.value=Ve.LOCAL_ACCESS:(L.value=Ve.REMOTE_ACCESS,de())},oe=()=>ze.appIsOllama(R.installedInstance?.installName),re=()=>{let e=l("AppSettingDialog.ModelsDirTip");return Ee.isWindows()?e+=l("AppSettingDialog.ModelsDirTipExtraWindows"):e+=l("AppSettingDialog.ModelsDirTipExtraMac"),e},de=()=>{const e=Oe.generateRandomString();M.value.externalAccessPath="/"+e},ce=S((()=>L.value===Ve.REMOTE_ACCESS));return(e,a)=>(s(),n(m,null,[i("a",{href:"#",class:"settings-link-btn",onClick:A(C,["prevent"])},u(e.$t("AppRunningWindow.Settings")),1),d(Z,{modelValue:f(v),"onUpdate:modelValue":a[6]||(a[6]=e=>w(v)?v.value=e:null),"min-width":"400","max-width":"800"},{default:r((()=>[e.installedInstance?(s(),o(H,{key:0,class:"mx-auto px-0 py-0 window-no-drag",width:"100%",title:e.$t("AppSettingDialog.Title")+e.installedInstance.name},{append:r((()=>[d(te,{icon:"mdi-close",class:"ms-auto",size:"compact",text:"Ok",elevation:"0",onClick:a[0]||(a[0]=e=>v.value=!1)})])),default:r((()=>[f(M)?(s(),o(Y,{key:0,class:"pt-0 pb-3 px-6",modelValue:f(b),"onUpdate:modelValue":a[5]||(a[5]=e=>w(b)?b.value=e:null),onSubmit:A($,["prevent"])},{default:r((()=>[d(ee,{modelValue:f(M).modelsDir,"onUpdate:modelValue":a[1]||(a[1]=e=>f(M).modelsDir=e),density:"comfortable",readonly:f(I),rules:V,label:e.$t("AppSettingDialog.ModelsDirLabel")},{append:r((()=>[d(J,{location:"bottom"},{activator:r((({props:e})=>[d(ae,y(e,{icon:"mdi-information-slab-circle-outline"}),null,16)])),default:r((()=>[i("pre",null,u(f(j)),1)])),_:1}),d(te,{class:"ml-1",onClick:O},{default:r((()=>[p(u(e.$t("AppSettingDialog.Browse")),1)])),_:1}),d(te,{class:"ml-1",onClick:G},{default:r((()=>[p(u(e.$t("AppSettingDialog.UseDefaultValue")),1)])),_:1})])),_:1},8,["modelValue","readonly","label"]),d(le,{class:"pt-0"},{default:r((()=>[i("pre",Be,u(re()),1)])),_:1}),d(K,null,{default:r((()=>[p(u(e.$t("AppSettingDialog.AccessTypeLabel")),1)])),_:1}),d(ne,{modelValue:f(L),"onUpdate:modelValue":a[2]||(a[2]=e=>w(L)?L.value=e:null)},{default:r((()=>[d(se,{label:e.$t("AppSettingDialog.LocalAccessOnly"),value:1},null,8,["label"]),d(se,{label:e.$t("AppSettingDialog.RemoteAccessAllowed"),value:2},null,8,["label"])])),_:1},8,["modelValue"]),f(ce)?(s(),o(ee,{key:0,modelValue:f(M).externalAccessPath,"onUpdate:modelValue":a[3]||(a[3]=e=>f(M).externalAccessPath=e),density:"comfortable",readonly:f(I),rules:U,label:e.$t("AppSettingDialog.ServerAccessPathLabel")},{append:r((()=>[d(te,{onClick:de},{default:r((()=>[p(u(e.$t("AppSettingDialog.GenRandomPathLabel")),1)])),_:1})])),_:1},8,["modelValue","readonly","label"])):h("",!0),d(ie,{class:"text-center justify-center"},{default:r((()=>[d(te,{variant:"outlined",onClick:a[4]||(a[4]=e=>v.value=!1)},{default:r((()=>[p(u(e.$t("AppSettingDialog.close")),1)])),_:1}),d(te,{color:"primary",variant:"flat",type:"submit",loading:f(I)},{default:r((()=>[p(u(e.$t("AppSettingDialog.saveConfig")),1)])),_:1},8,["loading"])])),_:1})])),_:1},8,["modelValue"])):h("",!0)])),_:1},8,["title"])):h("",!0)])),_:1},8,["modelValue"])],64))}}),Fe=e({__name:"copy-link-icon",props:{text:{}},setup(e){const t=e,l=a(!1),n=()=>{l.value=!0,navigator.clipboard.writeText(t.text),setTimeout((()=>{l.value=!1}),1500)};return(e,a)=>(s(),o(oe,{width:"16",height:"16",onClick:n,src:"./images/icons/link.png",style:{cursor:"pointer"}},{default:r((()=>[d(J,{activator:"parent","open-on-hover":!1,location:"left",transition:"false",modelValue:f(l),"onUpdate:modelValue":a[0]||(a[0]=e=>w(l)?l.value=e:null)},{default:r((()=>[p(u(e.$t("App.Copied")),1)])),_:1},8,["modelValue"])])),_:1}))}}),Pe={key:0,class:"justify-center mr-6 mt-2"},Ue=["href"],Ge=e({__name:"app-access-row",props:{lmAppData:{},installedInstance:{},appEnv:{}},setup(e){const l=e,i=a([]),c=a(!1),p=a(!1),S=async()=>{if(l.lmAppData?.accessInfo){const e=l.lmAppData.accessInfo,{accessType:a}=e;if(!a)return!1;if("browser"===a)return i.value.push(l.lmAppData.accessInfo?.webUrl||""),!0;if("exec"===a&&ze.appIsOllama(l.installedInstance?.installName)){if(l.appEnv){const e=l.appEnv.OLLAMA_HOST;i.value=await Re.getAccessHosts(e)}return!0}}return!1};return t((async()=>{c.value=await S(),p.value=ze.displayAccessSettingBtn(l.installedInstance?.installName)})),g((()=>l.appEnv),(async()=>{c.value=await S()})),(e,a)=>e.lmAppData&&f(c)?(s(),o(ke,{key:0,title:e.$t("AppRunningWindow.Access")},{append:r((()=>[f(p)?(s(),n("div",Pe,[d(We,{installedInstance:e.installedInstance},null,8,["installedInstance"])])):h("",!0)])),default:r((()=>[f(i)&&f(i).length>0?(s(),o(re,{key:0,class:"pt-1 pb-2"},{default:r((()=>[(s(!0),n(m,null,v(f(i),((e,a)=>(s(),o(de,{key:a,density:"compact","min-height":"1.1rem",class:"px-5"},{prepend:r((()=>[d(Fe,{text:e},null,8,["text"])])),default:r((()=>[(s(),n("a",{class:"mx-2",key:e,href:e,target:"_blank"},u(e),9,Ue))])),_:2},1024)))),128))])),_:1})):h("",!0)])),_:1},8,["title"])):h("",!0)}}),je=k(e({__name:"delete-confirm-dialog",props:{modelValue:{type:Boolean},itemName:{}},emits:["update:modelValue","confirm"],setup(e,{emit:t}){const l=e,n=t,i=a(!1);g((()=>l.modelValue),(e=>{i.value=e}));const c=()=>{i.value=!1,n("update:modelValue",!1)},m=async()=>{n("confirm"),c()};return(e,a)=>(s(),o(Z,{modelValue:f(i),"onUpdate:modelValue":a[0]||(a[0]=e=>w(i)?i.value=e:null),"max-width":"400"},{default:r((()=>[d(H,null,{default:r((()=>[d(K,{class:"headline"},{default:r((()=>[p(u(e.$t("AppRunningWindow.ConfirmDelete")),1)])),_:1}),d(le,null,{default:r((()=>[p(u(e.$t("AppRunningWindow.ConfirmDeleteMsg"))+" "+u(e.itemName),1)])),_:1}),d(ie,{class:"justify-center"},{default:r((()=>[d(te,{variant:"outlined",onClick:c},{default:r((()=>[p(u(e.$t("AppRunningWindow.Cancel")),1)])),_:1}),d(te,{variant:"elevated",color:"#F2313F",onClick:m},{default:r((()=>[p(u(e.$t("AppRunningWindow.ModelDeleteBtnLabel")),1)])),_:1})])),_:1})])),_:1})])),_:1},8,["modelValue"]))}}),[["__scopeId","data-v-e8470424"]]),He={class:"justify-center mr-6 mt-2"},Ke=e({__name:"model-download-row",props:{lmAppData:{},installedInstance:{},appEnv:{}},setup(e){const l=$e(),c=a([]),v=a([]),S=a(!1),_=a(null),b=a(null),I=a(!1),D=a(!1),x=a(!1),E=a(""),{t:M}=X(),T=e;t((async()=>{L(),await k()})),g((()=>T.lmAppData),(()=>{L()})),g((()=>T.installedInstance),(()=>{k()})),g((()=>T.appEnv),(()=>{k()}));const L=()=>{S.value=ze.appIsOllama(T.lmAppData?.installName)};g(_,(()=>{N()})),g(b,(e=>{R(e)}));const R=e=>{const a=v.value.find((a=>a.parameterSize===e));a&&(void 0===a.installed?(I.value=!0,D.value=!1):(I.value=!a.installed,D.value=a.installed))},N=()=>{const e=_.value,a=c.value.find((a=>a.installName===e)),t=a?.tags||[];if(v.value=t,t.length>0){const e=t[0].parameterSize;b.value=e,R(e)}},k=async()=>{const e=T.installedInstance?.installName;if(e&&S.value){c.value=[],v.value=[];const a=Re.getDownloadableModels(),t=await ze.mergeModelsList(e,a);if(c.value=t,console.log("mergedModelsList",t),_.value)N();else if(c.value&&c.value.length>0){const e=c.value[0];_.value=e.installName}}},C=()=>{const e=`${_.value}:${b.value}`;x.value=!0,E.value=e},z=async()=>{const e=`${_.value}:${b.value}`,a=ze.genModelDeleteCommand(T.installedInstance?.installName,e),t=M("AppRunningWindow.ModelDeleteBtnLabel")+" "+e;if(a&&_.value&&ze.appIsOllama(T.lmAppData?.installName)){const n=t+" "+M("AppRunningWindow.ModelDeleteSuccessful");l.addDeleteModelTerminal(e,t,a,n)}},$=async()=>{const e=`${_.value}:${b.value}`,a=ze.genModelDownloadCommand(T.installedInstance?.installName,e),t=M("AppRunningWindow.ModelDownloadBtnLabel")+" "+e;if(a&&_.value&&ze.appIsOllama(T.lmAppData?.installName)){const n=t+" "+M("AppRunningWindow.ModelDownloadSuccessful");l.addInstallModelTerminal(e,t,a,n)}};return(e,a)=>(s(),n(m,null,[e.lmAppData&&f(S)?(s(),o(ke,{key:0,title:e.$t("AppRunningWindow.ModelDownload")},{append:r((()=>[i("div",He,[f(D)?(s(),n("a",{key:0,href:"#",onClick:A(C,["prevent"]),class:"del-btn",style:{color:"#F2313F"}},u(e.$t("AppRunningWindow.ModelDeleteBtnLabel")),1)):h("",!0)])])),default:r((()=>[d(q,{class:"mx-5 model-download-sheet mb-6"},{default:r((()=>[d(ce,{class:"px-0 mt-3 mb-1",style:{color:"#4F4F67"}},{default:r((()=>[p(u(e.$t("AppRunningWindow.ModelName")),1)])),_:1}),d(pe,{items:f(c),"item-title":"displayName","item-value":"installName",modelValue:f(_),"onUpdate:modelValue":a[0]||(a[0]=e=>w(_)?_.value=e:null),variant:"outlined",density:"compact","hide-details":""},null,8,["items","modelValue"]),d(ce,{class:"px-0 mt-3 mb-1",style:{color:"#4F4F67"}},{default:r((()=>[p(u(e.$t("AppRunningWindow.ParameterSize")),1)])),_:1}),d(pe,{items:f(v),"item-title":"parameterSize","item-value":"parameterSize",modelValue:f(b),"onUpdate:modelValue":a[1]||(a[1]=e=>w(b)?b.value=e:null),variant:"outlined",density:"compact","hide-details":""},{selection:r((({item:a})=>[p(u(a.title)+" ",1),d(Q,{density:"default",class:"mx-1 file-size-chip"},{default:r((()=>[p(u(a.raw.fileSize),1)])),_:2},1024),a.raw.installed?(s(),o(Q,{key:0,density:"default",class:"installed-chip"},{default:r((()=>[i("span",null,u(e.$t("AppRunningWindow.ModelDownloadedShort")),1)])),_:1})):(s(),o(Q,{key:1,density:"default",class:"not-installed-chip"},{default:r((()=>[i("span",null,u(e.$t("AppRunningWindow.ModelNotDownloadedShort")),1)])),_:1}))])),item:r((({props:a,item:t})=>[d(de,y(a,{density:"compact"}),{title:r((()=>[p(u(t.title)+" ",1),d(Q,{density:"compact",class:"mx-1 file-size-chip"},{default:r((()=>[p(u(t.raw.fileSize),1)])),_:2},1024),t.raw.installed?(s(),o(Q,{key:0,density:"compact",class:"installed-chip"},{default:r((()=>[i("span",null,u(e.$t("AppRunningWindow.ModelDownloaded")),1)])),_:1})):(s(),o(Q,{key:1,density:"compact",class:"not-installed-chip"},{default:r((()=>[i("span",null,u(e.$t("AppRunningWindow.ModelNotDownloaded")),1)])),_:1}))])),_:2},1040)])),_:1},8,["items","modelValue"]),f(I)?(s(),o(ie,{key:0,class:"text-center justify-center pt-6"},{default:r((()=>[d(te,{onClick:$,variant:"flat","min-width":"8rem",color:"primary"},{default:r((()=>[p(u(e.$t("AppRunningWindow.ModelDownloadBtnLabel")),1)])),_:1})])),_:1})):h("",!0)])),_:1})])),_:1},8,["title"])):h("",!0),d(je,{"model-value":f(x),"onUpdate:modelValue":a[2]||(a[2]=e=>x.value=e),"item-name":f(E),onConfirm:z},null,8,["model-value","item-name"])],64))}}),qe={class:"justify-center mr-6 mt-2"},Qe={class:"d-flex"},Je={class:"d-flex flex-row ml-9 mt-1",style:{"font-size":"14px"}},Xe={style:{flex:"1"}},Ze=e({__name:"app-model-storage-row",props:{installedInstance:{},appEnv:{}},setup(e){const l=e,n=a(""),c=a(""),m=a(""),v=a(0),S=a(null);t((async()=>{ze.appIsOllama(l.installedInstance?.installName)&&(await b(),I())}));const w=a(null),{t:_}=X(),b=async()=>{const e=await P();c.value=e+"/.ollama/models"},I=async()=>{const e=await ze.getModelsDir(l.installedInstance?.installName,l.appEnv);console.log("dir",e),n.value=e||c.value,console.log("modelDir.value",n.value);const a=await ze.getModelFileSize(l.installedInstance?.installName,n.value);w.value=ye(a.dirSize),S.value=a,console.log("dirInfo",a),D()},D=()=>{if(!S.value)return;let e=0;try{e=S.value?.totalSpace-S.value.dirSize-S.value.freeSpace,v.value=S.value?.totalSpace-S.value.freeSpace}catch(n){console.error("calculate error",n)}const a=ye(e),t=ye(S.value.freeSpace),l=`${_("AppRunningWindow.StorageModelsSize")}: ${w.value},\n  ${_("AppRunningWindow.StorageDiskOther")}: ${a},\n  ${_("AppRunningWindow.StorageDiskFreeSpace")}: ${t}\n  `;m.value=l};g((()=>l.appEnv),(e=>{I()})),g((()=>l.installedInstance),(e=>{I()}));const x=async()=>{C(n.value)};return(e,a)=>f(w)?(s(),o(ke,{key:0,title:e.$t("AppRunningWindow.ModelStorageLabel")},{append:r((()=>[i("div",qe,[d(We,{installedInstance:e.installedInstance},null,8,["installedInstance"])])])),default:r((()=>[d(q,{class:"mt-3 pb-3 px-5"},{default:r((()=>[i("div",Qe,[d(oe,{src:"./images/icons/harddisk.svg",class:"mr-1",width:"32",height:"16"}),d(J,{text:f(m),location:"top"},{activator:r((({props:e})=>[d(ue,y({class:"custom-progress-bar"},e,{location:null,"bg-color":"#FFFFFF","bg-opacity":"1","buffer-color":"#DFDFEC","buffer-opacity":"1",opacity:"1",color:"#FEF1E5",height:"14",max:f(S)?.totalSpace||10,min:"0","buffer-value":f(v),"model-value":f(S)?.dirSize,rounded:""}),null,16,["max","buffer-value","model-value"])])),_:1},8,["text"])]),i("div",Je,[i("div",Xe,u(f(S)?.diskName),1),i("a",{href:"#",onClick:A(x,["prevent"])},[p(u(f(w))+" > ",1),f(n)?(s(),o(J,{key:0,activator:"parent",location:"top"},{default:r((()=>[p(u(f(n)),1)])),_:1})):h("",!0)])])])),_:1})])),_:1},8,["title"])):h("",!0)}}),Ye=e({__name:"app-env-and-access",props:{installedInstance:{},lmAppData:{}},emits:["appEnvSavedAndUpdated"],setup(e,{expose:l,emit:i}){const o=e,r=$e(),c=a({}),p=i;t((async()=>{u()}));const u=async()=>{const e=o.installedInstance?.installName;ze.appIsOllama(e)&&(c.value=await Re.getOSEnvObj()||{})};return l({updateAppEnvData:u}),g((()=>o.installedInstance),(()=>{u()})),g((()=>r.appSettingsSaved),(async e=>{e&&(c.value=null,await u(),p("appEnvSavedAndUpdated",c.value))})),(e,a)=>f(c)&&e.installedInstance?(s(),n(m,{key:0},[d(Ke,{appEnv:f(c),installedInstance:e.installedInstance,lmAppData:e.lmAppData},null,8,["appEnv","installedInstance","lmAppData"]),d(Ze,{appEnv:f(c),installedInstance:e.installedInstance},null,8,["appEnv","installedInstance"]),d(Ge,{appEnv:f(c),lmAppData:e.lmAppData,installedInstance:e.installedInstance},null,8,["appEnv","lmAppData","installedInstance"]),d(Ce,{appEnv:f(c),installedInstance:e.installedInstance},null,8,["appEnv","installedInstance"])],64)):h("",!0)}}),ea={class:"d-flex flex-row"},aa={class:"d-flex flex-column justify-center"},ta=e({__name:"AppRunningWindow",setup(e){const l=b(),c=I(),g=a(null),w=a(),y=a(),D=a(null),x=a(!1),E=a(!1),T=a("--"),L=a(""),{t:R}=X(),N=_("showToastMessage"),k=$e();S((()=>!(x.value&&!c.currentLmApp.runtimeUpdateAllowed))),t((async()=>{C();const e=l.params.id,a=await G(e);D.value=a;const t=a.appId;await c.fetchApp(t),g.value=c.currentLmApp,window.ipcRenderer?.on(U.STOP_AI_RUNNING_INSTANCE,((e,...a)=>{B(),W()})),P();const n=g?.value.name;document.title=n}));const C=()=>{const e=R("AppRunningWindow.MainProcessTab");k.initTerminal(e)},z=e=>{L.value=e;let a="";e===j.INSTALL&&(a=R("AppRunningWindow.InstallSuccess")),console.log("changeMainTerminalScriptType",e,a),k.changeMainTerminalScriptType(e,a)},$=async()=>{if(z(j.START),x.value=!0,g.value){const e=await(async e=>{const a=e.installName,t=(await M()).LMD_SCRIPTS_DIR,{repoLocalFolderName:l}=De.getLMDScriptRepoUrl(e);return`\nexport LMD_BASE_INSTALL_SCRIPT_DIR="${t}/${l}"\nsh $LMD_BASE_INSTALL_SCRIPT_DIR/apps/${a}/start.sh`})(g.value);V(e),window.ipcRenderer?.send(U.RUNNING_STATUS_CHANGE,!0)}},O=()=>Array.isArray(w.value)?w.value[0]:w.value,V=e=>{const a=O();console.log("main terminal run command",a,e),a?.runCommand(e)},B=()=>{x.value=!1,F(),O()?.runStopCommand(),window.ipcRenderer.send(U.RUNNING_STATUS_CHANGE,!1)},W=()=>{O()?.exitTerminal()},F=()=>{T.value="--"},P=()=>{const e=l.query.script;console.log("runDefaultScript",e),e===j.INSTALL?((async()=>{if(z(j.INSTALL),g.value){const e=await xe(g.value);V(e)}})(),J()):e===j.START&&Q()},H=e=>{if(Ee.isWindows())return;B();const a=(e=>{let a="";if(e)for(const t in e)a+=`${t}=${e[t]}\n`;return a})(e);O()?.runCommand(a),$()},Q=async()=>{if($(),ze.needPreStartApp(D.value?.installName))return Ee.isMacOS()?void setTimeout((()=>{J()}),1e3):void 0;J()},J=()=>{E.value=!0},Z=e=>{console.log("onCommandExecuteEnd",e),N&&e&&N(e,"success"),setTimeout((()=>{y.value?.updateAppEnvData()}),400)};return(e,a)=>(s(),o(Se,null,{default:r((()=>[d(me,{elevation:"0",class:"px-6 running-app-bar",height:"92",style:{"background-color":"#F3F3FA"}},{prepend:r((()=>[i("div",ea,[d(oe,{src:f(g)?.icon,width:"60",height:"60"},null,8,["src"]),i("div",aa,[d(K,{class:"pt-1 pb-0"},{default:r((()=>[p(u(f(g)?.name),1)])),_:1}),f(D)?.version&&"--"!==f(D)?.version?(s(),o(ce,{key:0,class:"py-0"},{default:r((()=>[p(u(e.$t("AppRunningWindow.Version"))+" "+u(f(D)?.version),1)])),_:1})):h("",!0)])])])),append:r((()=>[f(x)?(s(),o(te,{key:0,variant:"flat",color:"#F2313F",class:"mx-2",width:"80",height:"40",onClick:a[0]||(a[0]=e=>B())},{default:r((()=>[p(u(e.$t("AppRunningWindow.Stop")),1)])),_:1})):(s(),o(te,{key:1,color:"primary",variant:"flat",class:"mx-2",width:"80",height:"40",onClick:a[1]||(a[1]=e=>$())},{default:r((()=>[p(u(e.$t("AppRunningWindow.Start")),1)])),_:1}))])),_:1}),d(ge,{class:"running-window-main mb-0 d-flex"},{default:r((()=>[d(q,{fluid:"",class:"d-flex flex-column",style:{height:"100%",flex:"1","min-width":"0",overflow:"hidden"}},{default:r((()=>[d(ve,{class:"mx-0",modelValue:f(k).currentTerminalTab,"onUpdate:modelValue":a[2]||(a[2]=e=>f(k).currentTerminalTab=e),"align-tabs":"start",color:"primary"},{default:r((()=>[(s(!0),n(m,null,v(f(k).terminals,((e,a)=>(s(),o(Ae,{value:e.tabName,key:e.tabName},{append:r((()=>[e.closable?(s(),o(ae,{key:0,icon:"mdi-close-circle-outline",onClick:A((t=>((e,a)=>{k.removeTerminal(e,a)})(e,a)),["stop"])},null,8,["onClick"])):h("",!0)])),default:r((()=>[p(" "+u(e.text),1)])),_:2},1032,["value"])))),128))])),_:1},8,["modelValue"]),d(fe,{modelValue:f(k).currentTerminalTab,"onUpdate:modelValue":a[3]||(a[3]=e=>f(k).currentTerminalTab=e),class:"mx-0 my-0 pt-0 mb-0",style:{flex:"1","padding-left":"4px","background-color":"black","padding-bottom":"6px"}},{default:r((()=>[(s(!0),n(m,null,v(f(k).terminals,((e,a)=>(s(),o(we,{style:{flex:"1"},key:e.text,value:e.tabName,eager:""},{default:r((()=>["main-process"===e.tabName?(s(),o(Me,{key:0,onExecuteEnd:a=>{return t=e.commandExecuteEndToastMsg,J(),console.log("onMainTerminalCommandEnd"),void Z(t);var t},"command-execute-end-keywords":e.commandExecuteEndKeywords,ref_for:!0,ref_key:"generalTerminal",ref:w,socketURI:"ws://localhost:19312"},null,8,["onExecuteEnd","command-execute-end-keywords"])):(s(),o(Me,{key:1,onExecuteEnd:a=>Z(e.commandExecuteEndToastMsg),"command-execute-end-keywords":e.commandExecuteEndKeywords,initCommand:e.initCommand,socketURI:"ws://localhost:19312"},null,8,["onExecuteEnd","command-execute-end-keywords","initCommand"]))])),_:2},1032,["value"])))),128))])),_:1},8,["modelValue"])])),_:1}),d(q,{class:"running-app-right-side-bar"},{default:r((()=>[f(D)&&f(g)&&f(E)?(s(),o(Ye,{key:0,ref_key:"appEnvAndAccessComponent",ref:y,onAppEnvSavedAndUpdated:H,lmAppData:f(g),installedInstance:f(D)},null,8,["lmAppData","installedInstance"])):h("",!0)])),_:1})])),_:1})])),_:1}))}});export{ta as default};
