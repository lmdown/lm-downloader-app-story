import{_ as e}from"./delete-confirm-dialog-with-loading.js";import{_ as a}from"./common-app-bar.vue_vue_type_script_setup_true_lang.js";import{f as t,b as o,L as i,v as l,a6 as s,k as r,a5 as n,l as p,O as g,u as d,y as m,a3 as u,a8 as c,ae as v,af as h,X as y,Z as L,F as O,a4 as f}from"./vue.js";import{c as _,b as x,T as b,g as w,o as k}from"./index.js";import{a as T,r as $}from"./lmd-system.js";import{u as R}from"./top-right-controls.vue_vue_type_style_index_0_lang.js";import{D as j}from"./DateTimeUtil.js";import{U as A,z as P,l as C,b as D,E as U,W as M,M as E,a as S,q as V,X as F,r as N}from"./vuetify.js";import"./pinia.js";import"./xterm.js";import"./debounce.js";import"./vuei18n.js";import"./lmd-locales.js";import"./dayjs.js";const z={class:"page-title"},W={class:"page-subtitle"},q={style:{width:"360px"}},I={key:1,class:"text-grey text-caption align-self-center"},X={style:{"font-size":"14px",color:"#777"}},Y={class:"log-file-cell"},B=["onClick"],G=["onClick"],Z=t({__name:"OperationLogList",setup(t){const Z=o(10),H=o(1),{smAndDown:J}=A(),{t:K}=P(),{addToast:Q}=x(),ee=o([]),ae=o([]),te=o(""),oe=o([]),ie=o([]),le=o([]),se=o(!0),re=o(0),ne=o(!1),pe=o(!1),ge=o(!1),de=o(),me=({page:e,itemsPerPage:a})=>{se.value=!0,ve(e,a)},ue=R();i((async()=>{ce(),le.value=await(async()=>(await T.get("op-log/ai-app/apps")).data)()}));const ce=async()=>{ae.value=[{title:"id",key:"id",align:"end",sortable:!1,fixed:!0},{title:K("OperationLog.AppName"),align:"start",sortable:!1,key:"appName"},{title:K("OperationLog.Type"),key:"logType",sortable:!1,align:"start"},{title:K("OperationLog.RunningMode"),key:"installMethod",sortable:!1,align:"end"},{title:K("OperationLog.CreateTime"),key:"createTime",sortable:!1,align:"end"},{title:K("OperationLog.ReportStatus"),key:"reportStatus",align:"start"},{title:K("OperationLog.Actions"),key:"logFilePath",align:"start",minWidth:"80px",maxWidth:"160px",width:J.value?"80px":"160px",fixed:!0,sortable:!1}]};l((()=>ue.currentLocale),ce),l((()=>oe.value),(()=>{ee.value=[],me({page:1,itemsPerPage:Z.value})}));const ve=async(e,a)=>{const t=await(async(e,a,t)=>{let o=`op-log/ai-app?page=${a}&limit=${t}`;e&&e.length>0&&(o=`op-log/ai-app?ids=${e.join(",")}&page=${a}&limit=${t}`);return(await T.get(o)).data})(oe.value,e,a);ie.value=t.data,re.value=t.total,se.value=!1},he=e=>{null==e&&(e=0);return K("OperationLog.ReportStatus_"+e)},ye=async e=>{try{await(async e=>{const a=e.id,t=await T({url:`/op-log/ai-app/export/${a}`,method:"GET",responseType:"blob"}),o=document.createElement("a"),i=URL.createObjectURL(t.data);o.href=i;const l=e.logFilePath||"app.log";o.setAttribute("download",l),document.body.appendChild(o),o.click(),o.remove(),URL.revokeObjectURL(i)})(e)}catch(a){a instanceof axios.AxiosError?404===a.status&&Q(K("OperationLog.FileNotExist"),"error"):Q(a.message,"error")}},Le=async()=>{try{ge.value=!0;await(async e=>{const a=_(),t=a.getToken();return t?(await T.post("/op-log/ai-app/upload",e,{headers:{Authorization:`Bearer ${t}`}})).data:void a.showLoginView()})(ee.value)&&(Q(K("OperationLog.ReportSuccess"),"success"),me({page:H.value,itemsPerPage:Z.value}))}catch(e){Q(e.message,"error")}finally{ge.value=!1}},Oe=()=>{pe.value=!0},fe=async()=>{const e=await w();k(e.LMD_DATA_ROOT+"/logs")},_e=async()=>{try{await(async e=>(await T({url:"/op-log/ai-app/",method:"DELETE",data:e})).data)(ee.value),pe.value=!1,ee.value=[],1!==H.value?H.value=1:me({page:1,itemsPerPage:Z.value})}catch(e){Q(e.message,"error")}};return(t,o)=>{const i=a,l=e;return f(),s(O,null,[r(i),r(N,{class:"op-log-container mx-2 px-8"},{default:n((()=>[r(C,{class:"my-2 log-page-title-container"},{default:n((()=>[r(D,{src:"https://d-1314735556.cos.ap-shanghai.myqcloud.com/pkgs/desktop-assets/images/app/log-icon.svg",width:"58",height:"48","max-width":"58","max-height":"48"}),p("div",z,g(t.$t("App.OpLog")),1),p("div",W,g(t.$t("OperationLog.TotalLogs",{totalCount:d(re)})),1),r(U),p("div",q,[r(M,{items:d(le),"hide-details":"",modelValue:d(oe),"onUpdate:modelValue":o[0]||(o[0]=e=>m(oe)?oe.value=e:null),class:"app-select",multiple:"",rounded:"lg",variant:"outlined",density:"compact","item-title":"name",clearable:"","item-value":"id",placeholder:t.$t("OperationLog.AppName")},{item:n((({props:e})=>[r(S,v(h(e)),null,16)])),selection:n((({item:e,index:a})=>[a<2?(f(),u(E,{key:0,text:e.title,color:d(b).PRIMARY_COLOR},null,8,["text","color"])):c("",!0),2===a?(f(),s("span",I," (+"+g(d(oe).length-2)+" "+g(t.$t("OperationLog.Others"))+") ",1)):c("",!0)])),_:1},8,["items","modelValue","placeholder"])])])),_:1}),r(C,{class:"my-4 ga-2 d-flex",style:{"align-items":"center"}},{default:n((()=>[r(V,{variant:"flat",color:d(b).PRIMARY_COLOR,disabled:0===d(ee).length,height:"32",loading:d(ge),onClick:Le},{default:n((()=>[y(g(t.$t("OperationLog.Report")),1)])),_:1},8,["color","disabled","loading"]),r(V,{variant:"outlined",color:"red",style:{border:"1px solid red"},disabled:0===d(ee).length,height:"32",onClick:Oe},{default:n((()=>[y(g(t.$t("OperationLog.Delete")),1)])),_:1},8,["disabled"]),o[5]||(o[5]=y("    ")),r(V,{variant:"outlined",height:"32",onClick:fe},{default:n((()=>[y(g(t.$t("OperationLog.OpenLogDir")),1)])),_:1}),r(U),p("div",X,g(t.$t("OperationLog.ReportTip")),1)])),_:1}),r(d(F),{class:"no-wrap-table",density:"compact",page:d(H),"onUpdate:page":o[1]||(o[1]=e=>m(H)?H.value=e:null),"items-per-page":d(Z),"onUpdate:itemsPerPage":o[2]||(o[2]=e=>m(Z)?Z.value=e:null),modelValue:d(ee),"onUpdate:modelValue":o[3]||(o[3]=e=>m(ee)?ee.value=e:null),headers:d(ae),items:d(ie),"items-length":d(re),loading:d(se),search:d(te),"item-value":"id","show-select":"",ref_key:"dataTable",ref:de,"onUpdate:options":me},{"item.logType":n((({item:e})=>{return[y(g((a=e.logType,K("OperationLog.LogType_"+a))),1)];var a})),"item.installMethod":n((({item:e})=>{return[y(g((a=e.installMethod,K("OperationLog.RunningMode_"+a))),1)];var a})),"item.reportStatus":n((({item:e})=>[y(g(he(e.reportStatus)),1)])),"item.createTime":n((({item:e})=>[y(g(d(j).format(e.createTime,!1)),1)])),"item.operationStatus":n((({item:e})=>[y(g(void 0!==e.operationStatus?e.operationStatus:"--"),1)])),"item.logFilePath":n((({item:e})=>[p("div",Y,[p("a",{href:"#",onClick:L((a=>(async e=>{const a=(await w()).LMD_DATA_ROOT+"/logs/app/"+e.logFilePath;await $(a)||Q(K("OperationLog.FileNotExist"),"error")})(e)),["prevent"])},g(t.$t("OperationLog.ActionView")),9,B),o[6]||(o[6]=y("   ")),p("a",{href:"#",onClick:L((a=>ye(e)),["prevent"])},g(t.$t("OperationLog.ActionExpor")),9,G)])])),_:1},8,["page","items-per-page","modelValue","headers","items","items-length","loading","search"])])),_:1}),r(l,{"waiting-delete-result":!0,"in-progress":d(ne),"model-value":d(pe),"onUpdate:modelValue":o[4]||(o[4]=e=>pe.value=e),"extra-tip":t.$t("OperationLog.DeleteConfirmMsg"),"remvoe-btn-label":t.$t("OperationLog.Delete"),itemName:t.$t("OperationLog.AppLog"),onConfirm:_e},null,8,["in-progress","model-value","extra-tip","remvoe-btn-label","itemName"])],64)}}});export{Z as default};
