import{a2 as e,d as t,r as n,l as s,ab as o,o as r,n as a,a as i,N as l,E as c,a3 as d,c as p,w as u,ac as h,b as _,V as m,z as f,f as v,g,t as w,h as k,s as y,ad as S,ae as b,m as A,j as L,af as I,G as x,p as R,F as C,ag as T,K as N,T as P}from"./index-D8LzgPVj.js";import{u as $}from"./lmapp-BpXxNDzY.js";import{I as D}from"./IPCChannelName-ChmutG-C.js";import{a as W}from"./install-instance-BgUIOhxA.js";import{A as E}from"./AppScriptType-tEOJIb0R.js";function O(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var M,U={exports:{}};var j,B,V,z=M?U.exports:(M=1,self,U.exports=(j=B={},Object.defineProperty(j,"__esModule",{value:!0}),j.FitAddon=void 0,j.FitAddon=class{activate(e){this._terminal=e}dispose(){}fit(){const e=this.proposeDimensions();if(!e||!this._terminal||isNaN(e.cols)||isNaN(e.rows))return;const t=this._terminal._core;this._terminal.rows===e.rows&&this._terminal.cols===e.cols||(t._renderService.clear(),this._terminal.resize(e.cols,e.rows))}proposeDimensions(){if(!this._terminal)return;if(!this._terminal.element||!this._terminal.element.parentElement)return;const e=this._terminal._core,t=e._renderService.dimensions;if(0===t.css.cell.width||0===t.css.cell.height)return;const n=0===this._terminal.options.scrollback?0:e.viewport.scrollBarWidth,s=window.getComputedStyle(this._terminal.element.parentElement),o=parseInt(s.getPropertyValue("height")),r=Math.max(0,parseInt(s.getPropertyValue("width"))),a=window.getComputedStyle(this._terminal.element),i=o-(parseInt(a.getPropertyValue("padding-top"))+parseInt(a.getPropertyValue("padding-bottom"))),l=r-(parseInt(a.getPropertyValue("padding-right"))+parseInt(a.getPropertyValue("padding-left")))-n;return{cols:Math.max(2,Math.floor(l/t.css.cell.width)),rows:Math.max(1,Math.floor(i/t.css.cell.height))}}},B)),G={exports:{}};var F,H,q=(V||(V=1,F=G,function(e,t){F.exports=t()}(self,(()=>(()=>{var e={};return(()=>{var t=e;function n(e,t,n){return e.addEventListener(t,n),{dispose:()=>{n&&e.removeEventListener(t,n)}}}Object.defineProperty(t,"__esModule",{value:!0}),t.AttachAddon=void 0,t.AttachAddon=class{constructor(e,t){this._disposables=[],this._socket=e,this._socket.binaryType="arraybuffer",this._bidirectional=!(t&&!1===t.bidirectional)}activate(e){this._disposables.push(n(this._socket,"message",(t=>{const n=t.data;e.write("string"==typeof n?n:new Uint8Array(n))}))),this._bidirectional&&(this._disposables.push(e.onData((e=>this._sendData(e)))),this._disposables.push(e.onBinary((e=>this._sendBinary(e))))),this._disposables.push(n(this._socket,"close",(()=>this.dispose()))),this._disposables.push(n(this._socket,"error",(()=>this.dispose())))}dispose(){for(const e of this._disposables)e.dispose()}_sendData(e){this._checkOpenSocket()&&this._socket.send(e)}_sendBinary(e){if(!this._checkOpenSocket())return;const t=new Uint8Array(e.length);for(let n=0;n<e.length;++n)t[n]=255&e.charCodeAt(n);this._socket.send(t)}_checkOpenSocket(){switch(this._socket.readyState){case WebSocket.OPEN:return!0;case WebSocket.CONNECTING:throw new Error("Attach addon was loaded before socket was open");case WebSocket.CLOSING:return console.warn("Attach addon socket is closing"),!1;case WebSocket.CLOSED:throw new Error("Attach addon socket is closed");default:throw new Error("Unexpected socket state")}}}})(),e})()))),G.exports),K={exports:{}};var J,Q=(H||(H=1,function(e){!function(t,n){e.exports=n()}(self,(()=>(()=>{var e={6:(e,t)=>{function n(e){try{const t=new URL(e),n=t.password&&t.username?`${t.protocol}//${t.username}:${t.password}@${t.host}`:t.username?`${t.protocol}//${t.username}@${t.host}`:`${t.protocol}//${t.host}`;return e.toLocaleLowerCase().startsWith(n.toLocaleLowerCase())}catch(t){return!1}}Object.defineProperty(t,"__esModule",{value:!0}),t.LinkComputer=t.WebLinkProvider=void 0,t.WebLinkProvider=class{constructor(e,t,n,s={}){this._terminal=e,this._regex=t,this._handler=n,this._options=s}provideLinks(e,t){const n=s.computeLink(e,this._regex,this._terminal,this._handler);t(this._addCallbacks(n))}_addCallbacks(e){return e.map((e=>(e.leave=this._options.leave,e.hover=(t,n)=>{if(this._options.hover){const{range:s}=e;this._options.hover(t,n,s)}},e)))}};class s{static computeLink(e,t,o,r){const a=new RegExp(t.source,(t.flags||"")+"g"),[i,l]=s._getWindowedLineStrings(e-1,o),c=i.join("");let d;const p=[];for(;d=a.exec(c);){const e=d[0];if(!n(e))continue;const[t,a]=s._mapStrIdx(o,l,0,d.index),[i,c]=s._mapStrIdx(o,t,a,e.length);if(-1===t||-1===a||-1===i||-1===c)continue;const u={start:{x:a+1,y:t+1},end:{x:c,y:i+1}};p.push({range:u,text:e,activate:r})}return p}static _getWindowedLineStrings(e,t){let n,s=e,o=e,r=0,a="";const i=[];if(n=t.buffer.active.getLine(e)){const e=n.translateToString(!0);if(n.isWrapped&&" "!==e[0]){for(r=0;(n=t.buffer.active.getLine(--s))&&r<2048&&(a=n.translateToString(!0),r+=a.length,i.push(a),n.isWrapped&&-1===a.indexOf(" ")););i.reverse()}for(i.push(e),r=0;(n=t.buffer.active.getLine(++o))&&n.isWrapped&&r<2048&&(a=n.translateToString(!0),r+=a.length,i.push(a),-1===a.indexOf(" ")););}return[i,s]}static _mapStrIdx(e,t,n,s){const o=e.buffer.active,r=o.getNullCell();let a=n;for(;s;){const e=o.getLine(t);if(!e)return[-1,-1];for(let n=a;n<e.length;++n){e.getCell(n,r);const a=r.getChars();if(r.getWidth()&&(s-=a.length||1,n===e.length-1&&""===a)){const e=o.getLine(t+1);e&&e.isWrapped&&(e.getCell(0,r),2===r.getWidth()&&(s+=1))}if(s<0)return[t,n]}t++,a=0}return[t,a]}}t.LinkComputer=s}},t={};function n(s){var o=t[s];if(void 0!==o)return o.exports;var r=t[s]={exports:{}};return e[s](r,r.exports,n),r.exports}var s={};return(()=>{var e=s;Object.defineProperty(e,"__esModule",{value:!0}),e.WebLinksAddon=void 0;const t=n(6),o=/(https?|HTTPS?):[/]{2}[^\s"'!*(){}|\\\^<>`]*[^\s"':,.!?{}|\\\^~\[\]`()<>]/;function r(e,t){const n=window.open();if(n){try{n.opener=null}catch{}n.location.href=t}else console.warn("Opening link blocked as opener could not be cleared")}e.WebLinksAddon=class{constructor(e=r,t={}){this._handler=e,this._options=t}activate(e){this._terminal=e;const n=this._options,s=n.urlRegex||o;this._linkProvider=this._terminal.registerLinkProvider(new t.WebLinkProvider(this._terminal,s,this._handler,n))}dispose(){this._linkProvider?.dispose()}}})(),s})()))}(K)),K.exports),X={exports:{}};function Y(){if(J)return X.exports;function e(e,t=100,n={}){if("function"!=typeof e)throw new TypeError(`Expected the first parameter to be a function, got \`${typeof e}\`.`);if(t<0)throw new RangeError("`wait` must not be negative.");const{immediate:s}="boolean"==typeof n?{immediate:n}:n;let o,r,a,i,l;function c(){const t=o,n=r;return o=void 0,r=void 0,l=e.apply(t,n),l}function d(){const e=Date.now()-i;e<t&&e>=0?a=setTimeout(d,t-e):(a=void 0,s||(l=c()))}const p=function(...e){if(o&&this!==o&&Object.getPrototypeOf(this)===Object.getPrototypeOf(o))throw new Error("Debounced method called with different contexts of the same prototype.");o=this,r=e,i=Date.now();const n=s&&!a;return a||(a=setTimeout(d,t)),n&&(l=c()),l};return Object.defineProperty(p,"isPending",{get:()=>void 0!==a}),p.clear=()=>{a&&(clearTimeout(a),a=void 0)},p.flush=()=>{a&&p.trigger()},p.trigger=()=>{l=c(),p.clear()},p}return J=1,X.exports.debounce=e,X.exports=e,X.exports}const Z=O(Y()),ee=t({__name:"index",props:{socketURI:{}},setup(e,{expose:t}){const l=e,c=n(null),d=n(null),p=n(null),u=n(null);let h;s((()=>{v(),f()})),o((()=>{c.value?.close(),d.value?.dispose(),h&&u.value&&(h.unobserve(u.value),h.disconnect())}));const _=e=>{console.log("runCommand",e),console.log("runCommand socket.value",c.value),c.value?.send(e+"\n")};t({runCommand:_,runStopCommand:()=>{_("")},exitTerminal:()=>{_("exit")}});const m=Z((e=>{for(let t of e)b(t.contentRect.width,t.contentRect.height)}),50),f=()=>{p.value&&(h=new ResizeObserver(m),h.observe(p.value))},v=()=>{c.value=new WebSocket(l.socketURI),w(),g(),k()},g=()=>{c.value&&(c.value.onopen=()=>{(()=>{if(!u.value)return;if(!c.value)return;const e=new window.Terminal({fontSize:14,cursorBlink:!0}),t=new q.AttachAddon(c.value),n=new z.FitAddon,s=new Q.WebLinksAddon(((e,t)=>{var n=document.createElement("a");n.setAttribute("href",t),n.setAttribute("target","_blank"),n.setAttribute("id","lmdTempLink");const s=document.getElementById("lmdTempLink");s&&document.body.removeChild(s),document.body.appendChild(n),n.click()}));e.loadAddon(t),e.loadAddon(n),e.loadAddon(s),e.open(u.value),n.fit(),e.focus(),d.value=e})()})},w=()=>{c.value&&(c.value.onclose=e=>{console.log("close socket",e)})},k=()=>{c.value&&(c.value.onerror=e=>{console.log("socket 链接失败",e)})},y=n(80),S=n(30),b=(e,t)=>{const n=Math.floor(e/8.5),s=Math.round(t/16);if(console.log("cols",e,n),console.log("rows",t,s),0!==s&&0!==n&&(y.value!==n||S.value!==s)){y.value=n,S.value=s,d.value?.resize(n,s);const e=`lmd_action:resize:${n},${s}`;c.value?.send(e)}};return(e,t)=>(r(),a("div",{ref_key:"terminalOutContainer",ref:p,class:"mb-2",style:{height:"100%",width:"100%"}},[i("div",{ref_key:"terminalContainer",ref:u,class:"terminal",style:{height:"300px",width:"100%"}},null,512)],512))}}),te=["href"],ne=t({__name:"AppRunningWindow",setup(t){const o=l(),O=$(),M=n(null),U=n(null),j=n(),B=n(null),V=n(!1),z=n("--"),G=c((()=>!(V.value&&!O.currentLmApp.runtimeUpdateAllowed)));s((async()=>{const e=o.params.id,t=await W(e);B.value=t;const n=t.appId;await O.fetchApp(n),M.value=O.currentLmApp,window.ipcRenderer?.on(D.STOP_AI_RUNNING_INSTANCE,((e,...t)=>{J(),Q()})),U.value=await d(),Z();const s=M?.value.name;document.title=s}));const F=async()=>{if(V.value=!0,M.value){const t=await(async t=>{const n=t.installName;return`\nexport LMD_BASE_INSTALL_SCRIPT_DIR="${(await e()).LMD_SCRIPTS_DIR}/lmd-install-scripts"\nsh $LMD_BASE_INSTALL_SCRIPT_DIR/apps/${n}/start.sh`})(M.value);K(t),window.ipcRenderer?.send(D.RUNNING_STATUS_CHANGE,!0)}},H=async()=>{if(M.value){const t=await(async t=>{const n=t.installName;return`\nexport LMD_BASE_INSTALL_SCRIPT_DIR="${(await e()).LMD_SCRIPTS_DIR}/lmd-install-scripts"\nsh $LMD_BASE_INSTALL_SCRIPT_DIR/apps/${n}/update.sh\n`})(M.value);K(t)}},q=()=>{X()},K=e=>{j.value?.runCommand(e)},J=()=>{V.value=!1,Y(),j.value?.runStopCommand(),window.ipcRenderer.send(D.RUNNING_STATUS_CHANGE,!1)},Q=()=>{j.value?.exitTerminal()},X=async()=>{if(M.value){const t=await(async t=>{const n=t.installName;return`\nexport LMD_BASE_INSTALL_SCRIPT_DIR="${(await e()).LMD_SCRIPTS_DIR}/lmd-install-scripts"\ngit clone --depth=1 https://gitee.com/lmdown/lmd-install-scripts $LMD_BASE_INSTALL_SCRIPT_DIR\n#cd $LMD_BASE_INSTALL_SCRIPT_DIR && git fetch origin master && git reset --hard origin/master\nsh $LMD_BASE_INSTALL_SCRIPT_DIR/apps/${n}/install.sh`})(M.value);K(t)}},Y=()=>{z.value="--"},Z=()=>{o.query.script===E.INSTALL&&X()};return(e,t)=>(r(),p(h,null,{default:u((()=>[_(L,{elevation:"1",class:"px-2"},{prepend:u((()=>[_(m,{src:f(M)?.icon,width:"60",height:"60"},null,8,["src"]),_(v,null,{default:u((()=>[g(w(f(M)?.name),1)])),_:1}),f(B)?.version&&"--"!==f(B)?.version?(r(),p(k,{key:0},{default:u((()=>[g(w(e.$t("AppRunningWindow.Version"))+" "+w(f(B)?.version),1)])),_:1})):y("",!0)])),append:u((()=>[S(_(A,{stacked:"",onClick:q},{prepend:u((()=>[_(m,{src:"./images/icons/lmd-logo.png",size:"20",width:"25",height:"25"})])),default:u((()=>[g(" "+w(e.$t("AppRunningWindow.Install")),1)])),_:1},512),[[b,f(G)]]),S(_(A,{"prepend-icon":"mdi-autorenew",stacked:"",onClick:H},{default:u((()=>[g(w(e.$t("AppRunningWindow.Update")),1)])),_:1},512),[[b,f(G)]]),f(V)?(r(),p(A,{key:0,stacked:"","prepend-icon":"mdi-stop",onClick:t[0]||(t[0]=e=>J())},{default:u((()=>[g(w(e.$t("AppRunningWindow.Stop")),1)])),_:1})):(r(),p(A,{key:1,stacked:"","prepend-icon":"mdi-play",onClick:t[1]||(t[1]=e=>F())},{default:u((()=>[g(w(e.$t("AppRunningWindow.Start")),1)])),_:1})),f(V)?(r(),p(A,{key:2,stacked:"","prepend-icon":"mdi-refresh-circle",onClick:t[2]||(t[2]=e=>(J(),void F()))},{default:u((()=>[g(w(e.$t("AppRunningWindow.Restart")),1)])),_:1})):y("",!0)])),_:1}),_(T,{class:"mx-1"},{default:u((()=>[_(I,{fluid:"",class:"d-flex flex-column",style:{height:"100%"}},{default:u((()=>[f(M)?.accessInfo&&"browser"===f(M).accessInfo.accessType?(r(),p(x,{key:0,class:"my-1 py-1"},{default:u((()=>[g(w(e.$t("AppRunningWindow.Access"))+": ",1),i("a",{href:f(M).accessInfo?.webUrl||"",target:"_blank"},w(f(M).accessInfo.webUrl),9,te)])),_:1})):y("",!0),_(x,{class:"my-1 py-1"},{default:u((()=>[g(w(e.$t("AppRunningWindow.EnvVars"))+" ",1),f(U)?(r(!0),a(C,{key:0},R(f(U),((e,t)=>(r(),p(N,{variant:"tonal",size:"x-small",style:{"min-width":"50px","max-width":"120px","margin-left":"4px"},key:t},{default:u((()=>[g(w(t)+" ",1),_(P,{activator:"parent",location:"bottom"},{default:u((()=>[g(w(e),1)])),_:2},1024)])),_:2},1024)))),128)):y("",!0)])),_:1}),_(x,{class:"my-1 py-1"},{default:u((()=>[g(w(e.$t("AppRunningWindow.AppTerminal"))+": ",1)])),_:1}),_(ee,{ref_key:"generalTerminal",ref:j,socketURI:"ws://localhost:19312"},null,512)])),_:1})])),_:1})])),_:1}))}});export{ne as default};
