import{b as e,T as a,f as n,o as t}from"./index.js";import{d as l}from"./pinia.js";import{b as s,e as o,a3 as i,a2 as r,a5 as p,k as d,u as c,F as u,S as m,K as v,a0 as g,H as f,aa as w,$ as y,a8 as h,a1 as A,ac as x,l as I,a4 as _,m as S,Y as b,j as E,c as D}from"./vue.js";import{b as k,m as R,D as T,q as N,F as P,S as M,T as C,G as W,U as $,c as F,w as O,x as z,a as V,l as U,L as j,n as L,H as B,d as H,W as G,o as J,p as Y,E as q}from"./vuetify.js";import{b as K,A as Q,d as X,O as Z}from"./OSUtil.js";import{I as ee,a as ae,g as ne}from"./lmd-system.js";import"./index2.js";import{u as te,e as le,d as se,_ as oe,O as ie,a as re,D as pe,g as de,c as ce,b as ue}from"./delete-confirm-dialog.js";import{u as me}from"./lmapp.js";import{A as ve,O as ge,M as fe}from"./AppInfoUtil.js";import{p as we}from"./pretty-bytes.js";import{D as ye}from"./DateTimeUtil.js";import{A as he}from"./AppRunningUtil.js";import"./xterm.js";import"./debounce.js";import"./vuei18n.js";import"./lmd-locales.js";import"./dayjs.js";const{addToast:Ae}=e(),xe=l("appRemove",{state:()=>({removePercent:s(0),removeSuccessMsg:s(""),removed:s(!1)}),actions:{initModelsData(){this.removePercent=0},updateUI(e){this.removePercent=e,1===e&&(this.removed=!0,this.removeSuccessMsg&&Ae(this.removeSuccessMsg,"success"))}}}),Ie={class:"progress-area"},_e={style:{width:"210px"}},Se={key:0,style:{width:"250px"},class:"mt-6"},be={class:"progress-msg mb-8 mt-6"},Ee={class:"progress-msg-title"},De={class:"progress-msg-title"},ke={class:"mt-3",style:{"font-size":"14px"}},Re=o({__name:"remove-progress",props:{lmAppData:{}},setup(e){const n=xe();return(e,t)=>(g(),i("div",Ie,[r("div",_e,[d(k,{src:c(n).removed?"./images/my-ai/del-tip.svg":"./images/app/processing.svg",width:"210",height:"140"},null,8,["src"])]),c(n).removed?p("",!0):(g(),i("div",Se,[d(R,{width:"100%",class:"download-progress-bar","bg-color":"#F2F2FA","bg-opacity":"1","buffer-color":"#DFDFEC","buffer-opacity":"1",opacity:"1",color:c(a).PRIMARY_COLOR,height:"14",max:100,min:0,"model-value":c(n).removePercent,rounded:""},null,8,["color","model-value"])])),r("div",be,[c(n).removed?(g(),i(u,{key:1},[r("div",De,v(e.$t("AppRunningWindowV2.DeleteSuccessTitle")),1),r("div",ke,v(e.$t("AppRunningWindowV2.DeleteSuccessMsg")),1)],64)):(g(),i(u,{key:0},[r("div",Ee,v(e.lmAppData?.name),1),m(" "+v(e.$t("AppRunningWindowV2.DeletingMsg"))+" "+v(c(n).removePercent)+"% ",1)],64))])]))}});class Te{static extractProgress(e){let a=null;try{const n=/lmdprogress:(\d+)/g;let t;for(;null!==(t=n.exec(e));)a=parseInt(t[1],10)}catch(n){console.error("parse err",n)}return a}}const Ne={class:"app-install-container"},Pe={class:"install-steps"},Me={class:"pa-6 install-right-content"},Ce={class:"footer-button-bar"},We=o({__name:"app-remove",setup(a){const{t:n}=T(),t=te(),l=s(""),o=me(),u=s(null),x=w(),I=s(null),_=s(),S=xe(),b=s(!1),{addToast:E}=e();f((async()=>{D();const e=x.params.id;let a;try{a=await K(e)}catch(s){return console.log(s),void E(n("AppRunningWindowV2.DeleteNotFound"),"error")}I.value=a;const t=a.appId;await o.fetchApp(t),u.value=o.currentLmApp,window.ipcRenderer?.on(ee.STOP_AI_RUNNING_INSTANCE,(()=>{W(),$()})),R();const l=u?.value.name;document.title=n("LocalApps.Delete")+" "+l}));const D=()=>{const e=n("AppRunningWindow.MainProcessTab");t.initTerminal(e)},R=async()=>{var e;if(e=Q.REMOVE,l.value=e,console.log("changeMainTerminalScriptType",e,""),t.changeMainTerminalScriptType(e,""),u.value){const e=await le(u.value);M(e)}},M=e=>{const a=C();console.log("run command",a,e),a?.runCommand(e)},C=()=>Array.isArray(_.value)?_.value[0]:_.value,W=()=>{C()?.runStopCommand(),window.ipcRenderer.send(ee.RUNNING_STATUS_CHANGE,!1)},$=()=>{C()?.exitTerminal()},F=e=>{const a=Te.extractProgress(e);a&&(S.removePercent=a,100===a&&(S.removed=!0,I.value?.id&&X(I.value?.id)))},O=()=>{I.value?.id&&ae(I.value.id)};return(e,a)=>{const n=Re;return g(),i("div",Ne,[r("div",Pe,[r("div",Me,[c(u)?(g(),y(n,{key:0,"lm-app-data":c(u)},null,8,["lm-app-data"])):p("",!0),r("div",{class:h(["footer-terminal","app-install-footer-terminal",c(b)?"expanded":""])},[r("div",Ce,[d(N,{variant:"text",style:{position:"absolute",right:"10px",top:"5px"},onClick:a[0]||(a[0]=e=>b.value=!c(b))},{append:A((()=>[d(k,{src:c(b)?"./images/icons/expand-white.svg":"./images/icons/collapse-white.svg",width:"18",height:"18"},null,8,["src"])])),default:A((()=>[m(v(c(b)?e.$t("AppRunningWindowV2.Hide"):e.$t("AppRunningWindowV2.ViewLog"))+" ",1)])),_:1})]),d(se,{ref_key:"generalTerminal",ref:_,events:["lmdprogress"],onTerminalEvent:F,socketURI:"ws://localhost:19312"},null,512)],2)])]),d(P,{style:{"border-top":"1px solid #EBEBF7"},class:"py-6 text-center justify-center"},{default:A((()=>[d(N,{variant:"outlined",onClick:O},{default:A((()=>[m(v(e.$t("Common.close")),1)])),_:1})])),_:1})])}}}),$e={style:{"font-size":"14px","line-height":"16px"}},Fe=o({__name:"lmd-expansion-panel",props:{title:{default:""},showExpandIcon:{type:Boolean,default:!1},defaultExpanded:{type:Boolean,default:!1}},setup:e=>(f((()=>{})),(e,a)=>(g(),y(M,{dense:""},{default:A((()=>[d(C,{class:"d-flex"},{actions:A((({expanded:a})=>[e.showExpandIcon?(g(),i(u,{key:0},[r("span",$e,v(a?e.$t("AppRunningWindowV2.Collapse"):e.$t("AppRunningWindowV2.Expand")),1),d(k,{src:a?"./images/icons/collapse.svg":"./images/icons/expand.svg",width:"16",height:"16"},null,8,["src"])],64)):p("",!0)])),default:A((()=>[m(v(e.title)+" ",1),d(W),x(e.$slots,"append")])),_:3}),d($,{style:{padding:"0"}},{default:A((()=>[x(e.$slots,"default")])),_:3})])),_:3})))}),Oe=["href"],ze={style:{color:"#999999"},class:"mx-0 mt-4 mb-0"},Ve=o({__name:"app-access-row-v2",props:{lmAppData:{},installedInstance:{},appEnv:{}},setup(e){const a=e,n=s([]),t=s(!1),l=s(!1),o=async()=>{if(a.lmAppData?.accessInfo){const e=a.lmAppData.accessInfo,{accessType:t}=e;if(!t)return!1;if("browser"===t)return n.value.push(a.lmAppData.accessInfo?.webUrl||""),!0;if("exec"===t&&ve.appIsOllama(a.installedInstance?.installName)){if(a.appEnv){const e=a.appEnv[ge];n.value=await ie.getAccessHosts(e)}return!0}}return!1};return f((async()=>{t.value=await o(),l.value=ve.displayAccessSettingBtn(a.installedInstance?.installName)})),I((()=>a.appEnv),(async()=>{t.value=await o()})),I((()=>a.lmAppData?.accessInfo.webUrl),(async()=>{n.value=[],t.value=await o()})),(e,t)=>{const l=oe,s=re;return c(n)&&c(n).length>0?(g(),y(Fe,{key:0,title:e.$t("AppRunningWindow.Access"),readonly:"",value:"app-access",showExpandIcon:!1,"default-expanded":!0},{append:A((()=>[ve.appIsOllama(a.lmAppData?.installName)?(g(),y(l,{key:0,installedInstance:e.installedInstance},null,8,["installedInstance"])):p("",!0)])),default:A((()=>[d(F,{class:"pt-1 pb-2",style:{margin:"0 -24px -16px"}},{default:A((()=>[d(O,{"no-gutters":"",style:{padding:"0px"}},{default:A((()=>[(g(!0),i(u,null,_(c(n),((e,a)=>(g(),y(z,{key:a,class:"px-5 py-2",cols:"12",sm:"6"},{default:A((()=>[d(V,{style:{background:"#FFF4EA","border-radius":"4px",height:"40px"},density:"compact","min-height":"1.1rem",class:"px-5"},{prepend:A((()=>[d(s,{text:e},null,8,["text"])])),default:A((()=>[(g(),i("a",{class:"mx-2 app-access-link",key:e,href:e,target:"_blank"},v(e),9,Oe))])),_:2},1024)])),_:2},1024)))),128))])),_:1})])),_:1}),r("div",ze,v(e.$t("AppRunningWindowV2.AccessNote")),1)])),_:1},8,["title"])):p("",!0)}}}),Ue=o({__name:"app-env-row-v2",props:{installedInstance:{},appEnv:{}},setup(e){const a=s(null);f((async()=>{a.value=await n()}));const t=e=>"HF_MIRROR"===e?"HF_ENDPOINT":e;return(e,n)=>(g(),y(Fe,{title:e.$t("AppRunningWindow.EnvVars"),showExpandIcon:!0,value:"app-env"},{default:A((()=>[d(U,{class:"my-1 pt-2 pb-0 mx-0"},{default:A((()=>[(g(!0),i(u,null,_(c(a),((e,a)=>(g(),y(j,{variant:"tonal",size:"small",style:{"min-width":"50px","max-width":"190px","margin-left":"4px"},key:a},{default:A((()=>[m(v(t(a))+" ",1),d(L,{activator:"parent",location:"bottom"},{default:A((()=>[m(v(e),1)])),_:2},1024)])),_:2},1024)))),128)),(g(!0),i(u,null,_(e.appEnv,((e,a)=>(g(),y(j,{variant:"tonal",color:"orange-darken-4",size:"small",style:{"min-width":"50px","max-width":"220px","margin-left":"4px"},key:a},{default:A((()=>[m(v(a)+" ",1),d(L,{activator:"parent",location:"bottom"},{default:A((()=>[m(v(e),1)])),_:2},1024)])),_:2},1024)))),128))])),_:1})])),_:1},8,["title"]))}}),je={key:0,style:{width:"84px"},class:"d-flex flex-column justify-center items-center"},Le={class:"progress-text"},Be=o({__name:"download-progress",props:{downloadInfo:{}},setup:e=>(e,n)=>e.downloadInfo?(g(),i("div",je,[d(R,{width:"100%",class:"download-progress-bar","bg-color":"#D8D8D8","bg-opacity":"1","buffer-color":"#DFDFEC","buffer-opacity":"1",opacity:"1",color:c(a).PRIMARY_COLOR,height:"3",max:1,min:0,"model-value":e.downloadInfo.percent,rounded:""},null,8,["color","model-value"]),r("div",Le,[m(v(e.$t("AppRunningWindowV2.Downloading"))+" ",1),e.downloadInfo.percent?(g(),i(u,{key:0},[m(v(Math.floor(100*e.downloadInfo.percent))+"% ",1)],64)):p("",!0)])])):p("",!0)}),He={key:0},Ge={class:"model-storage-title d-flex flex-row align-baseline"},Je={class:""},Ye={class:"justify-center mr-6"},qe={class:"d-flex"},Ke={style:{flex:"1"}},Qe={class:"d-flex"},Xe={class:"d-flex flex-row mt-1",style:{"font-size":"14px"}},Ze={style:{flex:"1"}},ea=o({__name:"model-storage",props:{installedInstance:{},appEnv:{}},setup(e){const a=e,n=s(""),l=s(""),o=s(""),u=s(0),w=s(null);f((async()=>{ve.appIsOllama(a.installedInstance?.installName)&&(await _(),E())}));const h=s(null),{t:x}=T(),_=async()=>{const e=await ne();l.value=e+"/.ollama/models"},E=async()=>{const e=await ve.getModelsDir(a.installedInstance?.installName,a.appEnv);console.log("dir",e),n.value=e||l.value,console.log("modelDir.value",n.value);const t=await ve.getModelFileSize(a.installedInstance?.installName,n.value);t.dirSize&&(h.value=we(t.dirSize),w.value=t,console.log("dirInfo",t),D())},D=()=>{if(!w.value)return;let e=0;try{e=w.value?.totalSpace-w.value.dirSize-w.value.freeSpace,u.value=w.value?.totalSpace-w.value.freeSpace}catch(l){console.error("calculate error",l)}const a=we(e),n=we(w.value.freeSpace),t=`${x("AppRunningWindow.StorageModelsSize")}: ${h.value},\n  ${x("AppRunningWindow.StorageDiskOther")}: ${a},\n  ${x("AppRunningWindow.StorageDiskFreeSpace")}: ${n}\n  `;o.value=t};I((()=>a.appEnv),(e=>{E()})),I((()=>a.installedInstance),(e=>{E()}));const N=async()=>{t(n.value)};return(e,a)=>c(h)?(g(),i("div",He,[r("div",Ge,[r("div",Je,v(e.$t("AppRunningWindow.ModelStorageLabel")),1),d(W),r("div",Ye,[d(oe,{installedInstance:e.installedInstance},null,8,["installedInstance"])])]),d(U,{class:"mt-3 pb-3 px-5"},{default:A((()=>[r("div",qe,[r("div",null,[d(k,{src:"./images/icons/harddisk.svg",class:"mr-1",width:"72",height:"34"})]),r("div",Ke,[r("div",Qe,[d(L,{text:c(o),location:"top"},{activator:A((({props:e})=>[d(R,S({class:"custom-progress-bar"},e,{location:null,"bg-color":"#FFFFFF","bg-opacity":"1","buffer-color":"#DFDFEC","buffer-opacity":"1",opacity:"1",color:"#FEF1E5",height:"14",max:c(w)?.totalSpace||10,min:"0","buffer-value":c(u),"model-value":c(w)?.dirSize,rounded:""}),null,16,["max","buffer-value","model-value"])])),_:1},8,["text"])]),r("div",Xe,[r("div",Ze,v(c(w)?.diskName),1),r("a",{href:"#",style:{"text-decoration":"none",color:"rgba(0, 0, 0, 0.75)"},onClick:b(N,["prevent"])},[m(v(c(h))+" > ",1),c(n)?(g(),y(L,{key:0,activator:"parent",location:"top"},{default:A((()=>[m(v(c(n)),1)])),_:1})):p("",!0)])])])])])),_:1})])):p("",!0)}}),aa="http://localhost:11434";class na{constructor(e,a){if(this.paramSize=e,this.updateUI=a,!e.nameAndSize)throw new Error("nameAndSize is empty");this.nameAndSize=e.nameAndSize}totalPercentageWithoutCurrent=.01;totalPercentage=.01;pullingMainPart="";pullingCurrentPart="";nameAndSize="";async download(e){const a=e.signal,n=await fetch(`${aa}/api/pull`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:this.nameAndSize,stream:!0}),signal:a});if(!n.ok)throw new Error(`HTTP error: ${n.status}`);if(!n.body)throw new Error("No response body");const t=n.body.getReader(),l=new TextDecoder;let s="";for(;;){const{done:e,value:a}=await t.read();if(e)break;s+=l.decode(a);const n=s.split("\n");s=n.pop()||"";for(const t of n)if(t.trim())try{const e=JSON.parse(t);this.processProgress(e)}catch(o){console.error("Parse error:",o)}}}calculatePercentage(e,a,n){let t=this.totalPercentageWithoutCurrent;if(e&&e.completed&&e.total){t+=e.completed/e.total*a,t>.99&&(t=.99),t>=this.totalPercentage&&(this.totalPercentage=t)}n&&this.totalPercentage>=this.totalPercentageWithoutCurrent&&(this.totalPercentageWithoutCurrent=this.totalPercentage)}processProgress(e){const a=e?.status||"";let n=.02;if("pulling manifest"===a)n=.01;else if(a.startsWith("downloading")||a.startsWith("pulling")){void 0!==e.total&&void 0!==e.completed&&(!this.pullingMainPart&&e.total>5242880&&(this.pullingMainPart=a),this.pullingMainPart===a&&(n=.89));let t=!1;this.pullingCurrentPart!==a&&(this.pullingCurrentPart=a,t=!0),this.calculatePercentage(e,n,t)}else"success"===a&&(this.totalPercentage=1);this.updateUI&&this.updateUI(this.paramSize,this.totalPercentage)}}const{addToast:ta}=e(),la=l("modelDownloadInfo",{state:()=>({models:s([]),parameterSizes:s([]),downloadSuccessMsg:s(""),cancelDownloadMsg:s(""),fetchAbortControllers:s(new Map)}),actions:{initModelsData(){this.models=[],this.parameterSizes=[]},updateUI(e,a){const n=e.downloadProgress;n&&(n.percent=a,1===a&&(e.installed=!0,this.downloadSuccessMsg&&ta(this.downloadSuccessMsg,"success")))},onDownloadError(e){console.error("Failed to download model",e);let a=e.message;"BodyStreamBuffer was aborted"===a&&(a=this.cancelDownloadMsg),ta(a,"error")},async startDownload(e,a){a.nameAndSize=e,a.downloadProgress={nameAndSize:e,percent:0},this.updateUI(a,.01);const n=await(async(e,a,n)=>{const t=new AbortController;return new na(e,a).download(t).catch((e=>{n&&(console.error("download err",e),n(e))})),t})(a,this.updateUI,this.onDownloadError);this.fetchAbortControllers.set(a.nameAndSize,n)},async cancelDownload(e,a){const n=fe.genModelNameAndSize(e,a);try{const e=this.fetchAbortControllers.get(n);e?.abort()}catch(t){console.log("cancel err",t)}try{await(async e=>{const a=await fetch(`${aa}/api/pull`,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e})});if(!a.ok)throw new Error(`HTTP error: ${a.status}`);if(!a.body)throw new Error("No response body");const n=await a.json();n.error?console.error("cancel error",n.error):console.log("cancel done",n)})(n)}catch(t){console.error(t)}finally{a.installed=!1,a.downloadProgress&&(a.downloadProgress.percent=void 0)}},async deleteModel(e,a){const n=fe.genModelNameAndSize(e,a);try{await(async e=>{const a=await fetch(`${aa}/api/delete`,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e})});if(!a.ok)throw new Error(`HTTP error: ${a.status}`);if(!a.body)throw new Error("No response body");const n=await a.json();n.error?console.error("del error",n.error):console.log("del done",n)})(n)}catch(t){console.error(t)}finally{a.installed=!1,a.downloadProgress&&(a.downloadProgress.percent=void 0)}}}}),sa={key:0,class:"text-center py-10",style:{flex:"1"}},oa={class:"d-flex flex-row justify-center"},ia={style:{"min-width":"46px",display:"inline-block"}},ra={style:{"min-width":"60px",display:"inline-block"}},pa={key:0,class:"installed-chip"},da={key:1,class:"not-installed-chip"},ca=o({__name:"model-download-row-v2",props:{lmAppData:{},installedInstance:{},appEnv:{}},setup(e){const a=la(),n=s(!1),t=s(null),l=s(null),o=s(!1),w=s(""),{t:h}=T(),x=e;f((async()=>{S(),a.downloadSuccessMsg=h("AppRunningWindow.ModelDownloadSuccessful"),a.cancelDownloadMsg=h("AppRunningWindowV2.DownloadCanceled"),await E()})),I((()=>x.lmAppData),(()=>{S()})),I((()=>x.installedInstance),(()=>{E()})),I((()=>x.appEnv),(()=>{E()}));const S=()=>{n.value=ve.appIsOllama(x.lmAppData?.installName)};I(t,(()=>{b()}));const b=()=>{const e=t.value,n=a.models.find((a=>a.installName===e)),l=n?.tags||[];a.parameterSizes=l},E=async()=>{const e=x.installedInstance?.installName;if(e&&n.value){a.initModelsData();const n=ie.getDownloadableModels(),l=await ve.mergeModelsList(e,n);if(a.models=l,t.value)b();else{const e=a.models;if(e&&e.length>0){const a=e[0];t.value=a.installName}}}},D=async()=>{t.value&&l.value&&a.deleteModel(t.value,l.value)},k=e=>{const a=e.downloadProgress;return!!(a?.percent&&a.percent<1)},R=e=>{const a=e.tags;if(a&&a.length>0)for(let n=0;n<a.length;n++){if(a[n].installed)return!0}};return(e,s)=>{const f=Be;return g(),i(u,null,[e.lmAppData&&c(n)?(g(),y(Fe,{key:0,class:"model-download-panel",showExpandIcon:!0,value:"model-download",title:e.$t("AppRunningWindow.ModelDownload")},{default:A((()=>[d(U,{class:"model-download-sheet d-flex flex-row"},{default:A((()=>[c(a).models&&0!==c(a).models.length?p("",!0):(g(),i("div",sa,[d(B,{color:"primary",indeterminate:"",size:"40"})])),c(a).models&&c(a).models.length>0?(g(),y(F,{key:1,style:{"border-right":"1px solid #EBEBF7",flex:"1",padding:"0"},"max-height":"340"},{default:A((()=>[(g(!0),i(u,null,_(c(a).models,((e,a)=>(g(),y(V,{key:e.installName+a,density:"compact","active-class":"selected-model-item",onClick:a=>{var n;(n=e.installName)!==t.value&&(t.value=n)},active:c(t)===e.installName,title:e.displayName,value:e.installName},{append:A((()=>[R(e)?(g(),y(H,{key:0,class:"downloaded-icon",icon:"mdi-check-bold",size:"18"})):p("",!0)])),_:2},1032,["onClick","active","title","value"])))),128))])),_:1})):p("",!0),c(a).models&&c(a).models.length>0?(g(),y(F,{key:2,style:{flex:"1",padding:"0"}},{default:A((()=>[(g(!0),i(u,null,_(c(a).parameterSizes,((n,s)=>(g(),y(V,{key:n.parameterSize+s,density:"compact",active:!1,value:n.parameterSize},{default:A((()=>[r("div",oa,[r("span",ia,v(n.parameterSize),1),r("span",ra,[d(j,{density:"compact",class:"mx-1 file-size-chip"},{default:A((()=>[m(v(n.fileSize),1)])),_:2},1024)]),d(W,{style:{flex:"1"}}),n.installed?(g(),i("div",pa,v(e.$t("AppRunningWindow.ModelDownloaded")),1)):(g(),i(u,{key:1},[k(n)?(g(),y(f,{key:0,"download-info":n.downloadProgress},null,8,["download-info"])):(g(),i("div",da,v(e.$t("AppRunningWindow.ModelNotDownloaded")),1))],64)),d(W,{style:{flex:"1"}}),n.installed?(g(),y(N,{key:2,onClick:e=>(e=>{if(!t.value)return;const a=fe.genModelNameAndSize(t.value,e);l.value=e,o.value=!0,w.value=a})(n),variant:"text",density:"compact",color:"#F2313F"},{default:A((()=>[m(v(e.$t("AppRunningWindow.ModelDeleteBtnLabel")),1)])),_:2},1032,["onClick"])):(g(),i(u,{key:3},[k(n)?(g(),y(N,{key:0,onClick:e=>(async e=>{t.value&&a.cancelDownload(t.value,e)})(n),variant:"text",density:"compact"},{default:A((()=>[m(v(e.$t("AppRunningWindow.Cancel")),1)])),_:2},1032,["onClick"])):(g(),y(N,{key:1,onClick:e=>(async e=>{if(!t.value)return;const n=fe.genModelNameAndSize(t.value,e);a.startDownload(n,e)})(n),variant:"text",class:"model-download-btn",density:"compact"},{default:A((()=>[m(v(e.$t("AppRunningWindow.ModelDownloadBtnLabel")),1)])),_:2},1032,["onClick"]))],64))])])),_:2},1032,["value"])))),128))])),_:1})):p("",!0)])),_:1}),d(U,{style:{"border-top":"1px solid #EBEBF7"}},{default:A((()=>[d(ea,{appEnv:e.appEnv,installedInstance:e.installedInstance},null,8,["appEnv","installedInstance"])])),_:1})])),_:1},8,["title"])):p("",!0),d(pe,{"model-value":c(o),"onUpdate:modelValue":s[0]||(s[0]=e=>o.value=e),"item-name":c(w),onConfirm:D},null,8,["model-value","item-name"])],64)}}}),ua=o({__name:"app-env-and-access-v2",props:{installedInstance:{},lmAppData:{}},emits:["appEnvSavedAndUpdated"],setup(e,{expose:a,emit:n}){const t=e,l=te(),o=s({}),i=s(["app-access"]),r=n;f((async()=>{v(),m()}));const u=w(),m=()=>{u.query.script===Q.DOWNLOAD_MODEL&&(i.value=["app-access","model-download"])},v=async()=>{const e=t.installedInstance?.installName;ve.appIsOllama(e)&&(o.value=await ie.getOSEnvObj()||{})};return a({updateAppEnvData:v}),I((()=>t.installedInstance),(()=>{v()})),I((()=>l.appSettingsSaved),(async e=>{e&&(o.value=null,await v(),r("appEnvSavedAndUpdated",o.value))})),(e,a)=>{const n=Ve;return c(o)&&e.installedInstance?(g(),y(G,{key:0,multiple:"",elevation:"0",modelValue:c(i),"onUpdate:modelValue":a[0]||(a[0]=e=>E(i)?i.value=e:null),class:"lmd-running-panels"},{default:A((()=>[d(n,{appEnv:c(o),lmAppData:e.lmAppData,installedInstance:e.installedInstance},null,8,["appEnv","lmAppData","installedInstance"]),d(ca,{appEnv:c(o),installedInstance:e.installedInstance,lmAppData:e.lmAppData},null,8,["appEnv","installedInstance","lmAppData"]),d(Ue,{appEnv:c(o),installedInstance:e.installedInstance},null,8,["appEnv","installedInstance"])])),_:1},8,["modelValue"])):p("",!0)}}}),ma={class:"d-flex flex-column text-center justify-center align-middle"},va={style:{width:"60px",margin:"0 auto"},class:"mt-10"},ga={class:"d-flex flex-column justify-center"},fa=o({__name:"app-info-left",props:{lmAppData:{},installedInstance:{},isAppRunning:{type:Boolean}},emits:["startApp","stopApp"],setup(e,{emit:a}){const n=a;return(e,a)=>(g(),y(U,{class:"left-app-basic-info"},{default:A((()=>[r("div",ma,[r("div",va,[d(k,{src:e.lmAppData?.icon,width:"60",height:"60"},null,8,["src"])]),r("div",ga,[d(J,{class:"pt-1 pb-0"},{default:A((()=>[m(v(e.lmAppData?.name),1)])),_:1}),e.installedInstance?.version&&"--"!==e.installedInstance?.version?(g(),y(Y,{key:0,class:"py-0"},{default:A((()=>[m(v(e.$t("AppRunningWindow.Version"))+" "+v(e.installedInstance?.version),1)])),_:1})):p("",!0),d(q,null,{default:A((()=>[d(W,{class:"mt-6"}),e.isAppRunning?(g(),y(N,{key:0,variant:"flat",color:"#F2313F",class:"mx-2",width:"80",height:"40",onClick:a[0]||(a[0]=e=>{n("stopApp")})},{default:A((()=>[m(v(e.$t("AppRunningWindow.Stop")),1)])),_:1})):(g(),y(N,{key:1,color:"primary",variant:"flat",class:"mx-2",width:"80",height:"40",onClick:a[1]||(a[1]=e=>{n("startApp")})},{default:A((()=>[m(v(e.$t("AppRunningWindow.Start")),1)])),_:1}))])),_:1})])])])),_:1}))}}),wa={style:{flex:"1"}},ya={class:"pa-6 run-right-content"},ha={class:"footer-button-bar"},Aa={class:"footer-terminal-content"},xa=o({__name:"app-run",setup(a){const n=w(),t=me(),l=s(null),o=s(),x=s(),I=s(null),_=s(!1),S=s(!1),b=s(""),{t:E}=T(),{addToast:R}=e(),P=te(),M=s(!1);f((async()=>{W();const e=n.params.id,a=await K(e);I.value=a;const s=a.appId;await t.fetchApp(s),l.value=t.currentLmApp,window.ipcRenderer?.on(ee.STOP_AI_RUNNING_INSTANCE,(()=>{z(),V()})),j();const o=l?.value.name;document.title=o}));const C=D((()=>{if(P.terminals&&P.terminals.length>0)return P.terminals[0]})),W=()=>{const e=E("AppRunningWindow.MainProcessTab");P.initTerminal(e)},$=async()=>{var e;if(e=Q.START,b.value=e,P.changeMainTerminalScriptType(e,""),_.value=!0,l.value){const e=await de(l.value);O(e),window.ipcRenderer?.send(ee.RUNNING_STATUS_CHANGE,!0)}},F=()=>Array.isArray(o.value)?o.value[0]:o.value,O=e=>{const a=F();console.log("run command",a,e),a?.runCommand(e)},z=()=>{_.value=!1,F()?.runStopCommand(),window.ipcRenderer.send(ee.RUNNING_STATUS_CHANGE,!1)},V=()=>{F()?.exitTerminal()},U=e=>{if(Z.isWindows())return;z();const a=ce(e);F()?.runCommand(a),$()},j=async()=>{if($(),ve.needPreStartApp(I.value?.installName))return Z.isMacOS()?void setTimeout((()=>{L()}),20):void 0;L()},L=()=>{S.value=!0},B=e=>{console.log("onCommandExecuteEnd",e),e&&R(e,"success"),setTimeout((()=>{x.value?.updateAppEnvData()}),400)};return(e,a)=>(g(),i(u,null,[r("div",wa,[d(fa,{"lm-app-data":c(l),"is-app-running":c(_),onStopApp:z,onStartApp:$,"installed-instance":c(I)},null,8,["lm-app-data","is-app-running","installed-instance"]),r("div",ya,[c(I)&&c(l)&&c(S)?(g(),y(ua,{key:0,ref_key:"appEnvAndAccessComponent",ref:x,onAppEnvSavedAndUpdated:U,lmAppData:c(l),installedInstance:c(I)},null,8,["lmAppData","installedInstance"])):p("",!0)])]),r("footer",{class:h(["footer-terminal","app-run-footer-terminal",c(M)?"expanded":""])},[r("div",ha,[d(N,{variant:"text",style:{position:"absolute",right:"10px",top:"5px"},onClick:a[0]||(a[0]=e=>M.value=!c(M))},{append:A((()=>[d(k,{src:c(M)?"./images/icons/expand-white.svg":"./images/icons/collapse-white.svg",width:"18",height:"18"},null,8,["src"])])),default:A((()=>[m(v(c(M)?e.$t("AppRunningWindowV2.Hide"):e.$t("AppRunningWindowV2.ViewLog"))+" ",1)])),_:1})]),r("div",Aa,[c(C)&&"main-process"===c(C).tabName?(g(),y(se,{key:0,onExecuteEnd:a[1]||(a[1]=e=>{return a=c(C).commandExecuteEndToastMsg,L(),console.log("onMainTerminalCommandEnd"),void B(a);var a}),"command-execute-end-keywords":c(C).commandExecuteEndKeywords,ref_key:"generalTerminal",ref:o,socketURI:"ws://localhost:19312"},null,8,["command-execute-end-keywords"])):p("",!0)])],2)],64))}}),Ia={class:"app-install-result pt-10 pb-6 px-11 mb-12 mx-10"},_a=o({__name:"install-result",props:{lmAppData:{},installedInstance:{}},setup(e){const a=e,n=()=>{a.installedInstance.appInstallPath&&t(a.installedInstance.appInstallPath)};return(e,a)=>(g(),i("div",Ia,[d(O,{class:"gap-2 mb-2"},{default:A((()=>[d(z,{cols:"12",xs:"12",sm:"6",md:"6",lg:"6",class:"item"},{default:A((()=>[m(v(e.$t("AppRunningWindowV2.AppNameLabel"))+": "+v(e.lmAppData.name),1)])),_:1}),d(z,{cols:"12",xs:"12",sm:"6",md:"6",lg:"6",class:"item"},{default:A((()=>[m(v(e.$t("AppRunningWindowV2.AppInstallTimeLabel"))+": "+v(c(ye).format(e.installedInstance.createTime,!1)),1)])),_:1}),d(z,{cols:"12",xs:"12",sm:"6",md:"6",lg:"6",class:"item"},{default:A((()=>[m(v(e.$t("AppRunningWindowV2.AppInstallLocationLabel"))+": ",1),r("a",{href:"#",onClick:b(n,["prevent"])},v(e.installedInstance.appInstallPath),1)])),_:1})])),_:1})]))}}),{addToast:Sa}=e(),ba=l("appInstall",{state:()=>({installPercent:s(0),installSuccessMsg:s(""),installed:s(!1)}),actions:{initModelsData(){this.installPercent=0},updateUI(e){this.installPercent=e,1===e&&(this.installed=!0,this.installSuccessMsg&&Sa(this.installSuccessMsg,"success"))},onDownloadError(e){console.error("Failed to download App",e),Sa(e.message,"error")}}}),Ea={class:"progress-area"},Da={style:{width:"210px"}},ka={key:0,style:{width:"250px"},class:"mt-6"},Ra={class:"progress-msg mb-8 mt-6"},Ta={class:"progress-msg-title"},Na={class:"progress-msg-title"},Pa=o({__name:"install-progress",props:{lmAppData:{}},setup(e){const n=ba(),t=e;return(e,l)=>(g(),i("div",Ea,[r("div",Da,[d(k,{src:c(n).installed?"./images/app/succes.svg":"./images/app/processing.svg",width:"210",height:"140"},null,8,["src"])]),c(n).installed?p("",!0):(g(),i("div",ka,[d(R,{width:"100%",class:"download-progress-bar","bg-color":"#F2F2FA","bg-opacity":"1","buffer-color":"#DFDFEC","buffer-opacity":"1",opacity:"1",color:c(a).PRIMARY_COLOR,height:"14",max:100,min:0,"model-value":c(n).installPercent,rounded:""},null,8,["color","model-value"])])),r("div",Ra,[c(n).installed?(g(),i(u,{key:1},[r("div",Na,v(e.$t("AppRunningWindowV2.InstallSuccessTitle")),1),r("div",null,[ve.appIsOllama(t.lmAppData?.installName)?(g(),i(u,{key:0},[m(v(e.$t("AppRunningWindowV2.InstallSuccessNextTipForOllama")),1)],64)):(g(),i(u,{key:1},[m(v(e.$t("AppRunningWindowV2.InstallSuccessNextTip")),1)],64))])],64)):(g(),i(u,{key:0},[r("div",Ta,v(e.lmAppData?.name),1),m(" "+v(e.$t("AppRunningWindowV2.InstallingMsg"))+" "+v(c(n).installPercent)+"% ",1)],64))])]))}}),Ma={class:"app-install-container"},Ca={class:"install-steps"},Wa={class:"pa-6 install-right-content"},$a={class:"footer-button-bar"},Fa=o({__name:"app-install",setup(a){const{t:n}=T(),t=te(),l=s(""),o=me(),u=s(null),x=w(),I=s(null),_=s(),S=ba(),b=s(!1),{addToast:E}=e();f((async()=>{D();const e=x.params.id,a=await K(e);I.value=a;const n=a.appId;await o.fetchApp(n),u.value=o.currentLmApp,window.ipcRenderer?.on(ee.STOP_AI_RUNNING_INSTANCE,(()=>{W(),$()})),R();const t=u?.value.name;document.title=t}));const D=()=>{const e=n("AppRunningWindow.MainProcessTab");t.initTerminal(e)},R=async()=>{var e;if(console.log("installApp"),e=Q.INSTALL,l.value=e,console.log("changeMainTerminalScriptType",e,""),t.changeMainTerminalScriptType(e,""),u.value){const e=await ue(u.value);M(e)}},M=e=>{const a=C();console.log("run command",a,e),a?.runCommand(e)},C=()=>Array.isArray(_.value)?_.value[0]:_.value,W=()=>{C()?.runStopCommand(),window.ipcRenderer.send(ee.RUNNING_STATUS_CHANGE,!1)},$=()=>{C()?.exitTerminal()},F=e=>{const a=Te.extractProgress(e);a&&(S.installPercent=a,100===a&&(S.installed=!0))},O=()=>{console.log("installedInstance",I.value?.id),I.value?.id&&ae(I.value.id)},z=()=>{I.value&&he.goToRunningPage(I.value.id,Q.START,I.value.installName)};return(e,a)=>{const n=Pa,t=_a;return g(),i("div",Ma,[r("div",Ca,[r("div",Wa,[c(u)?(g(),y(n,{key:0,"lm-app-data":c(u)},null,8,["lm-app-data"])):p("",!0),c(I)&&c(u)&&c(S).installed?(g(),y(t,{key:1,lmAppData:c(u),installedInstance:c(I)},null,8,["lmAppData","installedInstance"])):p("",!0),r("div",{class:h(["footer-terminal","app-install-footer-terminal",c(b)?"expanded":""])},[r("div",$a,[d(N,{variant:"text",style:{position:"absolute",right:"10px",top:"5px"},onClick:a[0]||(a[0]=e=>b.value=!c(b))},{append:A((()=>[d(k,{src:c(b)?"./images/icons/expand-white.svg":"./images/icons/collapse-white.svg",width:"18",height:"18"},null,8,["src"])])),default:A((()=>[m(v(c(b)?e.$t("AppRunningWindowV2.Hide"):e.$t("AppRunningWindowV2.ViewLog"))+" ",1)])),_:1})]),d(se,{ref_key:"generalTerminal",ref:_,events:["lmdprogress"],onTerminalEvent:F,socketURI:"ws://localhost:19312"},null,512)],2)])]),d(P,{style:{"border-top":"1px solid #EBEBF7"},class:"py-6 text-center justify-center"},{default:A((()=>[d(N,{variant:"outlined",onClick:O},{default:A((()=>[m(v(e.$t("Common.close")),1)])),_:1}),ve.appIsOllama(u.value?.installName)?(g(),y(N,{key:0,variant:"flat",disabled:!c(S).installed,onClick:z,color:"primary"},{default:A((()=>[m(v(e.$t("AppRunningWindowV2.NextStep")),1)])),_:1},8,["disabled"])):p("",!0)])),_:1})])}}}),Oa=o({__name:"AppRunningWindowV2",setup(e){const a=s(""),n=w();return f((()=>{const e=n.query.script;e===Q.INSTALL?a.value="install":e===Q.START||e===Q.DOWNLOAD_MODEL?a.value="run":e===Q.REMOVE&&(a.value="remove")})),(e,n)=>{const t=Fa,l=xa,s=We;return g(),i(u,null,["install"===c(a)?(g(),y(t,{key:0})):p("",!0),"run"===c(a)?(g(),y(l,{key:1})):p("",!0),"remove"===c(a)?(g(),y(s,{key:2})):p("",!0)],64)}}});export{Oa as default};
