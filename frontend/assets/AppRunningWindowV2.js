import{u as e}from"./lmapp.js";import{_ as a,O as n,a as t,D as l,u as s,b as o,e as i,g as r,d,c as p}from"./delete-confirm-dialog.js";import{g as c,I as u,a as m}from"./lmd-system.js";import{A as v,a as g}from"./install-instance.js";import{A as f,O as w,M as y}from"./AppInfoUtil.js";import{R as h,S as A,F as x,b as I,T as S,c as _,r as E,s as k,a as b,m as D,K as N,I as R,l as T,A as P,G as C,d as M,o as W,U as $,B as F,C as z,D as O,E as j}from"./vuetify.js";import{e as U,H as L,$ as V,a1 as B,k as H,S as G,ab as J,K,a3 as Y,a5 as q,F as Q,a2 as X,a0 as Z,b as ee,l as ae,u as ne,a4 as te,m as le,Y as se,a9 as oe,j as ie,a as re,a8 as de}from"./vue.js";import{c as pe,T as ce,o as ue,b as me}from"./index.js";import{p as ve}from"./pretty-bytes.js";import{d as ge}from"./pinia.js";import{D as fe,A as we}from"./DateTimeUtil.js";import"./index2.js";import"./xterm.js";import"./debounce.js";import"./vuei18n.js";import"./lmd-locales.js";import"./dayjs.js";const ye={style:{"font-size":"14px","line-height":"16px"}},he=U({__name:"lmd-expansion-panel",props:{title:{default:""},showExpandIcon:{type:Boolean,default:!1},defaultExpanded:{type:Boolean,default:!1}},setup:e=>(L((()=>{})),(e,a)=>(Z(),V(h,{dense:""},{default:B((()=>[H(A,{class:"d-flex"},{actions:B((({expanded:a})=>[e.showExpandIcon?(Z(),Y(Q,{key:0},[X("span",ye,K(a?e.$t("AppRunningWindowV2.Collapse"):e.$t("AppRunningWindowV2.Expand")),1),H(I,{src:a?"./images/icons/collapse.svg":"./images/icons/expand.svg",width:"16",height:"16"},null,8,["src"])],64)):q("",!0)])),default:B((()=>[G(K(e.title)+" ",1),H(x),J(e.$slots,"append")])),_:3}),H(S,{style:{padding:"0"}},{default:B((()=>[J(e.$slots,"default")])),_:3})])),_:3})))}),Ae=["href"],xe=U({__name:"app-access-row-v2",props:{lmAppData:{},installedInstance:{},appEnv:{}},setup(e){const l=e,s=ee([]),o=ee(!1),i=ee(!1),r=async()=>{if(l.lmAppData?.accessInfo){const e=l.lmAppData.accessInfo,{accessType:a}=e;if(!a)return!1;if("browser"===a)return s.value.push(l.lmAppData.accessInfo?.webUrl||""),!0;if("exec"===a&&f.appIsOllama(l.installedInstance?.installName)){if(l.appEnv){const e=l.appEnv[w];s.value=await n.getAccessHosts(e)}return!0}}return!1};return L((async()=>{o.value=await r(),i.value=f.displayAccessSettingBtn(l.installedInstance?.installName)})),ae((()=>l.appEnv),(async()=>{o.value=await r()})),ae((()=>l.lmAppData?.accessInfo.webUrl),(async()=>{s.value=[],o.value=await r()})),(e,n)=>{const o=a,i=t;return Z(),V(he,{title:e.$t("AppRunningWindow.Access"),readonly:"",value:"app-access",showExpandIcon:!1,"default-expanded":!0},{append:B((()=>[f.appIsOllama(l.lmAppData?.installName)?(Z(),V(o,{key:0,installedInstance:e.installedInstance},null,8,["installedInstance"])):q("",!0)])),default:B((()=>[ne(s)&&ne(s).length>0?(Z(),V(_,{key:0,class:"pt-1 pb-2",style:{margin:"0 -24px -16px"}},{default:B((()=>[H(E,{"no-gutters":"",style:{padding:"0px"}},{default:B((()=>[(Z(!0),Y(Q,null,te(ne(s),((e,a)=>(Z(),V(k,{key:a,class:"px-5 py-2",cols:"12",sm:"6"},{default:B((()=>[H(b,{style:{background:"#FFF4EA","border-radius":"4px",height:"40px"},density:"compact","min-height":"1.1rem",class:"px-5"},{prepend:B((()=>[H(i,{text:e},null,8,["text"])])),default:B((()=>[(Z(),Y("a",{class:"mx-2 app-access-link",key:e,href:e,target:"_blank"},K(e),9,Ae))])),_:2},1024)])),_:2},1024)))),128))])),_:1})])),_:1})):q("",!0)])),_:1},8,["title"])}}}),Ie=U({__name:"app-env-row-v2",props:{installedInstance:{},appEnv:{}},setup(e){const a=ee(null);L((async()=>{a.value=await pe()}));const n=e=>"HF_MIRROR"===e?"HF_ENDPOINT":e;return(e,t)=>(Z(),V(he,{title:e.$t("AppRunningWindow.EnvVars"),showExpandIcon:!0,value:"app-env"},{default:B((()=>[H(D,{class:"my-1 pt-2 pb-0 mx-0"},{default:B((()=>[(Z(!0),Y(Q,null,te(ne(a),((e,a)=>(Z(),V(N,{variant:"tonal",size:"small",style:{"min-width":"50px","max-width":"190px","margin-left":"4px"},key:a},{default:B((()=>[G(K(n(a))+" ",1),H(R,{activator:"parent",location:"bottom"},{default:B((()=>[G(K(e),1)])),_:2},1024)])),_:2},1024)))),128)),(Z(!0),Y(Q,null,te(e.appEnv,((e,a)=>(Z(),V(N,{variant:"tonal",color:"orange-darken-4",size:"small",style:{"min-width":"50px","max-width":"220px","margin-left":"4px"},key:a},{default:B((()=>[G(K(a)+" ",1),H(R,{activator:"parent",location:"bottom"},{default:B((()=>[G(K(e),1)])),_:2},1024)])),_:2},1024)))),128))])),_:1})])),_:1},8,["title"]))}}),Se={key:0,style:{width:"84px"},class:"d-flex flex-column justify-center items-center"},_e={class:"progress-text"},Ee=U({__name:"download-progress",props:{downloadInfo:{}},setup:e=>(e,a)=>e.downloadInfo?(Z(),Y("div",Se,[H(T,{width:"100%",class:"download-progress-bar","bg-color":"#D8D8D8","bg-opacity":"1","buffer-color":"#DFDFEC","buffer-opacity":"1",opacity:"1",color:ne(ce).PRIMARY_COLOR,height:"3",max:1,min:0,"model-value":e.downloadInfo.percent,rounded:""},null,8,["color","model-value"]),X("div",_e,[G(K(e.$t("AppRunningWindowV2.Downloading"))+" ",1),e.downloadInfo.percent?(Z(),Y(Q,{key:0},[G(K(Math.floor(100*e.downloadInfo.percent))+"% ",1)],64)):q("",!0)])])):q("",!0)}),ke={key:0},be={class:"model-storage-title d-flex flex-row align-baseline"},De={class:""},Ne={class:"justify-center mr-6"},Re={class:"d-flex"},Te={style:{flex:"1"}},Pe={class:"d-flex"},Ce={class:"d-flex flex-row mt-1",style:{"font-size":"14px"}},Me={style:{flex:"1"}},We=U({__name:"model-storage",props:{installedInstance:{},appEnv:{}},setup(e){const n=e,t=ee(""),l=ee(""),s=ee(""),o=ee(0),i=ee(null);L((async()=>{f.appIsOllama(n.installedInstance?.installName)&&(await p(),u())}));const r=ee(null),{t:d}=P(),p=async()=>{const e=await c();l.value=e+"/.ollama/models"},u=async()=>{const e=await f.getModelsDir(n.installedInstance?.installName,n.appEnv);console.log("dir",e),t.value=e||l.value,console.log("modelDir.value",t.value);const a=await f.getModelFileSize(n.installedInstance?.installName,t.value);a.dirSize&&(r.value=ve(a.dirSize),i.value=a,console.log("dirInfo",a),m())},m=()=>{if(!i.value)return;let e=0;try{e=i.value?.totalSpace-i.value.dirSize-i.value.freeSpace,o.value=i.value?.totalSpace-i.value.freeSpace}catch(l){console.error("calculate error",l)}const a=ve(e),n=ve(i.value.freeSpace),t=`${d("AppRunningWindow.StorageModelsSize")}: ${r.value},\n  ${d("AppRunningWindow.StorageDiskOther")}: ${a},\n  ${d("AppRunningWindow.StorageDiskFreeSpace")}: ${n}\n  `;s.value=t};ae((()=>n.appEnv),(e=>{u()})),ae((()=>n.installedInstance),(e=>{u()}));const v=async()=>{ue(t.value)};return(e,n)=>ne(r)?(Z(),Y("div",ke,[X("div",be,[X("div",De,K(e.$t("AppRunningWindow.ModelStorageLabel")),1),H(x),X("div",Ne,[H(a,{installedInstance:e.installedInstance},null,8,["installedInstance"])])]),H(D,{class:"mt-3 pb-3 px-5"},{default:B((()=>[X("div",Re,[X("div",null,[H(I,{src:"./images/icons/harddisk.svg",class:"mr-1",width:"72",height:"34"})]),X("div",Te,[X("div",Pe,[H(R,{text:ne(s),location:"top"},{activator:B((({props:e})=>[H(T,le({class:"custom-progress-bar"},e,{location:null,"bg-color":"#FFFFFF","bg-opacity":"1","buffer-color":"#DFDFEC","buffer-opacity":"1",opacity:"1",color:"#FEF1E5",height:"14",max:ne(i)?.totalSpace||10,min:"0","buffer-value":ne(o),"model-value":ne(i)?.dirSize,rounded:""}),null,16,["max","buffer-value","model-value"])])),_:1},8,["text"])]),X("div",Ce,[X("div",Me,K(ne(i)?.diskName),1),X("a",{href:"#",style:{"text-decoration":"none",color:"rgba(0, 0, 0, 0.75)"},onClick:se(v,["prevent"])},[G(K(ne(r))+" > ",1),ne(t)?(Z(),V(R,{key:0,activator:"parent",location:"top"},{default:B((()=>[G(K(ne(t)),1)])),_:1})):q("",!0)])])])])])),_:1})])):q("",!0)}}),$e="http://localhost:11434";class Fe{constructor(e,a){if(this.paramSize=e,this.updateUI=a,!e.nameAndSize)throw new Error("nameAndSize is empty");this.nameAndSize=e.nameAndSize}totalPercentageWithoutCurrent=.01;totalPercentage=.01;pullingMainPart="";pullingCurrentPart="";nameAndSize="";async download(){const e=await fetch(`${$e}/api/pull`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:this.nameAndSize,stream:!0})});if(!e.ok)throw new Error(`HTTP error: ${e.status}`);if(!e.body)throw new Error("No response body");const a=e.body.getReader(),n=new TextDecoder;let t="";for(;;){const{done:e,value:s}=await a.read();if(e)break;t+=n.decode(s);const o=t.split("\n");t=o.pop()||"";for(const a of o)if(a.trim())try{const e=JSON.parse(a);this.processProgress(e)}catch(l){console.error("Parse error:",l)}}}calculatePercentage(e,a,n){let t=this.totalPercentageWithoutCurrent;if(e&&e.completed&&e.total){t+=e.completed/e.total*a,t>.99&&(t=.99),t>=this.totalPercentage&&(this.totalPercentage=t)}n&&this.totalPercentage>=this.totalPercentageWithoutCurrent&&(this.totalPercentageWithoutCurrent=this.totalPercentage)}processProgress(e){const a=e?.status;let n=.02;if("pulling manifest"===a)n=.01;else if(a.startsWith("downloading")||a.startsWith("pulling")){void 0!==e.total&&void 0!==e.completed&&(!this.pullingMainPart&&e.total>5242880&&(this.pullingMainPart=a),this.pullingMainPart===a&&(n=.89));let t=!1;this.pullingCurrentPart!==a&&(this.pullingCurrentPart=a,t=!0),this.calculatePercentage(e,n,t)}else"success"===a&&(this.totalPercentage=1);this.updateUI&&this.updateUI(this.paramSize,this.totalPercentage)}}const{addToast:ze}=me(),Oe=ge("modelDownloadInfo",{state:()=>({models:ee([]),parameterSizes:ee([]),downloadSuccessMsg:ee("")}),actions:{initModelsData(){this.models=[],this.parameterSizes=[]},updateUI(e,a){const n=e.downloadProgress;n&&(n.percent=a,1===a&&(e.installed=!0,this.downloadSuccessMsg&&ze(this.downloadSuccessMsg,"success")))},onDownloadError(e){console.error("Failed to download model",e),ze(e.message,"error")},startDownload(e,a){a.nameAndSize=e,a.downloadProgress={nameAndSize:e,percent:0},this.updateUI(a,.01),(async(e,a,n)=>{new Fe(e,a).download().catch((e=>{n&&(console.error("download err",e),n(e))}))})(a,this.updateUI,this.onDownloadError)},async cancelDownload(e,a){const n=y.genModelNameAndSize(e,a);try{await(async e=>{const a=await fetch(`${$e}/api/pull`,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e})});if(!a.ok)throw new Error(`HTTP error: ${a.status}`);if(!a.body)throw new Error("No response body");const n=await a.json();n.error?console.error("cancel error",n.error):console.log("cancel done",n)})(n)}catch(t){console.error(t)}finally{a.installed=!1,a.downloadProgress&&(a.downloadProgress.percent=void 0)}},async deleteModel(e,a){const n=y.genModelNameAndSize(e,a);try{await(async e=>{const a=await fetch(`${$e}/api/delete`,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e})});if(!a.ok)throw new Error(`HTTP error: ${a.status}`);if(!a.body)throw new Error("No response body");const n=await a.json();n.error?console.error("del error",n.error):console.log("del done",n)})(n)}catch(t){console.error(t)}finally{a.installed=!1,a.downloadProgress&&(a.downloadProgress.percent=void 0)}}}}),je={key:0,class:"text-center py-10",style:{flex:"1"}},Ue={class:"d-flex flex-row justify-center"},Le={style:{"min-width":"46px",display:"inline-block"}},Ve={style:{"min-width":"60px",display:"inline-block"}},Be={key:0,class:"installed-chip"},He={key:1,class:"not-installed-chip"},Ge=U({__name:"model-download-row-v2",props:{lmAppData:{},installedInstance:{},appEnv:{}},setup(e){const a=Oe(),t=ee(!1),s=ee(null),o=ee(null),i=ee(!1),r=ee(""),{t:d}=P(),p=e;L((async()=>{c(),a.downloadSuccessMsg=d("AppRunningWindow.ModelDownloadSuccessful"),await m()})),ae((()=>p.lmAppData),(()=>{c()})),ae((()=>p.installedInstance),(()=>{m()})),ae((()=>p.appEnv),(()=>{m()}));const c=()=>{t.value=f.appIsOllama(p.lmAppData?.installName)};ae(s,(()=>{u()}));const u=()=>{const e=s.value,n=a.models.find((a=>a.installName===e)),t=n?.tags||[];a.parameterSizes=t},m=async()=>{const e=p.installedInstance?.installName;if(e&&t.value){a.initModelsData();const t=n.getDownloadableModels(),l=await f.mergeModelsList(e,t);if(a.models=l,s.value)u();else{const e=a.models;if(e&&e.length>0){const a=e[0];s.value=a.installName}}}},v=async()=>{s.value&&o.value&&a.deleteModel(s.value,o.value)},g=e=>{const a=e.downloadProgress;return!!(a?.percent&&a.percent<1)},w=e=>{const a=e.tags;if(a&&a.length>0)for(let n=0;n<a.length;n++){if(a[n].installed)return!0}};return(e,n)=>{const d=Ee;return Z(),Y(Q,null,[e.lmAppData&&ne(t)?(Z(),V(he,{key:0,class:"model-download-panel",showExpandIcon:!0,value:"model-download",title:e.$t("AppRunningWindow.ModelDownload")},{default:B((()=>[H(D,{class:"model-download-sheet d-flex flex-row"},{default:B((()=>[ne(a).models&&0!==ne(a).models.length?q("",!0):(Z(),Y("div",je,[H(C,{color:"primary",indeterminate:"",size:"40"})])),ne(a).models&&ne(a).models.length>0?(Z(),V(_,{key:1,style:{"border-right":"1px solid #EBEBF7",flex:"1",padding:"0"},"max-height":"340"},{default:B((()=>[(Z(!0),Y(Q,null,te(ne(a).models,((e,a)=>(Z(),V(b,{key:e.installName+a,density:"compact","active-class":"selected-model-item",onClick:a=>{var n;(n=e.installName)!==s.value&&(s.value=n)},active:ne(s)===e.installName,title:e.displayName,value:e.installName},{append:B((()=>[w(e)?(Z(),V(M,{key:0,class:"downloaded-icon",icon:"mdi-check-bold",size:"18"})):q("",!0)])),_:2},1032,["onClick","active","title","value"])))),128))])),_:1})):q("",!0),ne(a).models&&ne(a).models.length>0?(Z(),V(_,{key:2,style:{flex:"1",padding:"0"}},{default:B((()=>[(Z(!0),Y(Q,null,te(ne(a).parameterSizes,((n,t)=>(Z(),V(b,{key:n.parameterSize+t,density:"compact",active:!1,value:n.parameterSize},{default:B((()=>[X("div",Ue,[X("span",Le,K(n.parameterSize),1),X("span",Ve,[H(N,{density:"compact",class:"mx-1 file-size-chip"},{default:B((()=>[G(K(n.fileSize),1)])),_:2},1024)]),H(x,{style:{flex:"1"}}),n.installed?(Z(),Y("div",Be,K(e.$t("AppRunningWindow.ModelDownloaded")),1)):(Z(),Y(Q,{key:1},[g(n)?(Z(),V(d,{key:0,"download-info":n.downloadProgress},null,8,["download-info"])):(Z(),Y("div",He,K(e.$t("AppRunningWindow.ModelNotDownloaded")),1))],64)),H(x,{style:{flex:"1"}}),n.installed?(Z(),V(W,{key:2,onClick:e=>(e=>{if(!s.value)return;const a=y.genModelNameAndSize(s.value,e);o.value=e,i.value=!0,r.value=a})(n),variant:"text",density:"compact",color:"#F2313F"},{default:B((()=>[G(K(e.$t("AppRunningWindow.ModelDeleteBtnLabel")),1)])),_:2},1032,["onClick"])):(Z(),Y(Q,{key:3},[g(n)?(Z(),V(W,{key:0,onClick:e=>(async e=>{s.value&&a.cancelDownload(s.value,e)})(n),variant:"text",density:"compact"},{default:B((()=>[G(K(e.$t("AppRunningWindow.Cancel")),1)])),_:2},1032,["onClick"])):(Z(),V(W,{key:1,onClick:e=>(async e=>{if(!s.value)return;const n=y.genModelNameAndSize(s.value,e);a.startDownload(n,e)})(n),variant:"text",class:"model-download-btn",density:"compact"},{default:B((()=>[G(K(e.$t("AppRunningWindow.ModelDownloadBtnLabel")),1)])),_:2},1032,["onClick"]))],64))])])),_:2},1032,["value"])))),128))])),_:1})):q("",!0)])),_:1}),H(D,{style:{"border-top":"1px solid #EBEBF7"}},{default:B((()=>[H(We,{appEnv:e.appEnv,installedInstance:e.installedInstance},null,8,["appEnv","installedInstance"])])),_:1})])),_:1},8,["title"])):q("",!0),H(l,{"model-value":ne(i),"onUpdate:modelValue":n[0]||(n[0]=e=>i.value=e),"item-name":ne(r),onConfirm:v},null,8,["model-value","item-name"])],64)}}}),Je=U({__name:"app-env-and-access-v2",props:{installedInstance:{},lmAppData:{}},emits:["appEnvSavedAndUpdated"],setup(e,{expose:a,emit:t}){const l=e,o=s(),i=ee({}),r=ee(["app-access"]),d=t;L((async()=>{u(),c()}));const p=oe(),c=()=>{p.query.script===v.DOWNLOAD_MODEL&&(r.value=["app-access","model-download"])},u=async()=>{const e=l.installedInstance?.installName;f.appIsOllama(e)&&(i.value=await n.getOSEnvObj()||{})};return a({updateAppEnvData:u}),ae((()=>l.installedInstance),(()=>{u()})),ae((()=>o.appSettingsSaved),(async e=>{e&&(i.value=null,await u(),d("appEnvSavedAndUpdated",i.value))})),(e,a)=>{const n=xe;return ne(i)&&e.installedInstance?(Z(),V($,{key:0,multiple:"",elevation:"0",modelValue:ne(r),"onUpdate:modelValue":a[0]||(a[0]=e=>ie(r)?r.value=e:null),class:"lmd-running-panels"},{default:B((()=>[H(n,{appEnv:ne(i),lmAppData:e.lmAppData,installedInstance:e.installedInstance},null,8,["appEnv","lmAppData","installedInstance"]),H(Ge,{appEnv:ne(i),installedInstance:e.installedInstance,lmAppData:e.lmAppData},null,8,["appEnv","installedInstance","lmAppData"]),H(Ie,{appEnv:ne(i),installedInstance:e.installedInstance},null,8,["appEnv","installedInstance"])])),_:1},8,["modelValue"])):q("",!0)}}}),Ke={class:"d-flex flex-column text-center justify-center align-middle"},Ye={style:{width:"60px",margin:"0 auto"},class:"mt-10"},qe={class:"d-flex flex-column justify-center"},Qe=U({__name:"app-info-left",props:{lmAppData:{},installedInstance:{},isAppRunning:{type:Boolean}},emits:["startApp","stopApp"],setup(e,{emit:a}){const n=a;return(e,a)=>(Z(),V(D,{class:"left-app-basic-info"},{default:B((()=>[X("div",Ke,[X("div",Ye,[H(I,{src:e.lmAppData?.icon,width:"60",height:"60"},null,8,["src"])]),X("div",qe,[H(F,{class:"pt-1 pb-0"},{default:B((()=>[G(K(e.lmAppData?.name),1)])),_:1}),e.installedInstance?.version&&"--"!==e.installedInstance?.version?(Z(),V(z,{key:0,class:"py-0"},{default:B((()=>[G(K(e.$t("AppRunningWindow.Version"))+" "+K(e.installedInstance?.version),1)])),_:1})):q("",!0),H(O,null,{default:B((()=>[H(x,{class:"mt-6"}),e.isAppRunning?(Z(),V(W,{key:0,variant:"flat",color:"#F2313F",class:"mx-2",width:"80",height:"40",onClick:a[0]||(a[0]=e=>{n("stopApp")})},{default:B((()=>[G(K(e.$t("AppRunningWindow.Stop")),1)])),_:1})):(Z(),V(W,{key:1,color:"primary",variant:"flat",class:"mx-2",width:"80",height:"40",onClick:a[1]||(a[1]=e=>{n("startApp")})},{default:B((()=>[G(K(e.$t("AppRunningWindow.Start")),1)])),_:1}))])),_:1})])])])),_:1}))}}),Xe={style:{flex:"1"}},Ze={class:"pa-6 run-right-content"},ea={class:"footer-button-bar"},aa={class:"footer-terminal-content"},na=U({__name:"app-run",setup(a){const n=oe(),t=e(),l=ee(null),p=ee(),c=ee(),m=ee(null),w=ee(!1),y=ee(!1),h=ee(""),{t:A}=P(),{addToast:x}=me(),S=s(),_=ee(!1);L((async()=>{k();const e=n.params.id,a=await g(e);m.value=a;const s=a.appId;await t.fetchApp(s),l.value=t.currentLmApp,window.ipcRenderer?.on(u.STOP_AI_RUNNING_INSTANCE,(()=>{R(),T()})),M();const o=l?.value.name;document.title=o}));const E=re((()=>{if(S.terminals&&S.terminals.length>0)return S.terminals[0]})),k=()=>{const e=A("AppRunningWindow.MainProcessTab");S.initTerminal(e)},b=async()=>{var e;if(e=v.START,h.value=e,S.changeMainTerminalScriptType(e,""),w.value=!0,l.value){const e=await r(l.value);N(e),window.ipcRenderer?.send(u.RUNNING_STATUS_CHANGE,!0)}},D=()=>Array.isArray(p.value)?p.value[0]:p.value,N=e=>{const a=D();console.log("run command",a,e),a?.runCommand(e)},R=()=>{w.value=!1,D()?.runStopCommand(),window.ipcRenderer.send(u.RUNNING_STATUS_CHANGE,!1)},T=()=>{D()?.exitTerminal()},C=e=>{if(o.isWindows())return;R();const a=d(e);D()?.runCommand(a),b()},M=async()=>{if(b(),f.needPreStartApp(m.value?.installName))return o.isMacOS()?void setTimeout((()=>{$()}),20):void 0;$()},$=()=>{y.value=!0},F=e=>{console.log("onCommandExecuteEnd",e),e&&x(e,"success"),setTimeout((()=>{c.value?.updateAppEnvData()}),400)};return(e,a)=>(Z(),Y(Q,null,[X("div",Xe,[H(Qe,{"lm-app-data":ne(l),"is-app-running":ne(w),onStopApp:R,onStartApp:b,"installed-instance":ne(m)},null,8,["lm-app-data","is-app-running","installed-instance"]),X("div",Ze,[ne(m)&&ne(l)&&ne(y)?(Z(),V(Je,{key:0,ref_key:"appEnvAndAccessComponent",ref:c,onAppEnvSavedAndUpdated:C,lmAppData:ne(l),installedInstance:ne(m)},null,8,["lmAppData","installedInstance"])):q("",!0)])]),X("footer",{class:de(["footer-terminal","app-run-footer-terminal",ne(_)?"expanded":""])},[X("div",ea,[H(W,{variant:"text",style:{position:"absolute",right:"10px",top:"5px"},onClick:a[0]||(a[0]=e=>_.value=!ne(_))},{append:B((()=>[H(I,{src:ne(_)?"./images/icons/expand-white.svg":"./images/icons/collapse-white.svg",width:"18",height:"18"},null,8,["src"])])),default:B((()=>[G(K(ne(_)?e.$t("AppRunningWindowV2.Hide"):e.$t("AppRunningWindowV2.ViewLog"))+" ",1)])),_:1})]),X("div",aa,[ne(E)&&"main-process"===ne(E).tabName?(Z(),V(i,{key:0,onExecuteEnd:a[1]||(a[1]=e=>{return a=ne(E).commandExecuteEndToastMsg,$(),console.log("onMainTerminalCommandEnd"),void F(a);var a}),"command-execute-end-keywords":ne(E).commandExecuteEndKeywords,ref_key:"generalTerminal",ref:p,socketURI:"ws://localhost:19312"},null,8,["command-execute-end-keywords"])):q("",!0)])],2)],64))}}),ta={class:"app-install-result pt-10 pb-6 px-11 mb-12 mx-10"},la=U({__name:"install-result",props:{lmAppData:{},installedInstance:{}},setup(e){const a=e,n=()=>{a.installedInstance.appInstallPath&&ue(a.installedInstance.appInstallPath)};return(e,a)=>(Z(),Y("div",ta,[H(E,{class:"gap-2 mb-2"},{default:B((()=>[H(k,{cols:"12",xs:"12",sm:"6",md:"6",lg:"6",class:"item"},{default:B((()=>[G(K(e.$t("AppRunningWindowV2.AppNameLabel"))+": "+K(e.lmAppData.name),1)])),_:1}),H(k,{cols:"12",xs:"12",sm:"6",md:"6",lg:"6",class:"item"},{default:B((()=>[G(K(e.$t("AppRunningWindowV2.AppInstallTimeLabel"))+": "+K(ne(fe).format(e.installedInstance.createTime,!1)),1)])),_:1}),H(k,{cols:"12",xs:"12",sm:"6",md:"6",lg:"6",class:"item"},{default:B((()=>[G(K(e.$t("AppRunningWindowV2.AppInstallLocationLabel"))+": ",1),X("a",{href:"#",onClick:se(n,["prevent"])},K(e.installedInstance.appInstallPath),1)])),_:1})])),_:1})]))}}),{addToast:sa}=me(),oa=ge("appInstall",{state:()=>({installPercent:ee(0),installSuccessMsg:ee(""),installed:ee(!1)}),actions:{initModelsData(){this.installPercent=0},updateUI(e){this.installPercent=e,1===e&&(this.installed=!0,this.installSuccessMsg&&sa(this.installSuccessMsg,"success"))},onDownloadError(e){console.error("Failed to download App",e),sa(e.message,"error")}}}),ia={class:"progress-area"},ra={style:{width:"210px"}},da={key:0,style:{width:"250px"},class:"mt-6"},pa={class:"progress-msg mb-8 mt-6"},ca={class:"progress-msg-title"},ua={class:"progress-msg-title"},ma=U({__name:"install-progress",props:{lmAppData:{}},setup(e){const a=oa(),n=e;return(e,t)=>(Z(),Y("div",ia,[X("div",ra,[H(I,{src:ne(a).installed?"./images/app/succes.svg":"./images/app/processing.svg",width:"210",height:"140"},null,8,["src"])]),ne(a).installed?q("",!0):(Z(),Y("div",da,[H(T,{width:"100%",class:"download-progress-bar","bg-color":"#F2F2FA","bg-opacity":"1","buffer-color":"#DFDFEC","buffer-opacity":"1",opacity:"1",color:ne(ce).PRIMARY_COLOR,height:"14",max:100,min:0,"model-value":ne(a).installPercent,rounded:""},null,8,["color","model-value"])])),X("div",pa,[ne(a).installed?(Z(),Y(Q,{key:1},[X("div",ua,K(e.$t("AppRunningWindowV2.InstallSuccessTitle")),1),X("div",null,[f.appIsOllama(n.lmAppData?.installName)?(Z(),Y(Q,{key:0},[G(K(e.$t("AppRunningWindowV2.InstallSuccessNextTipForOllama")),1)],64)):(Z(),Y(Q,{key:1},[G(K(e.$t("AppRunningWindowV2.InstallSuccessNextTip")),1)],64))])],64)):(Z(),Y(Q,{key:0},[X("div",ca,K(e.lmAppData?.name),1),G(" "+K(e.$t("AppRunningWindowV2.InstallingMsg"))+" "+K(ne(a).installPercent)+"% ",1)],64))])]))}});class va{static extractProgress(e){let a=null;try{const n=/lmdprogress:(\d+)/g;let t;for(;null!==(t=n.exec(e));)a=parseInt(t[1],10)}catch(n){console.error("parse err",n)}return a}}const ga={class:"app-install-container"},fa={class:"install-steps"},wa={class:"pa-6 install-right-content"},ya={class:"footer-button-bar"},ha=U({__name:"app-install",setup(a){const{t:n}=P(),t=s(),l=ee(""),o=e(),r=ee(null),d=oe(),c=ee(null),w=ee(),y=oa(),h=ee(!1),{addToast:A}=me();L((async()=>{x();const e=d.params.id,a=await g(e);c.value=a;const n=a.appId;await o.fetchApp(n),r.value=o.currentLmApp,window.ipcRenderer?.on(u.STOP_AI_RUNNING_INSTANCE,(()=>{k(),b()})),S();const t=r?.value.name;document.title=t}));const x=()=>{const e=n("AppRunningWindow.MainProcessTab");t.initTerminal(e)},S=async()=>{if(console.log("installApp"),(e=>{l.value=e;let a="";a=n("AppRunningWindow.InstallSuccess"),console.log("changeMainTerminalScriptType",e,a),t.changeMainTerminalScriptType(e,a)})(v.INSTALL),r.value){const e=await p(r.value);_(e)}},_=e=>{const a=E();console.log("run command",a,e),a?.runCommand(e)},E=()=>Array.isArray(w.value)?w.value[0]:w.value,k=()=>{E()?.runStopCommand(),window.ipcRenderer.send(u.RUNNING_STATUS_CHANGE,!1)},b=()=>{E()?.exitTerminal()},D=e=>{const a=va.extractProgress(e);a&&(y.installPercent=a,100===a&&(y.installed=!0,A(n("AppRunningWindow.InstallSuccess"),"success")))},N=()=>{console.log("installedInstance",c.value?.id),c.value?.id&&m(c.value.id)},R=()=>{c.value&&we.goToRunningPage(c.value.id,v.START,c.value.installName)};return(e,a)=>{const n=ma,t=la;return Z(),Y("div",ga,[X("div",fa,[X("div",wa,[ne(r)?(Z(),V(n,{key:0,"lm-app-data":ne(r)},null,8,["lm-app-data"])):q("",!0),ne(c)&&ne(r)&&ne(y).installed?(Z(),V(t,{key:1,lmAppData:ne(r),installedInstance:ne(c)},null,8,["lmAppData","installedInstance"])):q("",!0),X("div",{class:de(["footer-terminal","app-install-footer-terminal",ne(h)?"expanded":""])},[X("div",ya,[H(W,{variant:"text",style:{position:"absolute",right:"10px",top:"5px"},onClick:a[0]||(a[0]=e=>h.value=!ne(h))},{append:B((()=>[H(I,{src:ne(h)?"./images/icons/expand-white.svg":"./images/icons/collapse-white.svg",width:"18",height:"18"},null,8,["src"])])),default:B((()=>[G(K(ne(h)?e.$t("AppRunningWindowV2.Hide"):e.$t("AppRunningWindowV2.ViewLog"))+" ",1)])),_:1})]),H(i,{ref_key:"generalTerminal",ref:w,events:["lmdprogress"],onTerminalEvent:D,socketURI:"ws://localhost:19312"},null,512)],2)])]),H(j,{style:{"border-top":"1px solid #EBEBF7"},class:"py-6 text-center justify-center"},{default:B((()=>[H(W,{variant:"outlined",onClick:N},{default:B((()=>[G(K(e.$t("Common.close")),1)])),_:1}),f.appIsOllama(r.value?.installName)?(Z(),V(W,{key:0,variant:"flat",disabled:!ne(y).installed,onClick:R,color:"primary"},{default:B((()=>[G(K(e.$t("AppRunningWindowV2.NextStep")),1)])),_:1},8,["disabled"])):q("",!0)])),_:1})])}}}),Aa=U({__name:"AppRunningWindowV2",setup(e){const a=ee(""),n=oe();return L((()=>{const e=n.query.script;e===v.INSTALL?a.value="install":e!==v.START&&e!==v.DOWNLOAD_MODEL||(a.value="run")})),(e,n)=>{const t=ha,l=na;return Z(),Y(Q,null,["install"===ne(a)?(Z(),V(t,{key:0})):q("",!0),"run"===ne(a)?(Z(),V(l,{key:1})):q("",!0)],64)}}});export{Aa as default};
