import{c as e,T as a,i as n,h as t,o as l}from"./index.js";import{d as s}from"./pinia.js";import{b as o,e as i,a3 as r,a2 as c,a5 as d,k as p,u,F as m,S as v,K as g,a0 as f,H as w,aa as y,$ as h,a8 as A,a1 as x,ac as I,l as _,a4 as S,m as b,Y as D,j as k,c as E}from"./vue.js";import{b as R,m as T,D as N,q as M,F as P,S as C,T as W,G as $,U as O,c as F,w as z,x as L,a as V,L as j,l as U,n as B,H,d as G,W as Y,E as J,o as q,p as K}from"./vuetify.js";import{b as Q,A as X,d as Z,O as ee}from"./OSUtil.js";import{I as ae,a as ne,g as te,b as le}from"./lmd-system.js";import"./index2.js";import{u as se,e as oe,d as ie,_ as re,O as ce,a as de,D as pe,g as ue,c as me,b as ve}from"./delete-confirm-dialog.js";import{u as ge}from"./lmapp.js";import{A as fe,O as we,M as ye}from"./AppInfoUtil.js";import{p as he}from"./pretty-bytes.js";import{D as Ae}from"./DateTimeUtil.js";import{A as xe}from"./AppRunningUtil.js";import"./xterm.js";import"./debounce.js";import"./vuei18n.js";import"./lmd-locales.js";import"./dayjs.js";const{addToast:Ie}=e(),_e=s("appRemove",{state:()=>({removePercent:o(0),removeSuccessMsg:o(""),removed:o(!1)}),actions:{initModelsData(){this.removePercent=0},updateUI(e){this.removePercent=e,1===e&&(this.removed=!0,this.removeSuccessMsg&&Ie(this.removeSuccessMsg,"success"))}}}),Se={class:"progress-area"},be={style:{width:"210px"}},De={key:0,style:{width:"250px"},class:"mt-6"},ke={class:"progress-msg mb-8 mt-6"},Ee={class:"progress-msg-title"},Re={class:"progress-msg-title"},Te={class:"mt-3",style:{"font-size":"14px"}},Ne=i({__name:"remove-progress",props:{lmAppData:{}},setup(e){const n=_e();return(e,t)=>(f(),r("div",Se,[c("div",be,[p(R,{src:u(n).removed?"./images/my-ai/del-tip.svg":"./images/app/processing.svg",width:"210",height:"140"},null,8,["src"])]),u(n).removed?d("",!0):(f(),r("div",De,[p(T,{width:"100%",class:"download-progress-bar","bg-color":"#F2F2FA","bg-opacity":"1","buffer-color":"#DFDFEC","buffer-opacity":"1",opacity:"1",color:u(a).PRIMARY_COLOR,height:"14",max:100,min:0,"model-value":u(n).removePercent,rounded:""},null,8,["color","model-value"])])),c("div",ke,[u(n).removed?(f(),r(m,{key:1},[c("div",Re,g(e.$t("AppRunningWindowV2.DeleteSuccessTitle")),1),c("div",Te,g(e.$t("AppRunningWindowV2.DeleteSuccessMsg")),1)],64)):(f(),r(m,{key:0},[c("div",Ee,g(e.lmAppData?.name),1),v(" "+g(e.$t("AppRunningWindowV2.DeletingMsg"))+" "+g(u(n).removePercent)+"% ",1)],64))])]))}});class Me{static extractProgress(e){let a=null;try{const n=/lmdprogress:(\d+)/g;let t;for(;null!==(t=n.exec(e));)a=parseInt(t[1],10)}catch(n){console.error("parse err",n)}return a}}const Pe={class:"app-install-container"},Ce={class:"install-steps"},We={class:"pa-6 install-right-content"},$e={class:"footer-button-bar"},Oe=i({__name:"app-remove",setup(a){const{t:n}=N(),t=se(),l=o(""),s=ge(),i=o(null),m=y(),I=o(null),_=o(),S=_e(),b=o(!1),{addToast:D}=e();w((async()=>{k();const e=m.params.id;let a;try{a=await Q(e)}catch(o){return console.log(o),void D(n("AppRunningWindowV2.DeleteNotFound"),"error")}I.value=a;const t=a.appId;await s.fetchApp(t),i.value=s.currentLmApp,window.ipcRenderer?.on(ae.STOP_AI_RUNNING_INSTANCE,(()=>{W(),$()})),E();const l=i?.value.name;document.title=n("LocalApps.Delete")+" "+l}));const k=()=>{const e=n("AppRunningWindow.MainProcessTab");t.initTerminal(e)},E=async()=>{var e;if(e=X.REMOVE,l.value=e,console.log("changeMainTerminalScriptType",e,""),t.changeMainTerminalScriptType(e,""),i.value){const e=await oe(i.value);T(e)}},T=e=>{const a=C();console.log("run command",a,e),a?.runCommand(e)},C=()=>Array.isArray(_.value)?_.value[0]:_.value,W=()=>{C()?.runStopCommand(),window.ipcRenderer.send(ae.RUNNING_STATUS_CHANGE,!1)},$=()=>{C()?.exitTerminal()},O=e=>{const a=Me.extractProgress(e);a&&(S.removePercent=a,100===a&&(S.removed=!0,I.value?.id&&Z(I.value?.id)))},F=()=>{I.value?.id&&ne(I.value.id)};return(e,a)=>{const n=Ne;return f(),r("div",Pe,[c("div",Ce,[c("div",We,[u(i)?(f(),h(n,{key:0,"lm-app-data":u(i)},null,8,["lm-app-data"])):d("",!0),c("div",{class:A(["footer-terminal","app-install-footer-terminal",u(b)?"expanded":""])},[c("div",$e,[p(M,{variant:"text",style:{position:"absolute",right:"10px",top:"5px"},onClick:a[0]||(a[0]=e=>b.value=!u(b))},{append:x((()=>[p(R,{src:u(b)?"./images/icons/expand-white.svg":"./images/icons/collapse-white.svg",width:"18",height:"18"},null,8,["src"])])),default:x((()=>[v(g(u(b)?e.$t("AppRunningWindowV2.Hide"):e.$t("AppRunningWindowV2.ViewLog"))+" ",1)])),_:1})]),p(ie,{ref_key:"generalTerminal",ref:_,events:["lmdprogress"],onTerminalEvent:O,socketURI:"ws://localhost:19312"},null,512)],2)])]),p(P,{style:{"border-top":"1px solid #EBEBF7"},class:"py-6 text-center justify-center"},{default:x((()=>[p(M,{variant:"outlined",onClick:F},{default:x((()=>[v(g(e.$t("Common.close")),1)])),_:1})])),_:1})])}}}),Fe={style:{"font-size":"14px","line-height":"16px"}},ze=i({__name:"lmd-expansion-panel",props:{title:{default:""},showExpandIcon:{type:Boolean,default:!1},defaultExpanded:{type:Boolean,default:!1}},setup:e=>(w((()=>{})),(e,a)=>(f(),h(C,{dense:""},{default:x((()=>[p(W,{class:"d-flex"},{actions:x((({expanded:a})=>[e.showExpandIcon?(f(),r(m,{key:0},[c("span",Fe,g(a?e.$t("AppRunningWindowV2.Collapse"):e.$t("AppRunningWindowV2.Expand")),1),p(R,{src:a?"./images/icons/collapse.svg":"./images/icons/expand.svg",width:"16",height:"16"},null,8,["src"])],64)):d("",!0)])),default:x((()=>[v(g(e.title)+" ",1),p($),I(e.$slots,"append")])),_:3}),p(O,{style:{padding:"0"}},{default:x((()=>[I(e.$slots,"default")])),_:3})])),_:3})))});class Le{static openBrowser(e){const a=document.createElement("a");a.href=e,a.target="_blank",document.body.appendChild(a),a.click(),document.body.removeChild(a)}}const Ve=["href"],je={style:{color:"#999999"},class:"mx-0 mt-4 mb-0"},Ue=i({__name:"app-access-row-v2",props:{lmAppData:{},installedInstance:{},appEnv:{}},setup(e){const t=e,l=o([]),s=o(!1),i=o(!1),y=o(void 0),A=async()=>{if(t.lmAppData?.accessInfo){const e=t.lmAppData.accessInfo,{accessType:a}=e;if(!a)return!1;if("browser"===a)return l.value.push(t.lmAppData.accessInfo?.webUrl||""),!0;if("exec"===a&&fe.appIsOllama(t.installedInstance?.installName)){if(t.appEnv){const e=t.appEnv[we];l.value=await ce.getAccessHosts(e)}return!0}}return!1};w((async()=>{s.value=await A(),i.value=fe.displayAccessSettingBtn(t.installedInstance?.installName)})),_((()=>t.appEnv),(async()=>{s.value=await A()})),_((()=>t.lmAppData?.accessInfo.webUrl),(async()=>{l.value=[],s.value=await A()})),_((()=>t.lmAppData?.accessInfo.detectAvailablePortDone),(async()=>{setTimeout((()=>{I()}),100)}));const I=async()=>{if(t.lmAppData?.accessInfo?.openBrowserByLMD&&l.value?.length>0){y.value=!0;const e=l.value[0],a=await(async e=>{try{return await n(e,{headers:{"Cache-Control":"no-cache",Pragma:"no-cache",Expires:"0"}},2e3,2e3),!0}catch(a){return console.log("app check err",a),!1}})(e);console.log("checkRunningStatus result",a),y.value=!1,a&&Le.openBrowser(e)}};return(e,n)=>{const s=re,o=de;return u(l)&&u(l).length>0?(f(),h(ze,{key:0,title:e.$t("AppRunningWindow.Access"),readonly:"",value:"app-access",showExpandIcon:!1,"default-expanded":!0},{append:x((()=>[fe.appIsOllama(t.lmAppData?.installName)?(f(),h(s,{key:0,installedInstance:e.installedInstance},null,8,["installedInstance"])):d("",!0)])),default:x((()=>[p(F,{class:"pt-1 pb-2",style:{margin:"0 -24px -16px"}},{default:x((()=>[p(z,{"no-gutters":"",style:{padding:"0px"}},{default:x((()=>[(f(!0),r(m,null,S(u(l),((n,t)=>(f(),h(L,{key:t,class:"px-5 py-2",cols:"12",sm:"6"},{default:x((()=>[p(V,{style:{background:"#FFF4EA","border-radius":"4px",height:"40px"},density:"compact","min-height":"1.1rem",class:"px-5"},{prepend:x((()=>[p(o,{text:n},null,8,["text"])])),default:x((()=>[(f(),r("a",{class:"mx-2 app-access-link",key:n,href:n,target:"_blank"},g(n),9,Ve)),u(y)?(f(),h(j,{key:0,size:"small",color:u(a).PRIMARY_COLOR},{default:x((()=>[v(g(e.$t("AppRunningWindow.Starting")),1)])),_:1},8,["color"])):d("",!0)])),_:2},1024)])),_:2},1024)))),128))])),_:1})])),_:1}),c("div",je,g(e.$t("AppRunningWindowV2.AccessNote")),1)])),_:1},8,["title"])):d("",!0)}}}),Be=i({__name:"app-env-row-v2",props:{installedInstance:{},appEnv:{}},setup(e){const a=o(null);w((async()=>{a.value=await t()}));const n=e=>"HF_MIRROR"===e?"HF_ENDPOINT":e;return(e,t)=>(f(),h(ze,{title:e.$t("AppRunningWindow.EnvVars"),showExpandIcon:!0,value:"app-env"},{default:x((()=>[p(U,{class:"my-1 pt-2 pb-0 mx-0"},{default:x((()=>[(f(!0),r(m,null,S(u(a),((e,a)=>(f(),h(j,{variant:"tonal",size:"small",style:{"min-width":"50px","max-width":"190px","margin-left":"4px"},key:a},{default:x((()=>[v(g(n(a))+" ",1),p(B,{activator:"parent",location:"bottom"},{default:x((()=>[v(g(e),1)])),_:2},1024)])),_:2},1024)))),128)),(f(!0),r(m,null,S(e.appEnv,((e,a)=>(f(),h(j,{variant:"tonal",color:"orange-darken-4",size:"small",style:{"min-width":"50px","max-width":"220px","margin-left":"4px"},key:a},{default:x((()=>[v(g(a)+" ",1),p(B,{activator:"parent",location:"bottom"},{default:x((()=>[v(g(e),1)])),_:2},1024)])),_:2},1024)))),128))])),_:1})])),_:1},8,["title"]))}}),He={key:0,style:{width:"84px"},class:"d-flex flex-column justify-center items-center"},Ge={class:"progress-text"},Ye=i({__name:"download-progress",props:{downloadInfo:{}},setup:e=>(e,n)=>e.downloadInfo?(f(),r("div",He,[p(T,{width:"100%",class:"download-progress-bar","bg-color":"#D8D8D8","bg-opacity":"1","buffer-color":"#DFDFEC","buffer-opacity":"1",opacity:"1",color:u(a).PRIMARY_COLOR,height:"3",max:1,min:0,"model-value":e.downloadInfo.percent,rounded:""},null,8,["color","model-value"]),c("div",Ge,[v(g(e.$t("AppRunningWindowV2.Downloading"))+" ",1),e.downloadInfo.percent?(f(),r(m,{key:0},[v(g(Math.floor(100*e.downloadInfo.percent))+"% ",1)],64)):d("",!0)])])):d("",!0)}),Je={key:0},qe={class:"model-storage-title d-flex flex-row align-baseline"},Ke={class:""},Qe={class:"justify-center mr-6"},Xe={class:"d-flex"},Ze={style:{flex:"1"}},ea={class:"d-flex"},aa={class:"d-flex flex-row mt-1",style:{"font-size":"14px"}},na={style:{flex:"1"}},ta=i({__name:"model-storage",props:{installedInstance:{},appEnv:{}},setup(e){const a=e,n=o(""),t=o(""),s=o(""),i=o(0),m=o(null);w((async()=>{fe.appIsOllama(a.installedInstance?.installName)&&(await I(),S())}));const y=o(null),{t:A}=N(),I=async()=>{const e=await te();t.value=e+"/.ollama/models"},S=async()=>{const e=await fe.getModelsDir(a.installedInstance?.installName,a.appEnv);console.log("dir",e),n.value=e||t.value,console.log("modelDir.value",n.value);const l=await fe.getModelFileSize(a.installedInstance?.installName,n.value);l.dirSize&&(y.value=he(l.dirSize),m.value=l,console.log("dirInfo",l),k())},k=()=>{if(!m.value)return;let e=0;try{e=m.value?.totalSpace-m.value.dirSize-m.value.freeSpace,i.value=m.value?.totalSpace-m.value.freeSpace}catch(l){console.error("calculate error",l)}const a=he(e),n=he(m.value.freeSpace),t=`${A("AppRunningWindow.StorageModelsSize")}: ${y.value},\n  ${A("AppRunningWindow.StorageDiskOther")}: ${a},\n  ${A("AppRunningWindow.StorageDiskFreeSpace")}: ${n}\n  `;s.value=t};_((()=>a.appEnv),(e=>{S()})),_((()=>a.installedInstance),(e=>{S()}));const E=async()=>{l(n.value)};return(e,a)=>u(y)?(f(),r("div",Je,[c("div",qe,[c("div",Ke,g(e.$t("AppRunningWindow.ModelStorageLabel")),1),p($),c("div",Qe,[p(re,{installedInstance:e.installedInstance},null,8,["installedInstance"])])]),p(U,{class:"mt-3 pb-3 px-5"},{default:x((()=>[c("div",Xe,[c("div",null,[p(R,{src:"./images/icons/harddisk.svg",class:"mr-1",width:"72",height:"34"})]),c("div",Ze,[c("div",ea,[p(B,{text:u(s),location:"top"},{activator:x((({props:e})=>[p(T,b({class:"custom-progress-bar"},e,{location:null,"bg-color":"#FFFFFF","bg-opacity":"1","buffer-color":"#DFDFEC","buffer-opacity":"1",opacity:"1",color:"#FEF1E5",height:"14",max:u(m)?.totalSpace||10,min:"0","buffer-value":u(i),"model-value":u(m)?.dirSize,rounded:""}),null,16,["max","buffer-value","model-value"])])),_:1},8,["text"])]),c("div",aa,[c("div",na,g(u(m)?.diskName),1),c("a",{href:"#",style:{"text-decoration":"none",color:"rgba(0, 0, 0, 0.75)"},onClick:D(E,["prevent"])},[v(g(u(y))+" > ",1),u(n)?(f(),h(B,{key:0,activator:"parent",location:"top"},{default:x((()=>[v(g(u(n)),1)])),_:1})):d("",!0)])])])])])),_:1})])):d("",!0)}}),la="http://localhost:11434";class sa{constructor(e,a){if(this.paramSize=e,this.updateUI=a,!e.nameAndSize)throw new Error("nameAndSize is empty");this.nameAndSize=e.nameAndSize}totalPercentageWithoutCurrent=.01;totalPercentage=.01;pullingMainPart="";pullingCurrentPart="";nameAndSize="";async download(e){const a=e.signal,n=await fetch(`${la}/api/pull`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:this.nameAndSize,stream:!0}),signal:a});if(!n.ok)throw new Error(`HTTP error: ${n.status}`);if(!n.body)throw new Error("No response body");const t=n.body.getReader(),l=new TextDecoder;let s="";for(;;){const{done:e,value:a}=await t.read();if(e)break;s+=l.decode(a);const n=s.split("\n");s=n.pop()||"";for(const t of n)if(t.trim())try{const e=JSON.parse(t);this.processProgress(e)}catch(o){console.error("Parse error:",o)}}}calculatePercentage(e,a,n){let t=this.totalPercentageWithoutCurrent;if(e&&e.completed&&e.total){t+=e.completed/e.total*a,t>.99&&(t=.99),t>=this.totalPercentage&&(this.totalPercentage=t)}n&&this.totalPercentage>=this.totalPercentageWithoutCurrent&&(this.totalPercentageWithoutCurrent=this.totalPercentage)}processProgress(e){const a=e?.status||"";let n=.02;if("pulling manifest"===a)n=.01;else if(a.startsWith("downloading")||a.startsWith("pulling")){void 0!==e.total&&void 0!==e.completed&&(!this.pullingMainPart&&e.total>5242880&&(this.pullingMainPart=a),this.pullingMainPart===a&&(n=.89));let t=!1;this.pullingCurrentPart!==a&&(this.pullingCurrentPart=a,t=!0),this.calculatePercentage(e,n,t)}else"success"===a&&(this.totalPercentage=1);this.updateUI&&this.updateUI(this.paramSize,this.totalPercentage)}}const{addToast:oa}=e(),ia=s("modelDownloadInfo",{state:()=>({models:o([]),parameterSizes:o([]),downloadSuccessMsg:o(""),cancelDownloadMsg:o(""),fetchAbortControllers:o(new Map)}),actions:{initModelsData(){this.models=[],this.parameterSizes=[]},updateUI(e,a){const n=e.downloadProgress;n&&(n.percent=a,1===a&&(e.installed=!0,this.downloadSuccessMsg&&oa(this.downloadSuccessMsg,"success")))},onDownloadError(e){console.error("Failed to download model",e);let a=e.message;"BodyStreamBuffer was aborted"===a&&(a=this.cancelDownloadMsg),oa(a,"error")},async startDownload(e,a){a.nameAndSize=e,a.downloadProgress={nameAndSize:e,percent:0},this.updateUI(a,.01);const n=await(async(e,a,n)=>{const t=new AbortController;return new sa(e,a).download(t).catch((e=>{n&&(console.error("download err",e),n(e))})),t})(a,this.updateUI,this.onDownloadError);this.fetchAbortControllers.set(a.nameAndSize,n)},async cancelDownload(e,a){const n=ye.genModelNameAndSize(e,a);try{const e=this.fetchAbortControllers.get(n);e?.abort()}catch(t){console.log("cancel err",t)}try{await(async e=>{const a=await fetch(`${la}/api/pull`,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e})});if(!a.ok)throw new Error(`HTTP error: ${a.status}`);if(!a.body)throw new Error("No response body");const n=await a.json();n.error?console.error("cancel error",n.error):console.log("cancel done",n)})(n)}catch(t){console.error(t)}finally{a.installed=!1,a.downloadProgress&&(a.downloadProgress.percent=void 0)}},async deleteModel(e,a){const n=ye.genModelNameAndSize(e,a);try{await(async e=>{const a=await fetch(`${la}/api/delete`,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e})});if(!a.ok)throw new Error(`HTTP error: ${a.status}`);if(!a.body)throw new Error("No response body");const n=await a.json();n.error?console.error("del error",n.error):console.log("del done",n)})(n)}catch(t){console.error(t)}finally{a.installed=!1,a.downloadProgress&&(a.downloadProgress.percent=void 0)}}}}),ra={key:0,class:"text-center py-10",style:{flex:"1"}},ca={class:"d-flex flex-row justify-center"},da={style:{"min-width":"46px",display:"inline-block"}},pa={style:{"min-width":"60px",display:"inline-block"}},ua={key:0,class:"installed-chip"},ma={key:1,class:"not-installed-chip"},va=i({__name:"model-download-row-v2",props:{lmAppData:{},installedInstance:{},appEnv:{}},setup(e){const a=ia(),n=o(!1),t=o(null),l=o(null),s=o(!1),i=o(""),{t:y}=N(),A=e;w((async()=>{I(),a.downloadSuccessMsg=y("AppRunningWindow.ModelDownloadSuccessful"),a.cancelDownloadMsg=y("AppRunningWindowV2.DownloadCanceled"),await D()})),_((()=>A.lmAppData),(()=>{I()})),_((()=>A.installedInstance),(()=>{D()})),_((()=>A.appEnv),(()=>{D()}));const I=()=>{n.value=fe.appIsOllama(A.lmAppData?.installName)};_(t,(()=>{b()}));const b=()=>{const e=t.value,n=a.models.find((a=>a.installName===e)),l=n?.tags||[];a.parameterSizes=l},D=async()=>{const e=A.installedInstance?.installName;if(e&&n.value){a.initModelsData();const n=ce.getDownloadableModels(),l=await fe.mergeModelsList(e,n);if(a.models=l,t.value)b();else{const e=a.models;if(e&&e.length>0){const a=e[0];t.value=a.installName}}}},k=async()=>{t.value&&l.value&&a.deleteModel(t.value,l.value)},E=e=>{const a=e.downloadProgress;return!!(a?.percent&&a.percent<1)},R=e=>{const a=e.tags;if(a&&a.length>0)for(let n=0;n<a.length;n++){if(a[n].installed)return!0}};return(e,o)=>{const w=Ye;return f(),r(m,null,[e.lmAppData&&u(n)?(f(),h(ze,{key:0,class:"model-download-panel",showExpandIcon:!0,value:"model-download",title:e.$t("AppRunningWindow.ModelDownload")},{default:x((()=>[p(U,{class:"model-download-sheet d-flex flex-row"},{default:x((()=>[u(a).models&&0!==u(a).models.length?d("",!0):(f(),r("div",ra,[p(H,{color:"primary",indeterminate:"",size:"40"})])),u(a).models&&u(a).models.length>0?(f(),h(F,{key:1,style:{"border-right":"1px solid #EBEBF7",flex:"1",padding:"0"},"max-height":"340"},{default:x((()=>[(f(!0),r(m,null,S(u(a).models,((e,a)=>(f(),h(V,{key:e.installName+a,density:"compact","active-class":"selected-model-item",onClick:a=>{var n;(n=e.installName)!==t.value&&(t.value=n)},active:u(t)===e.installName,title:e.displayName,value:e.installName},{append:x((()=>[R(e)?(f(),h(G,{key:0,class:"downloaded-icon",icon:"mdi-check-bold",size:"18"})):d("",!0)])),_:2},1032,["onClick","active","title","value"])))),128))])),_:1})):d("",!0),u(a).models&&u(a).models.length>0?(f(),h(F,{key:2,style:{flex:"1",padding:"0"}},{default:x((()=>[(f(!0),r(m,null,S(u(a).parameterSizes,((n,o)=>(f(),h(V,{key:n.parameterSize+o,density:"compact",active:!1,value:n.parameterSize},{default:x((()=>[c("div",ca,[c("span",da,g(n.parameterSize),1),c("span",pa,[p(j,{density:"compact",class:"mx-1 file-size-chip"},{default:x((()=>[v(g(n.fileSize),1)])),_:2},1024)]),p($,{style:{flex:"1"}}),n.installed?(f(),r("div",ua,g(e.$t("AppRunningWindow.ModelDownloaded")),1)):(f(),r(m,{key:1},[E(n)?(f(),h(w,{key:0,"download-info":n.downloadProgress},null,8,["download-info"])):(f(),r("div",ma,g(e.$t("AppRunningWindow.ModelNotDownloaded")),1))],64)),p($,{style:{flex:"1"}}),n.installed?(f(),h(M,{key:2,onClick:e=>(e=>{if(!t.value)return;const a=ye.genModelNameAndSize(t.value,e);l.value=e,s.value=!0,i.value=a})(n),variant:"text",density:"compact",color:"#F2313F"},{default:x((()=>[v(g(e.$t("AppRunningWindow.ModelDeleteBtnLabel")),1)])),_:2},1032,["onClick"])):(f(),r(m,{key:3},[E(n)?(f(),h(M,{key:0,onClick:e=>(async e=>{t.value&&a.cancelDownload(t.value,e)})(n),variant:"text",density:"compact"},{default:x((()=>[v(g(e.$t("AppRunningWindow.Cancel")),1)])),_:2},1032,["onClick"])):(f(),h(M,{key:1,onClick:e=>(async e=>{if(!t.value)return;const n=ye.genModelNameAndSize(t.value,e);a.startDownload(n,e)})(n),variant:"text",class:"model-download-btn",density:"compact"},{default:x((()=>[v(g(e.$t("AppRunningWindow.ModelDownloadBtnLabel")),1)])),_:2},1032,["onClick"]))],64))])])),_:2},1032,["value"])))),128))])),_:1})):d("",!0)])),_:1}),p(U,{style:{"border-top":"1px solid #EBEBF7"}},{default:x((()=>[p(ta,{appEnv:e.appEnv,installedInstance:e.installedInstance},null,8,["appEnv","installedInstance"])])),_:1})])),_:1},8,["title"])):d("",!0),p(pe,{"model-value":u(s),"onUpdate:modelValue":o[0]||(o[0]=e=>s.value=e),"item-name":u(i),onConfirm:k},null,8,["model-value","item-name"])],64)}}}),ga=i({__name:"app-env-and-access-v2",props:{installedInstance:{},lmAppData:{}},emits:["appEnvSavedAndUpdated"],setup(e,{expose:a,emit:n}){const t=e,l=se(),s=o({}),i=o(["app-access"]),r=o(void 0),c=n;w((async()=>{I(),A()}));const m=y(),A=()=>{m.query.script===X.DOWNLOAD_MODEL&&(i.value=["app-access","model-download"])},I=async()=>{const e=t.installedInstance?.installName;fe.appIsOllama(e)&&(s.value=await ce.getOSEnvObj()||{},S())};a({updateAppEnvData:I}),_((()=>t.installedInstance),(()=>{I()})),_((()=>l.appSettingsSaved),(async e=>{e&&(s.value=null,await I(),c("appEnvSavedAndUpdated",s.value))}));const S=async()=>{const e=s.value;e.OLLAMA_MODELS&&(r.value=await le(e.OLLAMA_MODELS))};return(e,a)=>{const n=Ue;return u(s)&&e.installedInstance?(f(),h(Y,{key:0,multiple:"",elevation:"0",modelValue:u(i),"onUpdate:modelValue":a[0]||(a[0]=e=>k(i)?i.value=e:null),class:"lmd-running-panels"},{default:x((()=>[p(n,{appEnv:u(s),lmAppData:e.lmAppData,installedInstance:e.installedInstance},null,8,["appEnv","lmAppData","installedInstance"]),!1===u(r)?(f(),h(J,{key:0,class:"pt-0 mt-0 px-2",style:{color:"red","justify-items":"center","align-items":"center"}},{default:x((()=>[p(G,{style:{opacity:"1"},icon:"mdi-information-slab-circle-outline"}),v(" "+g(e.$t("AppRunningWindowV2.ModelDirNotFound")),1)])),_:1})):d("",!0),p(va,{appEnv:u(s),installedInstance:e.installedInstance,lmAppData:e.lmAppData},null,8,["appEnv","installedInstance","lmAppData"]),p(Be,{appEnv:u(s),installedInstance:e.installedInstance},null,8,["appEnv","installedInstance"])])),_:1},8,["modelValue"])):d("",!0)}}}),fa={class:"d-flex flex-column text-center justify-center align-middle"},wa={style:{width:"60px",margin:"0 auto"},class:"mt-10"},ya={class:"d-flex flex-column justify-center"},ha=i({__name:"app-info-left",props:{lmAppData:{},installedInstance:{},isAppRunning:{type:Boolean}},emits:["startApp","stopApp"],setup(e,{emit:a}){const n=a;return(e,a)=>(f(),h(U,{class:"left-app-basic-info"},{default:x((()=>[c("div",fa,[c("div",wa,[p(R,{src:e.lmAppData?.icon,rounded:"",width:"60",height:"60"},null,8,["src"])]),c("div",ya,[p(q,{class:"pt-1 pb-0"},{default:x((()=>[v(g(e.lmAppData?.name),1)])),_:1}),e.installedInstance?.version&&"--"!==e.installedInstance?.version?(f(),h(K,{key:0,class:"py-0"},{default:x((()=>[v(g(e.$t("AppRunningWindow.Version"))+" "+g(e.installedInstance?.version),1)])),_:1})):d("",!0),p(J,null,{default:x((()=>[p($,{class:"mt-6"}),e.isAppRunning?(f(),h(M,{key:0,variant:"flat",color:"#F2313F",class:"mx-2",width:"80",height:"40",onClick:a[0]||(a[0]=e=>{n("stopApp")})},{default:x((()=>[v(g(e.$t("AppRunningWindow.Stop")),1)])),_:1})):(f(),h(M,{key:1,color:"primary",variant:"flat",class:"mx-2",width:"80",height:"40",onClick:a[1]||(a[1]=e=>{n("startApp")})},{default:x((()=>[v(g(e.$t("AppRunningWindow.Start")),1)])),_:1}))])),_:1})])])])),_:1}))}}),Aa={style:{flex:"1"}},xa={class:"pa-6 run-right-content"},Ia={class:"footer-button-bar"},_a={class:"footer-terminal-content"},Sa=i({__name:"app-run",setup(a){const n=y(),t=ge(),l=o(null),s=o(),i=o(),I=o(null),_=o(!1),S=o(!1),b=o(""),{t:D}=N(),{addToast:k}=e(),T=se(),P=o(!1);w((async()=>{W();const e=n.params.id,a=await Q(e);I.value=a;const s=a.appId;await t.fetchApp(s),l.value=t.currentLmApp,window.ipcRenderer?.on(ae.STOP_AI_RUNNING_INSTANCE,(()=>{z(),L()})),j();const o=l?.value.name;document.title=o}));const C=E((()=>{if(T.terminals&&T.terminals.length>0)return T.terminals[0]})),W=()=>{const e=D("AppRunningWindow.MainProcessTab");T.initTerminal(e)},$=async()=>{var e;if(e=X.START,b.value=e,T.changeMainTerminalScriptType(e,""),_.value=!0,l.value){const e=await ue(l.value);F(e),window.ipcRenderer?.send(ae.RUNNING_STATUS_CHANGE,!0)}},O=()=>Array.isArray(s.value)?s.value[0]:s.value,F=e=>{const a=O();console.log("run command",a,e),a?.runCommand(e)},z=()=>{_.value=!1,O()?.runStopCommand(),window.ipcRenderer.send(ae.RUNNING_STATUS_CHANGE,!1)},L=()=>{O()?.exitTerminal()},V=e=>{if(ee.isWindows())return;z();const a=me(e);O()?.runCommand(a),$()},j=async()=>{if($(),fe.needPreStartApp(I.value?.installName))return ee.isMacOS()?void setTimeout((()=>{U()}),20):void 0;U()},U=()=>{S.value=!0},B=e=>{console.log("onCommandExecuteEnd",e),e&&k(e,"success"),setTimeout((()=>{i.value?.updateAppEnvData()}),400)};return(e,a)=>(f(),r(m,null,[c("div",Aa,[p(ha,{"lm-app-data":u(l),"is-app-running":u(_),onStopApp:z,onStartApp:$,"installed-instance":u(I)},null,8,["lm-app-data","is-app-running","installed-instance"]),c("div",xa,[u(I)&&u(l)&&u(S)?(f(),h(ga,{key:0,ref_key:"appEnvAndAccessComponent",ref:i,onAppEnvSavedAndUpdated:V,lmAppData:u(l),installedInstance:u(I)},null,8,["lmAppData","installedInstance"])):d("",!0)])]),c("footer",{class:A(["footer-terminal","app-run-footer-terminal",u(P)?"expanded":""])},[c("div",Ia,[p(M,{variant:"text",style:{position:"absolute",right:"10px",top:"5px"},onClick:a[0]||(a[0]=e=>P.value=!u(P))},{append:x((()=>[p(R,{src:u(P)?"./images/icons/expand-white.svg":"./images/icons/collapse-white.svg",width:"18",height:"18"},null,8,["src"])])),default:x((()=>[v(g(u(P)?e.$t("AppRunningWindowV2.Hide"):e.$t("AppRunningWindowV2.ViewLog"))+" ",1)])),_:1})]),c("div",_a,[u(C)&&"main-process"===u(C).tabName?(f(),h(ie,{key:0,onExecuteEnd:a[1]||(a[1]=e=>{return a=u(C).commandExecuteEndToastMsg,U(),console.log("onMainTerminalCommandEnd"),void B(a);var a}),"command-execute-end-keywords":u(C).commandExecuteEndKeywords,ref_key:"generalTerminal",ref:s,socketURI:"ws://localhost:19312"},null,8,["command-execute-end-keywords"])):d("",!0)])],2)],64))}}),ba={class:"app-install-result pt-10 pb-6 px-11 mb-12 mx-10"},Da=i({__name:"install-result",props:{lmAppData:{},installedInstance:{}},setup(e){const a=e,n=()=>{a.installedInstance.appInstallPath&&l(a.installedInstance.appInstallPath)};return(e,a)=>(f(),r("div",ba,[p(z,{class:"gap-2 mb-2"},{default:x((()=>[p(L,{cols:"12",xs:"12",sm:"6",md:"6",lg:"6",class:"item"},{default:x((()=>[v(g(e.$t("AppRunningWindowV2.AppNameLabel"))+": "+g(e.lmAppData.name),1)])),_:1}),p(L,{cols:"12",xs:"12",sm:"6",md:"6",lg:"6",class:"item"},{default:x((()=>[v(g(e.$t("AppRunningWindowV2.AppInstallTimeLabel"))+": "+g(u(Ae).format(e.installedInstance.createTime,!1)),1)])),_:1}),p(L,{cols:"12",xs:"12",sm:"6",md:"6",lg:"6",class:"item"},{default:x((()=>[v(g(e.$t("AppRunningWindowV2.AppInstallLocationLabel"))+": ",1),c("a",{href:"#",onClick:D(n,["prevent"])},g(e.installedInstance.appInstallPath),1)])),_:1})])),_:1})]))}}),{addToast:ka}=e(),Ea=s("appInstall",{state:()=>({installPercent:o(0),installSuccessMsg:o(""),installed:o(!1)}),actions:{initModelsData(){this.installPercent=0},updateUI(e){this.installPercent=e,1===e&&(this.installed=!0,this.installSuccessMsg&&ka(this.installSuccessMsg,"success"))},onDownloadError(e){console.error("Failed to download App",e),ka(e.message,"error")}}}),Ra={class:"progress-area"},Ta={style:{width:"210px"}},Na={key:0,style:{width:"250px"},class:"mt-6"},Ma={class:"progress-msg mb-8 mt-6"},Pa={class:"progress-msg-title"},Ca={class:"progress-msg-title"},Wa=i({__name:"install-progress",props:{lmAppData:{}},setup(e){const n=Ea(),t=e;return(e,l)=>(f(),r("div",Ra,[c("div",Ta,[p(R,{src:u(n).installed?"./images/app/succes.svg":"./images/app/processing.svg",width:"210",height:"140"},null,8,["src"])]),u(n).installed?d("",!0):(f(),r("div",Na,[p(T,{width:"100%",class:"download-progress-bar","bg-color":"#F2F2FA","bg-opacity":"1","buffer-color":"#DFDFEC","buffer-opacity":"1",opacity:"1",color:u(a).PRIMARY_COLOR,height:"14",max:100,min:0,"model-value":u(n).installPercent,rounded:""},null,8,["color","model-value"])])),c("div",Ma,[u(n).installed?(f(),r(m,{key:1},[c("div",Ca,g(e.$t("AppRunningWindowV2.InstallSuccessTitle")),1),c("div",null,[fe.appIsOllama(t.lmAppData?.installName)?(f(),r(m,{key:0},[v(g(e.$t("AppRunningWindowV2.InstallSuccessNextTipForOllama")),1)],64)):(f(),r(m,{key:1},[v(g(e.$t("AppRunningWindowV2.InstallSuccessNextTip")),1)],64))])],64)):(f(),r(m,{key:0},[c("div",Pa,g(e.lmAppData?.name),1),v(" "+g(e.$t("AppRunningWindowV2.InstallingMsg"))+" "+g(u(n).installPercent)+"% ",1)],64))])]))}}),$a={class:"app-install-container"},Oa={class:"install-steps"},Fa={class:"pa-6 install-right-content"},za={class:"footer-button-bar"},La=i({__name:"app-install",setup(a){const{t:n}=N(),t=se(),l=o(""),s=ge(),i=o(null),m=y(),I=o(null),_=o(),S=Ea(),b=o(!1),{addToast:D}=e();w((async()=>{k();const e=m.params.id,a=await Q(e);I.value=a;const n=a.appId;await s.fetchApp(n),i.value=s.currentLmApp,window.ipcRenderer?.on(ae.STOP_AI_RUNNING_INSTANCE,(()=>{W(),$()})),E();const t=i?.value.name;document.title=t}));const k=()=>{const e=n("AppRunningWindow.MainProcessTab");t.initTerminal(e)},E=async()=>{var e;if(console.log("installApp"),e=X.INSTALL,l.value=e,console.log("changeMainTerminalScriptType",e,""),t.changeMainTerminalScriptType(e,""),i.value){const e=await ve(i.value);T(e)}},T=e=>{const a=C();console.log("run command",a,e),a?.runCommand(e)},C=()=>Array.isArray(_.value)?_.value[0]:_.value,W=()=>{C()?.runStopCommand(),window.ipcRenderer.send(ae.RUNNING_STATUS_CHANGE,!1)},$=()=>{C()?.exitTerminal()},O=e=>{const a=Me.extractProgress(e);a&&(S.installPercent=a,100===a&&(S.installed=!0))},F=()=>{console.log("installedInstance",I.value?.id),I.value?.id&&ne(I.value.id)},z=()=>{I.value&&xe.goToRunningPage(I.value.id,X.START,I.value.installName)};return(e,a)=>{const n=Wa,t=Da;return f(),r("div",$a,[c("div",Oa,[c("div",Fa,[u(i)?(f(),h(n,{key:0,"lm-app-data":u(i)},null,8,["lm-app-data"])):d("",!0),u(I)&&u(i)&&u(S).installed?(f(),h(t,{key:1,lmAppData:u(i),installedInstance:u(I)},null,8,["lmAppData","installedInstance"])):d("",!0),c("div",{class:A(["footer-terminal","app-install-footer-terminal",u(b)?"expanded":""])},[c("div",za,[p(M,{variant:"text",style:{position:"absolute",right:"10px",top:"5px"},onClick:a[0]||(a[0]=e=>b.value=!u(b))},{append:x((()=>[p(R,{src:u(b)?"./images/icons/expand-white.svg":"./images/icons/collapse-white.svg",width:"18",height:"18"},null,8,["src"])])),default:x((()=>[v(g(u(b)?e.$t("AppRunningWindowV2.Hide"):e.$t("AppRunningWindowV2.ViewLog"))+" ",1)])),_:1})]),p(ie,{ref_key:"generalTerminal",ref:_,events:["lmdprogress"],onTerminalEvent:O,socketURI:"ws://localhost:19312"},null,512)],2)])]),p(P,{style:{"border-top":"1px solid #EBEBF7"},class:"py-6 text-center justify-center"},{default:x((()=>[p(M,{variant:"outlined",onClick:F},{default:x((()=>[v(g(e.$t("Common.close")),1)])),_:1}),fe.appIsOllama(i.value?.installName)?(f(),h(M,{key:0,variant:"flat",disabled:!u(S).installed,onClick:z,color:"primary"},{default:x((()=>[v(g(e.$t("AppRunningWindowV2.NextStep")),1)])),_:1},8,["disabled"])):d("",!0)])),_:1})])}}}),Va=i({__name:"AppRunningWindowV2",setup(e){const a=o(""),n=y();return w((()=>{const e=n.query.script;e===X.INSTALL?a.value="install":e===X.START||e===X.DOWNLOAD_MODEL?a.value="run":e===X.REMOVE&&(a.value="remove")})),(e,n)=>{const t=La,l=Sa,s=Oe;return f(),r(m,null,["install"===u(a)?(f(),h(t,{key:0})):d("",!0),"run"===u(a)?(f(),h(l,{key:1})):d("",!0),"remove"===u(a)?(f(),h(s,{key:2})):d("",!0)],64)}}});export{Va as default};
