import{b as e,T as a,g as l,f as t,d as n,L as o,o as s,h as i}from"./index.js";import{d}from"./pinia.js";import{b as r,f as c,a6 as p,l as u,a8 as m,k as v,u as g,F as f,X as w,O as y,a4 as h,L as A,a0 as I,ac as D,e as _,a3 as x,n as b,a5 as S,x as k,v as R,y as E,a7 as C,G as M,H as O,A as T,ab as N,Z as L,m as $}from"./vue.js";import{b as V,m as P,z as W,q as F,D as U,E as z,A as j,B,o as H,l as G,O as Y,M as K,H as J,d as q,P as Q,Q as X,R as Z,S as ee,e as ae,n as le,C as te,I as ne,J as oe,c as se,w as ie,x as de,a as re,T as ce,p as pe}from"./vuetify.js";import{O as ue,e as me,d as ve,a as ge,I as fe,A as we}from"./OSUtil.js";import{I as ye,d as he,a as Ae,e as Ie,_ as De,g as _e,f as xe,s as be,h as Se,D as ke,j as Re,k as Ee,l as Ce,m as Me,n as Oe}from"./lmd-system.js";import{u as Te}from"./index2.js";import{r as Ne,a as Le,b as $e}from"./xterm.js";import{a as Ve,b as Pe,A as We,M as Fe,O as Ue}from"./AppInfoUtil.js";import{p as ze}from"./pretty-bytes.js";import{D as je}from"./DateTimeUtil.js";import"./debounce.js";import"./vuei18n.js";import"./lmd-locales.js";import"./dayjs.js";const{addToast:Be}=e(),He=d("appRemove",{state:()=>({removePercent:r(0),removeSuccessMsg:r(""),removed:r(!1)}),actions:{initModelsData(){this.removePercent=0},updateUI(e){this.removePercent=e,1===e&&(this.removed=!0,this.removeSuccessMsg&&Be(this.removeSuccessMsg,"success"))}}}),Ge={class:"progress-area"},Ye={style:{width:"210px"}},Ke={key:0,style:{width:"250px"},class:"mt-6"},Je={class:"progress-msg mb-8 mt-6"},qe={class:"progress-msg-title"},Qe={class:"progress-msg-title"},Xe={class:"mt-3",style:{"font-size":"14px"}},Ze=c({__name:"remove-progress",props:{lmAppData:{}},setup(e){const l=He();return(e,t)=>(h(),p("div",Ge,[u("div",Ye,[v(V,{src:g(l).removed?"./images/my-ai/del-tip.svg":"./images/app/processing.svg",width:"210",height:"140"},null,8,["src"])]),g(l).removed?m("",!0):(h(),p("div",Ke,[v(P,{width:"100%",class:"download-progress-bar","bg-color":"#F2F2FA","bg-opacity":"1","buffer-color":"#DFDFEC","buffer-opacity":"1",opacity:"1",color:g(a).PRIMARY_COLOR,height:"14",max:100,min:0,"model-value":g(l).removePercent,rounded:""},null,8,["color","model-value"])])),u("div",Je,[g(l).removed?(h(),p(f,{key:1},[u("div",Qe,y(e.$t("AppRunningWindowV2.DeleteSuccessTitle")),1),u("div",Xe,y(e.$t("AppRunningWindowV2.DeleteSuccessMsg")),1)],64)):(h(),p(f,{key:0},[u("div",qe,y(e.lmAppData?.name),1),w(" "+y(e.$t("AppRunningWindowV2.DeletingMsg"))+" "+y(g(l).removePercent)+"% ",1)],64))])]))}}),ea=d("runningInstance",{state:()=>({runningInstances:[],appSettingsSaved:!1,terminals:[],currentTerminalTab:""}),actions:{addRunningInstance(e){this.runningInstances.find((a=>a.id===e.id))||this.runningInstances.push(e)},removeRunningInstance(e){const a=this.runningInstances.findIndex((a=>a.id===e.id));-1!=a&&this.runningInstances.splice(a,1)},resetAppSettingsSavedStatus(){this.appSettingsSaved=!1},onAppSettingsSaved(){this.appSettingsSaved=!0},changeMainTerminalScriptType(e,a){try{const l=this.terminals[0];l.commandExecuteEndKeywords=[`lmd ${e} script end.`],l.commandExecuteEndToastMsg=a}catch(l){console.error(l)}},initTerminal(e){const a={icon:"mdi-application-brackets-outline",text:e,tabName:"main-process",closable:!1};this.terminals=[a],this.currentTerminalTab=a.tabName},addTerminal(e){this.terminals.find((a=>a.tabName===e.tabName))||(console.log("addTerminal",e.commandExecuteEndKeywords),this.terminals.push(e)),this.currentTerminalTab=e.tabName},removeTerminal(e,a){this.currentTerminalTab="main-process",this.terminals.splice(a,1)},addInstallModelTerminal(e,a,l,t){const n={text:a,tabName:a,initCommand:l,closable:!0,commandExecuteEndKeywords:["digest","writing manifest","success"],commandExecuteEndToastMsg:t};this.addTerminal(n)},addDeleteModelTerminal(e,a,l,t){const n={text:a,tabName:a,initCommand:l,closable:!0,commandExecuteEndKeywords:[`deleted '${e}'`],commandExecuteEndToastMsg:t};this.addTerminal(n)}}});class aa{static getLMDScriptRepoUrl(e){let a="https://gitee.com/lmdown/lmd-install-scripts";if(e?.downloadInfo&&e?.downloadInfo.length>0){a=e.downloadInfo[0].scriptGitRepoUrl}return{repoUrl:a,repoLocalFolderName:this.getLastPathSegment(a)||"lmd-install-scripts"}}static getLastPathSegment(e){const a=e.match(/[^\/?#]+(?=[/?#]*$)/);return a?a[0]:null}}const la="browser";class ta{static async isPortInUse(e){const a=`http://127.0.0.1:${e}`;try{const l=await fetch(a,{method:"get",mode:"no-cors",cache:"no-store"});return console.log(`${e} in use`,l.status),l.ok}catch(l){return console.log(`can not access port ${e}`,l),!1}}static async findAvailablePort(e,a){let l=e;for(let n=1;n<=a;n++)try{if(!(await this.isPortInUse(l)))return l;l++}catch(t){console.error(`check port ${l} err`,t),l++}return console.error("no Available port, use default value"),e}}class na{static async genSetPortCommand(e){if(e?.accessInfo.accessType===la&&this.needCheckPort(e)&&e.accessInfo.webUrl){e.accessInfo.detectAvailablePortDone=!1;const{url:a,port:l}=await na.checkPortInUrl(e.accessInfo.webUrl);if(e.accessInfo.detectAvailablePortDone=!0,l)return e.accessInfo.webUrl=a,`export SERVER_PORT=${l}\nexport GRADIO_SERVER_PORT=${l}`}return""}static needCheckPort(e){return["spark-tts","index-tts","f5-tts","framepack","liveportrait","ace-step","cosyvoice","latentsync","notagen"].includes(e.installName)||e?.accessInfo?.detectAvailablePort}static async checkPortInUrl(e){try{const a=new URL(e),l=parseInt(a.port,10);if(isNaN(l))throw new Error("does not contain a valid port");const t=await ta.findAvailablePort(l,20);return a.port=t.toString(),{url:a.toString(),port:t}}catch(a){return console.log("Invalid URL",a),{url:e}}}}const oa=e=>"0"===t("UPDATE_INSTALL_SCRIPTS")?"":`\ngit clone --depth=1 ${e} "$LMD_BASE_INSTALL_SCRIPT_DIR"\ncd "$LMD_BASE_INSTALL_SCRIPT_DIR" && git fetch origin master && git reset --hard origin/master`;var sa=Ne(),ia=Le(),da=$e();const ra=c({__name:"index",props:{socketURI:{},initCommand:{},commandExecuteEndKeywords:{},events:{}},emits:["executeEnd","terminalEvent","ready"],setup(e,{expose:a,emit:l}){const t=l,o=r([]),s=r(!1),i=e,d=r(null),c=r(null),m=r(null),v=r(null);let g;A((()=>{D(),y()})),I((()=>{d.value?.close(),c.value?.dispose(),g&&v.value&&(g.unobserve(v.value),g.disconnect())}));const f=e=>{console.log("runCommand",e),console.log("runCommand socket.value",d.value),d.value?.send(e+"\n")};a({runCommand:f,runStopCommand:()=>{f(""),f("")},exitTerminal:()=>{f("exit")}});const w=n((e=>{for(const a of e){let e=a.contentRect.height;ue.isMacOS()&&(e-=10),E(a.contentRect.width,e)}}),9),y=()=>{m.value&&(g=new ResizeObserver(w),g.observe(m.value))},D=()=>{d.value=new WebSocket(i.socketURI),b(),x(),S(),_()},_=()=>{d.value&&(d.value.onmessage=e=>{const a=e.data,l=i.events;console.log("event data ",e.data),console.log("props.events ",i.events),l&&l.length>0&&l.forEach((e=>{a.includes(e)&&(console.log("emit terminalEvent",a),t("terminalEvent",a))}));const n=i.commandExecuteEndKeywords;n&&(n.forEach((e=>{a.includes(e)&&!o.value.includes(e)&&o.value.push(e)})),o.value.length===n.length&&(t("executeEnd"),s.value=!0,o.value=[]))})},x=()=>{d.value&&(d.value.onopen=()=>{(()=>{if(!v.value)return;if(!d.value)return;const e=new window.Terminal({fontSize:14,cursorBlink:!0}),a=new ia.AttachAddon(d.value),l=new sa.FitAddon,t=new da.WebLinksAddon(((e,a)=>{const l=document.createElement("a");l.setAttribute("href",a),l.setAttribute("target","_blank"),l.setAttribute("id","lmdTempLink");const t=document.getElementById("lmdTempLink");t&&document.body.removeChild(t),document.body.appendChild(l),l.click()}));e.loadAddon(a),e.loadAddon(l),e.loadAddon(t),e.open(v.value),l.fit(),c.value=e})(),i.initCommand&&f(i.initCommand),t("ready")})},b=()=>{d.value&&(d.value.onclose=e=>{console.log("close socket",e)})},S=()=>{d.value&&(d.value.onerror=e=>{console.log("socket err",e)})},k=r(80),R=r(30),E=(e,a)=>{const l=Math.floor(e/8.5),t=Math.round(a/16);if(console.log("cols",e,l),console.log("rows",a,t),0!==t&&0!==l&&(k.value!==l||R.value!==t)){k.value=l,R.value=t,c.value?.resize(l,t);const e=`lmd_action:resize:${l},${t}`;d.value?.send(e)}};return(e,a)=>(h(),p("div",{ref_key:"terminalOutContainer",ref:m,class:"mb-0",style:{height:"100%",width:"100%"}},[u("div",{ref_key:"terminalContainer",ref:v,class:"terminal",style:{height:"300px",width:"100%"}},null,512)],512))}});class ca{static extractProgress(e){let a=null;try{const l=/lmdprogress:(\d+)/g;let t;for(;null!==(t=l.exec(e));)a=parseInt(t[1],10)}catch(l){console.error("parse err",l)}return a}}class pa{static genWSUrl(e,a,l){return`ws://localhost:19312/?appId=${e}&installedInstanceId=${a}&runningLogType=${l}`}}const ua="install",ma="run",va="delete",ga={class:"app-install-container"},fa={class:"install-steps"},wa={class:"pa-6 install-right-content"},ya={class:"footer-button-bar"},ha=c({__name:"app-remove",setup(a){const{t:t}=W(),n=ea(),o=r(""),s=Te(),i=r(null),d=D(),c=r(null),f=r(),I=He(),k=r(!1),{addToast:R}=e();A((async()=>{M();const e=d.params.id;let a;try{a=await me(e)}catch(o){return console.log(o),void R(t("AppRunningWindowV2.DeleteNotFound"),"error")}c.value=a;const l=a.appId;await s.fetchApp(l),i.value=s.currentLmApp,window.ipcRenderer?.on(ye.STOP_AI_RUNNING_INSTANCE,(()=>{L(),$()}));const n=i?.value.name;document.title=`[${t("LocalApps.Delete")}] ${n}`}));const E=_((()=>{if(i.value?.id&&c.value?.id)return pa.genWSUrl(i.value?.id,c.value?.id,va)})),C=()=>{console.log("onTerminalReady"),O()},M=()=>{const e=t("AppRunningWindow.MainProcessTab");n.initTerminal(e)},O=async()=>{var e;if(e=ge.REMOVE,o.value=e,console.log("changeMainTerminalScriptType",e,""),n.changeMainTerminalScriptType(e,""),i.value&&c.value){const e=await(async(e,a)=>{const t=e.installName,n=(await l()).LMD_SCRIPTS_DIR,{repoUrl:o,repoLocalFolderName:s}=aa.getLMDScriptRepoUrl(e),i=oa(o);console.log("repoLocalFolderName",s);const d="docker"===a?.installMethod?"remove-d.sh":"remove.sh";let r="";return a.instancesCountOfApp>1&&(r="keepmodels"),`\nexport LMD_BASE_INSTALL_SCRIPT_DIR="${n}/${s}"\n${i}\nsh "$LMD_BASE_INSTALL_SCRIPT_DIR/apps/${t}/${d}" ${r}`})(i.value,c.value);T(e)}},T=e=>{const a=N();console.log("run command",a,e),a?.runCommand(e)},N=()=>Array.isArray(f.value)?f.value[0]:f.value,L=()=>{N()?.runStopCommand(),window.ipcRenderer.send(ye.RUNNING_STATUS_CHANGE,!1)},$=()=>{N()?.exitTerminal()},P=e=>{const a=ca.extractProgress(e);a&&(I.removePercent=a,100===a&&(I.removed=!0,c.value?.id&&ve(c.value?.id)))},z=()=>{c.value?.id&&he(c.value.id)};return(e,a)=>{const l=Ze;return h(),p("div",ga,[u("div",fa,[u("div",wa,[g(i)?(h(),x(l,{key:0,"lm-app-data":g(i)},null,8,["lm-app-data"])):m("",!0),u("div",{class:b(["footer-terminal","app-install-footer-terminal",g(k)?"expanded":""])},[u("div",ya,[v(F,{variant:"text",style:{position:"absolute",right:"10px",top:"5px"},onClick:a[0]||(a[0]=e=>k.value=!g(k))},{append:S((()=>[v(V,{src:g(k)?"./images/icons/expand-white.svg":"./images/icons/collapse-white.svg",width:"18",height:"18"},null,8,["src"])])),default:S((()=>[w(y(g(k)?e.$t("AppRunningWindowV2.Hide"):e.$t("AppRunningWindowV2.ViewLog"))+" ",1)])),_:1})]),g(E)?(h(),x(ra,{key:0,ref_key:"generalTerminal",ref:f,events:["lmdprogress"],onTerminalEvent:P,onReady:C,socketURI:g(E)},null,8,["socketURI"])):m("",!0)],2)])]),v(U,{style:{"border-top":"1px solid #EBEBF7"},class:"py-6 text-center justify-center"},{default:S((()=>[v(F,{variant:"outlined",onClick:z},{default:S((()=>[w(y(e.$t("Common.close")),1)])),_:1})])),_:1})])}}}),Aa={key:0,style:{width:"84px"},class:"d-flex flex-column justify-center items-center"},Ia={class:"progress-text"},Da=c({__name:"comfyui-progress-bar",props:{downloadInfo:{}},setup:e=>(e,l)=>e.downloadInfo?(h(),p("div",Aa,[v(P,{width:"100%",class:"download-progress-bar","bg-color":"#D8D8D8","bg-opacity":"1","buffer-color":"#DFDFEC","buffer-opacity":"1",opacity:"1",color:g(a).PRIMARY_COLOR,height:"3",max:1,min:0,"model-value":e.downloadInfo.percent||0,rounded:""},null,8,["color","model-value"]),u("div",Ia,[w(y(e.$t("AppRunningWindowV2.Downloading"))+" ",1),e.downloadInfo.percent?(h(),p(f,{key:0},[w(y(Math.floor(100*e.downloadInfo.percent))+"% ",1)],64)):m("",!0)])])):m("",!0)});class _a{static DOWNLOADING=1;static DOWNLOADED=2;static NOT_DOWNLOADED=3}const xa=async()=>{const e=`https://r-1314735556.cos.ap-shanghai.myqcloud.com/pkgs/models/data/comfyui/cats.json?v=${function(){const e=(new Date).getTime(),a=6e5,l=Math.floor(e/a)*a;return Math.floor(l/1e4)}()}`;return(await axios.get(e)).data},ba=async(e,a)=>{const l=[];a.forEach((e=>{const a=Object.assign({},e);a.downloadInfo=void 0,l.push(a)}));return(await Ae.post("/self-manage/model-files/check-files",{modelPath:e,files:l})).data.files};class Sa{modelFileInfo;abortController=null;constructor(e){this.modelFileInfo=e}async startDownloadModelFile(e,a){this.abortController||(this.abortController=new AbortController);const l=this.modelFileInfo.value,t="ComfyUI",n={modelRepoId:this.modelFileInfo.modelRepoId,filePathInRepo:l,modelPath:`${t}/models/${this.modelFileInfo.subDir}`,appInstallPath:t};this.modelFileInfo.downloadTool&&(n.downloadTool=this.modelFileInfo.downloadTool),await(async(e,a,l,t)=>{const n=l.signal,o=await fetch(`${Ie}/self-manage/model-files/download`,{method:"POST",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(e),signal:n,keepalive:!0});if(!o.ok)throw new Error(`HTTP error: ${o.status}`);if(!o.body)throw new Error("No response body");const s=o.body.getReader(),i=new TextDecoder("utf-8");let d="";try{for(;;){const{done:e,value:l}=await s.read();if(e)break;d+=i.decode(l);const n=d.split("\n");d=n.pop()||"";for(const o of n)if(o.trim())try{const e=JSON.parse(o);if(console.log("line -- : ",o),e.progress){const l=e.progress;0!==l&&t(a,l)}}catch(r){console.error("Parse error:",r)}}}catch(r){if("AbortError"!==r.name)throw r;console.log("Stream aborted")}})(n,e,this.abortController,a)}cancel(){try{this.abortController?.abort(),this.abortController=null}catch(e){console.log("cancel",e)}}}const{addToast:ka}=e(),Ra=d("comfyui-model-info",{state:()=>({modelFileInfoMap:r(new Map)}),actions:{initModelsData(){},async checkDownloadingModels(e){e&&e.length>0&&e.forEach((e=>{const a=this.getModelInfoKey(e),l=this.modelFileInfoMap.get(a);l&&(e.downloadInfo=l.downloadInfo)}))},updateUI(e,a){const l=e.downloadInfo;l&&(l.percent=a||0,1===a?(l.status=_a.DOWNLOADED,this.clearModelInfo(e)):l.status=_a.DOWNLOADING)},onDownloadError(e){const a=e.message;ka(a,"error")},async startDownload(e){const a=this.getModelInfoKey(e);if(this.modelFileInfoMap.set(a,e),e.downloadInfo||(e.downloadInfo={}),!e.downloadInfo.downloader){const a=new Sa(e);e.downloadInfo.downloader=a}e.downloadInfo.downloader.startDownloadModelFile(e,this.updateUI),this.updateUI(e,.01)},async cancelDownload(e){try{e.downloadInfo&&(e.downloadInfo.downloader?.cancel(),e.downloadInfo.status=_a.NOT_DOWNLOADED),this.clearModelInfo(e)}catch(a){console.log("cancel err",a)}},clearModelInfo(e){const a=this.getModelInfoKey(e);this.modelFileInfoMap.delete(a)},getModelInfoKey:e=>e.subDir+"/"+e.value}}),Ea={class:"d-flex flex-row",style:{width:"150px"}},Ca=c({__name:"comfyui-model-download-progress",props:{modelFileInfo:{}},setup(e){const l=e,{t:t}=W(),n=Ra(),o={[_a.DOWNLOADING]:t("AppRunningWindowV2.Downloading"),[_a.DOWNLOADED]:t("AppRunningWindowV2.Downloaded"),[_a.NOT_DOWNLOADED]:t("AppRunningWindowV2.NotDownloaded")},s={[_a.DOWNLOADING]:"rgba(0, 0, 0, 0.75)",[_a.DOWNLOADED]:"#0ABB1F",[_a.NOT_DOWNLOADED]:"rgba(0, 0, 0, 0.25)"},i=_((()=>{const e=l.modelFileInfo.downloadInfo?.status||_a.NOT_DOWNLOADED;return o[e]})),d=_((()=>{const e=l.modelFileInfo.downloadInfo?.status||_a.NOT_DOWNLOADED;return s[e]})),r=_((()=>{const e=l.modelFileInfo.downloadInfo?.status;return e===_a.DOWNLOADING})),c=()=>{n.cancelDownload(l.modelFileInfo)};return(e,l)=>{const t=Da;return h(),p("div",Ea,[g(r)?(h(),x(t,{key:0,"download-info":e.modelFileInfo.downloadInfo},null,8,["download-info"])):(h(),p("div",{key:1,style:k(`color: ${g(d)}; font-size: 12px;`)},y(g(i)),5)),g(r)?(h(),x(F,{key:2,variant:"text",style:{flex:"1"},onClick:c,color:g(a).PRIMARY_COLOR},{default:S((()=>[w(y(e.$t("AppRunningWindowV2.Cancel")),1)])),_:1},8,["color"])):(h(),x(z,{key:3}))])}}}),Ma={key:0},Oa={class:"d-flex",style:{"align-items":"center"}},Ta=["title"],Na={style:{"font-size":"14px",color:"#666","margin-top":"-8px"},class:"pl-7"},La=c({__name:"model-choose-dialog",props:{allModelFiles:{},modelValue:{type:Boolean}},emits:["update:modelValue","hide","cancel"],setup(e,{emit:l}){const t=e,n=r(t.modelValue),s=r(!1),i=Ra(),d=r([]),c=r(null);_((()=>i.modelFileInfoMap.size>0));const m=e=>o.localeIsEn()?e?.desc_en:e?.desc_zhHans,A=l;R((()=>t.modelValue),(e=>{n.value=e,e&&I()}));const I=async()=>{s.value=!0;t.allModelFiles&&(c.value=await ba("ComfyUI/models/",t.allModelFiles)),D(),s.value=!1,k()},D=()=>{c.value?.forEach((e=>{const a=t.allModelFiles?.find((a=>e.value===a.value));a&&(a.downloadInfo||(a.downloadInfo={}),a.downloadInfo.status=_a.DOWNLOADED)}))},k=()=>{const e=t.allModelFiles?.filter((e=>e.downloadInfo?.status===_a.DOWNLOADED));e&&(d.value=e)};R(n,(e=>{A("update:modelValue",e)}));const M=()=>{n.value=!1,A("cancel")},O=()=>{T.value.forEach((e=>{e.downloadInfo||(e.downloadInfo={},e.downloadInfo.status=_a.NOT_DOWNLOADED),e.downloadInfo.status===_a.NOT_DOWNLOADED&&i.startDownload(e)}))},T=_((()=>{const e=[];return d.value&&d.value.length>0&&d.value.forEach((a=>{a.downloadInfo?a.downloadInfo.status===_a.NOT_DOWNLOADED&&e.push(a):e.push(a)})),e})),N=e=>{const a=e.downloadInfo?.status||_a.NOT_DOWNLOADED;return a===_a.DOWNLOADING||a===_a.DOWNLOADED},L=e=>N(e)?"#D6D6D6":a.PRIMARY_COLOR;return(e,l)=>{const t=Ca;return h(),x(j,{modelValue:g(n),"onUpdate:modelValue":l[1]||(l[1]=e=>E(n)?n.value=e:null),"max-width":"720","min-width":"400"},{default:S((()=>[v(B,{class:"px-2 py-4"},{default:S((()=>[v(H,{class:"choose-models-dialog-title"},{default:S((()=>[w(y(e.$t("AppRunningWindowV2.ChooseModelFiles")),1)])),_:1}),v(G,{class:"d-flex flex-column px-4 py-5 choose-model-file-list"},{default:S((()=>[g(s)?(h(),p("div",Ma,[v(P,{color:g(a).PRIMARY_COLOR,indeterminate:""},null,8,["color"])])):(h(!0),p(f,{key:1},C(e.allModelFiles,(e=>(h(),p(f,{key:e.value},[u("div",Oa,[v(Y,{density:"compact",class:b(["file-item"]),modelValue:g(d),"onUpdate:modelValue":l[0]||(l[0]=e=>E(d)?d.value=e:null),color:L(e),value:e,"hide-details":"",readonly:N(e)},{label:S((()=>[u("div",{class:"checkbox-label",title:e.title||e.value},y(e.title||e.value),9,Ta)])),_:2},1032,["modelValue","color","value","readonly"]),v(z,{style:{width:"16px",flex:"unset"}}),v(K,{size:"small",density:"compact",style:{"background-color":"rgba(250, 100, 0, 0.08)"},variant:"outlined",color:g(a).PRIMARY_COLOR},{default:S((()=>[w(y(e.size),1)])),_:2},1032,["color"]),v(z),v(t,{modelFileInfo:e},null,8,["modelFileInfo"])]),u("div",Na,y(m(e)),1)],64)))),128))])),_:1}),v(U,{class:"confirm-actions"},{default:S((()=>[v(z),v(F,{variant:"outlined",onClick:M},{default:S((()=>[w(y(e.$t("AppRunningWindowV2.Close")),1)])),_:1}),v(F,{variant:"flat",color:"primary",onClick:O,disabled:0===g(T).length},{default:S((()=>[w(y(e.$t("AppRunningWindowV2.Download")),1)])),_:1},8,["disabled"]),v(z)])),_:1})])),_:1})])),_:1},8,["modelValue"])}}}),$a={class:"file-grid-container"},Va=["title"],Pa=c({__name:"model-file-list-view",props:{data:{},modelValue:{},showCheckbox:{type:Boolean}},emits:["update:modelValue"],setup(e,{emit:l}){const t=e,n=r([]),o=l;return R((()=>t.modelValue),(e=>{n.value=e})),R((()=>n.value),(e=>{o("update:modelValue",e)})),(e,l)=>(h(),p("div",$a,[(h(!0),p(f,null,C(e.data,(t=>(h(),p("div",{key:t.value,class:"d-flex flex-row",style:{"align-items":"center",width:"100%"}},[e.showCheckbox?(h(),x(Y,{key:0,density:"compact",class:"file-item",modelValue:g(n),"onUpdate:modelValue":l[0]||(l[0]=e=>E(n)?n.value=e:null),color:g(a).PRIMARY_COLOR,label:t.title||t.value,value:t,"hide-details":"",style:{}},null,8,["modelValue","color","label","value"])):(h(),p("div",{key:1,class:"file-item file-item-label",title:t.title||t.value},y(t.title||t.value),9,Va)),v(K,{size:"small",class:"mr-2",density:"compact",style:{"background-color":"rgba(250, 100, 0, 0.08)"},variant:"outlined",color:g(a).PRIMARY_COLOR},{default:S((()=>[w(y(t.size),1)])),_:2},1032,["color"])])))),128))]))}}),Wa={key:0,class:"model-desc-and-download"},Fa={class:"desc-title"},Ua={style:{"font-size":"14px","font-weight":"normal",color:"#333"}},za={key:0,class:"desc-imgs"},ja={class:"desc-title mt-5"},Ba={key:1},Ha={class:"model-file-list"},Ga={key:0,class:"mx-8 my-8"},Ya={key:1,style:{"text-align":"center","justify-items":"center"}},Ka={class:"mt-4 pb-0",style:{color:"rgba(0, 0, 0, 0.45)"}},Ja=c({__name:"model-desc-and-download",props:{selectedItem:{}},setup(e){const l=e,t=Ra(),n=r(null),s=r(null),i=r(null),d=r(null),c=r(!1),I=r(!1),D=r(!1);A((()=>{}));const b=async()=>{if(l.selectedItem){D.value=!0,n.value=await(async e=>{const a=`https://r-1314735556.cos.ap-shanghai.myqcloud.com/pkgs/models/data/comfyui/${e.path}`;return(await axios.get(a)).data})(l.selectedItem);const e="ComfyUI/models/";n.value?.files&&(s.value=n.value?.files,i.value=await ba(e,n.value?.files),k(),t.checkDownloadingModels(n.value?.files)),D.value=!1}},k=()=>{i.value?.forEach((e=>{const a=s.value?.find((a=>e.value===a.value));a&&(a.downloadInfo||(a.downloadInfo={}),a.downloadInfo.status=_a.DOWNLOADED)}))};R((()=>l.selectedItem),(e=>{e&&b()})),R((()=>I.value),(e=>{e||(b(),T())}));const M=()=>{I.value=!0},O=()=>{c.value=!0},T=()=>{c.value=!1},N=async()=>{d.value&&d.value?.length>0&&(await(async(e,a)=>(await Ae.delete("/self-manage/model-files/files",{data:{modelPath:e,files:a}})).data.files)("ComfyUI/models/",d.value),b(),T())},L=()=>{T()},$=_((()=>o.localeIsEn()?l.selectedItem?.desc_en:l.selectedItem?.desc_zhHans)),W=_((()=>{for(const[e,a]of t.modelFileInfoMap){const e=l.selectedItem?.value;if(a.modelPackage===e)return!0}return!1}));return R(W,(e=>{!1===e&&b()})),(e,l)=>{const t=Pa,o=La;return h(),p(f,null,[e.selectedItem?(h(),p("div",Wa,[u("div",Fa,[w(y(e.selectedItem?.title||e.selectedItem?.value)+"    ",1),u("span",Ua,y(g($)),1)]),g(n)?(h(),p("div",za,[(h(!0),p(f,null,C(g(n).snapshots,(e=>(h(),x(V,{key:e.url,rounded:"lg",cover:"","max-width":"180","max-height":"180",width:"180",height:"180",src:e.url},null,8,["src"])))),128))])):m("",!0),u("div",ja,[w(y(e.$t("AppRunningWindowV2.MyModelFiles"))+" ",1),v(z),v(F,{variant:"flat",onClick:M,color:g(a).PRIMARY_COLOR,rounded:"xl",size:"small",style:{"font-size":"14px"}},{default:S((()=>[w(y(e.$t("AppRunningWindowV2.ChooseModelFiles"))+" ",1),g(W)?(h(),x(J,{key:0,indeterminate:"",size:"16","model-value":"80",width:"3",style:{"margin-left":"4px"}})):g(s)&&g(s).length>0?(h(),p("div",Ba," ("+y(g(s)?.length)+") ",1)):m("",!0)])),_:1},8,["color"]),l[2]||(l[2]=w("    ")),g(c)?(h(),x(F,{key:1,variant:"outlined",onClick:N,color:"red",rounded:"xl",size:"small"},{default:S((()=>[w(y(e.$t("AppRunningWindowV2.ConfirmDelete")),1)])),_:1})):(h(),x(F,{key:0,variant:"outlined",onClick:O,color:"red",rounded:"xl",size:"small"},{default:S((()=>[w(y(e.$t("AppRunningWindowV2.Delete")),1)])),_:1})),l[3]||(l[3]=w("    ")),g(c)?(h(),x(F,{key:2,variant:"outlined",onClick:L,rounded:"xl",size:"small"},{default:S((()=>[w(y(e.$t("AppRunningWindowV2.Cancel")),1)])),_:1})):m("",!0)]),u("div",Ha,[g(D)?(h(),p("div",Ga,[v(P,{color:g(a).PRIMARY_COLOR,indeterminate:""},null,8,["color"])])):(h(),p(f,{key:1},[g(i)&&g(i).length>0?(h(),x(t,{key:0,"show-checkbox":g(c),data:g(i),modelValue:g(d),"onUpdate:modelValue":l[0]||(l[0]=e=>E(d)?d.value=e:null)},null,8,["show-checkbox","data","modelValue"])):(h(),p("div",Ya,[v(V,{"max-width":"147","max-height":"120",width:"147",height:"120",src:"./images/app/no-data.svg"}),u("div",Ka,y(e.$t("AppRunningWindowV2.NoModelFiles")),1)]))],64))])])):m("",!0),v(o,{"all-model-files":g(s),"downloaded-model-files":g(i),modelValue:g(I),"onUpdate:modelValue":l[1]||(l[1]=e=>E(I)?I.value=e:null)},null,8,["all-model-files","downloaded-model-files","modelValue"])],64)}}}),qa={key:0,class:"menu"},Qa=["onClick"],Xa={class:"arrow"},Za={class:"submenu"},el=["onClick"],al={key:0,class:"small-tag"},ll=De(c({__name:"MenuComponent",props:{menuData:{},modelValue:{}},emits:["update:modelValue"],setup(e,{emit:a}){const l=e,t=_({get:()=>l.modelValue,set:e=>n("update:modelValue",e)}),n=a;return(e,a)=>e.menuData?(h(),p("div",qa,[(h(!0),p(f,null,C(e.menuData,(e=>(h(),p("div",{key:e.value,class:"menu-item"},[u("div",{class:b(["menu-title",{active:e.isOpen}]),onClick:a=>(e=>{e.children&&(e.isOpen=!e.isOpen)})(e)},[w(y(e.title)+" ",1),u("span",Xa,[e.isOpen?(h(),x(q,{key:0,size:"18",icon:"mdi-menu-up"})):(h(),x(q,{key:1,size:"18",icon:"mdi-menu-down"}))])],10,Qa),v(T,{name:"slide"},{default:S((()=>[M(u("div",Za,[(h(!0),p(f,null,C(e.children,(e=>(h(),p("div",{key:e.value,class:b(["submenu-item",{active:e===g(t)}]),onClick:a=>(e=>{t.value=e,n("update:modelValue",e)})(e)},[w(y(e.title)+" ",1),e.format?(h(),p("span",al,y(e.format),1)):m("",!0)],10,el)))),128))],512),[[O,e.isOpen]])])),_:2},1024)])))),128))])):m("",!0)}}),[["__scopeId","data-v-3ecaa233"]]),tl=c({__name:"model-categories",props:{modelValue:{}},emits:["update:modelValue"],setup(e,{emit:a}){const l=e,t=a,n=_({get:()=>l.modelValue,set:e=>t("update:modelValue",e)});A((()=>{o()}));const o=async()=>{const e=await xa();i.value=e,console.log("allModelCats::",i.value);const a=s();if(a){const{menuData:e,firstMenuItem:l}=a;e&&l&&(e.isOpen=!0,n.value=l)}},s=()=>{for(const e of i.value)if(e?.children&&e?.children.length>0){const a=e?.children[0];return{menuData:e,firstMenuItem:a}}},i=r([]);return(e,a)=>{const l=ll;return h(),x(l,{"menu-data":g(i),modelValue:g(n),"onUpdate:modelValue":a[0]||(a[0]=e=>E(n)?n.value=e:null)},null,8,["menu-data","modelValue"])}}}),nl={style:{flex:"1","min-height":"300px","max-height":"490px",display:"flex","flex-direction":"row"}},ol=c({__name:"model-tree-comfyui",setup(e){const a=r(null);return(e,l)=>{const t=tl,n=Ja;return h(),p("div",nl,[v(t,{modelValue:g(a),"onUpdate:modelValue":l[0]||(l[0]=e=>E(a)?a.value=e:null)},null,8,["modelValue"]),v(n,{"selected-item":g(a)},null,8,["selected-item"])])}}});class sl{static async getAppSettings(){const e=await this.getOSEnvObj();return{modelsDir:e.OLLAMA_MODELS,externalAccessHost:e.OLLAMA_HOST,externalAccessPath:e.OLLAMA_ACCESS_PATH_LMD}}static async getOSEnvObj(){return await _e(Pe.DISPLAY_ENV)}static async getAccessHosts(e){const a="11434",l=[`http://127.0.0.1:${a}`];if(e&&"127.0.0.1"!==e){const t=e.split(":"),n=t[0];let o=[n];const s=t[1]||a;"0.0.0.0"===n&&(o=await xe()),o&&o.length>0&&o.forEach((e=>{l.push(`http://${e}:${s}`)}))}else;return l}static async saveAppSettings(e,a){e.modelsDir===a&&(e.modelsDir="");const l={OLLAMA_MODELS:e.modelsDir,OLLAMA_HOST:e.externalAccessHost,OLLAMA_ACCESS_PATH_LMD:e.externalAccessPath};return await be(l)}static getDownloadableModels(){return JSON.parse(JSON.stringify(Ve))}}const il={style:{"font-size":"14px","line-height":"16px"}},dl=c({__name:"lmd-expansion-panel",props:{title:{default:""},showExpandIcon:{type:Boolean,default:!1},defaultExpanded:{type:Boolean,default:!1}},setup:e=>(A((()=>{})),(e,a)=>(h(),x(Q,{dense:""},{default:S((()=>[v(X,{class:"d-flex"},{actions:S((({expanded:a})=>[e.showExpandIcon?(h(),p(f,{key:0},[u("span",il,y(a?e.$t("AppRunningWindowV2.Collapse"):e.$t("AppRunningWindowV2.Expand")),1),v(V,{src:a?"./images/icons/collapse.svg":"./images/icons/expand.svg",width:"16",height:"16"},null,8,["src"])],64)):m("",!0)])),default:S((()=>[w(y(e.title)+" ",1),v(z),N(e.$slots,"append")])),_:3}),v(Z,{style:{padding:"0"}},{default:S((()=>[N(e.$slots,"default")])),_:3})])),_:3})))}),rl={style:{"font-size":"12px"}},cl={style:{"font-size":"12px"}},pl=c({__name:"ollama-settings-btn",props:{installedInstance:{}},setup(a){const{t:l}=W(),t=r(!1),n=r(!1),o=r(!1),i=r(!1),d=r(""),c=ea(),{addToast:I}=e(),D=r({}),b=r(!0),k=a;R((()=>k.installedInstance),(()=>{C()}));const C=()=>{J()?t.value=!0:t.value=!1};A((()=>{C()}));const M=async()=>{n.value=!0,await O(),await K()};R((()=>n),(()=>{console.log("dialogVisible change: ",n)}));const O=async()=>{const e=await Re();d.value=e+"/.ollama/models"},T=async()=>{if(!o.value)return;if(!D)return;if(""===d.value){const e=l("AppSettingDialog.DataNotValid");return void I(e,"error")}i.value=!0;const e=Object.assign({},D.value),a=await sl.saveAppSettings(e,d.value);console.log("save result ",a);const t=l("Common.saveSuccess");I(t,"success"),i.value=!1,c.onAppSettingsSaved(),setTimeout((()=>{c.resetAppSettingsSavedStatus()}),100),n.value=!1,console.log("hideDialog",n.value),We.killAppProcessed(k.installedInstance?.installName),setTimeout((()=>{Ee()}),1500)},N=async()=>{const e=await Se(D.value.modelsDir,!0);e&&e.path&&(D.value.modelsDir=e.path,console.log("dirInfo",e),b.value=ke.checkModelsDirValid(e,["blobs"]),console.log("dirValid.value",b.value))},V=()=>{s(D.value.modelsDir)},P=[e=>!!e||l("Common.fieldRequired"),()=>b.value||l("AppSettingDialog.ModelsDirNotValid")],z=/^(\d{1,3}\.){3}\d{1,3}(:\d{1,5})?$/,H=[e=>""===e||(z.test(e)||l("AppSettingDialog.HostNotValid"))],G=async()=>{D.value.modelsDir=d.value},Y=_((()=>{if(J())return l("AppSettingDialog.OllamaModelsDirInfoIconTip")})),K=async()=>{if(J()){const e=await sl.getAppSettings();console.log("getOSEnvForCurrentApp",e),D.value=Object.assign({},e),""===e.modelsDir&&(console.log("getOSEnvForCurrentApp",e),D.value.modelsDir=d.value)}},J=()=>We.appIsOllama(k.installedInstance?.installName);return(e,a)=>(h(),p(f,null,[v(F,{class:"settings-small-btn",variant:"outlined",density:"compact",rounded:"",onClick:L(M,["stop"])},{default:S((()=>[w(y(e.$t("AppRunningWindow.Settings")),1)])),_:1}),v(j,{modelValue:g(n),"onUpdate:modelValue":a[5]||(a[5]=e=>E(n)?n.value=e:null),"min-width":"400","max-width":"840"},{default:S((()=>[e.installedInstance?(h(),x(B,{key:0,class:"mx-auto px-0 py-0 window-no-drag",width:"100%",title:e.$t("AppSettingDialog.Title")+e.installedInstance.name},{append:S((()=>[v(F,{icon:"mdi-close",class:"ms-auto",size:"compact",text:"Ok",elevation:"0",onClick:a[0]||(a[0]=e=>n.value=!1)})])),default:S((()=>[g(D)?(h(),x(ee,{key:0,class:"pt-0 pb-3 px-6",modelValue:g(o),"onUpdate:modelValue":a[4]||(a[4]=e=>E(o)?o.value=e:null),onSubmit:L(T,["prevent"])},{default:S((()=>[v(ae,{modelValue:g(D).modelsDir,"onUpdate:modelValue":a[1]||(a[1]=e=>g(D).modelsDir=e),density:"comfortable",readonly:g(i),rules:P,label:e.$t("AppSettingDialog.ModelsDirLabel")},{append:S((()=>[v(le,{location:"bottom"},{activator:S((({props:e})=>[v(q,$(e,{icon:"mdi-information-slab-circle-outline"}),null,16)])),default:S((()=>[u("pre",null,y(g(Y)),1)])),_:1}),v(F,{class:"ml-1",onClick:N,variant:"outlined"},{default:S((()=>[w(y(e.$t("AppSettingDialog.Browse")),1)])),_:1}),v(F,{class:"ml-1",onClick:V,variant:"outlined"},{default:S((()=>[w(y(e.$t("AppSettingDialog.Open")),1)])),_:1}),v(F,{class:"ml-1",onClick:G,variant:"outlined"},{default:S((()=>[w(y(e.$t("AppSettingDialog.UseDefaultValue")),1)])),_:1})])),_:1},8,["modelValue","readonly","label"]),v(te,{class:"pt-0"},{default:S((()=>[u("pre",rl,y(l("AppSettingDialog.ModelsDirTip")),1)])),_:1}),v(ae,{modelValue:g(D).externalAccessHost,"onUpdate:modelValue":a[2]||(a[2]=e=>g(D).externalAccessHost=e),density:"comfortable",readonly:g(i),rules:H,label:e.$t("AppSettingDialog.ServerHostLabel")},null,8,["modelValue","readonly","label"]),v(te,{class:"pt-0"},{default:S((()=>[u("pre",cl,y(l("AppSettingDialog.ServerHostTip")),1)])),_:1}),v(U,{class:"text-center justify-center"},{default:S((()=>[v(F,{variant:"outlined",onClick:a[3]||(a[3]=e=>n.value=!1)},{default:S((()=>[w(y(e.$t("AppSettingDialog.close")),1)])),_:1}),v(F,{color:"primary",variant:"flat",type:"submit",loading:g(i)},{default:S((()=>[w(y(e.$t("AppSettingDialog.saveConfig")),1)])),_:1},8,["loading"])])),_:1})])),_:1},8,["modelValue"])):m("",!0)])),_:1},8,["title"])):m("",!0)])),_:1},8,["modelValue"])],64))}}),ul={key:0},ml={class:"model-storage-title d-flex flex-row align-baseline"},vl={class:""},gl={key:0,class:"justify-center mr-6"},fl={class:"d-flex"},wl={style:{flex:"1"}},yl={class:"d-flex"},hl={class:"d-flex flex-row mt-1",style:{"font-size":"14px"}},Al={style:{flex:"1"}},Il=c({__name:"model-storage",props:{installedInstance:{},appEnv:{}},setup(e){const a=e,l=r(""),t=r(""),n=r(""),o=r(0),i=r(null);A((async()=>{We.appIsOllama(a.installedInstance?.installName)&&await f(),I()}));const d=r(null),{t:c}=W(),f=async()=>{const e=await Re();t.value=e+"/.ollama/models"},I=async()=>{const e=await We.getModelsDirV2(a.installedInstance,a.appEnv);l.value=e||t.value;const n=await We.getModelFileSize(a.installedInstance?.installName,l.value);d.value=ze(n.dirSize||0),i.value=n,D()},D=()=>{if(!i.value)return;let e=0;try{e=i.value?.totalSpace-i.value.dirSize-i.value.freeSpace,o.value=i.value?.totalSpace-i.value.freeSpace}catch(s){console.error("calculate error",s)}const a=ze(e),l=ze(i.value.freeSpace),t=`${c("AppRunningWindow.StorageModelsSize")}: ${d.value},\n  ${c("AppRunningWindow.StorageDiskOther")}: ${a},\n  ${c("AppRunningWindow.StorageDiskFreeSpace")}: ${l}\n  `;n.value=t};R((()=>a.appEnv),(e=>{I()})),R((()=>a.installedInstance),(e=>{I()}));const _=async()=>{s(l.value)};return(e,t)=>g(d)?(h(),p("div",ul,[u("div",ml,[u("div",vl,y(e.$t("AppRunningWindow.ModelStorageLabel")),1),v(z),g(We).appIsOllama(a.installedInstance?.installName)?(h(),p("div",gl,[v(pl,{installedInstance:e.installedInstance},null,8,["installedInstance"])])):m("",!0)]),v(G,{class:"mt-3 pb-3 px-5"},{default:S((()=>[u("div",fl,[u("div",null,[v(V,{src:"./images/icons/harddisk.svg",class:"mr-1",width:"72",height:"34"})]),u("div",wl,[u("div",yl,[v(le,{text:g(n),location:"top"},{activator:S((({props:e})=>[v(P,$({class:"custom-progress-bar"},e,{location:null,"bg-color":"#FFFFFF","bg-opacity":"1","buffer-color":"#DFDFEC","buffer-opacity":"1",opacity:"1",color:"#FEF1E5",height:"14",max:g(i)?.totalSpace||10,min:"0","buffer-value":g(o),"model-value":g(i)?.dirSize,rounded:""}),null,16,["max","buffer-value","model-value"])])),_:1},8,["text"])]),u("div",hl,[u("div",Al,y(g(i)?.diskName),1),u("a",{href:"#",style:{"text-decoration":"none",color:"rgba(0, 0, 0, 0.75)"},onClick:L(_,["prevent"])},[w(y(g(d))+" > ",1),g(l)?(h(),x(le,{key:0,activator:"parent",location:"top"},{default:S((()=>[w(y(g(l)),1)])),_:1})):m("",!0)])])])])])),_:1})])):m("",!0)}}),Dl="http://localhost:11434";class _l{constructor(e,a){if(this.paramSize=e,this.updateUI=a,!e.nameAndSize)throw new Error("nameAndSize is empty");this.nameAndSize=e.nameAndSize}totalPercentageWithoutCurrent=.01;totalPercentage=.01;pullingMainPart="";pullingCurrentPart="";nameAndSize="";async download(e){const a=e.signal,l=await fetch(`${Dl}/api/pull`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:this.nameAndSize,stream:!0}),signal:a});if(!l.ok)throw new Error(`HTTP error: ${l.status}`);if(!l.body)throw new Error("No response body");const t=l.body.getReader(),n=new TextDecoder;let o="";for(;;){const{done:e,value:a}=await t.read();if(e)break;o+=n.decode(a);const l=o.split("\n");o=l.pop()||"";for(const t of l)if(t.trim())try{const e=JSON.parse(t);this.processProgress(e)}catch(s){console.error("Parse error:",s)}}}calculatePercentage(e,a,l){let t=this.totalPercentageWithoutCurrent;if(e&&e.completed&&e.total){t+=e.completed/e.total*a,t>.99&&(t=.99),t>=this.totalPercentage&&(this.totalPercentage=t)}l&&this.totalPercentage>=this.totalPercentageWithoutCurrent&&(this.totalPercentageWithoutCurrent=this.totalPercentage)}processProgress(e){const a=e?.status||"";let l=.02;if("pulling manifest"===a)l=.01;else if(a.startsWith("downloading")||a.startsWith("pulling")){void 0!==e.total&&void 0!==e.completed&&(!this.pullingMainPart&&e.total>5242880&&(this.pullingMainPart=a),this.pullingMainPart===a&&(l=.89));let t=!1;this.pullingCurrentPart!==a&&(this.pullingCurrentPart=a,t=!0),this.calculatePercentage(e,l,t)}else"success"===a&&(this.totalPercentage=1);this.updateUI&&this.updateUI(this.paramSize,this.totalPercentage)}}const{addToast:xl}=e(),bl=d("modelDownloadInfo",{state:()=>({models:r([]),parameterSizes:r([]),downloadSuccessMsg:r(""),cancelDownloadMsg:r(""),fetchAbortControllers:r(new Map)}),actions:{initModelsData(){this.models=[],this.parameterSizes=[]},updateUI(e,a){const l=e.downloadProgress;l&&(l.percent=a,1===a&&(e.installed=!0,this.downloadSuccessMsg&&xl(this.downloadSuccessMsg,"success")))},onDownloadError(e){console.error("Failed to download model",e);let a=e.message;"BodyStreamBuffer was aborted"===a&&(a=this.cancelDownloadMsg),xl(a,"error")},async startDownload(e,a){a.nameAndSize=e,a.downloadProgress={nameAndSize:e,percent:0},this.updateUI(a,.01);const l=await(async(e,a,l)=>{const t=new AbortController;return new _l(e,a).download(t).catch((e=>{l&&(console.error("download err",e),l(e))})),t})(a,this.updateUI,this.onDownloadError);this.fetchAbortControllers.set(a.nameAndSize,l)},async cancelDownload(e,a){const l=Fe.genModelNameAndSize(e,a);try{const e=this.fetchAbortControllers.get(l);e?.abort()}catch(t){console.log("cancel err",t)}try{await(async e=>{const a=await fetch(`${Dl}/api/pull`,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e})});if(!a.ok)throw new Error(`HTTP error: ${a.status}`);if(!a.body)throw new Error("No response body");const l=await a.json();l.error?console.error("cancel error",l.error):console.log("cancel done",l)})(l)}catch(t){console.error(t)}finally{a.installed=!1,a.downloadProgress&&(a.downloadProgress.percent=void 0)}},async deleteModel(e,a){const l=Fe.genModelNameAndSize(e,a);try{await(async e=>{const a=await fetch(`${Dl}/api/delete`,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e})});if(!a.ok)throw new Error(`HTTP error: ${a.status}`);if(!a.body)throw new Error("No response body");const l=await a.json();l.error?console.error("del error",l.error):console.log("del done",l)})(l)}catch(t){console.error(t)}finally{a.installed=!1,a.downloadProgress&&(a.downloadProgress.percent=void 0)}}}}),Sl=c({__name:"model-download-row-comfyui",props:{lmAppData:{},installedInstance:{},appEnv:{}},setup(e){const a=bl(),l=r(!1),t=r(null),{t:n}=W(),o=e;A((async()=>{s(),a.downloadSuccessMsg=n("AppRunningWindow.ModelDownloadSuccessful"),a.cancelDownloadMsg=n("AppRunningWindowV2.DownloadCanceled"),await d()})),R((()=>o.lmAppData),(()=>{s()})),R((()=>o.installedInstance),(()=>{d()})),R((()=>o.appEnv),(()=>{d()}));const s=()=>{l.value=We.checkModelDownloadBtnVisibility(o.lmAppData?.installName)};R(t,(()=>{i()}));const i=()=>{const e=t.value,l=a.models.find((a=>a.installName===e)),n=l?.tags||[];a.parameterSizes=n},d=async()=>{const e=o.installedInstance?.installName;if(e&&l.value){a.initModelsData();const l=sl.getDownloadableModels(),n=await We.mergeModelsList(e,l);if(a.models=n,t.value)i();else{const e=a.models;if(e&&e.length>0){const a=e[0];t.value=a.installName}}}};return(e,a)=>{const t=ol;return e.lmAppData&&g(l)?(h(),x(dl,{key:0,class:"model-download-panel",showExpandIcon:!0,value:"model-download",title:e.$t("AppRunningWindow.ModelDownload")},{default:S((()=>[v(G,{class:"model-download-sheet d-flex flex-row"},{default:S((()=>[v(t,{"lm-app-data":e.lmAppData},null,8,["lm-app-data"])])),_:1}),v(G,{style:{"border-top":"1px solid #EBEBF7"}},{default:S((()=>[e.installedInstance?(h(),x(Il,{key:0,appEnv:e.appEnv,installedInstance:e.installedInstance},null,8,["appEnv","installedInstance"])):m("",!0)])),_:1})])),_:1},8,["title"])):m("",!0)}}}),kl=c({__name:"copy-link-icon",props:{text:{}},setup(e){const a=e,l=r(!1),t=()=>{l.value=!0,navigator.clipboard.writeText(a.text),setTimeout((()=>{l.value=!1}),1500)};return(e,a)=>(h(),x(V,{width:"16",height:"16",onClick:t,src:"./images/icons/link-copy.svg",style:{cursor:"pointer"}},{default:S((()=>[v(le,{activator:"parent","open-on-hover":!1,location:"bottom",transition:"false",modelValue:g(l),"onUpdate:modelValue":a[0]||(a[0]=e=>E(l)?l.value=e:null)},{default:S((()=>[w(y(e.$t("App.Copied")),1)])),_:1},8,["modelValue"])])),_:1}))}});class Rl{static async getAppEnvData(e){const a=await(async e=>(await Ae.get(`/self-manage/ai-app-env/${e}`)).data)(e);return a}static async getAccessHosts(e,a){const l=this.parsePort(e),t=[`http://127.0.0.1:${l}`];if("1"===a.allowExternalAccess){const e=await xe();e&&e.length>0&&e.forEach((e=>{t.push(`http://${e}:${l}`)}))}return t}static parsePort(e){return e.split(":")[2]||"8188"}static async saveAppEnvData(e,a){return await(async(e,a)=>(await Ae.post(`/self-manage/ai-app-env/${e}`,{envObj:a})).data)(e,a)}}const El=c({__name:"app-settings-btn",props:{installedInstance:{}},setup(l){const{t:t}=W(),n=r(!1),o=r(!1),s=r(!1),i=ea(),{addToast:d}=e(),c=r({}),I=r([{label:t("AppSettingDialog.LocalAccessOnly"),value:"0"},{label:t("AppSettingDialog.AllowLANAccess"),value:"1"}]),D=l;R((()=>D.installedInstance),(()=>{})),A((()=>{}));const _=async()=>{n.value=!0,await k()};R((()=>n),(()=>{console.log("dialogVisible change: ",n)}));const b=async()=>{if(!o.value)return;if(!c)return;if(!D.installedInstance?.appId)return;s.value=!0;const e=Object.assign({},c.value),a=await Rl.saveAppEnvData(D.installedInstance?.appId,e);console.log("save result ",a);const l=t("Common.saveSuccess");d(l,"success"),s.value=!1,i.onAppSettingsSaved(),n.value=!1,console.log("hideDialog",n.value),setTimeout((()=>{location.reload()}),1e3)},k=async()=>{if(We.appIsComfyUI(D.installedInstance?.installName)){const e=await Rl.getAppEnvData(D.installedInstance.appId);console.log("envForCurrentApp",e),c.value=Object.assign({allowExternalAccess:"0"},e)}};return(e,l)=>(h(),p(f,null,[v(F,{class:"settings-small-btn",variant:"outlined",density:"compact",rounded:"",onClick:L(_,["stop"])},{default:S((()=>[w(y(e.$t("AppRunningWindow.Settings")),1)])),_:1}),v(j,{modelValue:g(n),"onUpdate:modelValue":l[4]||(l[4]=e=>E(n)?n.value=e:null),"min-width":"400","max-width":"640"},{default:S((()=>[e.installedInstance?(h(),x(B,{key:0,class:"mx-auto px-0 py-0 window-no-drag",width:"100%",title:e.$t("AppSettingDialog.Title")+e.installedInstance.name},{append:S((()=>[v(F,{icon:"mdi-close",class:"ms-auto",size:"compact",text:"Ok",elevation:"0",onClick:l[0]||(l[0]=e=>n.value=!1)})])),default:S((()=>[g(c)?(h(),x(ee,{key:0,class:"pt-0 pb-3 px-6",modelValue:g(o),"onUpdate:modelValue":l[3]||(l[3]=e=>E(o)?o.value=e:null),onSubmit:L(b,["prevent"])},{default:S((()=>[v(H,{class:"px-0"},{default:S((()=>[w(y(e.$t("AppSettingDialog.AppLanAccessLabel")),1)])),_:1}),v(ne,{modelValue:g(c).allowExternalAccess,"onUpdate:modelValue":l[1]||(l[1]=e=>g(c).allowExternalAccess=e),"hide-details":""},{default:S((()=>[(h(!0),p(f,null,C(g(I),(e=>(h(),x(oe,{key:e.value,value:e.value,color:g(a).PRIMARY_COLOR},{label:S((()=>[w(y(e.label),1)])),_:2},1032,["value","color"])))),128))])),_:1},8,["modelValue"]),v(te,{class:"pt-0"},{default:S((()=>[u("pre",null,y(e.$t("AppSettingDialog.AppLanAccessTip")),1)])),_:1}),v(U,{class:"text-center justify-center"},{default:S((()=>[v(F,{variant:"outlined",onClick:l[2]||(l[2]=e=>n.value=!1)},{default:S((()=>[w(y(e.$t("AppSettingDialog.close")),1)])),_:1}),v(F,{color:"primary",variant:"flat",type:"submit",loading:g(s)},{default:S((()=>[w(y(e.$t("AppSettingDialog.saveConfig")),1)])),_:1},8,["loading"])])),_:1})])),_:1},8,["modelValue"])):m("",!0)])),_:1},8,["title"])):m("",!0)])),_:1},8,["modelValue"])],64))}});function Cl(){let e=!1;return{callApiWithRetry:async function(a,l={},t=100,n=1e3){return async function o(s){if(e)throw console.log("API call cancelled by user"),new Error("API call cancelled by user");try{console.log(`Attempt ${s}: Calling API...`);return await axios(a,l)}catch(d){if(s<t&&!e)return console.error(`Attempt ${s} failed. Retrying in ${n}ms...`),await(i=n,new Promise((e=>setTimeout(e,i)))),o(s+1);{const a=e?"API call cancelled by user":"Failed to call API after maximum attempts";throw console.error(a),new Error(a)}}var i}(1)},cancel:function(){e=!0}}}class Ml{static openBrowser(e){const a=document.createElement("a");a.href=e,a.target="_blank",document.body.appendChild(a),a.click(),document.body.removeChild(a)}}const Ol=["href"],Tl={style:{color:"#999999"},class:"mx-0 mt-4 mb-0"},Nl=c({__name:"app-access-row-v2",props:{lmAppData:{},installedInstance:{},appEnv:{},isAppRunning:{type:Boolean}},setup(e){const l=e,t=r([]),n=r(!1),o=r(!1),s=r(null),i=r(void 0),d=async()=>{if(l.lmAppData?.accessInfo){const e=l.lmAppData.accessInfo,{accessType:a}=e;if(!a)return!1;if("browser"===a){const e=l.lmAppData.accessInfo?.webUrl;if(We.appIsComfyUI(l.lmAppData.installName)&&e){const a=await Rl.getAppEnvData(l.lmAppData.id);t.value=await Rl.getAccessHosts(e,a),c()}else t.value.push(e||"");return!0}if("exec"===a&&We.appIsOllama(l.installedInstance?.installName)){if(l.appEnv){const e=l.appEnv[Ue];t.value=await sl.getAccessHosts(e)}return!0}}return!1};A((async()=>{n.value=await d(),o.value=We.displayAccessSettingBtn(l.installedInstance?.installName)})),R((()=>l.appEnv),(async()=>{t.value=[],n.value=await d()})),R((()=>l.isAppRunning),(async()=>{s.value?.cancel()})),R((()=>l.lmAppData?.accessInfo.webUrl),(async()=>{t.value=[],n.value=await d()})),R((()=>l.lmAppData?.accessInfo.detectAvailablePortDone),(async e=>{e&&setTimeout((()=>{We.appIsComfyUI(l.lmAppData?.installName)||c()}),100)}));const c=async()=>{if(i.value)return;const e=l.installedInstance?.installMethod,a=l.lmAppData?.accessInfo,n=t.value?.length;let o;o=e===fe.DOCKER?a?.dockerOpenBrowserByLMD&&n>0:a?.openBrowserByLMD&&n>0;const d=a?.showDetectStatus;if(o||d){i.value=!0;const e=t.value[0],{apiCaller:a,promise:l}=(e=>{const a=Cl(),l=a.callApiWithRetry(e,{headers:{"Cache-Control":"no-cache",Pragma:"no-cache",Expires:"0"}},2e3,2e3);return{apiCaller:a,promise:l}})(e);s.value=a,l.then((()=>{i.value=!1,o&&Ml.openBrowser(e)})).catch((e=>{console.error(e),a?.cancel()}))}};return(e,n)=>{const o=El,s=pl,d=kl;return g(t)&&g(t).length>0?(h(),x(dl,{key:0,title:e.$t("AppRunningWindow.Access"),readonly:"",value:"app-access",showExpandIcon:!1,"default-expanded":!0},{append:S((()=>[We.appIsComfyUI(l.lmAppData?.installName)?(h(),x(o,{key:0,installedInstance:e.installedInstance},null,8,["installedInstance"])):m("",!0),We.appIsOllama(l.lmAppData?.installName)?(h(),x(s,{key:1,installedInstance:e.installedInstance},null,8,["installedInstance"])):m("",!0)])),default:S((()=>[v(se,{class:"pt-1 pb-2",style:{margin:"0 -24px -16px"}},{default:S((()=>[v(ie,{"no-gutters":"",style:{padding:"0px"}},{default:S((()=>[(h(!0),p(f,null,C(g(t),((l,t)=>(h(),x(de,{key:t,class:"px-5 py-2",cols:"12",sm:"6"},{default:S((()=>[v(re,{style:{background:"#FFF4EA","border-radius":"4px",height:"40px"},density:"compact","min-height":"1.1rem",class:"px-5"},{prepend:S((()=>[v(d,{text:l},null,8,["text"])])),default:S((()=>[(h(),p("a",{class:"mx-2 app-access-link",key:l,href:l,target:"_blank"},y(l),9,Ol)),e.isAppRunning&&g(i)?(h(),x(K,{key:0,size:"small",color:g(a).PRIMARY_COLOR},{default:S((()=>[w(y(e.$t("AppRunningWindow.Starting")),1)])),_:1},8,["color"])):m("",!0)])),_:2},1024)])),_:2},1024)))),128))])),_:1})])),_:1}),u("div",Tl,y(e.$t("AppRunningWindowV2.AccessNote")),1)])),_:1},8,["title"])):m("",!0)}}}),Ll=c({__name:"app-env-row-v2",props:{installedInstance:{},appEnv:{}},setup(e){const a=r(null);A((async()=>{a.value=await i()}));const l=e=>"HF_MIRROR"===e?"HF_ENDPOINT":e;return(e,t)=>(h(),x(dl,{title:e.$t("AppRunningWindow.EnvVars"),showExpandIcon:!0,value:"app-env"},{default:S((()=>[v(G,{class:"my-1 pt-2 pb-0 mx-0"},{default:S((()=>[(h(!0),p(f,null,C(g(a),((e,a)=>(h(),x(K,{variant:"tonal",size:"small",style:{"min-width":"50px","max-width":"190px","margin-left":"4px"},key:a},{default:S((()=>[w(y(l(a))+" ",1),v(le,{activator:"parent",location:"bottom"},{default:S((()=>[w(y(e),1)])),_:2},1024)])),_:2},1024)))),128)),(h(!0),p(f,null,C(e.appEnv,((e,a)=>(h(),x(K,{variant:"tonal",color:"orange-darken-4",size:"small",style:{"min-width":"50px","max-width":"220px","margin-left":"4px"},key:a},{default:S((()=>[w(y(a)+" ",1),v(le,{activator:"parent",location:"bottom"},{default:S((()=>[w(y(e),1)])),_:2},1024)])),_:2},1024)))),128))])),_:1})])),_:1},8,["title"]))}}),$l={key:0,style:{width:"84px"},class:"d-flex flex-column justify-center items-center"},Vl={class:"progress-text"},Pl=c({__name:"download-progress",props:{downloadInfo:{}},setup:e=>(e,l)=>e.downloadInfo?(h(),p("div",$l,[v(P,{width:"100%",class:"download-progress-bar","bg-color":"#D8D8D8","bg-opacity":"1","buffer-color":"#DFDFEC","buffer-opacity":"1",opacity:"1",color:g(a).PRIMARY_COLOR,height:"3",max:1,min:0,"model-value":e.downloadInfo.percent,rounded:""},null,8,["color","model-value"]),u("div",Vl,[w(y(e.$t("AppRunningWindowV2.Downloading"))+" ",1),e.downloadInfo.percent?(h(),p(f,{key:0},[w(y(Math.floor(100*e.downloadInfo.percent))+"% ",1)],64)):m("",!0)])])):m("",!0)}),Wl=De(c({__name:"delete-confirm-dialog",props:{modelValue:{type:Boolean},itemName:{}},emits:["update:modelValue","confirm"],setup(e,{emit:a}){const l=e,t=a,n=r(!1);R((()=>n.value),(e=>{t("update:modelValue",e)})),R((()=>l.modelValue),(e=>{n.value=e}));const o=()=>{n.value=!1},s=async()=>{t("confirm"),o()};return(e,a)=>(h(),x(j,{modelValue:g(n),"onUpdate:modelValue":a[0]||(a[0]=e=>E(n)?n.value=e:null),"max-width":"400"},{default:S((()=>[v(B,null,{default:S((()=>[v(H,{class:"headline"},{default:S((()=>[w(y(e.$t("AppRunningWindow.ConfirmDelete")),1)])),_:1}),v(te,null,{default:S((()=>[w(y(e.$t("AppRunningWindow.ConfirmDeleteMsg"))+" ",1),a[1]||(a[1]=u("br",null,null,-1)),w(" "+y(e.itemName),1)])),_:1}),v(U,{class:"justify-center mb-2"},{default:S((()=>[v(F,{variant:"outlined",onClick:o},{default:S((()=>[w(y(e.$t("AppRunningWindow.Cancel")),1)])),_:1}),v(F,{variant:"flat",color:"#F2313F",onClick:s},{default:S((()=>[w(y(e.$t("AppRunningWindow.ModelDeleteBtnLabel")),1)])),_:1})])),_:1})])),_:1})])),_:1},8,["modelValue"]))}}),[["__scopeId","data-v-2e8b336e"]]),Fl={key:0,class:"text-center py-10",style:{flex:"1"}},Ul={class:"d-flex flex-row justify-center"},zl={style:{"min-width":"46px",display:"inline-block"}},jl={style:{"min-width":"60px",display:"inline-block"}},Bl={key:0,class:"installed-chip"},Hl={key:1,class:"not-installed-chip"},Gl=c({__name:"model-download-row-v2",props:{lmAppData:{},installedInstance:{},appEnv:{}},setup(e){const a=bl(),l=r(!1),t=r(null),n=r(null),o=r(!1),s=r(""),{t:i}=W(),d=e;A((async()=>{c(),a.downloadSuccessMsg=i("AppRunningWindow.ModelDownloadSuccessful"),a.cancelDownloadMsg=i("AppRunningWindowV2.DownloadCanceled"),await D()})),R((()=>d.lmAppData),(()=>{c()})),R((()=>d.installedInstance),(()=>{D()})),R((()=>d.appEnv),(()=>{D()}));const c=()=>{l.value=We.appIsOllama(d.lmAppData?.installName)};R(t,(()=>{I()}));const I=()=>{const e=t.value,l=a.models.find((a=>a.installName===e)),n=l?.tags||[];a.parameterSizes=n},D=async()=>{const e=d.installedInstance?.installName;if(e&&l.value){a.initModelsData();const l=sl.getDownloadableModels(),n=await We.mergeModelsList(e,l);if(a.models=n,t.value)I();else{const e=a.models;if(e&&e.length>0){const a=e[0];t.value=a.installName}}}},_=async()=>{t.value&&n.value&&a.deleteModel(t.value,n.value)},b=e=>{const a=e.downloadProgress;return!!(a?.percent&&a.percent<1)},k=e=>{const a=e.tags;if(a&&a.length>0)for(let l=0;l<a.length;l++){if(a[l].installed)return!0}};return(e,i)=>{const d=Pl;return h(),p(f,null,[e.lmAppData&&g(l)?(h(),x(dl,{key:0,class:"model-download-panel",showExpandIcon:!0,value:"model-download",title:e.$t("AppRunningWindow.ModelDownload")},{default:S((()=>[v(G,{class:"model-download-sheet d-flex flex-row"},{default:S((()=>[g(a).models&&0!==g(a).models.length?m("",!0):(h(),p("div",Fl,[v(J,{color:"primary",indeterminate:"",size:"40"})])),g(a).models&&g(a).models.length>0?(h(),x(se,{key:1,style:{"border-right":"1px solid #EBEBF7",flex:"1",padding:"0"},"max-height":"340"},{default:S((()=>[(h(!0),p(f,null,C(g(a).models,((e,a)=>(h(),x(re,{key:e.installName+a,density:"compact","active-class":"selected-model-item",onClick:a=>{var l;(l=e.installName)!==t.value&&(t.value=l)},active:g(t)===e.installName,title:e.displayName,value:e.installName},{append:S((()=>[k(e)?(h(),x(q,{key:0,class:"downloaded-icon",icon:"mdi-check-bold",size:"18"})):m("",!0)])),_:2},1032,["onClick","active","title","value"])))),128))])),_:1})):m("",!0),g(a).models&&g(a).models.length>0?(h(),x(se,{key:2,style:{flex:"1",padding:"0"}},{default:S((()=>[(h(!0),p(f,null,C(g(a).parameterSizes,((l,i)=>(h(),x(re,{key:l.parameterSize+i,density:"compact",active:!1,value:l.parameterSize},{default:S((()=>[u("div",Ul,[u("span",zl,y(l.parameterSize),1),u("span",jl,[v(K,{density:"compact",class:"mx-1 file-size-chip"},{default:S((()=>[w(y(l.fileSize),1)])),_:2},1024)]),v(z,{style:{flex:"1"}}),l.installed?(h(),p("div",Bl,y(e.$t("AppRunningWindow.ModelDownloaded")),1)):(h(),p(f,{key:1},[b(l)?(h(),x(d,{key:0,"download-info":l.downloadProgress},null,8,["download-info"])):(h(),p("div",Hl,y(e.$t("AppRunningWindow.ModelNotDownloaded")),1))],64)),v(z,{style:{flex:"1"}}),l.installed?(h(),x(F,{key:2,onClick:e=>(e=>{if(!t.value)return;const a=Fe.genModelNameAndSize(t.value,e);n.value=e,o.value=!0,s.value=a})(l),variant:"text",density:"compact",color:"#F2313F"},{default:S((()=>[w(y(e.$t("AppRunningWindow.ModelDeleteBtnLabel")),1)])),_:2},1032,["onClick"])):(h(),p(f,{key:3},[b(l)?(h(),x(F,{key:0,onClick:e=>(async e=>{t.value&&a.cancelDownload(t.value,e)})(l),variant:"text",density:"compact"},{default:S((()=>[w(y(e.$t("AppRunningWindow.Cancel")),1)])),_:2},1032,["onClick"])):(h(),x(F,{key:1,onClick:e=>(async e=>{if(!t.value)return;const l=Fe.genModelNameAndSize(t.value,e);a.startDownload(l,e)})(l),variant:"text",class:"model-download-btn",density:"compact"},{default:S((()=>[w(y(e.$t("AppRunningWindow.ModelDownloadBtnLabel")),1)])),_:2},1032,["onClick"]))],64))])])),_:2},1032,["value"])))),128))])),_:1})):m("",!0)])),_:1}),v(G,{style:{"border-top":"1px solid #EBEBF7"}},{default:S((()=>[e.installedInstance?(h(),x(Il,{key:0,appEnv:e.appEnv,installedInstance:e.installedInstance},null,8,["appEnv","installedInstance"])):m("",!0)])),_:1})])),_:1},8,["title"])):m("",!0),v(Wl,{"model-value":g(o),"onUpdate:modelValue":i[0]||(i[0]=e=>o.value=e),"item-name":g(s),onConfirm:_},null,8,["model-value","item-name"])],64)}}}),Yl=c({__name:"app-env-and-access-v2",props:{installedInstance:{},lmAppData:{},isAppRunning:{type:Boolean}},emits:["appEnvSavedAndUpdated"],setup(e,{expose:a,emit:l}){const t=e,n=ea(),o=r({}),s=r(["app-access"]),i=r(void 0),d=l;A((async()=>{u(),p()}));const c=D(),p=()=>{const e=c.query.script,a=t.lmAppData?.installName;(We.appIsComfyUI(a)||We.appIsOllama(a)&&e===ge.DOWNLOAD_MODEL)&&(s.value=["app-access","model-download"])},u=async()=>{const e=t.installedInstance?.installName;We.appIsOllama(e)?(o.value=await sl.getOSEnvObj()||{},f()):We.appIsComfyUI(e)&&(o.value=await sl.getOSEnvObj()||{})};a({updateAppEnvData:u}),R((()=>t.installedInstance),(()=>{u()})),R((()=>n.appSettingsSaved),(async e=>{e&&(o.value=null,await u(),d("appEnvSavedAndUpdated",o.value))}));const f=async()=>{const e=o.value;e.OLLAMA_MODELS&&(i.value=await Ce(e.OLLAMA_MODELS))};return(e,a)=>{const l=Nl,t=Sl;return g(o)&&e.installedInstance?(h(),x(ce,{key:0,multiple:"",elevation:"0",modelValue:g(s),"onUpdate:modelValue":a[0]||(a[0]=e=>E(s)?s.value=e:null),class:"lmd-running-panels"},{default:S((()=>[v(l,{appEnv:g(o),isAppRunning:e.isAppRunning,lmAppData:e.lmAppData,installedInstance:e.installedInstance},null,8,["appEnv","isAppRunning","lmAppData","installedInstance"]),!1===g(i)?(h(),x(te,{key:0,class:"pt-0 mt-0 px-2",style:{color:"red","justify-items":"center","align-items":"center"}},{default:S((()=>[v(q,{style:{opacity:"1"},icon:"mdi-information-slab-circle-outline"}),w(" "+y(e.$t("AppRunningWindowV2.ModelDirNotFound")),1)])),_:1})):m("",!0),g(We).appIsComfyUI(e.installedInstance.installName)?(h(),x(t,{key:1,appEnv:g(o),installedInstance:e.installedInstance,lmAppData:e.lmAppData},null,8,["appEnv","installedInstance","lmAppData"])):g(We).appIsOllama(e.installedInstance.installName)?(h(),x(Gl,{key:2,appEnv:g(o),installedInstance:e.installedInstance,lmAppData:e.lmAppData},null,8,["appEnv","installedInstance","lmAppData"])):m("",!0),v(Ll,{appEnv:g(o),installedInstance:e.installedInstance},null,8,["appEnv","installedInstance"])])),_:1},8,["modelValue"])):m("",!0)}}}),Kl={class:"d-flex flex-column text-center justify-center align-middle"},Jl={style:{width:"60px",margin:"0 auto"},class:"mt-10"},ql={class:"d-flex flex-column justify-center"},Ql=c({__name:"app-info-left",props:{lmAppData:{},installedInstance:{},isAppRunning:{type:Boolean}},emits:["startApp","stopApp"],setup(e,{emit:a}){const l=e,t=a,{t:n}=W(),o=_((()=>l.installedInstance?.installMethod===fe.DOCKER?n("LMAppDetail.DockerMode"):""));return(e,a)=>(h(),x(G,{class:"left-app-basic-info"},{default:S((()=>[u("div",Kl,[u("div",Jl,[v(V,{src:e.lmAppData?.icon,rounded:"",width:"60",height:"60"},null,8,["src"])]),u("div",ql,[v(H,{class:"pt-1 pb-0"},{default:S((()=>[w(y(e.lmAppData?.name),1)])),_:1}),e.installedInstance?.version&&"--"!==e.installedInstance?.version?(h(),x(pe,{key:0,class:"py-0"},{default:S((()=>[w(y(e.$t("AppRunningWindow.Version"))+" "+y(e.installedInstance?.version),1)])),_:1})):m("",!0),v(te,null,{default:S((()=>[g(o)?(h(),x(K,{key:0,density:"default",variant:"flat",size:"small",color:"#086dd7"},{default:S((()=>[w(y(g(o)),1)])),_:1})):m("",!0),v(z,{class:"mt-6"}),e.isAppRunning?(h(),x(F,{key:1,variant:"flat",color:"#F2313F",class:"mx-2",width:"80",height:"40",onClick:a[0]||(a[0]=e=>{t("stopApp")})},{default:S((()=>[w(y(e.$t("AppRunningWindow.Stop")),1)])),_:1})):(h(),x(F,{key:2,color:"primary",variant:"flat",class:"mx-2",width:"80",height:"40",onClick:a[1]||(a[1]=e=>{t("startApp")})},{default:S((()=>[w(y(e.$t("AppRunningWindow.Start")),1)])),_:1}))])),_:1})])])])),_:1}))}}),Xl={style:{flex:"1"}},Zl={class:"pa-6 run-right-content"},et={class:"footer-button-bar"},at={class:"footer-terminal-content"},lt=c({__name:"app-run",setup(a){const t=D(),n=Te(),o=r(null),s=r(),i=r(),d=r(null),c=r(!1),I=r(!1),k=r(""),{t:R}=W(),{addToast:E}=e(),C=ea(),M=r(!1);A((async()=>{$();const e=t.params.id,a=await me(e);d.value=a;const l=a.appId;await n.fetchApp(l),o.value=n.currentLmApp,window.ipcRenderer?.on(ye.STOP_AI_RUNNING_INSTANCE,(()=>{j(),B()})),O()}));const O=()=>{const e=o?.value?.name;document.title=`[${R("LMAppDetail.RunApp")}] ${e}`},T=()=>{console.log("onTerminalReady"),G()},N=_((()=>{if(o.value?.id&&d.value?.id)return pa.genWSUrl(o.value?.id,d.value?.id,ma)})),L=_((()=>{if(C.terminals&&C.terminals.length>0)return C.terminals[0]})),$=()=>{const e=R("AppRunningWindow.MainProcessTab");C.initTerminal(e)},P=async()=>{var e;if(e=ge.START,k.value=e,C.changeMainTerminalScriptType(e,""),c.value=!0,o.value&&d.value){let e=await(async(e,a)=>{const t=e.installName,n=(await l()).LMD_SCRIPTS_DIR,{repoUrl:o,repoLocalFolderName:s}=aa.getLMDScriptRepoUrl(e);return`\nexport LMD_BASE_INSTALL_SCRIPT_DIR="${n}/${s}"\n${oa(o)}\n${await na.genSetPortCommand(e)}\nsh "$LMD_BASE_INSTALL_SCRIPT_DIR/apps/${t}/${"docker"===a?.installMethod?"start-d.sh":"start.sh"}"`})(o.value,d.value);const a=t.query.module;if(console.log("route.params.module",a),a){e=`\nexport LMD_LAUNCH_APP_MODULE=${a}\n`+e}z(e),window.ipcRenderer?.send(ye.RUNNING_STATUS_CHANGE,!0)}},U=()=>Array.isArray(s.value)?s.value[0]:s.value,z=e=>{const a=U();console.log("run command",a,e),a?.runCommand(e)},j=()=>{c.value=!1,U()?.runStopCommand(),window.ipcRenderer.send(ye.RUNNING_STATUS_CHANGE,!1)},B=()=>{U()?.exitTerminal()},H=e=>{if(ue.isWindows())return;j();const a=(e=>{let a="";if(e)for(const l in e)a+=`${l}=${e[l]}\n`;return a})(e);U()?.runCommand(a),P()},G=async()=>{if(P(),We.needPreStartApp(d.value?.installName))return ue.isMacOS()?void setTimeout((()=>{Y()}),20):void 0;Y()},Y=()=>{I.value=!0},K=e=>{console.log("onCommandExecuteEnd",e),e&&E(e,"success"),setTimeout((()=>{i.value?.updateAppEnvData()}),400)},J=e=>{e.includes("lmdevent:docker_run_error")&&E(R("AppRunningWindowV2.docker_run_error"),"error",6e3)};return(e,a)=>(h(),p(f,null,[u("div",Xl,[v(Ql,{"lm-app-data":g(o),"is-app-running":g(c),onStopApp:j,onStartApp:P,"installed-instance":g(d)},null,8,["lm-app-data","is-app-running","installed-instance"]),u("div",Zl,[g(d)&&g(o)&&g(I)?(h(),x(Yl,{key:0,ref_key:"appEnvAndAccessComponent",ref:i,onAppEnvSavedAndUpdated:H,isAppRunning:g(c),lmAppData:g(o),installedInstance:g(d)},null,8,["isAppRunning","lmAppData","installedInstance"])):m("",!0)])]),u("footer",{class:b(["footer-terminal","app-run-footer-terminal",g(M)?"expanded":""])},[u("div",et,[v(F,{variant:"text",style:{position:"absolute",right:"10px",top:"5px"},onClick:a[0]||(a[0]=e=>M.value=!g(M))},{append:S((()=>[v(V,{src:g(M)?"./images/icons/expand-white.svg":"./images/icons/collapse-white.svg",width:"18",height:"18"},null,8,["src"])])),default:S((()=>[w(y(g(M)?e.$t("AppRunningWindowV2.Hide"):e.$t("AppRunningWindowV2.ViewLog"))+" ",1)])),_:1})]),u("div",at,[g(N)&&g(L)&&"main-process"===g(L).tabName?(h(),x(ra,{key:0,socketURI:g(N),onExecuteEnd:a[1]||(a[1]=e=>{return a=g(L).commandExecuteEndToastMsg,Y(),console.log("onMainTerminalCommandEnd"),void K(a);var a}),"command-execute-end-keywords":g(L).commandExecuteEndKeywords,ref_key:"generalTerminal",ref:s,events:["lmdprogress","lmdevent:docker_run_error"],onReady:T,onTerminalEvent:J},null,8,["socketURI","command-execute-end-keywords"])):m("",!0)])],2)],64))}}),tt={class:"app-install-result pt-10 pb-6 px-11 mb-12 mx-10"},nt=c({__name:"install-result",props:{lmAppData:{},installedInstance:{}},setup(e){const a=e,l=()=>{a.installedInstance.appInstallPath&&s(a.installedInstance.appInstallPath)};return(e,a)=>(h(),p("div",tt,[v(ie,{class:"gap-2 mb-2"},{default:S((()=>[v(de,{cols:"12",xs:"12",sm:"6",md:"6",lg:"6",class:"item"},{default:S((()=>[w(y(e.$t("AppRunningWindowV2.AppNameLabel"))+": "+y(e.lmAppData.name),1)])),_:1}),v(de,{cols:"12",xs:"12",sm:"6",md:"6",lg:"6",class:"item"},{default:S((()=>[w(y(e.$t("AppRunningWindowV2.AppInstallTimeLabel"))+": "+y(g(je).format(e.installedInstance.createTime,!1)),1)])),_:1}),v(de,{cols:"12",xs:"12",sm:"6",md:"6",lg:"6",class:"item"},{default:S((()=>[w(y(e.$t("AppRunningWindowV2.AppInstallLocationLabel"))+": ",1),u("a",{href:"#",onClick:L(l,["prevent"])},y(e.installedInstance.appInstallPath),1)])),_:1})])),_:1})]))}}),{addToast:ot}=e(),st=d("appInstall",{state:()=>({installPercent:r(0),installSuccessMsg:r(""),installed:r(!1)}),actions:{initModelsData(){this.installPercent=0},updateUI(e){this.installPercent=e,1===e&&(this.installed=!0,this.installSuccessMsg&&ot(this.installSuccessMsg,"success"))},onDownloadError(e){console.error("Failed to download App",e),ot(e.message,"error")}}}),it={class:"progress-area"},dt={style:{width:"210px"}},rt={key:0,style:{width:"250px"},class:"mt-6"},ct={class:"progress-msg mb-8 mt-6"},pt={class:"progress-msg-title"},ut={class:"progress-msg-title"},mt=c({__name:"install-progress",props:{lmAppData:{},instanceData:{}},setup(e){const l=st(),t=e,{t:n}=W(),o=_((()=>"docker"===t.instanceData?.installMethod?n("LMAppDetail.DockerMode"):""));return(e,n)=>(h(),p("div",it,[u("div",dt,[v(V,{src:g(l).installed?"./images/app/succes.svg":"./images/app/processing.svg",width:"210",height:"140"},null,8,["src"])]),g(l).installed?m("",!0):(h(),p("div",rt,[v(P,{width:"100%",class:"download-progress-bar","bg-color":"#F2F2FA","bg-opacity":"1","buffer-color":"#DFDFEC","buffer-opacity":"1",opacity:"1",color:g(a).PRIMARY_COLOR,height:"14",max:100,min:0,"model-value":g(l).installPercent,rounded:""},null,8,["color","model-value"])])),u("div",ct,[g(l).installed?(h(),p(f,{key:1},[u("div",ut,y(e.$t("AppRunningWindowV2.InstallSuccessTitle")),1),u("div",null,[We.appIsOllama(t.lmAppData?.installName)?(h(),p(f,{key:0},[w(y(e.$t("AppRunningWindowV2.InstallSuccessNextTipForOllama")),1)],64)):(h(),p(f,{key:1},[w(y(e.$t("AppRunningWindowV2.InstallSuccessNextTip")),1)],64))])],64)):(h(),p(f,{key:0},[u("div",pt,y(e.lmAppData?.name),1),g(o)?(h(),x(K,{key:0,class:"mt-1 mb-3",density:"default",size:"small",color:"#086dd7"},{default:S((()=>[w(y(g(o)),1)])),_:1})):m("",!0),u("div",null,y(e.$t("AppRunningWindowV2.InstallingMsg"))+" "+y(g(l).installPercent)+"% ",1)],64))])]))}}),vt={class:"app-install-container"},gt={class:"install-steps"},ft={class:"pa-6 install-right-content"},wt={class:"footer-button-bar"},yt=c({__name:"app-install",setup(a){const{t:t}=W(),n=ea(),o=r(""),s=Te(),i=r(null),d=D(),c=r(null),f=r(),I=st(),k=r(!1),{addToast:R}=e();A((async()=>{O();const e=d.params.id,a=await me(e);c.value=a;const l=a.appId;await s.fetchApp(l),i.value=s.currentLmApp,window.ipcRenderer?.on(ye.STOP_AI_RUNNING_INSTANCE,(()=>{$(),P()})),E()}));const E=()=>{const e=i?.value?.name;document.title=`[${t("LMAppDetail.install")}] ${e}`},C=()=>{console.log("onTerminalReady"),T()},M=_((()=>{if(i.value?.id&&c.value?.id)return pa.genWSUrl(i.value.id,c.value.id,ua)})),O=()=>{const e=t("AppRunningWindow.MainProcessTab");n.initTerminal(e)},T=async()=>{var e;if(console.log("installApp"),e=ge.INSTALL,o.value=e,console.log("changeMainTerminalScriptType",e,""),n.changeMainTerminalScriptType(e,""),i.value&&c.value){const e=await(async(e,a)=>{const t=e.installName,n=(await l()).LMD_SCRIPTS_DIR,{repoUrl:o,repoLocalFolderName:s}=aa.getLMDScriptRepoUrl(e),i=oa(o);return console.log("repoLocalFolderName",s),`\nexport LMD_BASE_INSTALL_SCRIPT_DIR="${n}/${s}"\n${i}\nsh "$LMD_BASE_INSTALL_SCRIPT_DIR/apps/${t}/${"docker"===a?.installMethod?"install-d.sh":"install.sh"}"`})(i.value,c.value);N(e)}Me()},N=e=>{const a=L();console.log("run command",a,e),a?.runCommand(e)},L=()=>Array.isArray(f.value)?f.value[0]:f.value,$=()=>{L()?.runStopCommand(),window.ipcRenderer.send(ye.RUNNING_STATUS_CHANGE,!1)},P=()=>{L()?.exitTerminal()},z=e=>{if(e.includes("lmdevent:docker_run_error"))return void R(t("AppRunningWindowV2.docker_run_error"),"error",6e3);const a=ca.extractProgress(e);a&&(I.installPercent=a,100===a&&(I.installed=!0,Oe()))},j=()=>{console.log("installedInstance",c.value?.id),c.value?.id&&he(c.value.id)},B=()=>{c.value&&we.goToRunningPage(c.value.id,ge.START,c.value.installName)};return(e,a)=>{const l=mt,t=nt;return h(),p("div",vt,[u("div",gt,[u("div",ft,[g(i)?(h(),x(l,{key:0,"instance-data":g(c),"lm-app-data":g(i)},null,8,["instance-data","lm-app-data"])):m("",!0),g(c)&&g(i)&&g(I).installed?(h(),x(t,{key:1,lmAppData:g(i),installedInstance:g(c)},null,8,["lmAppData","installedInstance"])):m("",!0),u("div",{class:b(["footer-terminal","app-install-footer-terminal",g(k)?"expanded":""])},[u("div",wt,[v(F,{variant:"text",style:{position:"absolute",right:"10px",top:"5px"},onClick:a[0]||(a[0]=e=>k.value=!g(k))},{append:S((()=>[v(V,{src:g(k)?"./images/icons/expand-white.svg":"./images/icons/collapse-white.svg",width:"18",height:"18"},null,8,["src"])])),default:S((()=>[w(y(g(k)?e.$t("AppRunningWindowV2.Hide"):e.$t("AppRunningWindowV2.ViewLog"))+" ",1)])),_:1})]),g(M)?(h(),x(ra,{key:0,ref_key:"generalTerminal",ref:f,events:["lmdprogress","lmdevent:docker_run_error"],onTerminalEvent:z,onReady:C,socketURI:g(M)},null,8,["socketURI"])):m("",!0)],2)])]),v(U,{style:{"border-top":"1px solid #EBEBF7"},class:"py-6 text-center justify-center"},{default:S((()=>[v(F,{variant:"outlined",onClick:j},{default:S((()=>[w(y(e.$t("Common.close")),1)])),_:1}),We.appIsOllama(i.value?.installName)?(h(),x(F,{key:0,variant:"flat",disabled:!g(I).installed,onClick:B,color:"primary"},{default:S((()=>[w(y(e.$t("AppRunningWindowV2.NextStep")),1)])),_:1},8,["disabled"])):m("",!0)])),_:1})])}}}),ht=c({__name:"AppRunningWindowV2",setup(e){const a=r(""),l=D();return A((()=>{const e=l.query.script;e===ge.INSTALL?a.value="install":e===ge.START||e===ge.DOWNLOAD_MODEL?a.value="run":e===ge.REMOVE&&(a.value="remove")})),(e,l)=>{const t=yt,n=lt,o=ha;return h(),p(f,null,["install"===g(a)?(h(),x(t,{key:0})):m("",!0),"run"===g(a)?(h(),x(n,{key:1})):m("",!0),"remove"===g(a)?(h(),x(o,{key:2})):m("",!0)],64)}}});export{ht as default};
