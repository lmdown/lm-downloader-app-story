import{b as e,T as a,g as t,f as l,d as n,L as o,o as s,h as i}from"./index.js";import{d}from"./pinia.js";import{b as r,f as c,a6 as p,l as u,a8 as m,k as v,u as g,F as f,X as w,O as y,a4 as h,L as A,a0 as I,ac as D,e as _,a3 as x,n as b,a5 as S,x as k,v as R,y as E,a7 as C,G as M,H as O,A as N,ab as T,Z as L,m as $}from"./vue.js";import{b as V,m as P,z as W,q as U,D as F,E as z,A as j,B,o as H,l as G,O as Y,M as K,H as J,d as q,P as Q,Q as X,R as Z,S as ee,e as ae,n as te,C as le,I as ne,J as oe,c as se,w as ie,x as de,a as re,T as ce,p as pe}from"./vuetify.js";import{O as ue,e as me,d as ve,a as ge,I as fe,A as we}from"./OSUtil.js";import{I as ye,d as he,a as Ae,e as Ie,_ as De,g as _e,f as xe,s as be,h as Se,D as ke,j as Re,k as Ee,l as Ce,m as Me,n as Oe}from"./lmd-system.js";import{u as Ne}from"./index2.js";import{r as Te,a as Le,b as $e}from"./xterm.js";import{a as Ve,b as Pe,A as We,M as Ue,O as Fe}from"./AppInfoUtil.js";import{p as ze}from"./pretty-bytes.js";import{D as je}from"./DateTimeUtil.js";import"./debounce.js";import"./vuei18n.js";import"./lmd-locales.js";import"./dayjs.js";const{addToast:Be}=e(),He=d("appRemove",{state:()=>({removePercent:r(0),removeSuccessMsg:r(""),removed:r(!1)}),actions:{initModelsData(){this.removePercent=0},updateUI(e){this.removePercent=e,1===e&&(this.removed=!0,this.removeSuccessMsg&&Be(this.removeSuccessMsg,"success"))}}}),Ge={class:"progress-area"},Ye={style:{width:"210px"}},Ke={key:0,style:{width:"250px"},class:"mt-6"},Je={class:"progress-msg mb-8 mt-6"},qe={class:"progress-msg-title"},Qe={class:"progress-msg-title"},Xe={class:"mt-3",style:{"font-size":"14px"}},Ze=c({__name:"remove-progress",props:{lmAppData:{}},setup(e){const t=He();return(e,l)=>(h(),p("div",Ge,[u("div",Ye,[v(V,{src:g(t).removed?"./images/my-ai/del-tip.svg":"./images/app/processing.svg",width:"210",height:"140"},null,8,["src"])]),g(t).removed?m("",!0):(h(),p("div",Ke,[v(P,{width:"100%",class:"download-progress-bar","bg-color":"#F2F2FA","bg-opacity":"1","buffer-color":"#DFDFEC","buffer-opacity":"1",opacity:"1",color:g(a).PRIMARY_COLOR,height:"14",max:100,min:0,"model-value":g(t).removePercent,rounded:""},null,8,["color","model-value"])])),u("div",Je,[g(t).removed?(h(),p(f,{key:1},[u("div",Qe,y(e.$t("AppRunningWindowV2.DeleteSuccessTitle")),1),u("div",Xe,y(e.$t("AppRunningWindowV2.DeleteSuccessMsg")),1)],64)):(h(),p(f,{key:0},[u("div",qe,y(e.lmAppData?.name),1),w(" "+y(e.$t("AppRunningWindowV2.DeletingMsg"))+" "+y(g(t).removePercent)+"% ",1)],64))])]))}}),ea=d("runningInstance",{state:()=>({runningInstances:[],appSettingsSaved:!1,terminals:[],currentTerminalTab:""}),actions:{addRunningInstance(e){this.runningInstances.find((a=>a.id===e.id))||this.runningInstances.push(e)},removeRunningInstance(e){const a=this.runningInstances.findIndex((a=>a.id===e.id));-1!=a&&this.runningInstances.splice(a,1)},resetAppSettingsSavedStatus(){this.appSettingsSaved=!1},onAppSettingsSaved(){this.appSettingsSaved=!0},changeMainTerminalScriptType(e,a){try{const t=this.terminals[0];t.commandExecuteEndKeywords=[`lmd ${e} script end.`],t.commandExecuteEndToastMsg=a}catch(t){console.error(t)}},initTerminal(e){const a={icon:"mdi-application-brackets-outline",text:e,tabName:"main-process",closable:!1};this.terminals=[a],this.currentTerminalTab=a.tabName},addTerminal(e){this.terminals.find((a=>a.tabName===e.tabName))||(console.log("addTerminal",e.commandExecuteEndKeywords),this.terminals.push(e)),this.currentTerminalTab=e.tabName},removeTerminal(e,a){this.currentTerminalTab="main-process",this.terminals.splice(a,1)},addInstallModelTerminal(e,a,t,l){const n={text:a,tabName:a,initCommand:t,closable:!0,commandExecuteEndKeywords:["digest","writing manifest","success"],commandExecuteEndToastMsg:l};this.addTerminal(n)},addDeleteModelTerminal(e,a,t,l){const n={text:a,tabName:a,initCommand:t,closable:!0,commandExecuteEndKeywords:[`deleted '${e}'`],commandExecuteEndToastMsg:l};this.addTerminal(n)}}});class aa{static getLMDScriptRepoUrl(e){let a="https://gitee.com/lmdown/lmd-install-scripts";if(e?.downloadInfo&&e?.downloadInfo.length>0){a=e.downloadInfo[0].scriptGitRepoUrl}return{repoUrl:a,repoLocalFolderName:this.getLastPathSegment(a)||"lmd-install-scripts"}}static getLastPathSegment(e){const a=e.match(/[^\/?#]+(?=[/?#]*$)/);return a?a[0]:null}}const ta="browser";class la{static async isPortInUse(e){const a=`http://127.0.0.1:${e}`;try{const t=await fetch(a,{method:"get",mode:"no-cors",cache:"no-store"});return console.log(`${e} in use`,t.status),t.ok}catch(t){return console.log(`can not access port ${e}`,t),!1}}static async findAvailablePort(e,a){let t=e;for(let n=1;n<=a;n++)try{if(!(await this.isPortInUse(t)))return t;t++}catch(l){console.error(`check port ${t} err`,l),t++}return console.error("no Available port, use default value"),e}}class na{static async genSetPortCommand(e){if(e?.accessInfo.accessType===ta&&this.needCheckPort(e)&&e.accessInfo.webUrl){e.accessInfo.detectAvailablePortDone=!1;const{url:a,port:t}=await na.checkPortInUrl(e.accessInfo.webUrl);if(e.accessInfo.detectAvailablePortDone=!0,t)return e.accessInfo.webUrl=a,`export SERVER_PORT=${t}\nexport GRADIO_SERVER_PORT=${t}`}return""}static needCheckPort(e){return["spark-tts","index-tts","f5-tts","framepack","liveportrait","ace-step","cosyvoice","latentsync","notagen"].includes(e.installName)||e?.accessInfo?.detectAvailablePort}static async checkPortInUrl(e){try{const a=new URL(e),t=parseInt(a.port,10);if(isNaN(t))throw new Error("does not contain a valid port");const l=await la.findAvailablePort(t,20);return a.port=l.toString(),{url:a.toString(),port:l}}catch(a){return console.log("Invalid URL",a),{url:e}}}}const oa=e=>"0"===l("UPDATE_INSTALL_SCRIPTS")?"":`\ngit clone --depth=1 ${e} "$LMD_BASE_INSTALL_SCRIPT_DIR"\ncd "$LMD_BASE_INSTALL_SCRIPT_DIR" && git fetch origin master && git reset --hard origin/master`;var sa=Te(),ia=Le(),da=$e();const ra=c({__name:"index",props:{socketURI:{},initCommand:{},commandExecuteEndKeywords:{},events:{}},emits:["executeEnd","terminalEvent","ready"],setup(e,{expose:a,emit:t}){const l=t,o=r([]),s=r(!1),i=e,d=r(null),c=r(null),m=r(null),v=r(null);let g;A((()=>{D(),y()})),I((()=>{d.value?.close(),c.value?.dispose(),g&&v.value&&(g.unobserve(v.value),g.disconnect())}));const f=e=>{console.log("runCommand",e),console.log("runCommand socket.value",d.value),d.value?.send(e+"\n")};a({runCommand:f,runStopCommand:()=>{f(""),f("")},exitTerminal:()=>{f("exit")}});const w=n((e=>{for(const a of e){let e=a.contentRect.height;ue.isMacOS()&&(e-=10),E(a.contentRect.width,e)}}),9),y=()=>{m.value&&(g=new ResizeObserver(w),g.observe(m.value))},D=()=>{d.value=new WebSocket(i.socketURI),b(),x(),S(),_()},_=()=>{d.value&&(d.value.onmessage=e=>{const a=e.data,t=i.events;console.log("event data ",e.data),console.log("props.events ",i.events),t&&t.length>0&&t.forEach((e=>{a.includes(e)&&(console.log("emit terminalEvent",a),l("terminalEvent",a))}));const n=i.commandExecuteEndKeywords;n&&(n.forEach((e=>{a.includes(e)&&!o.value.includes(e)&&o.value.push(e)})),o.value.length===n.length&&(l("executeEnd"),s.value=!0,o.value=[]))})},x=()=>{d.value&&(d.value.onopen=()=>{(()=>{if(!v.value)return;if(!d.value)return;const e=new window.Terminal({fontSize:14,cursorBlink:!0}),a=new ia.AttachAddon(d.value),t=new sa.FitAddon,l=new da.WebLinksAddon(((e,a)=>{const t=document.createElement("a");t.setAttribute("href",a),t.setAttribute("target","_blank"),t.setAttribute("id","lmdTempLink");const l=document.getElementById("lmdTempLink");l&&document.body.removeChild(l),document.body.appendChild(t),t.click()}));e.loadAddon(a),e.loadAddon(t),e.loadAddon(l),e.open(v.value),t.fit(),c.value=e})(),i.initCommand&&f(i.initCommand),l("ready")})},b=()=>{d.value&&(d.value.onclose=e=>{console.log("close socket",e)})},S=()=>{d.value&&(d.value.onerror=e=>{console.log("socket err",e)})},k=r(80),R=r(30),E=(e,a)=>{const t=Math.floor(e/8.5),l=Math.round(a/16);if(console.log("cols",e,t),console.log("rows",a,l),0!==l&&0!==t&&(k.value!==t||R.value!==l)){k.value=t,R.value=l,c.value?.resize(t,l);const e=`lmd_action:resize:${t},${l}`;d.value?.send(e)}};return(e,a)=>(h(),p("div",{ref_key:"terminalOutContainer",ref:m,class:"mb-0",style:{height:"100%",width:"100%"}},[u("div",{ref_key:"terminalContainer",ref:v,class:"terminal",style:{height:"300px",width:"100%"}},null,512)],512))}});class ca{static extractProgress(e){let a=null;try{const t=/lmdprogress:(\d+)/g;let l;for(;null!==(l=t.exec(e));)a=parseInt(l[1],10)}catch(t){console.error("parse err",t)}return a}}class pa{static genWSUrl(e,a,t){return`ws://localhost:19312/?appId=${e}&installedInstanceId=${a}&runningLogType=${t}`}}const ua="install",ma="run",va="delete",ga={class:"app-install-container"},fa={class:"install-steps"},wa={class:"pa-6 install-right-content"},ya={class:"footer-button-bar"},ha=c({__name:"app-remove",setup(a){const{t:l}=W(),n=ea(),o=r(""),s=Ne(),i=r(null),d=D(),c=r(null),f=r(),I=He(),k=r(!1),{addToast:R}=e();A((async()=>{M();const e=d.params.id;let a;try{a=await me(e)}catch(o){return console.log(o),void R(l("AppRunningWindowV2.DeleteNotFound"),"error")}c.value=a;const t=a.appId;await s.fetchApp(t),i.value=s.currentLmApp,window.ipcRenderer?.on(ye.STOP_AI_RUNNING_INSTANCE,(()=>{L(),$()}));const n=i?.value.name;document.title=`[${l("LocalApps.Delete")}] ${n}`}));const E=_((()=>{if(i.value?.id&&c.value?.id)return pa.genWSUrl(i.value?.id,c.value?.id,va)})),C=()=>{console.log("onTerminalReady"),O()},M=()=>{const e=l("AppRunningWindow.MainProcessTab");n.initTerminal(e)},O=async()=>{var e;if(e=ge.REMOVE,o.value=e,console.log("changeMainTerminalScriptType",e,""),n.changeMainTerminalScriptType(e,""),i.value&&c.value){const e=await(async(e,a)=>{const l=e.installName,n=(await t()).LMD_SCRIPTS_DIR,{repoUrl:o,repoLocalFolderName:s}=aa.getLMDScriptRepoUrl(e),i=oa(o);console.log("repoLocalFolderName",s);const d="docker"===a?.installMethod?"remove-d.sh":"remove.sh";let r="";return a.instancesCountOfApp>1&&(r="keepmodels"),`\nexport LMD_BASE_INSTALL_SCRIPT_DIR="${n}/${s}"\n${i}\nsh "$LMD_BASE_INSTALL_SCRIPT_DIR/apps/${l}/${d}" ${r}`})(i.value,c.value);N(e)}},N=e=>{const a=T();console.log("run command",a,e),a?.runCommand(e)},T=()=>Array.isArray(f.value)?f.value[0]:f.value,L=()=>{T()?.runStopCommand(),window.ipcRenderer.send(ye.RUNNING_STATUS_CHANGE,!1)},$=()=>{T()?.exitTerminal()},P=e=>{const a=ca.extractProgress(e);a&&(I.removePercent=a,100===a&&(I.removed=!0,c.value?.id&&ve(c.value?.id)))},z=()=>{c.value?.id&&he(c.value.id)};return(e,a)=>{const t=Ze;return h(),p("div",ga,[u("div",fa,[u("div",wa,[g(i)?(h(),x(t,{key:0,"lm-app-data":g(i)},null,8,["lm-app-data"])):m("",!0),u("div",{class:b(["footer-terminal","app-install-footer-terminal",g(k)?"expanded":""])},[u("div",ya,[v(U,{variant:"text",style:{position:"absolute",right:"10px",top:"5px"},onClick:a[0]||(a[0]=e=>k.value=!g(k))},{append:S((()=>[v(V,{src:g(k)?"./images/icons/expand-white.svg":"./images/icons/collapse-white.svg",width:"18",height:"18"},null,8,["src"])])),default:S((()=>[w(y(g(k)?e.$t("AppRunningWindowV2.Hide"):e.$t("AppRunningWindowV2.ViewLog"))+" ",1)])),_:1})]),g(E)?(h(),x(ra,{key:0,ref_key:"generalTerminal",ref:f,events:["lmdprogress"],onTerminalEvent:P,onReady:C,socketURI:g(E)},null,8,["socketURI"])):m("",!0)],2)])]),v(F,{style:{"border-top":"1px solid #EBEBF7"},class:"py-6 text-center justify-center"},{default:S((()=>[v(U,{variant:"outlined",onClick:z},{default:S((()=>[w(y(e.$t("Common.close")),1)])),_:1})])),_:1})])}}}),Aa={key:0,style:{width:"84px"},class:"d-flex flex-column justify-center items-center"},Ia={class:"progress-text"},Da=c({__name:"comfyui-progress-bar",props:{downloadInfo:{}},setup:e=>(e,t)=>e.downloadInfo?(h(),p("div",Aa,[v(P,{width:"100%",class:"download-progress-bar","bg-color":"#D8D8D8","bg-opacity":"1","buffer-color":"#DFDFEC","buffer-opacity":"1",opacity:"1",color:g(a).PRIMARY_COLOR,height:"3",max:1,min:0,"model-value":e.downloadInfo.percent||0,rounded:""},null,8,["color","model-value"]),u("div",Ia,[w(y(e.$t("AppRunningWindowV2.Downloading"))+" ",1),e.downloadInfo.percent?(h(),p(f,{key:0},[w(y(Math.floor(100*e.downloadInfo.percent))+"% ",1)],64)):m("",!0)])])):m("",!0)});class _a{static DOWNLOADING=1;static DOWNLOADED=2;static NOT_DOWNLOADED=3}const xa=async()=>{const e=`https://lmdstatic.oss-cn-shanghai.aliyuncs.com/pkgs/models/data/comfyui/cats.json?v=${function(){const e=(new Date).getTime(),a=6e5,t=Math.floor(e/a)*a;return Math.floor(t/1e4)}()}`;return(await axios.get(e)).data},ba=async(e,a)=>{const t=[];a.forEach((e=>{const a=Object.assign({},e);a.downloadInfo=void 0,t.push(a)}));return(await Ae.post("/self-manage/model-files/check-files",{modelPath:e,files:t})).data.files};class Sa{modelFileInfo;abortController=null;constructor(e){this.modelFileInfo=e}async startDownloadModelFile(e,a){this.abortController||(this.abortController=new AbortController);const t=this.modelFileInfo.value,l="ComfyUI",n={modelRepoId:this.modelFileInfo.modelRepoId,filePathInRepo:t,modelPath:`${l}/models/${this.modelFileInfo.subDir}`,appInstallPath:l};await(async(e,a,t,l)=>{const n=t.signal,o=await fetch(`${Ie}/self-manage/model-files/download`,{method:"POST",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(e),signal:n,keepalive:!0});if(!o.ok)throw new Error(`HTTP error: ${o.status}`);if(!o.body)throw new Error("No response body");const s=o.body.getReader(),i=new TextDecoder("utf-8");let d="";try{for(;;){const{done:e,value:t}=await s.read();if(e)break;d+=i.decode(t);const n=d.split("\n");d=n.pop()||"";for(const o of n)if(o.trim())try{const e=JSON.parse(o);if(console.log("line -- : ",o),e.progress){const t=e.progress;0!==t&&l(a,t)}}catch(r){console.error("Parse error:",r)}}}catch(r){if("AbortError"!==r.name)throw r;console.log("Stream aborted")}})(n,e,this.abortController,a)}cancel(){try{this.abortController?.abort(),this.abortController=null}catch(e){console.log("cancel",e)}}}const{addToast:ka}=e(),Ra=d("comfyui-model-info",{state:()=>({modelFileInfoMap:r(new Map)}),actions:{initModelsData(){},async checkDownloadingModels(e){e&&e.length>0&&e.forEach((e=>{const a=this.getModelInfoKey(e),t=this.modelFileInfoMap.get(a);t&&(e.downloadInfo=t.downloadInfo)}))},updateUI(e,a){const t=e.downloadInfo;t&&(t.percent=a||0,1===a?(t.status=_a.DOWNLOADED,this.clearModelInfo(e)):t.status=_a.DOWNLOADING)},onDownloadError(e){const a=e.message;ka(a,"error")},async startDownload(e){const a=this.getModelInfoKey(e);if(this.modelFileInfoMap.set(a,e),e.downloadInfo||(e.downloadInfo={}),!e.downloadInfo.downloader){const a=new Sa(e);e.downloadInfo.downloader=a}e.downloadInfo.downloader.startDownloadModelFile(e,this.updateUI),this.updateUI(e,.01)},async cancelDownload(e){try{e.downloadInfo&&(e.downloadInfo.downloader?.cancel(),e.downloadInfo.status=_a.NOT_DOWNLOADED),this.clearModelInfo(e)}catch(a){console.log("cancel err",a)}},clearModelInfo(e){const a=this.getModelInfoKey(e);this.modelFileInfoMap.delete(a)},getModelInfoKey:e=>e.subDir+"/"+e.value}}),Ea={class:"d-flex flex-row",style:{width:"150px"}},Ca=c({__name:"comfyui-model-download-progress",props:{modelFileInfo:{}},setup(e){const t=e,{t:l}=W(),n=Ra(),o={[_a.DOWNLOADING]:l("AppRunningWindowV2.Downloading"),[_a.DOWNLOADED]:l("AppRunningWindowV2.Downloaded"),[_a.NOT_DOWNLOADED]:l("AppRunningWindowV2.NotDownloaded")},s={[_a.DOWNLOADING]:"rgba(0, 0, 0, 0.75)",[_a.DOWNLOADED]:"#0ABB1F",[_a.NOT_DOWNLOADED]:"rgba(0, 0, 0, 0.25)"},i=_((()=>{const e=t.modelFileInfo.downloadInfo?.status||_a.NOT_DOWNLOADED;return o[e]})),d=_((()=>{const e=t.modelFileInfo.downloadInfo?.status||_a.NOT_DOWNLOADED;return s[e]})),r=_((()=>{const e=t.modelFileInfo.downloadInfo?.status;return e===_a.DOWNLOADING})),c=()=>{n.cancelDownload(t.modelFileInfo)};return(e,t)=>{const l=Da;return h(),p("div",Ea,[g(r)?(h(),x(l,{key:0,"download-info":e.modelFileInfo.downloadInfo},null,8,["download-info"])):(h(),p("div",{key:1,style:k(`color: ${g(d)}; font-size: 12px;`)},y(g(i)),5)),g(r)?(h(),x(U,{key:2,variant:"text",style:{flex:"1"},onClick:c,color:g(a).PRIMARY_COLOR},{default:S((()=>[w(y(e.$t("AppRunningWindowV2.Cancel")),1)])),_:1},8,["color"])):(h(),x(z,{key:3}))])}}}),Ma={key:0},Oa=["title"],Na=c({__name:"model-choose-dialog",props:{allModelFiles:{},modelValue:{type:Boolean}},emits:["update:modelValue","hide","cancel"],setup(e,{emit:t}){const l=e,n=r(l.modelValue),o=r(!1),s=Ra(),i=r([]),d=r(null);_((()=>s.modelFileInfoMap.size>0));const c=t;R((()=>l.modelValue),(e=>{n.value=e,e&&m()}));const m=async()=>{o.value=!0;l.allModelFiles&&(d.value=await ba("ComfyUI/models/",l.allModelFiles)),A(),o.value=!1,I()},A=()=>{d.value?.forEach((e=>{const a=l.allModelFiles?.find((a=>e.value===a.value));a&&(a.downloadInfo||(a.downloadInfo={}),a.downloadInfo.status=_a.DOWNLOADED)}))},I=()=>{const e=l.allModelFiles?.filter((e=>e.downloadInfo?.status===_a.DOWNLOADED));e&&(i.value=e)};R(n,(e=>{c("update:modelValue",e)}));const D=()=>{n.value=!1,c("cancel")},k=()=>{M.value.forEach((e=>{e.downloadInfo||(e.downloadInfo={},e.downloadInfo.status=_a.NOT_DOWNLOADED),e.downloadInfo.status===_a.NOT_DOWNLOADED&&s.startDownload(e)}))},M=_((()=>{const e=[];return i.value&&i.value.length>0&&i.value.forEach((a=>{a.downloadInfo?a.downloadInfo.status===_a.NOT_DOWNLOADED&&e.push(a):e.push(a)})),e})),O=e=>{const a=e.downloadInfo?.status||_a.NOT_DOWNLOADED;return a===_a.DOWNLOADING||a===_a.DOWNLOADED},N=e=>O(e)?"#D6D6D6":a.PRIMARY_COLOR;return(e,t)=>{const l=Ca;return h(),x(j,{modelValue:g(n),"onUpdate:modelValue":t[1]||(t[1]=e=>E(n)?n.value=e:null),"max-width":"720","min-width":"400"},{default:S((()=>[v(B,{class:"px-2 py-4"},{default:S((()=>[v(H,{class:"choose-models-dialog-title"},{default:S((()=>[w(y(e.$t("AppRunningWindowV2.ChooseModelFiles")),1)])),_:1}),v(G,{class:"d-flex flex-column px-4 py-5 choose-model-file-list"},{default:S((()=>[g(o)?(h(),p("div",Ma,[v(P,{color:g(a).PRIMARY_COLOR,indeterminate:""},null,8,["color"])])):(h(!0),p(f,{key:1},C(e.allModelFiles,(e=>(h(),p("div",{key:e.value,class:"d-flex",style:{"align-items":"center"}},[v(Y,{density:"compact",class:b(["file-item"]),modelValue:g(i),"onUpdate:modelValue":t[0]||(t[0]=e=>E(i)?i.value=e:null),color:N(e),value:e,"hide-details":"",readonly:O(e)},{label:S((()=>[u("div",{class:"checkbox-label",title:e.title||e.value},y(e.title||e.value),9,Oa)])),_:2},1032,["modelValue","color","value","readonly"]),v(z,{style:{width:"16px",flex:"unset"}}),v(K,{size:"small",density:"compact",style:{"background-color":"rgba(250, 100, 0, 0.08)"},variant:"outlined",color:g(a).PRIMARY_COLOR},{default:S((()=>[w(y(e.size),1)])),_:2},1032,["color"]),v(z),v(l,{modelFileInfo:e},null,8,["modelFileInfo"])])))),128))])),_:1}),v(F,{class:"confirm-actions"},{default:S((()=>[v(z),v(U,{variant:"outlined",onClick:D},{default:S((()=>[w(y(e.$t("AppRunningWindowV2.Close")),1)])),_:1}),v(U,{variant:"flat",color:"primary",onClick:k,disabled:0===g(M).length},{default:S((()=>[w(y(e.$t("AppRunningWindowV2.Download")),1)])),_:1},8,["disabled"]),v(z)])),_:1})])),_:1})])),_:1},8,["modelValue"])}}}),Ta={class:"file-grid-container"},La=["title"],$a=c({__name:"model-file-list-view",props:{data:{},modelValue:{},showCheckbox:{type:Boolean}},emits:["update:modelValue"],setup(e,{emit:t}){const l=e,n=r([]),o=t;return R((()=>l.modelValue),(e=>{n.value=e})),R((()=>n.value),(e=>{o("update:modelValue",e)})),(e,t)=>(h(),p("div",Ta,[(h(!0),p(f,null,C(e.data,(l=>(h(),p("div",{key:l.value,class:"d-flex flex-row",style:{"align-items":"center",width:"100%"}},[e.showCheckbox?(h(),x(Y,{key:0,density:"compact",class:"file-item",modelValue:g(n),"onUpdate:modelValue":t[0]||(t[0]=e=>E(n)?n.value=e:null),color:g(a).PRIMARY_COLOR,label:l.title||l.value,value:l,"hide-details":"",style:{}},null,8,["modelValue","color","label","value"])):(h(),p("div",{key:1,class:"file-item file-item-label",title:l.title||l.value},y(l.title||l.value),9,La)),v(K,{size:"small",class:"mr-2",density:"compact",style:{"background-color":"rgba(250, 100, 0, 0.08)"},variant:"outlined",color:g(a).PRIMARY_COLOR},{default:S((()=>[w(y(l.size),1)])),_:2},1032,["color"])])))),128))]))}}),Va={key:0,class:"model-desc-and-download"},Pa={class:"desc-title"},Wa={key:0,class:"desc-imgs"},Ua={class:"desc-title mt-5"},Fa={key:1},za={class:"model-file-list"},ja={key:0,class:"mx-8 my-8"},Ba={key:1,style:{"text-align":"center","justify-items":"center"}},Ha={class:"mt-4 pb-0",style:{color:"rgba(0, 0, 0, 0.45)"}},Ga=c({__name:"model-desc-and-download",props:{selectedItem:{}},setup(e){const t=e,l=Ra(),n=r(null),o=r(null),s=r(null),i=r(null),d=r(!1),c=r(!1),I=r(!1);A((()=>{}));const D=async()=>{if(t.selectedItem){I.value=!0,n.value=await(async e=>{const a=`https://lmdstatic.oss-cn-shanghai.aliyuncs.com/pkgs/models/data/comfyui/${e.path}`;return(await axios.get(a)).data})(t.selectedItem);const e="ComfyUI/models/";n.value?.files&&(o.value=n.value?.files,s.value=await ba(e,n.value?.files),b(),l.checkDownloadingModels(n.value?.files)),I.value=!1}},b=()=>{s.value?.forEach((e=>{const a=o.value?.find((a=>e.value===a.value));a&&(a.downloadInfo||(a.downloadInfo={}),a.downloadInfo.status=_a.DOWNLOADED)}))};R((()=>t.selectedItem),(e=>{e&&D()})),R((()=>c.value),(e=>{e||(D(),O())}));const k=()=>{c.value=!0},M=()=>{d.value=!0},O=()=>{d.value=!1},N=async()=>{i.value&&i.value?.length>0&&(await(async(e,a)=>(await Ae.delete("/self-manage/model-files/files",{data:{modelPath:e,files:a}})).data.files)("ComfyUI/models/",i.value),D(),O())},T=()=>{O()},L=_((()=>{for(const[e,a]of l.modelFileInfoMap){const e=t.selectedItem?.value;if(a.modelPackage===e)return!0}return!1}));return(e,t)=>{const l=$a,r=Na;return h(),p(f,null,[e.selectedItem?(h(),p("div",Va,[u("div",Pa,y(e.selectedItem?.title||e.selectedItem?.value),1),g(n)?(h(),p("div",Wa,[(h(!0),p(f,null,C(g(n).snapshots,(e=>(h(),x(V,{key:e.url,rounded:"lg",cover:"","max-width":"180","max-height":"180",width:"180",height:"180",src:e.url},null,8,["src"])))),128))])):m("",!0),u("div",Ua,[w(y(e.$t("AppRunningWindowV2.MyModelFiles"))+" ",1),v(z),v(U,{variant:"flat",onClick:k,color:g(a).PRIMARY_COLOR,rounded:"xl",size:"small",style:{"font-size":"14px"}},{default:S((()=>[w(y(e.$t("AppRunningWindowV2.ChooseModelFiles"))+" ",1),g(L)?(h(),x(J,{key:0,indeterminate:"",size:"16","model-value":"80",width:"3",style:{"margin-left":"4px"}})):g(o)&&g(o).length>0?(h(),p("div",Fa," ("+y(g(o)?.length)+") ",1)):m("",!0)])),_:1},8,["color"]),t[2]||(t[2]=w("    ")),g(d)?(h(),x(U,{key:1,variant:"outlined",onClick:N,color:"red",rounded:"xl",size:"small"},{default:S((()=>[w(y(e.$t("AppRunningWindowV2.ConfirmDelete")),1)])),_:1})):(h(),x(U,{key:0,variant:"outlined",onClick:M,color:"red",rounded:"xl",size:"small"},{default:S((()=>[w(y(e.$t("AppRunningWindowV2.Delete")),1)])),_:1})),t[3]||(t[3]=w("    ")),g(d)?(h(),x(U,{key:2,variant:"outlined",onClick:T,rounded:"xl",size:"small"},{default:S((()=>[w(y(e.$t("AppRunningWindowV2.Cancel")),1)])),_:1})):m("",!0)]),u("div",za,[g(I)?(h(),p("div",ja,[v(P,{color:g(a).PRIMARY_COLOR,indeterminate:""},null,8,["color"])])):(h(),p(f,{key:1},[g(s)&&g(s).length>0?(h(),x(l,{key:0,"show-checkbox":g(d),data:g(s),modelValue:g(i),"onUpdate:modelValue":t[0]||(t[0]=e=>E(i)?i.value=e:null)},null,8,["show-checkbox","data","modelValue"])):(h(),p("div",Ba,[v(V,{"max-width":"147","max-height":"120",width:"147",height:"120",src:"./images/app/no-data.svg"}),u("div",Ha,y(e.$t("AppRunningWindowV2.NoModelFiles")),1)]))],64))])])):m("",!0),v(r,{"all-model-files":g(o),"downloaded-model-files":g(s),modelValue:g(c),"onUpdate:modelValue":t[1]||(t[1]=e=>E(c)?c.value=e:null)},null,8,["all-model-files","downloaded-model-files","modelValue"])],64)}}}),Ya={key:0,class:"menu"},Ka=["onClick"],Ja={class:"arrow"},qa={class:"submenu"},Qa=["onClick"],Xa={key:0,class:"small-tag"},Za=De(c({__name:"MenuComponent",props:{menuData:{},modelValue:{}},emits:["update:modelValue"],setup(e,{emit:a}){const t=e,l=_({get:()=>t.modelValue,set:e=>n("update:modelValue",e)}),n=a;return(e,a)=>e.menuData?(h(),p("div",Ya,[(h(!0),p(f,null,C(e.menuData,(e=>(h(),p("div",{key:e.value,class:"menu-item"},[u("div",{class:b(["menu-title",{active:e.isOpen}]),onClick:a=>(e=>{e.children&&(e.isOpen=!e.isOpen)})(e)},[w(y(e.title)+" ",1),u("span",Ja,[e.isOpen?(h(),x(q,{key:0,size:"18",icon:"mdi-menu-up"})):(h(),x(q,{key:1,size:"18",icon:"mdi-menu-down"}))])],10,Ka),v(N,{name:"slide"},{default:S((()=>[M(u("div",qa,[(h(!0),p(f,null,C(e.children,(e=>(h(),p("div",{key:e.value,class:b(["submenu-item",{active:e===g(l)}]),onClick:a=>(e=>{l.value=e,n("update:modelValue",e)})(e)},[w(y(e.title)+" ",1),e.format?(h(),p("span",Xa,y(e.format),1)):m("",!0)],10,Qa)))),128))],512),[[O,e.isOpen]])])),_:2},1024)])))),128))])):m("",!0)}}),[["__scopeId","data-v-10bc5dbe"]]),et=c({__name:"model-categories",props:{modelValue:{}},emits:["update:modelValue"],setup(e,{emit:a}){const t=e,l=a,n=_({get:()=>t.modelValue,set:e=>l("update:modelValue",e)});A((()=>{s()}));const s=async()=>{const e=await xa();e.forEach((e=>{o.localeIsEn()?e.comment=e.comment_en||"":e.comment=e.comment_zhHans||""})),d.value=e,console.log("allModelCats::",d.value);const a=i();if(a){const{menuData:e,firstMenuItem:t}=a;e&&t&&(e.isOpen=!0,n.value=t)}},i=()=>{for(const e of d.value)if(e?.children&&e?.children.length>0){const a=e?.children[0];return{menuData:e,firstMenuItem:a}}},d=r([]);return(e,a)=>{const t=Za;return h(),x(t,{"menu-data":g(d),modelValue:g(n),"onUpdate:modelValue":a[0]||(a[0]=e=>E(n)?n.value=e:null)},null,8,["menu-data","modelValue"])}}}),at={style:{flex:"1","min-height":"300px","max-height":"490px",display:"flex","flex-direction":"row"}},tt=c({__name:"model-tree-comfyui",setup(e){const a=r(null);return(e,t)=>{const l=et,n=Ga;return h(),p("div",at,[v(l,{modelValue:g(a),"onUpdate:modelValue":t[0]||(t[0]=e=>E(a)?a.value=e:null)},null,8,["modelValue"]),v(n,{"selected-item":g(a)},null,8,["selected-item"])])}}});class lt{static async getAppSettings(){const e=await this.getOSEnvObj();return{modelsDir:e.OLLAMA_MODELS,externalAccessHost:e.OLLAMA_HOST,externalAccessPath:e.OLLAMA_ACCESS_PATH_LMD}}static async getOSEnvObj(){return await _e(Pe.DISPLAY_ENV)}static async getAccessHosts(e){const a="11434",t=[`http://127.0.0.1:${a}`];if(e&&"127.0.0.1"!==e){const l=e.split(":"),n=l[0];let o=[n];const s=l[1]||a;"0.0.0.0"===n&&(o=await xe()),o&&o.length>0&&o.forEach((e=>{t.push(`http://${e}:${s}`)}))}else;return t}static async saveAppSettings(e,a){e.modelsDir===a&&(e.modelsDir="");const t={OLLAMA_MODELS:e.modelsDir,OLLAMA_HOST:e.externalAccessHost,OLLAMA_ACCESS_PATH_LMD:e.externalAccessPath};return await be(t)}static getDownloadableModels(){return JSON.parse(JSON.stringify(Ve))}}const nt={style:{"font-size":"14px","line-height":"16px"}},ot=c({__name:"lmd-expansion-panel",props:{title:{default:""},showExpandIcon:{type:Boolean,default:!1},defaultExpanded:{type:Boolean,default:!1}},setup:e=>(A((()=>{})),(e,a)=>(h(),x(Q,{dense:""},{default:S((()=>[v(X,{class:"d-flex"},{actions:S((({expanded:a})=>[e.showExpandIcon?(h(),p(f,{key:0},[u("span",nt,y(a?e.$t("AppRunningWindowV2.Collapse"):e.$t("AppRunningWindowV2.Expand")),1),v(V,{src:a?"./images/icons/collapse.svg":"./images/icons/expand.svg",width:"16",height:"16"},null,8,["src"])],64)):m("",!0)])),default:S((()=>[w(y(e.title)+" ",1),v(z),T(e.$slots,"append")])),_:3}),v(Z,{style:{padding:"0"}},{default:S((()=>[T(e.$slots,"default")])),_:3})])),_:3})))}),st={style:{"font-size":"12px"}},it={style:{"font-size":"12px"}},dt=c({__name:"ollama-settings-btn",props:{installedInstance:{}},setup(a){const{t:t}=W(),l=r(!1),n=r(!1),o=r(!1),i=r(!1),d=r(""),c=ea(),{addToast:I}=e(),D=r({}),b=r(!0),k=a;R((()=>k.installedInstance),(()=>{C()}));const C=()=>{J()?l.value=!0:l.value=!1};A((()=>{C()}));const M=async()=>{n.value=!0,await O(),await K()};R((()=>n),(()=>{console.log("dialogVisible change: ",n)}));const O=async()=>{const e=await Re();d.value=e+"/.ollama/models"},N=async()=>{if(!o.value)return;if(!D)return;if(""===d.value){const e=t("AppSettingDialog.DataNotValid");return void I(e,"error")}i.value=!0;const e=Object.assign({},D.value),a=await lt.saveAppSettings(e,d.value);console.log("save result ",a);const l=t("Common.saveSuccess");I(l,"success"),i.value=!1,c.onAppSettingsSaved(),setTimeout((()=>{c.resetAppSettingsSavedStatus()}),100),n.value=!1,console.log("hideDialog",n.value),We.killAppProcessed(k.installedInstance?.installName),setTimeout((()=>{Ee()}),1500)},T=async()=>{const e=await Se(D.value.modelsDir,!0);e&&e.path&&(D.value.modelsDir=e.path,console.log("dirInfo",e),b.value=ke.checkModelsDirValid(e,["blobs"]),console.log("dirValid.value",b.value))},V=()=>{s(D.value.modelsDir)},P=[e=>!!e||t("Common.fieldRequired"),()=>b.value||t("AppSettingDialog.ModelsDirNotValid")],z=/^(\d{1,3}\.){3}\d{1,3}(:\d{1,5})?$/,H=[e=>""===e||(z.test(e)||t("AppSettingDialog.HostNotValid"))],G=async()=>{D.value.modelsDir=d.value},Y=_((()=>{if(J())return t("AppSettingDialog.OllamaModelsDirInfoIconTip")})),K=async()=>{if(J()){const e=await lt.getAppSettings();console.log("getOSEnvForCurrentApp",e),D.value=Object.assign({},e),""===e.modelsDir&&(console.log("getOSEnvForCurrentApp",e),D.value.modelsDir=d.value)}},J=()=>We.appIsOllama(k.installedInstance?.installName);return(e,a)=>(h(),p(f,null,[v(U,{class:"settings-small-btn",variant:"outlined",density:"compact",rounded:"",onClick:L(M,["stop"])},{default:S((()=>[w(y(e.$t("AppRunningWindow.Settings")),1)])),_:1}),v(j,{modelValue:g(n),"onUpdate:modelValue":a[5]||(a[5]=e=>E(n)?n.value=e:null),"min-width":"400","max-width":"840"},{default:S((()=>[e.installedInstance?(h(),x(B,{key:0,class:"mx-auto px-0 py-0 window-no-drag",width:"100%",title:e.$t("AppSettingDialog.Title")+e.installedInstance.name},{append:S((()=>[v(U,{icon:"mdi-close",class:"ms-auto",size:"compact",text:"Ok",elevation:"0",onClick:a[0]||(a[0]=e=>n.value=!1)})])),default:S((()=>[g(D)?(h(),x(ee,{key:0,class:"pt-0 pb-3 px-6",modelValue:g(o),"onUpdate:modelValue":a[4]||(a[4]=e=>E(o)?o.value=e:null),onSubmit:L(N,["prevent"])},{default:S((()=>[v(ae,{modelValue:g(D).modelsDir,"onUpdate:modelValue":a[1]||(a[1]=e=>g(D).modelsDir=e),density:"comfortable",readonly:g(i),rules:P,label:e.$t("AppSettingDialog.ModelsDirLabel")},{append:S((()=>[v(te,{location:"bottom"},{activator:S((({props:e})=>[v(q,$(e,{icon:"mdi-information-slab-circle-outline"}),null,16)])),default:S((()=>[u("pre",null,y(g(Y)),1)])),_:1}),v(U,{class:"ml-1",onClick:T,variant:"outlined"},{default:S((()=>[w(y(e.$t("AppSettingDialog.Browse")),1)])),_:1}),v(U,{class:"ml-1",onClick:V,variant:"outlined"},{default:S((()=>[w(y(e.$t("AppSettingDialog.Open")),1)])),_:1}),v(U,{class:"ml-1",onClick:G,variant:"outlined"},{default:S((()=>[w(y(e.$t("AppSettingDialog.UseDefaultValue")),1)])),_:1})])),_:1},8,["modelValue","readonly","label"]),v(le,{class:"pt-0"},{default:S((()=>[u("pre",st,y(t("AppSettingDialog.ModelsDirTip")),1)])),_:1}),v(ae,{modelValue:g(D).externalAccessHost,"onUpdate:modelValue":a[2]||(a[2]=e=>g(D).externalAccessHost=e),density:"comfortable",readonly:g(i),rules:H,label:e.$t("AppSettingDialog.ServerHostLabel")},null,8,["modelValue","readonly","label"]),v(le,{class:"pt-0"},{default:S((()=>[u("pre",it,y(t("AppSettingDialog.ServerHostTip")),1)])),_:1}),v(F,{class:"text-center justify-center"},{default:S((()=>[v(U,{variant:"outlined",onClick:a[3]||(a[3]=e=>n.value=!1)},{default:S((()=>[w(y(e.$t("AppSettingDialog.close")),1)])),_:1}),v(U,{color:"primary",variant:"flat",type:"submit",loading:g(i)},{default:S((()=>[w(y(e.$t("AppSettingDialog.saveConfig")),1)])),_:1},8,["loading"])])),_:1})])),_:1},8,["modelValue"])):m("",!0)])),_:1},8,["title"])):m("",!0)])),_:1},8,["modelValue"])],64))}}),rt={key:0},ct={class:"model-storage-title d-flex flex-row align-baseline"},pt={class:""},ut={class:"justify-center mr-6"},mt={class:"d-flex"},vt={style:{flex:"1"}},gt={class:"d-flex"},ft={class:"d-flex flex-row mt-1",style:{"font-size":"14px"}},wt={style:{flex:"1"}},yt=c({__name:"model-storage",props:{installedInstance:{},appEnv:{}},setup(e){const a=e,t=r(""),l=r(""),n=r(""),o=r(0),i=r(null);A((async()=>{We.appIsOllama(a.installedInstance?.installName)&&await f(),I()}));const d=r(null),{t:c}=W(),f=async()=>{const e=await Re();l.value=e+"/.ollama/models"},I=async()=>{const e=await We.getModelsDirV2(a.installedInstance,a.appEnv);t.value=e||l.value;const n=await We.getModelFileSize(a.installedInstance?.installName,t.value);d.value=ze(n.dirSize||0),i.value=n,D()},D=()=>{if(!i.value)return;let e=0;try{e=i.value?.totalSpace-i.value.dirSize-i.value.freeSpace,o.value=i.value?.totalSpace-i.value.freeSpace}catch(s){console.error("calculate error",s)}const a=ze(e),t=ze(i.value.freeSpace),l=`${c("AppRunningWindow.StorageModelsSize")}: ${d.value},\n  ${c("AppRunningWindow.StorageDiskOther")}: ${a},\n  ${c("AppRunningWindow.StorageDiskFreeSpace")}: ${t}\n  `;n.value=l};R((()=>a.appEnv),(e=>{I()})),R((()=>a.installedInstance),(e=>{I()}));const _=async()=>{s(t.value)};return(e,a)=>g(d)?(h(),p("div",rt,[u("div",ct,[u("div",pt,y(e.$t("AppRunningWindow.ModelStorageLabel")),1),v(z),u("div",ut,[v(dt,{installedInstance:e.installedInstance},null,8,["installedInstance"])])]),v(G,{class:"mt-3 pb-3 px-5"},{default:S((()=>[u("div",mt,[u("div",null,[v(V,{src:"./images/icons/harddisk.svg",class:"mr-1",width:"72",height:"34"})]),u("div",vt,[u("div",gt,[v(te,{text:g(n),location:"top"},{activator:S((({props:e})=>[v(P,$({class:"custom-progress-bar"},e,{location:null,"bg-color":"#FFFFFF","bg-opacity":"1","buffer-color":"#DFDFEC","buffer-opacity":"1",opacity:"1",color:"#FEF1E5",height:"14",max:g(i)?.totalSpace||10,min:"0","buffer-value":g(o),"model-value":g(i)?.dirSize,rounded:""}),null,16,["max","buffer-value","model-value"])])),_:1},8,["text"])]),u("div",ft,[u("div",wt,y(g(i)?.diskName),1),u("a",{href:"#",style:{"text-decoration":"none",color:"rgba(0, 0, 0, 0.75)"},onClick:L(_,["prevent"])},[w(y(g(d))+" > ",1),g(t)?(h(),x(te,{key:0,activator:"parent",location:"top"},{default:S((()=>[w(y(g(t)),1)])),_:1})):m("",!0)])])])])])),_:1})])):m("",!0)}}),ht="http://localhost:11434";class At{constructor(e,a){if(this.paramSize=e,this.updateUI=a,!e.nameAndSize)throw new Error("nameAndSize is empty");this.nameAndSize=e.nameAndSize}totalPercentageWithoutCurrent=.01;totalPercentage=.01;pullingMainPart="";pullingCurrentPart="";nameAndSize="";async download(e){const a=e.signal,t=await fetch(`${ht}/api/pull`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:this.nameAndSize,stream:!0}),signal:a});if(!t.ok)throw new Error(`HTTP error: ${t.status}`);if(!t.body)throw new Error("No response body");const l=t.body.getReader(),n=new TextDecoder;let o="";for(;;){const{done:e,value:a}=await l.read();if(e)break;o+=n.decode(a);const t=o.split("\n");o=t.pop()||"";for(const l of t)if(l.trim())try{const e=JSON.parse(l);this.processProgress(e)}catch(s){console.error("Parse error:",s)}}}calculatePercentage(e,a,t){let l=this.totalPercentageWithoutCurrent;if(e&&e.completed&&e.total){l+=e.completed/e.total*a,l>.99&&(l=.99),l>=this.totalPercentage&&(this.totalPercentage=l)}t&&this.totalPercentage>=this.totalPercentageWithoutCurrent&&(this.totalPercentageWithoutCurrent=this.totalPercentage)}processProgress(e){const a=e?.status||"";let t=.02;if("pulling manifest"===a)t=.01;else if(a.startsWith("downloading")||a.startsWith("pulling")){void 0!==e.total&&void 0!==e.completed&&(!this.pullingMainPart&&e.total>5242880&&(this.pullingMainPart=a),this.pullingMainPart===a&&(t=.89));let l=!1;this.pullingCurrentPart!==a&&(this.pullingCurrentPart=a,l=!0),this.calculatePercentage(e,t,l)}else"success"===a&&(this.totalPercentage=1);this.updateUI&&this.updateUI(this.paramSize,this.totalPercentage)}}const{addToast:It}=e(),Dt=d("modelDownloadInfo",{state:()=>({models:r([]),parameterSizes:r([]),downloadSuccessMsg:r(""),cancelDownloadMsg:r(""),fetchAbortControllers:r(new Map)}),actions:{initModelsData(){this.models=[],this.parameterSizes=[]},updateUI(e,a){const t=e.downloadProgress;t&&(t.percent=a,1===a&&(e.installed=!0,this.downloadSuccessMsg&&It(this.downloadSuccessMsg,"success")))},onDownloadError(e){console.error("Failed to download model",e);let a=e.message;"BodyStreamBuffer was aborted"===a&&(a=this.cancelDownloadMsg),It(a,"error")},async startDownload(e,a){a.nameAndSize=e,a.downloadProgress={nameAndSize:e,percent:0},this.updateUI(a,.01);const t=await(async(e,a,t)=>{const l=new AbortController;return new At(e,a).download(l).catch((e=>{t&&(console.error("download err",e),t(e))})),l})(a,this.updateUI,this.onDownloadError);this.fetchAbortControllers.set(a.nameAndSize,t)},async cancelDownload(e,a){const t=Ue.genModelNameAndSize(e,a);try{const e=this.fetchAbortControllers.get(t);e?.abort()}catch(l){console.log("cancel err",l)}try{await(async e=>{const a=await fetch(`${ht}/api/pull`,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e})});if(!a.ok)throw new Error(`HTTP error: ${a.status}`);if(!a.body)throw new Error("No response body");const t=await a.json();t.error?console.error("cancel error",t.error):console.log("cancel done",t)})(t)}catch(l){console.error(l)}finally{a.installed=!1,a.downloadProgress&&(a.downloadProgress.percent=void 0)}},async deleteModel(e,a){const t=Ue.genModelNameAndSize(e,a);try{await(async e=>{const a=await fetch(`${ht}/api/delete`,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e})});if(!a.ok)throw new Error(`HTTP error: ${a.status}`);if(!a.body)throw new Error("No response body");const t=await a.json();t.error?console.error("del error",t.error):console.log("del done",t)})(t)}catch(l){console.error(l)}finally{a.installed=!1,a.downloadProgress&&(a.downloadProgress.percent=void 0)}}}}),_t=c({__name:"model-download-row-comfyui",props:{lmAppData:{},installedInstance:{},appEnv:{}},setup(e){const a=Dt(),t=r(!1),l=r(null),{t:n}=W(),o=e;A((async()=>{s(),a.downloadSuccessMsg=n("AppRunningWindow.ModelDownloadSuccessful"),a.cancelDownloadMsg=n("AppRunningWindowV2.DownloadCanceled"),await d()})),R((()=>o.lmAppData),(()=>{s()})),R((()=>o.installedInstance),(()=>{d()})),R((()=>o.appEnv),(()=>{d()}));const s=()=>{t.value=We.checkModelDownloadBtnVisibility(o.lmAppData?.installName)};R(l,(()=>{i()}));const i=()=>{const e=l.value,t=a.models.find((a=>a.installName===e)),n=t?.tags||[];a.parameterSizes=n},d=async()=>{const e=o.installedInstance?.installName;if(e&&t.value){a.initModelsData();const t=lt.getDownloadableModels(),n=await We.mergeModelsList(e,t);if(a.models=n,l.value)i();else{const e=a.models;if(e&&e.length>0){const a=e[0];l.value=a.installName}}}};return(e,a)=>{const l=tt;return e.lmAppData&&g(t)?(h(),x(ot,{key:0,class:"model-download-panel",showExpandIcon:!0,value:"model-download",title:e.$t("AppRunningWindow.ModelDownload")},{default:S((()=>[v(G,{class:"model-download-sheet d-flex flex-row"},{default:S((()=>[v(l,{"lm-app-data":e.lmAppData},null,8,["lm-app-data"])])),_:1}),v(G,{style:{"border-top":"1px solid #EBEBF7"}},{default:S((()=>[e.installedInstance?(h(),x(yt,{key:0,appEnv:e.appEnv,installedInstance:e.installedInstance},null,8,["appEnv","installedInstance"])):m("",!0)])),_:1})])),_:1},8,["title"])):m("",!0)}}}),xt=c({__name:"copy-link-icon",props:{text:{}},setup(e){const a=e,t=r(!1),l=()=>{t.value=!0,navigator.clipboard.writeText(a.text),setTimeout((()=>{t.value=!1}),1500)};return(e,a)=>(h(),x(V,{width:"16",height:"16",onClick:l,src:"./images/icons/link-copy.svg",style:{cursor:"pointer"}},{default:S((()=>[v(te,{activator:"parent","open-on-hover":!1,location:"bottom",transition:"false",modelValue:g(t),"onUpdate:modelValue":a[0]||(a[0]=e=>E(t)?t.value=e:null)},{default:S((()=>[w(y(e.$t("App.Copied")),1)])),_:1},8,["modelValue"])])),_:1}))}});class bt{static async getAppEnvData(e){const a=await(async e=>(await Ae.get(`/self-manage/ai-app-env/${e}`)).data)(e);return a}static async getAccessHosts(e,a){const t=this.parsePort(e),l=[`http://127.0.0.1:${t}`];if("1"===a.allowExternalAccess){const e=await xe();e&&e.length>0&&e.forEach((e=>{l.push(`http://${e}:${t}`)}))}return l}static parsePort(e){return e.split(":")[2]||"8188"}static async saveAppEnvData(e,a){return await(async(e,a)=>(await Ae.post(`/self-manage/ai-app-env/${e}`,{envObj:a})).data)(e,a)}}const St=c({__name:"app-settings-btn",props:{installedInstance:{}},setup(t){const{t:l}=W(),n=r(!1),o=r(!1),s=r(!1),i=ea(),{addToast:d}=e(),c=r({}),I=r([{label:l("AppSettingDialog.LocalAccessOnly"),value:"0"},{label:l("AppSettingDialog.AllowLANAccess"),value:"1"}]),D=t;R((()=>D.installedInstance),(()=>{})),A((()=>{}));const _=async()=>{n.value=!0,await k()};R((()=>n),(()=>{console.log("dialogVisible change: ",n)}));const b=async()=>{if(!o.value)return;if(!c)return;if(!D.installedInstance?.appId)return;s.value=!0;const e=Object.assign({},c.value),a=await bt.saveAppEnvData(D.installedInstance?.appId,e);console.log("save result ",a);const t=l("Common.saveSuccess");d(t,"success"),s.value=!1,i.onAppSettingsSaved(),n.value=!1,console.log("hideDialog",n.value),setTimeout((()=>{location.reload()}),1e3)},k=async()=>{if(We.appIsComfyUI(D.installedInstance?.installName)){const e=await bt.getAppEnvData(D.installedInstance.appId);console.log("envForCurrentApp",e),c.value=Object.assign({allowExternalAccess:"0"},e)}};return(e,t)=>(h(),p(f,null,[v(U,{class:"settings-small-btn",variant:"outlined",density:"compact",rounded:"",onClick:L(_,["stop"])},{default:S((()=>[w(y(e.$t("AppRunningWindow.Settings")),1)])),_:1}),v(j,{modelValue:g(n),"onUpdate:modelValue":t[4]||(t[4]=e=>E(n)?n.value=e:null),"min-width":"400","max-width":"640"},{default:S((()=>[e.installedInstance?(h(),x(B,{key:0,class:"mx-auto px-0 py-0 window-no-drag",width:"100%",title:e.$t("AppSettingDialog.Title")+e.installedInstance.name},{append:S((()=>[v(U,{icon:"mdi-close",class:"ms-auto",size:"compact",text:"Ok",elevation:"0",onClick:t[0]||(t[0]=e=>n.value=!1)})])),default:S((()=>[g(c)?(h(),x(ee,{key:0,class:"pt-0 pb-3 px-6",modelValue:g(o),"onUpdate:modelValue":t[3]||(t[3]=e=>E(o)?o.value=e:null),onSubmit:L(b,["prevent"])},{default:S((()=>[v(H,{class:"px-0"},{default:S((()=>[w(y(e.$t("AppSettingDialog.AppLanAccessLabel")),1)])),_:1}),v(ne,{modelValue:g(c).allowExternalAccess,"onUpdate:modelValue":t[1]||(t[1]=e=>g(c).allowExternalAccess=e),"hide-details":""},{default:S((()=>[(h(!0),p(f,null,C(g(I),(e=>(h(),x(oe,{key:e.value,value:e.value,color:g(a).PRIMARY_COLOR},{label:S((()=>[w(y(e.label),1)])),_:2},1032,["value","color"])))),128))])),_:1},8,["modelValue"]),v(le,{class:"pt-0"},{default:S((()=>[u("pre",null,y(e.$t("AppSettingDialog.AppLanAccessTip")),1)])),_:1}),v(F,{class:"text-center justify-center"},{default:S((()=>[v(U,{variant:"outlined",onClick:t[2]||(t[2]=e=>n.value=!1)},{default:S((()=>[w(y(e.$t("AppSettingDialog.close")),1)])),_:1}),v(U,{color:"primary",variant:"flat",type:"submit",loading:g(s)},{default:S((()=>[w(y(e.$t("AppSettingDialog.saveConfig")),1)])),_:1},8,["loading"])])),_:1})])),_:1},8,["modelValue"])):m("",!0)])),_:1},8,["title"])):m("",!0)])),_:1},8,["modelValue"])],64))}});function kt(){let e=!1;return{callApiWithRetry:async function(a,t={},l=100,n=1e3){return async function o(s){if(e)throw console.log("API call cancelled by user"),new Error("API call cancelled by user");try{console.log(`Attempt ${s}: Calling API...`);return await axios(a,t)}catch(d){if(s<l&&!e)return console.error(`Attempt ${s} failed. Retrying in ${n}ms...`),await(i=n,new Promise((e=>setTimeout(e,i)))),o(s+1);{const a=e?"API call cancelled by user":"Failed to call API after maximum attempts";throw console.error(a),new Error(a)}}var i}(1)},cancel:function(){e=!0}}}class Rt{static openBrowser(e){const a=document.createElement("a");a.href=e,a.target="_blank",document.body.appendChild(a),a.click(),document.body.removeChild(a)}}const Et=["href"],Ct={style:{color:"#999999"},class:"mx-0 mt-4 mb-0"},Mt=c({__name:"app-access-row-v2",props:{lmAppData:{},installedInstance:{},appEnv:{},isAppRunning:{type:Boolean}},setup(e){const t=e,l=r([]),n=r(!1),o=r(!1),s=r(null),i=r(void 0),d=async()=>{if(t.lmAppData?.accessInfo){const e=t.lmAppData.accessInfo,{accessType:a}=e;if(!a)return!1;if("browser"===a){const e=t.lmAppData.accessInfo?.webUrl;if(We.appIsComfyUI(t.lmAppData.installName)&&e){const a=await bt.getAppEnvData(t.lmAppData.id);l.value=await bt.getAccessHosts(e,a),c()}else l.value.push(e||"");return!0}if("exec"===a&&We.appIsOllama(t.installedInstance?.installName)){if(t.appEnv){const e=t.appEnv[Fe];l.value=await lt.getAccessHosts(e)}return!0}}return!1};A((async()=>{n.value=await d(),o.value=We.displayAccessSettingBtn(t.installedInstance?.installName)})),R((()=>t.appEnv),(async()=>{l.value=[],n.value=await d()})),R((()=>t.isAppRunning),(async()=>{s.value?.cancel()})),R((()=>t.lmAppData?.accessInfo.webUrl),(async()=>{l.value=[],n.value=await d()})),R((()=>t.lmAppData?.accessInfo.detectAvailablePortDone),(async e=>{e&&setTimeout((()=>{We.appIsComfyUI(t.lmAppData?.installName)||c()}),100)}));const c=async()=>{if(i.value)return;const e=t.installedInstance?.installMethod,a=t.lmAppData?.accessInfo,n=l.value?.length;let o;o=e===fe.DOCKER?a?.dockerOpenBrowserByLMD&&n>0:a?.openBrowserByLMD&&n>0;const d=a?.showDetectStatus;if(o||d){i.value=!0;const e=l.value[0],{apiCaller:a,promise:t}=(e=>{const a=kt(),t=a.callApiWithRetry(e,{headers:{"Cache-Control":"no-cache",Pragma:"no-cache",Expires:"0"}},2e3,2e3);return{apiCaller:a,promise:t}})(e);s.value=a,t.then((()=>{i.value=!1,o&&Rt.openBrowser(e)})).catch((e=>{console.error(e),a?.cancel()}))}};return(e,n)=>{const o=St,s=dt,d=xt;return g(l)&&g(l).length>0?(h(),x(ot,{key:0,title:e.$t("AppRunningWindow.Access"),readonly:"",value:"app-access",showExpandIcon:!1,"default-expanded":!0},{append:S((()=>[We.appIsComfyUI(t.lmAppData?.installName)?(h(),x(o,{key:0,installedInstance:e.installedInstance},null,8,["installedInstance"])):m("",!0),We.appIsOllama(t.lmAppData?.installName)?(h(),x(s,{key:1,installedInstance:e.installedInstance},null,8,["installedInstance"])):m("",!0)])),default:S((()=>[v(se,{class:"pt-1 pb-2",style:{margin:"0 -24px -16px"}},{default:S((()=>[v(ie,{"no-gutters":"",style:{padding:"0px"}},{default:S((()=>[(h(!0),p(f,null,C(g(l),((t,l)=>(h(),x(de,{key:l,class:"px-5 py-2",cols:"12",sm:"6"},{default:S((()=>[v(re,{style:{background:"#FFF4EA","border-radius":"4px",height:"40px"},density:"compact","min-height":"1.1rem",class:"px-5"},{prepend:S((()=>[v(d,{text:t},null,8,["text"])])),default:S((()=>[(h(),p("a",{class:"mx-2 app-access-link",key:t,href:t,target:"_blank"},y(t),9,Et)),e.isAppRunning&&g(i)?(h(),x(K,{key:0,size:"small",color:g(a).PRIMARY_COLOR},{default:S((()=>[w(y(e.$t("AppRunningWindow.Starting")),1)])),_:1},8,["color"])):m("",!0)])),_:2},1024)])),_:2},1024)))),128))])),_:1})])),_:1}),u("div",Ct,y(e.$t("AppRunningWindowV2.AccessNote")),1)])),_:1},8,["title"])):m("",!0)}}}),Ot=c({__name:"app-env-row-v2",props:{installedInstance:{},appEnv:{}},setup(e){const a=r(null);A((async()=>{a.value=await i()}));const t=e=>"HF_MIRROR"===e?"HF_ENDPOINT":e;return(e,l)=>(h(),x(ot,{title:e.$t("AppRunningWindow.EnvVars"),showExpandIcon:!0,value:"app-env"},{default:S((()=>[v(G,{class:"my-1 pt-2 pb-0 mx-0"},{default:S((()=>[(h(!0),p(f,null,C(g(a),((e,a)=>(h(),x(K,{variant:"tonal",size:"small",style:{"min-width":"50px","max-width":"190px","margin-left":"4px"},key:a},{default:S((()=>[w(y(t(a))+" ",1),v(te,{activator:"parent",location:"bottom"},{default:S((()=>[w(y(e),1)])),_:2},1024)])),_:2},1024)))),128)),(h(!0),p(f,null,C(e.appEnv,((e,a)=>(h(),x(K,{variant:"tonal",color:"orange-darken-4",size:"small",style:{"min-width":"50px","max-width":"220px","margin-left":"4px"},key:a},{default:S((()=>[w(y(a)+" ",1),v(te,{activator:"parent",location:"bottom"},{default:S((()=>[w(y(e),1)])),_:2},1024)])),_:2},1024)))),128))])),_:1})])),_:1},8,["title"]))}}),Nt={key:0,style:{width:"84px"},class:"d-flex flex-column justify-center items-center"},Tt={class:"progress-text"},Lt=c({__name:"download-progress",props:{downloadInfo:{}},setup:e=>(e,t)=>e.downloadInfo?(h(),p("div",Nt,[v(P,{width:"100%",class:"download-progress-bar","bg-color":"#D8D8D8","bg-opacity":"1","buffer-color":"#DFDFEC","buffer-opacity":"1",opacity:"1",color:g(a).PRIMARY_COLOR,height:"3",max:1,min:0,"model-value":e.downloadInfo.percent,rounded:""},null,8,["color","model-value"]),u("div",Tt,[w(y(e.$t("AppRunningWindowV2.Downloading"))+" ",1),e.downloadInfo.percent?(h(),p(f,{key:0},[w(y(Math.floor(100*e.downloadInfo.percent))+"% ",1)],64)):m("",!0)])])):m("",!0)}),$t=De(c({__name:"delete-confirm-dialog",props:{modelValue:{type:Boolean},itemName:{}},emits:["update:modelValue","confirm"],setup(e,{emit:a}){const t=e,l=a,n=r(!1);R((()=>n.value),(e=>{l("update:modelValue",e)})),R((()=>t.modelValue),(e=>{n.value=e}));const o=()=>{n.value=!1},s=async()=>{l("confirm"),o()};return(e,a)=>(h(),x(j,{modelValue:g(n),"onUpdate:modelValue":a[0]||(a[0]=e=>E(n)?n.value=e:null),"max-width":"400"},{default:S((()=>[v(B,null,{default:S((()=>[v(H,{class:"headline"},{default:S((()=>[w(y(e.$t("AppRunningWindow.ConfirmDelete")),1)])),_:1}),v(le,null,{default:S((()=>[w(y(e.$t("AppRunningWindow.ConfirmDeleteMsg"))+" ",1),a[1]||(a[1]=u("br",null,null,-1)),w(" "+y(e.itemName),1)])),_:1}),v(F,{class:"justify-center mb-2"},{default:S((()=>[v(U,{variant:"outlined",onClick:o},{default:S((()=>[w(y(e.$t("AppRunningWindow.Cancel")),1)])),_:1}),v(U,{variant:"flat",color:"#F2313F",onClick:s},{default:S((()=>[w(y(e.$t("AppRunningWindow.ModelDeleteBtnLabel")),1)])),_:1})])),_:1})])),_:1})])),_:1},8,["modelValue"]))}}),[["__scopeId","data-v-2e8b336e"]]),Vt={key:0,class:"text-center py-10",style:{flex:"1"}},Pt={class:"d-flex flex-row justify-center"},Wt={style:{"min-width":"46px",display:"inline-block"}},Ut={style:{"min-width":"60px",display:"inline-block"}},Ft={key:0,class:"installed-chip"},zt={key:1,class:"not-installed-chip"},jt=c({__name:"model-download-row-v2",props:{lmAppData:{},installedInstance:{},appEnv:{}},setup(e){const a=Dt(),t=r(!1),l=r(null),n=r(null),o=r(!1),s=r(""),{t:i}=W(),d=e;A((async()=>{c(),a.downloadSuccessMsg=i("AppRunningWindow.ModelDownloadSuccessful"),a.cancelDownloadMsg=i("AppRunningWindowV2.DownloadCanceled"),await D()})),R((()=>d.lmAppData),(()=>{c()})),R((()=>d.installedInstance),(()=>{D()})),R((()=>d.appEnv),(()=>{D()}));const c=()=>{t.value=We.appIsOllama(d.lmAppData?.installName)};R(l,(()=>{I()}));const I=()=>{const e=l.value,t=a.models.find((a=>a.installName===e)),n=t?.tags||[];a.parameterSizes=n},D=async()=>{const e=d.installedInstance?.installName;if(e&&t.value){a.initModelsData();const t=lt.getDownloadableModels(),n=await We.mergeModelsList(e,t);if(a.models=n,l.value)I();else{const e=a.models;if(e&&e.length>0){const a=e[0];l.value=a.installName}}}},_=async()=>{l.value&&n.value&&a.deleteModel(l.value,n.value)},b=e=>{const a=e.downloadProgress;return!!(a?.percent&&a.percent<1)},k=e=>{const a=e.tags;if(a&&a.length>0)for(let t=0;t<a.length;t++){if(a[t].installed)return!0}};return(e,i)=>{const d=Lt;return h(),p(f,null,[e.lmAppData&&g(t)?(h(),x(ot,{key:0,class:"model-download-panel",showExpandIcon:!0,value:"model-download",title:e.$t("AppRunningWindow.ModelDownload")},{default:S((()=>[v(G,{class:"model-download-sheet d-flex flex-row"},{default:S((()=>[g(a).models&&0!==g(a).models.length?m("",!0):(h(),p("div",Vt,[v(J,{color:"primary",indeterminate:"",size:"40"})])),g(a).models&&g(a).models.length>0?(h(),x(se,{key:1,style:{"border-right":"1px solid #EBEBF7",flex:"1",padding:"0"},"max-height":"340"},{default:S((()=>[(h(!0),p(f,null,C(g(a).models,((e,a)=>(h(),x(re,{key:e.installName+a,density:"compact","active-class":"selected-model-item",onClick:a=>{var t;(t=e.installName)!==l.value&&(l.value=t)},active:g(l)===e.installName,title:e.displayName,value:e.installName},{append:S((()=>[k(e)?(h(),x(q,{key:0,class:"downloaded-icon",icon:"mdi-check-bold",size:"18"})):m("",!0)])),_:2},1032,["onClick","active","title","value"])))),128))])),_:1})):m("",!0),g(a).models&&g(a).models.length>0?(h(),x(se,{key:2,style:{flex:"1",padding:"0"}},{default:S((()=>[(h(!0),p(f,null,C(g(a).parameterSizes,((t,i)=>(h(),x(re,{key:t.parameterSize+i,density:"compact",active:!1,value:t.parameterSize},{default:S((()=>[u("div",Pt,[u("span",Wt,y(t.parameterSize),1),u("span",Ut,[v(K,{density:"compact",class:"mx-1 file-size-chip"},{default:S((()=>[w(y(t.fileSize),1)])),_:2},1024)]),v(z,{style:{flex:"1"}}),t.installed?(h(),p("div",Ft,y(e.$t("AppRunningWindow.ModelDownloaded")),1)):(h(),p(f,{key:1},[b(t)?(h(),x(d,{key:0,"download-info":t.downloadProgress},null,8,["download-info"])):(h(),p("div",zt,y(e.$t("AppRunningWindow.ModelNotDownloaded")),1))],64)),v(z,{style:{flex:"1"}}),t.installed?(h(),x(U,{key:2,onClick:e=>(e=>{if(!l.value)return;const a=Ue.genModelNameAndSize(l.value,e);n.value=e,o.value=!0,s.value=a})(t),variant:"text",density:"compact",color:"#F2313F"},{default:S((()=>[w(y(e.$t("AppRunningWindow.ModelDeleteBtnLabel")),1)])),_:2},1032,["onClick"])):(h(),p(f,{key:3},[b(t)?(h(),x(U,{key:0,onClick:e=>(async e=>{l.value&&a.cancelDownload(l.value,e)})(t),variant:"text",density:"compact"},{default:S((()=>[w(y(e.$t("AppRunningWindow.Cancel")),1)])),_:2},1032,["onClick"])):(h(),x(U,{key:1,onClick:e=>(async e=>{if(!l.value)return;const t=Ue.genModelNameAndSize(l.value,e);a.startDownload(t,e)})(t),variant:"text",class:"model-download-btn",density:"compact"},{default:S((()=>[w(y(e.$t("AppRunningWindow.ModelDownloadBtnLabel")),1)])),_:2},1032,["onClick"]))],64))])])),_:2},1032,["value"])))),128))])),_:1})):m("",!0)])),_:1}),v(G,{style:{"border-top":"1px solid #EBEBF7"}},{default:S((()=>[e.installedInstance?(h(),x(yt,{key:0,appEnv:e.appEnv,installedInstance:e.installedInstance},null,8,["appEnv","installedInstance"])):m("",!0)])),_:1})])),_:1},8,["title"])):m("",!0),v($t,{"model-value":g(o),"onUpdate:modelValue":i[0]||(i[0]=e=>o.value=e),"item-name":g(s),onConfirm:_},null,8,["model-value","item-name"])],64)}}}),Bt=c({__name:"app-env-and-access-v2",props:{installedInstance:{},lmAppData:{},isAppRunning:{type:Boolean}},emits:["appEnvSavedAndUpdated"],setup(e,{expose:a,emit:t}){const l=e,n=ea(),o=r({}),s=r(["app-access"]),i=r(void 0),d=t;A((async()=>{u(),p()}));const c=D(),p=()=>{const e=c.query.script,a=l.lmAppData?.installName;(We.appIsComfyUI(a)||We.appIsOllama(a)&&e===ge.DOWNLOAD_MODEL)&&(s.value=["app-access","model-download"])},u=async()=>{const e=l.installedInstance?.installName;We.appIsOllama(e)?(o.value=await lt.getOSEnvObj()||{},f()):We.appIsComfyUI(e)&&(o.value=await lt.getOSEnvObj()||{})};a({updateAppEnvData:u}),R((()=>l.installedInstance),(()=>{u()})),R((()=>n.appSettingsSaved),(async e=>{e&&(o.value=null,await u(),d("appEnvSavedAndUpdated",o.value))}));const f=async()=>{const e=o.value;e.OLLAMA_MODELS&&(i.value=await Ce(e.OLLAMA_MODELS))};return(e,a)=>{const t=Mt,l=_t;return g(o)&&e.installedInstance?(h(),x(ce,{key:0,multiple:"",elevation:"0",modelValue:g(s),"onUpdate:modelValue":a[0]||(a[0]=e=>E(s)?s.value=e:null),class:"lmd-running-panels"},{default:S((()=>[v(t,{appEnv:g(o),isAppRunning:e.isAppRunning,lmAppData:e.lmAppData,installedInstance:e.installedInstance},null,8,["appEnv","isAppRunning","lmAppData","installedInstance"]),!1===g(i)?(h(),x(le,{key:0,class:"pt-0 mt-0 px-2",style:{color:"red","justify-items":"center","align-items":"center"}},{default:S((()=>[v(q,{style:{opacity:"1"},icon:"mdi-information-slab-circle-outline"}),w(" "+y(e.$t("AppRunningWindowV2.ModelDirNotFound")),1)])),_:1})):m("",!0),g(We).appIsComfyUI(e.installedInstance.installName)?(h(),x(l,{key:1,appEnv:g(o),installedInstance:e.installedInstance,lmAppData:e.lmAppData},null,8,["appEnv","installedInstance","lmAppData"])):g(We).appIsOllama(e.installedInstance.installName)?(h(),x(jt,{key:2,appEnv:g(o),installedInstance:e.installedInstance,lmAppData:e.lmAppData},null,8,["appEnv","installedInstance","lmAppData"])):m("",!0),v(Ot,{appEnv:g(o),installedInstance:e.installedInstance},null,8,["appEnv","installedInstance"])])),_:1},8,["modelValue"])):m("",!0)}}}),Ht={class:"d-flex flex-column text-center justify-center align-middle"},Gt={style:{width:"60px",margin:"0 auto"},class:"mt-10"},Yt={class:"d-flex flex-column justify-center"},Kt=c({__name:"app-info-left",props:{lmAppData:{},installedInstance:{},isAppRunning:{type:Boolean}},emits:["startApp","stopApp"],setup(e,{emit:a}){const t=e,l=a,{t:n}=W(),o=_((()=>t.installedInstance?.installMethod===fe.DOCKER?n("LMAppDetail.DockerMode"):""));return(e,a)=>(h(),x(G,{class:"left-app-basic-info"},{default:S((()=>[u("div",Ht,[u("div",Gt,[v(V,{src:e.lmAppData?.icon,rounded:"",width:"60",height:"60"},null,8,["src"])]),u("div",Yt,[v(H,{class:"pt-1 pb-0"},{default:S((()=>[w(y(e.lmAppData?.name),1)])),_:1}),e.installedInstance?.version&&"--"!==e.installedInstance?.version?(h(),x(pe,{key:0,class:"py-0"},{default:S((()=>[w(y(e.$t("AppRunningWindow.Version"))+" "+y(e.installedInstance?.version),1)])),_:1})):m("",!0),v(le,null,{default:S((()=>[g(o)?(h(),x(K,{key:0,density:"default",variant:"flat",size:"small",color:"#086dd7"},{default:S((()=>[w(y(g(o)),1)])),_:1})):m("",!0),v(z,{class:"mt-6"}),e.isAppRunning?(h(),x(U,{key:1,variant:"flat",color:"#F2313F",class:"mx-2",width:"80",height:"40",onClick:a[0]||(a[0]=e=>{l("stopApp")})},{default:S((()=>[w(y(e.$t("AppRunningWindow.Stop")),1)])),_:1})):(h(),x(U,{key:2,color:"primary",variant:"flat",class:"mx-2",width:"80",height:"40",onClick:a[1]||(a[1]=e=>{l("startApp")})},{default:S((()=>[w(y(e.$t("AppRunningWindow.Start")),1)])),_:1}))])),_:1})])])])),_:1}))}}),Jt={style:{flex:"1"}},qt={class:"pa-6 run-right-content"},Qt={class:"footer-button-bar"},Xt={class:"footer-terminal-content"},Zt=c({__name:"app-run",setup(a){const l=D(),n=Ne(),o=r(null),s=r(),i=r(),d=r(null),c=r(!1),I=r(!1),k=r(""),{t:R}=W(),{addToast:E}=e(),C=ea(),M=r(!1);A((async()=>{$();const e=l.params.id,a=await me(e);d.value=a;const t=a.appId;await n.fetchApp(t),o.value=n.currentLmApp,window.ipcRenderer?.on(ye.STOP_AI_RUNNING_INSTANCE,(()=>{j(),B()})),O()}));const O=()=>{const e=o?.value?.name;document.title=`[${R("LMAppDetail.RunApp")}] ${e}`},N=()=>{console.log("onTerminalReady"),G()},T=_((()=>{if(o.value?.id&&d.value?.id)return pa.genWSUrl(o.value?.id,d.value?.id,ma)})),L=_((()=>{if(C.terminals&&C.terminals.length>0)return C.terminals[0]})),$=()=>{const e=R("AppRunningWindow.MainProcessTab");C.initTerminal(e)},P=async()=>{var e;if(e=ge.START,k.value=e,C.changeMainTerminalScriptType(e,""),c.value=!0,o.value&&d.value){let e=await(async(e,a)=>{const l=e.installName,n=(await t()).LMD_SCRIPTS_DIR,{repoUrl:o,repoLocalFolderName:s}=aa.getLMDScriptRepoUrl(e);return`\nexport LMD_BASE_INSTALL_SCRIPT_DIR="${n}/${s}"\n${oa(o)}\n${await na.genSetPortCommand(e)}\nsh "$LMD_BASE_INSTALL_SCRIPT_DIR/apps/${l}/${"docker"===a?.installMethod?"start-d.sh":"start.sh"}"`})(o.value,d.value);const a=l.query.module;if(console.log("route.params.module",a),a){e=`\nexport LMD_LAUNCH_APP_MODULE=${a}\n`+e}z(e),window.ipcRenderer?.send(ye.RUNNING_STATUS_CHANGE,!0)}},F=()=>Array.isArray(s.value)?s.value[0]:s.value,z=e=>{const a=F();console.log("run command",a,e),a?.runCommand(e)},j=()=>{c.value=!1,F()?.runStopCommand(),window.ipcRenderer.send(ye.RUNNING_STATUS_CHANGE,!1)},B=()=>{F()?.exitTerminal()},H=e=>{if(ue.isWindows())return;j();const a=(e=>{let a="";if(e)for(const t in e)a+=`${t}=${e[t]}\n`;return a})(e);F()?.runCommand(a),P()},G=async()=>{if(P(),We.needPreStartApp(d.value?.installName))return ue.isMacOS()?void setTimeout((()=>{Y()}),20):void 0;Y()},Y=()=>{I.value=!0},K=e=>{console.log("onCommandExecuteEnd",e),e&&E(e,"success"),setTimeout((()=>{i.value?.updateAppEnvData()}),400)},J=e=>{e.includes("lmdevent:docker_run_error")&&E(R("AppRunningWindowV2.docker_run_error"),"error",6e3)};return(e,a)=>(h(),p(f,null,[u("div",Jt,[v(Kt,{"lm-app-data":g(o),"is-app-running":g(c),onStopApp:j,onStartApp:P,"installed-instance":g(d)},null,8,["lm-app-data","is-app-running","installed-instance"]),u("div",qt,[g(d)&&g(o)&&g(I)?(h(),x(Bt,{key:0,ref_key:"appEnvAndAccessComponent",ref:i,onAppEnvSavedAndUpdated:H,isAppRunning:g(c),lmAppData:g(o),installedInstance:g(d)},null,8,["isAppRunning","lmAppData","installedInstance"])):m("",!0)])]),u("footer",{class:b(["footer-terminal","app-run-footer-terminal",g(M)?"expanded":""])},[u("div",Qt,[v(U,{variant:"text",style:{position:"absolute",right:"10px",top:"5px"},onClick:a[0]||(a[0]=e=>M.value=!g(M))},{append:S((()=>[v(V,{src:g(M)?"./images/icons/expand-white.svg":"./images/icons/collapse-white.svg",width:"18",height:"18"},null,8,["src"])])),default:S((()=>[w(y(g(M)?e.$t("AppRunningWindowV2.Hide"):e.$t("AppRunningWindowV2.ViewLog"))+" ",1)])),_:1})]),u("div",Xt,[g(T)&&g(L)&&"main-process"===g(L).tabName?(h(),x(ra,{key:0,socketURI:g(T),onExecuteEnd:a[1]||(a[1]=e=>{return a=g(L).commandExecuteEndToastMsg,Y(),console.log("onMainTerminalCommandEnd"),void K(a);var a}),"command-execute-end-keywords":g(L).commandExecuteEndKeywords,ref_key:"generalTerminal",ref:s,events:["lmdprogress","lmdevent:docker_run_error"],onReady:N,onTerminalEvent:J},null,8,["socketURI","command-execute-end-keywords"])):m("",!0)])],2)],64))}}),el={class:"app-install-result pt-10 pb-6 px-11 mb-12 mx-10"},al=c({__name:"install-result",props:{lmAppData:{},installedInstance:{}},setup(e){const a=e,t=()=>{a.installedInstance.appInstallPath&&s(a.installedInstance.appInstallPath)};return(e,a)=>(h(),p("div",el,[v(ie,{class:"gap-2 mb-2"},{default:S((()=>[v(de,{cols:"12",xs:"12",sm:"6",md:"6",lg:"6",class:"item"},{default:S((()=>[w(y(e.$t("AppRunningWindowV2.AppNameLabel"))+": "+y(e.lmAppData.name),1)])),_:1}),v(de,{cols:"12",xs:"12",sm:"6",md:"6",lg:"6",class:"item"},{default:S((()=>[w(y(e.$t("AppRunningWindowV2.AppInstallTimeLabel"))+": "+y(g(je).format(e.installedInstance.createTime,!1)),1)])),_:1}),v(de,{cols:"12",xs:"12",sm:"6",md:"6",lg:"6",class:"item"},{default:S((()=>[w(y(e.$t("AppRunningWindowV2.AppInstallLocationLabel"))+": ",1),u("a",{href:"#",onClick:L(t,["prevent"])},y(e.installedInstance.appInstallPath),1)])),_:1})])),_:1})]))}}),{addToast:tl}=e(),ll=d("appInstall",{state:()=>({installPercent:r(0),installSuccessMsg:r(""),installed:r(!1)}),actions:{initModelsData(){this.installPercent=0},updateUI(e){this.installPercent=e,1===e&&(this.installed=!0,this.installSuccessMsg&&tl(this.installSuccessMsg,"success"))},onDownloadError(e){console.error("Failed to download App",e),tl(e.message,"error")}}}),nl={class:"progress-area"},ol={style:{width:"210px"}},sl={key:0,style:{width:"250px"},class:"mt-6"},il={class:"progress-msg mb-8 mt-6"},dl={class:"progress-msg-title"},rl={class:"progress-msg-title"},cl=c({__name:"install-progress",props:{lmAppData:{},instanceData:{}},setup(e){const t=ll(),l=e,{t:n}=W(),o=_((()=>"docker"===l.instanceData?.installMethod?n("LMAppDetail.DockerMode"):""));return(e,n)=>(h(),p("div",nl,[u("div",ol,[v(V,{src:g(t).installed?"./images/app/succes.svg":"./images/app/processing.svg",width:"210",height:"140"},null,8,["src"])]),g(t).installed?m("",!0):(h(),p("div",sl,[v(P,{width:"100%",class:"download-progress-bar","bg-color":"#F2F2FA","bg-opacity":"1","buffer-color":"#DFDFEC","buffer-opacity":"1",opacity:"1",color:g(a).PRIMARY_COLOR,height:"14",max:100,min:0,"model-value":g(t).installPercent,rounded:""},null,8,["color","model-value"])])),u("div",il,[g(t).installed?(h(),p(f,{key:1},[u("div",rl,y(e.$t("AppRunningWindowV2.InstallSuccessTitle")),1),u("div",null,[We.appIsOllama(l.lmAppData?.installName)?(h(),p(f,{key:0},[w(y(e.$t("AppRunningWindowV2.InstallSuccessNextTipForOllama")),1)],64)):(h(),p(f,{key:1},[w(y(e.$t("AppRunningWindowV2.InstallSuccessNextTip")),1)],64))])],64)):(h(),p(f,{key:0},[u("div",dl,y(e.lmAppData?.name),1),g(o)?(h(),x(K,{key:0,class:"mt-1 mb-3",density:"default",size:"small",color:"#086dd7"},{default:S((()=>[w(y(g(o)),1)])),_:1})):m("",!0),u("div",null,y(e.$t("AppRunningWindowV2.InstallingMsg"))+" "+y(g(t).installPercent)+"% ",1)],64))])]))}}),pl={class:"app-install-container"},ul={class:"install-steps"},ml={class:"pa-6 install-right-content"},vl={class:"footer-button-bar"},gl=c({__name:"app-install",setup(a){const{t:l}=W(),n=ea(),o=r(""),s=Ne(),i=r(null),d=D(),c=r(null),f=r(),I=ll(),k=r(!1),{addToast:R}=e();A((async()=>{O();const e=d.params.id,a=await me(e);c.value=a;const t=a.appId;await s.fetchApp(t),i.value=s.currentLmApp,window.ipcRenderer?.on(ye.STOP_AI_RUNNING_INSTANCE,(()=>{$(),P()})),E()}));const E=()=>{const e=i?.value?.name;document.title=`[${l("LMAppDetail.install")}] ${e}`},C=()=>{console.log("onTerminalReady"),N()},M=_((()=>{if(i.value?.id&&c.value?.id)return pa.genWSUrl(i.value.id,c.value.id,ua)})),O=()=>{const e=l("AppRunningWindow.MainProcessTab");n.initTerminal(e)},N=async()=>{var e;if(console.log("installApp"),e=ge.INSTALL,o.value=e,console.log("changeMainTerminalScriptType",e,""),n.changeMainTerminalScriptType(e,""),i.value&&c.value){const e=await(async(e,a)=>{const l=e.installName,n=(await t()).LMD_SCRIPTS_DIR,{repoUrl:o,repoLocalFolderName:s}=aa.getLMDScriptRepoUrl(e),i=oa(o);return console.log("repoLocalFolderName",s),`\nexport LMD_BASE_INSTALL_SCRIPT_DIR="${n}/${s}"\n${i}\nsh "$LMD_BASE_INSTALL_SCRIPT_DIR/apps/${l}/${"docker"===a?.installMethod?"install-d.sh":"install.sh"}"`})(i.value,c.value);T(e)}Me()},T=e=>{const a=L();console.log("run command",a,e),a?.runCommand(e)},L=()=>Array.isArray(f.value)?f.value[0]:f.value,$=()=>{L()?.runStopCommand(),window.ipcRenderer.send(ye.RUNNING_STATUS_CHANGE,!1)},P=()=>{L()?.exitTerminal()},z=e=>{if(e.includes("lmdevent:docker_run_error"))return void R(l("AppRunningWindowV2.docker_run_error"),"error",6e3);const a=ca.extractProgress(e);a&&(I.installPercent=a,100===a&&(I.installed=!0,Oe()))},j=()=>{console.log("installedInstance",c.value?.id),c.value?.id&&he(c.value.id)},B=()=>{c.value&&we.goToRunningPage(c.value.id,ge.START,c.value.installName)};return(e,a)=>{const t=cl,l=al;return h(),p("div",pl,[u("div",ul,[u("div",ml,[g(i)?(h(),x(t,{key:0,"instance-data":g(c),"lm-app-data":g(i)},null,8,["instance-data","lm-app-data"])):m("",!0),g(c)&&g(i)&&g(I).installed?(h(),x(l,{key:1,lmAppData:g(i),installedInstance:g(c)},null,8,["lmAppData","installedInstance"])):m("",!0),u("div",{class:b(["footer-terminal","app-install-footer-terminal",g(k)?"expanded":""])},[u("div",vl,[v(U,{variant:"text",style:{position:"absolute",right:"10px",top:"5px"},onClick:a[0]||(a[0]=e=>k.value=!g(k))},{append:S((()=>[v(V,{src:g(k)?"./images/icons/expand-white.svg":"./images/icons/collapse-white.svg",width:"18",height:"18"},null,8,["src"])])),default:S((()=>[w(y(g(k)?e.$t("AppRunningWindowV2.Hide"):e.$t("AppRunningWindowV2.ViewLog"))+" ",1)])),_:1})]),g(M)?(h(),x(ra,{key:0,ref_key:"generalTerminal",ref:f,events:["lmdprogress","lmdevent:docker_run_error"],onTerminalEvent:z,onReady:C,socketURI:g(M)},null,8,["socketURI"])):m("",!0)],2)])]),v(F,{style:{"border-top":"1px solid #EBEBF7"},class:"py-6 text-center justify-center"},{default:S((()=>[v(U,{variant:"outlined",onClick:j},{default:S((()=>[w(y(e.$t("Common.close")),1)])),_:1}),We.appIsOllama(i.value?.installName)?(h(),x(U,{key:0,variant:"flat",disabled:!g(I).installed,onClick:B,color:"primary"},{default:S((()=>[w(y(e.$t("AppRunningWindowV2.NextStep")),1)])),_:1},8,["disabled"])):m("",!0)])),_:1})])}}}),fl=c({__name:"AppRunningWindowV2",setup(e){const a=r(""),t=D();return A((()=>{const e=t.query.script;e===ge.INSTALL?a.value="install":e===ge.START||e===ge.DOWNLOAD_MODEL?a.value="run":e===ge.REMOVE&&(a.value="remove")})),(e,t)=>{const l=gl,n=Zt,o=ha;return h(),p(f,null,["install"===g(a)?(h(),x(l,{key:0})):m("",!0),"run"===g(a)?(h(),x(n,{key:1})):m("",!0),"remove"===g(a)?(h(),x(o,{key:2})):m("",!0)],64)}}});export{fl as default};
