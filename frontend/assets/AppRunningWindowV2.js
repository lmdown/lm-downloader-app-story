import{b as e,T as a,g as t,f as n,d as l,o as s,h as o,i}from"./index.js";import{d as r}from"./pinia.js";import{b as c,e as d,a4 as p,a3 as u,a6 as m,k as v,u as g,F as f,S as h,K as y,a1 as w,H as A,Z as _,ac as S,c as I,a0 as D,a9 as x,a2 as b,j as R,l as k,V as E,m as T,ab as M,a5 as C}from"./vue.js";import{b as N,m as $,G as L,q as P,E as O,n as V,z as U,A as W,O as F,e as z,d as j,D as B,P as H,Q as G,F as K,R as J,c as q,w as Y,x as Q,a as Z,M as X,l as ee,o as ae,H as te,S as ne,p as le}from"./vuetify.js";import{O as se,e as oe,d as ie,a as re,I as ce,A as de}from"./OSUtil.js";import{I as pe,d as ue,g as me,e as ve,s as ge,f as fe,D as he,h as ye,j as we,_ as Ae,k as _e,l as Se,m as Ie}from"./lmd-system.js";import{u as De}from"./index2.js";import{r as xe,a as be,b as Re}from"./xterm.js";import{a as ke,b as Ee,A as Te,O as Me,M as Ce}from"./AppInfoUtil.js";import{p as Ne}from"./pretty-bytes.js";import{D as $e}from"./DateTimeUtil.js";import"./debounce.js";import"./vuei18n.js";import"./lmd-locales.js";import"./dayjs.js";const{addToast:Le}=e(),Pe=r("appRemove",{state:()=>({removePercent:c(0),removeSuccessMsg:c(""),removed:c(!1)}),actions:{initModelsData(){this.removePercent=0},updateUI(e){this.removePercent=e,1===e&&(this.removed=!0,this.removeSuccessMsg&&Le(this.removeSuccessMsg,"success"))}}}),Oe={class:"progress-area"},Ve={style:{width:"210px"}},Ue={key:0,style:{width:"250px"},class:"mt-6"},We={class:"progress-msg mb-8 mt-6"},Fe={class:"progress-msg-title"},ze={class:"progress-msg-title"},je={class:"mt-3",style:{"font-size":"14px"}},Be=d({__name:"remove-progress",props:{lmAppData:{}},setup(e){const t=Pe();return(e,n)=>(w(),p("div",Oe,[u("div",Ve,[v(N,{src:g(t).removed?"./images/my-ai/del-tip.svg":"./images/app/processing.svg",width:"210",height:"140"},null,8,["src"])]),g(t).removed?m("",!0):(w(),p("div",Ue,[v($,{width:"100%",class:"download-progress-bar","bg-color":"#F2F2FA","bg-opacity":"1","buffer-color":"#DFDFEC","buffer-opacity":"1",opacity:"1",color:g(a).PRIMARY_COLOR,height:"14",max:100,min:0,"model-value":g(t).removePercent,rounded:""},null,8,["color","model-value"])])),u("div",We,[g(t).removed?(w(),p(f,{key:1},[u("div",ze,y(e.$t("AppRunningWindowV2.DeleteSuccessTitle")),1),u("div",je,y(e.$t("AppRunningWindowV2.DeleteSuccessMsg")),1)],64)):(w(),p(f,{key:0},[u("div",Fe,y(e.lmAppData?.name),1),h(" "+y(e.$t("AppRunningWindowV2.DeletingMsg"))+" "+y(g(t).removePercent)+"% ",1)],64))])]))}}),He=r("runningInstance",{state:()=>({runningInstances:[],appSettingsSaved:!1,terminals:[],currentTerminalTab:""}),actions:{addRunningInstance(e){this.runningInstances.find((a=>a.id===e.id))||this.runningInstances.push(e)},removeRunningInstance(e){const a=this.runningInstances.findIndex((a=>a.id===e.id));-1!=a&&this.runningInstances.splice(a,1)},resetAppSettingsSavedStatus(){this.appSettingsSaved=!1},onAppSettingsSaved(){this.appSettingsSaved=!0},changeMainTerminalScriptType(e,a){try{const t=this.terminals[0];t.commandExecuteEndKeywords=[`lmd ${e} script end.`],t.commandExecuteEndToastMsg=a}catch(t){console.error(t)}},initTerminal(e){const a={icon:"mdi-application-brackets-outline",text:e,tabName:"main-process",closable:!1};this.terminals=[a],this.currentTerminalTab=a.tabName},addTerminal(e){this.terminals.find((a=>a.tabName===e.tabName))||(console.log("addTerminal",e.commandExecuteEndKeywords),this.terminals.push(e)),this.currentTerminalTab=e.tabName},removeTerminal(e,a){this.currentTerminalTab="main-process",this.terminals.splice(a,1)},addInstallModelTerminal(e,a,t,n){const l={text:a,tabName:a,initCommand:t,closable:!0,commandExecuteEndKeywords:["digest","writing manifest","success"],commandExecuteEndToastMsg:n};this.addTerminal(l)},addDeleteModelTerminal(e,a,t,n){const l={text:a,tabName:a,initCommand:t,closable:!0,commandExecuteEndKeywords:[`deleted '${e}'`],commandExecuteEndToastMsg:n};this.addTerminal(l)}}});class Ge{static getLMDScriptRepoUrl(e){let a="https://gitee.com/lmdown/lmd-install-scripts";if(e?.downloadInfo&&e?.downloadInfo.length>0){a=e.downloadInfo[0].scriptGitRepoUrl}return{repoUrl:a,repoLocalFolderName:this.getLastPathSegment(a)||"lmd-install-scripts"}}static getLastPathSegment(e){const a=e.match(/[^\/?#]+(?=[/?#]*$)/);return a?a[0]:null}}const Ke="browser";class Je{static async isPortInUse(e){const a=`http://127.0.0.1:${e}`;try{const t=await fetch(a,{method:"get",mode:"no-cors",cache:"no-store"});return console.log(`${e} in use`,t.status),t.ok}catch(t){return console.log(`can not access port ${e}`,t),!1}}static async findAvailablePort(e,a){let t=e;for(let l=1;l<=a;l++)try{if(!(await this.isPortInUse(t)))return t;t++}catch(n){console.error(`check port ${t} err`,n),t++}return console.error("no Available port, use default value"),e}}class qe{static async genSetPortCommand(e){if(e?.accessInfo.accessType===Ke&&this.needCheckPort(e)&&e.accessInfo.webUrl){e.accessInfo.detectAvailablePortDone=!1;const{url:a,port:t}=await qe.checkPortInUrl(e.accessInfo.webUrl);if(e.accessInfo.detectAvailablePortDone=!0,t)return e.accessInfo.webUrl=a,`export SERVER_PORT=${t}\nexport GRADIO_SERVER_PORT=${t}`}return""}static needCheckPort(e){return["spark-tts","index-tts","f5-tts","framepack","liveportrait","ace-step","cosyvoice","latentsync","notagen"].includes(e.installName)||e?.accessInfo?.detectAvailablePort}static async checkPortInUrl(e){try{const a=new URL(e),t=parseInt(a.port,10);if(isNaN(t))throw new Error("does not contain a valid port");const n=await Je.findAvailablePort(t,20);return a.port=n.toString(),{url:a.toString(),port:n}}catch(a){return console.log("Invalid URL",a),{url:e}}}}const Ye=e=>"0"===n("UPDATE_INSTALL_SCRIPTS")?"":`\ngit clone --depth=1 ${e} "$LMD_BASE_INSTALL_SCRIPT_DIR"\ncd "$LMD_BASE_INSTALL_SCRIPT_DIR" && git fetch origin master && git reset --hard origin/master`;var Qe=xe(),Ze=be(),Xe=Re();const ea=d({__name:"index",props:{socketURI:{},initCommand:{},commandExecuteEndKeywords:{},events:{}},emits:["executeEnd","terminalEvent","ready"],setup(e,{expose:a,emit:t}){const n=t,s=c([]),o=c(!1),i=e,r=c(null),d=c(null),m=c(null),v=c(null);let g;A((()=>{S(),y()})),_((()=>{r.value?.close(),d.value?.dispose(),g&&v.value&&(g.unobserve(v.value),g.disconnect())}));const f=e=>{console.log("runCommand",e),console.log("runCommand socket.value",r.value),r.value?.send(e+"\n")};a({runCommand:f,runStopCommand:()=>{f(""),f("")},exitTerminal:()=>{f("exit")}});const h=l((e=>{for(const a of e){let e=a.contentRect.height;se.isMacOS()&&(e-=10),E(a.contentRect.width,e)}}),9),y=()=>{m.value&&(g=new ResizeObserver(h),g.observe(m.value))},S=()=>{r.value=new WebSocket(i.socketURI),x(),D(),b(),I()},I=()=>{r.value&&(r.value.onmessage=e=>{const a=e.data,t=i.events;console.log("event data ",e.data),console.log("props.events ",i.events),t&&t.length>0&&t.forEach((e=>{a.includes(e)&&(console.log("emit terminalEvent",a),n("terminalEvent",a))}));const l=i.commandExecuteEndKeywords;l&&(l.forEach((e=>{a.includes(e)&&!s.value.includes(e)&&s.value.push(e)})),s.value.length===l.length&&(n("executeEnd"),o.value=!0,s.value=[]))})},D=()=>{r.value&&(r.value.onopen=()=>{(()=>{if(!v.value)return;if(!r.value)return;const e=new window.Terminal({fontSize:14,cursorBlink:!0}),a=new Ze.AttachAddon(r.value),t=new Qe.FitAddon,n=new Xe.WebLinksAddon(((e,a)=>{const t=document.createElement("a");t.setAttribute("href",a),t.setAttribute("target","_blank"),t.setAttribute("id","lmdTempLink");const n=document.getElementById("lmdTempLink");n&&document.body.removeChild(n),document.body.appendChild(t),t.click()}));e.loadAddon(a),e.loadAddon(t),e.loadAddon(n),e.open(v.value),t.fit(),d.value=e})(),i.initCommand&&f(i.initCommand),n("ready")})},x=()=>{r.value&&(r.value.onclose=e=>{console.log("close socket",e)})},b=()=>{r.value&&(r.value.onerror=e=>{console.log("socket err",e)})},R=c(80),k=c(30),E=(e,a)=>{const t=Math.floor(e/8.5),n=Math.round(a/16);if(console.log("cols",e,t),console.log("rows",a,n),0!==n&&0!==t&&(R.value!==t||k.value!==n)){R.value=t,k.value=n,d.value?.resize(t,n);const e=`lmd_action:resize:${t},${n}`;r.value?.send(e)}};return(e,a)=>(w(),p("div",{ref_key:"terminalOutContainer",ref:m,class:"mb-0",style:{height:"100%",width:"100%"}},[u("div",{ref_key:"terminalContainer",ref:v,class:"terminal",style:{height:"300px",width:"100%"}},null,512)],512))}});class aa{static extractProgress(e){let a=null;try{const t=/lmdprogress:(\d+)/g;let n;for(;null!==(n=t.exec(e));)a=parseInt(n[1],10)}catch(t){console.error("parse err",t)}return a}}class ta{static genWSUrl(e,a,t){return`ws://localhost:19312/?appId=${e}&installedInstanceId=${a}&runningLogType=${t}`}}const na="install",la="run",sa="delete",oa={class:"app-install-container"},ia={class:"install-steps"},ra={class:"pa-6 install-right-content"},ca={class:"footer-button-bar"},da=d({__name:"app-remove",setup(a){const{t:n}=L(),l=He(),s=c(""),o=De(),i=c(null),r=S(),d=c(null),f=c(),_=Pe(),R=c(!1),{addToast:k}=e();A((async()=>{M();const e=r.params.id;let a;try{a=await oe(e)}catch(s){return console.log(s),void k(n("AppRunningWindowV2.DeleteNotFound"),"error")}d.value=a;const t=a.appId;await o.fetchApp(t),i.value=o.currentLmApp,window.ipcRenderer?.on(pe.STOP_AI_RUNNING_INSTANCE,(()=>{U(),W()}));const l=i?.value.name;document.title=`[${n("LMAppDetail.Delete")}] ${l}`}));const E=I((()=>{if(i.value?.id&&d.value?.id)return ta.genWSUrl(i.value?.id,d.value?.id,sa)})),T=()=>{console.log("onTerminalReady"),C()},M=()=>{const e=n("AppRunningWindow.MainProcessTab");l.initTerminal(e)},C=async()=>{var e;if(e=re.REMOVE,s.value=e,console.log("changeMainTerminalScriptType",e,""),l.changeMainTerminalScriptType(e,""),i.value&&d.value){const e=await(async(e,a)=>{const n=e.installName,l=(await t()).LMD_SCRIPTS_DIR,{repoUrl:s,repoLocalFolderName:o}=Ge.getLMDScriptRepoUrl(e),i=Ye(s);console.log("repoLocalFolderName",o);const r="docker"===a?.installMethod?"remove-d.sh":"remove.sh";let c="";return a.instancesCountOfApp>1&&(c="keepmodels"),`\nexport LMD_BASE_INSTALL_SCRIPT_DIR="${l}/${o}"\n${i}\nsh "$LMD_BASE_INSTALL_SCRIPT_DIR/apps/${n}/${r}" ${c}`})(i.value,d.value);$(e)}},$=e=>{const a=V();console.log("run command",a,e),a?.runCommand(e)},V=()=>Array.isArray(f.value)?f.value[0]:f.value,U=()=>{V()?.runStopCommand(),window.ipcRenderer.send(pe.RUNNING_STATUS_CHANGE,!1)},W=()=>{V()?.exitTerminal()},F=e=>{const a=aa.extractProgress(e);a&&(_.removePercent=a,100===a&&(_.removed=!0,d.value?.id&&ie(d.value?.id)))},z=()=>{d.value?.id&&ue(d.value.id)};return(e,a)=>{const t=Be;return w(),p("div",oa,[u("div",ia,[u("div",ra,[g(i)?(w(),D(t,{key:0,"lm-app-data":g(i)},null,8,["lm-app-data"])):m("",!0),u("div",{class:x(["footer-terminal","app-install-footer-terminal",g(R)?"expanded":""])},[u("div",ca,[v(P,{variant:"text",style:{position:"absolute",right:"10px",top:"5px"},onClick:a[0]||(a[0]=e=>R.value=!g(R))},{append:b((()=>[v(N,{src:g(R)?"./images/icons/expand-white.svg":"./images/icons/collapse-white.svg",width:"18",height:"18"},null,8,["src"])])),default:b((()=>[h(y(g(R)?e.$t("AppRunningWindowV2.Hide"):e.$t("AppRunningWindowV2.ViewLog"))+" ",1)])),_:1})]),g(E)?(w(),D(ea,{key:0,ref_key:"generalTerminal",ref:f,events:["lmdprogress"],onTerminalEvent:F,onReady:T,socketURI:g(E)},null,8,["socketURI"])):m("",!0)],2)])]),v(O,{style:{"border-top":"1px solid #EBEBF7"},class:"py-6 text-center justify-center"},{default:b((()=>[v(P,{variant:"outlined",onClick:z},{default:b((()=>[h(y(e.$t("Common.close")),1)])),_:1})])),_:1})])}}}),pa=d({__name:"copy-link-icon",props:{text:{}},setup(e){const a=e,t=c(!1),n=()=>{t.value=!0,navigator.clipboard.writeText(a.text),setTimeout((()=>{t.value=!1}),1500)};return(e,a)=>(w(),D(N,{width:"16",height:"16",onClick:n,src:"./images/icons/link-copy.svg",style:{cursor:"pointer"}},{default:b((()=>[v(V,{activator:"parent","open-on-hover":!1,location:"bottom",transition:"false",modelValue:g(t),"onUpdate:modelValue":a[0]||(a[0]=e=>R(t)?t.value=e:null)},{default:b((()=>[h(y(e.$t("App.Copied")),1)])),_:1},8,["modelValue"])])),_:1}))}});class ua{static async getAppSettings(){const e=await this.getOSEnvObj();return{modelsDir:e.OLLAMA_MODELS,externalAccessHost:e.OLLAMA_HOST,externalAccessPath:e.OLLAMA_ACCESS_PATH_LMD}}static async getOSEnvObj(){return await me(Ee.DISPLAY_ENV)}static async getAccessHosts(e){const a="11434",t=[`http://127.0.0.1:${a}`];if(e&&"127.0.0.1"!==e){const n=e.split(":"),l=n[0];let s=[l];const o=n[1]||a;"0.0.0.0"===l&&(s=await ve()),s&&s.length>0&&s.forEach((e=>{t.push(`http://${e}:${o}`)}))}else;return t}static async saveAppSettings(e,a){e.modelsDir===a&&(e.modelsDir="");const t={OLLAMA_MODELS:e.modelsDir,OLLAMA_HOST:e.externalAccessHost,OLLAMA_ACCESS_PATH_LMD:e.externalAccessPath};return await ge(t)}static getDownloadableModels(){return JSON.parse(JSON.stringify(ke))}}const ma={style:{"font-size":"12px"}},va={style:{"font-size":"12px"}},ga=d({__name:"ollama-settings-btn",props:{installedInstance:{}},setup(a){const{t:t}=L(),n=c(!1),l=c(!1),o=c(!1),i=c(!1),r=c(""),d=He(),{addToast:_}=e(),S=c({}),x=c(!0),M=a;k((()=>M.installedInstance),(()=>{C()}));const C=()=>{ee()?n.value=!0:n.value=!1};A((()=>{C()}));const N=async()=>{l.value=!0,console.log("showDialog1",l.value),await $(),await X(),console.log("showDialog2",l.value)};k((()=>l),(()=>{console.log("dialogVisible change: ",l)}));const $=async()=>{const e=await ye();r.value=e+"/.ollama/models"},H=async()=>{if(!o.value)return;if(!S)return;if(""===r.value){const e=t("AppSettingDialog.DataNotValid");return void _(e,"error")}i.value=!0;const e=Object.assign({},S.value),a=await ua.saveAppSettings(e,r.value);console.log("save result ",a);const n=t("Common.saveSuccess");_(n,"success"),i.value=!1,d.onAppSettingsSaved(),setTimeout((()=>{d.resetAppSettingsSavedStatus()}),100),l.value=!1,console.log("hideDialog",l.value),Te.killAppProcessed(M.installedInstance?.installName),setTimeout((()=>{we()}),1500)},G=async()=>{const e=await fe(S.value.modelsDir,!0);e&&e.path&&(S.value.modelsDir=e.path,console.log("dirInfo",e),x.value=he.checkModelsDirValid(e,["blobs"]),console.log("dirValid.value",x.value))},K=()=>{s(S.value.modelsDir)},J=[e=>!!e||t("Common.fieldRequired"),()=>x.value||t("AppSettingDialog.ModelsDirNotValid")],q=/^(\d{1,3}\.){3}\d{1,3}(:\d{1,5})?$/,Y=[e=>""===e||(q.test(e)||t("AppSettingDialog.HostNotValid"))],Q=async()=>{S.value.modelsDir=r.value},Z=I((()=>{if(ee())return t("AppSettingDialog.OllamaModelsDirInfoIconTip")})),X=async()=>{if(ee()){const e=await ua.getAppSettings();console.log("getOSEnvForCurrentApp",e),S.value=Object.assign({},e),""===e.modelsDir&&(console.log("getOSEnvForCurrentApp",e),S.value.modelsDir=r.value)}},ee=()=>Te.appIsOllama(M.installedInstance?.installName);return(e,a)=>(w(),p(f,null,[v(P,{class:"settings-small-btn",variant:"outlined",density:"compact",rounded:"",onClick:E(N,["stop"])},{default:b((()=>[h(y(e.$t("AppRunningWindow.Settings")),1)])),_:1}),v(U,{modelValue:g(l),"onUpdate:modelValue":a[5]||(a[5]=e=>R(l)?l.value=e:null),"min-width":"400","max-width":"840"},{default:b((()=>[e.installedInstance?(w(),D(W,{key:0,class:"mx-auto px-0 py-0 window-no-drag",width:"100%",title:e.$t("AppSettingDialog.Title")+e.installedInstance.name},{append:b((()=>[v(P,{icon:"mdi-close",class:"ms-auto",size:"compact",text:"Ok",elevation:"0",onClick:a[0]||(a[0]=e=>l.value=!1)})])),default:b((()=>[g(S)?(w(),D(F,{key:0,class:"pt-0 pb-3 px-6",modelValue:g(o),"onUpdate:modelValue":a[4]||(a[4]=e=>R(o)?o.value=e:null),onSubmit:E(H,["prevent"])},{default:b((()=>[v(z,{modelValue:g(S).modelsDir,"onUpdate:modelValue":a[1]||(a[1]=e=>g(S).modelsDir=e),density:"comfortable",readonly:g(i),rules:J,label:e.$t("AppSettingDialog.ModelsDirLabel")},{append:b((()=>[v(V,{location:"bottom"},{activator:b((({props:e})=>[v(j,T(e,{icon:"mdi-information-slab-circle-outline"}),null,16)])),default:b((()=>[u("pre",null,y(g(Z)),1)])),_:1}),v(P,{class:"ml-1",onClick:G,variant:"outlined"},{default:b((()=>[h(y(e.$t("AppSettingDialog.Browse")),1)])),_:1}),v(P,{class:"ml-1",onClick:K,variant:"outlined"},{default:b((()=>[h(y(e.$t("AppSettingDialog.Open")),1)])),_:1}),v(P,{class:"ml-1",onClick:Q,variant:"outlined"},{default:b((()=>[h(y(e.$t("AppSettingDialog.UseDefaultValue")),1)])),_:1})])),_:1},8,["modelValue","readonly","label"]),v(B,{class:"pt-0"},{default:b((()=>[u("pre",ma,y(t("AppSettingDialog.ModelsDirTip")),1)])),_:1}),v(z,{modelValue:g(S).externalAccessHost,"onUpdate:modelValue":a[2]||(a[2]=e=>g(S).externalAccessHost=e),density:"comfortable",readonly:g(i),rules:Y,label:e.$t("AppSettingDialog.ServerHostLabel")},null,8,["modelValue","readonly","label"]),v(B,{class:"pt-0"},{default:b((()=>[u("pre",va,y(t("AppSettingDialog.ServerHostTip")),1)])),_:1}),v(O,{class:"text-center justify-center"},{default:b((()=>[v(P,{variant:"outlined",onClick:a[3]||(a[3]=e=>l.value=!1)},{default:b((()=>[h(y(e.$t("AppSettingDialog.close")),1)])),_:1}),v(P,{color:"primary",variant:"flat",type:"submit",loading:g(i)},{default:b((()=>[h(y(e.$t("AppSettingDialog.saveConfig")),1)])),_:1},8,["loading"])])),_:1})])),_:1},8,["modelValue"])):m("",!0)])),_:1},8,["title"])):m("",!0)])),_:1},8,["modelValue"])],64))}}),fa={style:{"font-size":"14px","line-height":"16px"}},ha=d({__name:"lmd-expansion-panel",props:{title:{default:""},showExpandIcon:{type:Boolean,default:!1},defaultExpanded:{type:Boolean,default:!1}},setup:e=>(A((()=>{})),(e,a)=>(w(),D(H,{dense:""},{default:b((()=>[v(G,{class:"d-flex"},{actions:b((({expanded:a})=>[e.showExpandIcon?(w(),p(f,{key:0},[u("span",fa,y(a?e.$t("AppRunningWindowV2.Collapse"):e.$t("AppRunningWindowV2.Expand")),1),v(N,{src:a?"./images/icons/collapse.svg":"./images/icons/expand.svg",width:"16",height:"16"},null,8,["src"])],64)):m("",!0)])),default:b((()=>[h(y(e.title)+" ",1),v(K),M(e.$slots,"append")])),_:3}),v(J,{style:{padding:"0"}},{default:b((()=>[M(e.$slots,"default")])),_:3})])),_:3})))});class ya{static openBrowser(e){const a=document.createElement("a");a.href=e,a.target="_blank",document.body.appendChild(a),a.click(),document.body.removeChild(a)}}const wa=["href"],Aa={style:{color:"#999999"},class:"mx-0 mt-4 mb-0"},_a=d({__name:"app-access-row-v2",props:{lmAppData:{},installedInstance:{},appEnv:{},isAppRunning:{type:Boolean}},setup(e){const t=e,n=c([]),l=c(!1),s=c(!1),i=c(void 0),r=async()=>{if(t.lmAppData?.accessInfo){const e=t.lmAppData.accessInfo,{accessType:a}=e;if(!a)return!1;if("browser"===a)return n.value.push(t.lmAppData.accessInfo?.webUrl||""),!0;if("exec"===a&&Te.appIsOllama(t.installedInstance?.installName)){if(t.appEnv){const e=t.appEnv[Me];n.value=await ua.getAccessHosts(e)}return!0}}return!1};A((async()=>{l.value=await r(),s.value=Te.displayAccessSettingBtn(t.installedInstance?.installName)})),k((()=>t.appEnv),(async()=>{l.value=await r()})),k((()=>t.lmAppData?.accessInfo.webUrl),(async()=>{n.value=[],l.value=await r()})),k((()=>t.lmAppData?.accessInfo.detectAvailablePortDone),(async e=>{e&&setTimeout((()=>{d()}),100)}));const d=async()=>{const e=t.installedInstance?.installMethod,a=t.lmAppData?.accessInfo,l=n.value?.length;let s;s=e===ce.DOCKER?a?.dockerOpenBrowserByLMD&&l>0:a?.openBrowserByLMD&&l>0;const r=a?.showDetectStatus;if(s||r){i.value=!0;const e=n.value[0],a=await(async e=>{try{return await o(e,{headers:{"Cache-Control":"no-cache",Pragma:"no-cache",Expires:"0"}},2e3,2e3),!0}catch(a){return console.log("app check err",a),!1}})(e);console.log("checkRunningStatus result",a),i.value=!1,s&&a&&ya.openBrowser(e)}};return(e,l)=>{const s=ga,o=pa;return g(n)&&g(n).length>0?(w(),D(ha,{key:0,title:e.$t("AppRunningWindow.Access"),readonly:"",value:"app-access",showExpandIcon:!1,"default-expanded":!0},{append:b((()=>[Te.appIsOllama(t.lmAppData?.installName)?(w(),D(s,{key:0,installedInstance:e.installedInstance},null,8,["installedInstance"])):m("",!0)])),default:b((()=>[v(q,{class:"pt-1 pb-2",style:{margin:"0 -24px -16px"}},{default:b((()=>[v(Y,{"no-gutters":"",style:{padding:"0px"}},{default:b((()=>[(w(!0),p(f,null,C(g(n),((t,n)=>(w(),D(Q,{key:n,class:"px-5 py-2",cols:"12",sm:"6"},{default:b((()=>[v(Z,{style:{background:"#FFF4EA","border-radius":"4px",height:"40px"},density:"compact","min-height":"1.1rem",class:"px-5"},{prepend:b((()=>[v(o,{text:t},null,8,["text"])])),default:b((()=>[(w(),p("a",{class:"mx-2 app-access-link",key:t,href:t,target:"_blank"},y(t),9,wa)),e.isAppRunning&&g(i)?(w(),D(X,{key:0,size:"small",color:g(a).PRIMARY_COLOR},{default:b((()=>[h(y(e.$t("AppRunningWindow.Starting")),1)])),_:1},8,["color"])):m("",!0)])),_:2},1024)])),_:2},1024)))),128))])),_:1})])),_:1}),u("div",Aa,y(e.$t("AppRunningWindowV2.AccessNote")),1)])),_:1},8,["title"])):m("",!0)}}}),Sa=d({__name:"app-env-row-v2",props:{installedInstance:{},appEnv:{}},setup(e){const a=c(null);A((async()=>{a.value=await i()}));const t=e=>"HF_MIRROR"===e?"HF_ENDPOINT":e;return(e,n)=>(w(),D(ha,{title:e.$t("AppRunningWindow.EnvVars"),showExpandIcon:!0,value:"app-env"},{default:b((()=>[v(ee,{class:"my-1 pt-2 pb-0 mx-0"},{default:b((()=>[(w(!0),p(f,null,C(g(a),((e,a)=>(w(),D(X,{variant:"tonal",size:"small",style:{"min-width":"50px","max-width":"190px","margin-left":"4px"},key:a},{default:b((()=>[h(y(t(a))+" ",1),v(V,{activator:"parent",location:"bottom"},{default:b((()=>[h(y(e),1)])),_:2},1024)])),_:2},1024)))),128)),(w(!0),p(f,null,C(e.appEnv,((e,a)=>(w(),D(X,{variant:"tonal",color:"orange-darken-4",size:"small",style:{"min-width":"50px","max-width":"220px","margin-left":"4px"},key:a},{default:b((()=>[h(y(a)+" ",1),v(V,{activator:"parent",location:"bottom"},{default:b((()=>[h(y(e),1)])),_:2},1024)])),_:2},1024)))),128))])),_:1})])),_:1},8,["title"]))}}),Ia={key:0,style:{width:"84px"},class:"d-flex flex-column justify-center items-center"},Da={class:"progress-text"},xa=d({__name:"download-progress",props:{downloadInfo:{}},setup:e=>(e,t)=>e.downloadInfo?(w(),p("div",Ia,[v($,{width:"100%",class:"download-progress-bar","bg-color":"#D8D8D8","bg-opacity":"1","buffer-color":"#DFDFEC","buffer-opacity":"1",opacity:"1",color:g(a).PRIMARY_COLOR,height:"3",max:1,min:0,"model-value":e.downloadInfo.percent,rounded:""},null,8,["color","model-value"]),u("div",Da,[h(y(e.$t("AppRunningWindowV2.Downloading"))+" ",1),e.downloadInfo.percent?(w(),p(f,{key:0},[h(y(Math.floor(100*e.downloadInfo.percent))+"% ",1)],64)):m("",!0)])])):m("",!0)}),ba=Ae(d({__name:"delete-confirm-dialog",props:{modelValue:{type:Boolean},itemName:{}},emits:["update:modelValue","confirm"],setup(e,{emit:a}){const t=e,n=a,l=c(!1);k((()=>l.value),(e=>{n("update:modelValue",e)})),k((()=>t.modelValue),(e=>{l.value=e}));const s=()=>{l.value=!1},o=async()=>{n("confirm"),s()};return(e,a)=>(w(),D(U,{modelValue:g(l),"onUpdate:modelValue":a[0]||(a[0]=e=>R(l)?l.value=e:null),"max-width":"400"},{default:b((()=>[v(W,null,{default:b((()=>[v(ae,{class:"headline"},{default:b((()=>[h(y(e.$t("AppRunningWindow.ConfirmDelete")),1)])),_:1}),v(B,null,{default:b((()=>[h(y(e.$t("AppRunningWindow.ConfirmDeleteMsg"))+" ",1),a[1]||(a[1]=u("br",null,null,-1)),h(" "+y(e.itemName),1)])),_:1}),v(O,{class:"justify-center mb-2"},{default:b((()=>[v(P,{variant:"outlined",onClick:s},{default:b((()=>[h(y(e.$t("AppRunningWindow.Cancel")),1)])),_:1}),v(P,{variant:"flat",color:"#F2313F",onClick:o},{default:b((()=>[h(y(e.$t("AppRunningWindow.ModelDeleteBtnLabel")),1)])),_:1})])),_:1})])),_:1})])),_:1},8,["modelValue"]))}}),[["__scopeId","data-v-2e8b336e"]]),Ra={key:0},ka={class:"model-storage-title d-flex flex-row align-baseline"},Ea={class:""},Ta={class:"justify-center mr-6"},Ma={class:"d-flex"},Ca={style:{flex:"1"}},Na={class:"d-flex"},$a={class:"d-flex flex-row mt-1",style:{"font-size":"14px"}},La={style:{flex:"1"}},Pa=d({__name:"model-storage",props:{installedInstance:{},appEnv:{}},setup(e){const a=e,t=c(""),n=c(""),l=c(""),o=c(0),i=c(null);A((async()=>{Te.appIsOllama(a.installedInstance?.installName)&&(await f(),_())}));const r=c(null),{t:d}=L(),f=async()=>{const e=await ye();n.value=e+"/.ollama/models"},_=async()=>{const e=await Te.getModelsDir(a.installedInstance?.installName,a.appEnv);console.log("dir",e),t.value=e||n.value,console.log("modelDir.value",t.value);const l=await Te.getModelFileSize(a.installedInstance?.installName,t.value);l.dirSize&&(r.value=Ne(l.dirSize),i.value=l,console.log("dirInfo",l),S())},S=()=>{if(!i.value)return;let e=0;try{e=i.value?.totalSpace-i.value.dirSize-i.value.freeSpace,o.value=i.value?.totalSpace-i.value.freeSpace}catch(s){console.error("calculate error",s)}const a=Ne(e),t=Ne(i.value.freeSpace),n=`${d("AppRunningWindow.StorageModelsSize")}: ${r.value},\n  ${d("AppRunningWindow.StorageDiskOther")}: ${a},\n  ${d("AppRunningWindow.StorageDiskFreeSpace")}: ${t}\n  `;l.value=n};k((()=>a.appEnv),(e=>{_()})),k((()=>a.installedInstance),(e=>{_()}));const I=async()=>{s(t.value)};return(e,a)=>g(r)?(w(),p("div",Ra,[u("div",ka,[u("div",Ea,y(e.$t("AppRunningWindow.ModelStorageLabel")),1),v(K),u("div",Ta,[v(ga,{installedInstance:e.installedInstance},null,8,["installedInstance"])])]),v(ee,{class:"mt-3 pb-3 px-5"},{default:b((()=>[u("div",Ma,[u("div",null,[v(N,{src:"./images/icons/harddisk.svg",class:"mr-1",width:"72",height:"34"})]),u("div",Ca,[u("div",Na,[v(V,{text:g(l),location:"top"},{activator:b((({props:e})=>[v($,T({class:"custom-progress-bar"},e,{location:null,"bg-color":"#FFFFFF","bg-opacity":"1","buffer-color":"#DFDFEC","buffer-opacity":"1",opacity:"1",color:"#FEF1E5",height:"14",max:g(i)?.totalSpace||10,min:"0","buffer-value":g(o),"model-value":g(i)?.dirSize,rounded:""}),null,16,["max","buffer-value","model-value"])])),_:1},8,["text"])]),u("div",$a,[u("div",La,y(g(i)?.diskName),1),u("a",{href:"#",style:{"text-decoration":"none",color:"rgba(0, 0, 0, 0.75)"},onClick:E(I,["prevent"])},[h(y(g(r))+" > ",1),g(t)?(w(),D(V,{key:0,activator:"parent",location:"top"},{default:b((()=>[h(y(g(t)),1)])),_:1})):m("",!0)])])])])])),_:1})])):m("",!0)}}),Oa="http://localhost:11434";class Va{constructor(e,a){if(this.paramSize=e,this.updateUI=a,!e.nameAndSize)throw new Error("nameAndSize is empty");this.nameAndSize=e.nameAndSize}totalPercentageWithoutCurrent=.01;totalPercentage=.01;pullingMainPart="";pullingCurrentPart="";nameAndSize="";async download(e){const a=e.signal,t=await fetch(`${Oa}/api/pull`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:this.nameAndSize,stream:!0}),signal:a});if(!t.ok)throw new Error(`HTTP error: ${t.status}`);if(!t.body)throw new Error("No response body");const n=t.body.getReader(),l=new TextDecoder;let s="";for(;;){const{done:e,value:a}=await n.read();if(e)break;s+=l.decode(a);const t=s.split("\n");s=t.pop()||"";for(const n of t)if(n.trim())try{const e=JSON.parse(n);this.processProgress(e)}catch(o){console.error("Parse error:",o)}}}calculatePercentage(e,a,t){let n=this.totalPercentageWithoutCurrent;if(e&&e.completed&&e.total){n+=e.completed/e.total*a,n>.99&&(n=.99),n>=this.totalPercentage&&(this.totalPercentage=n)}t&&this.totalPercentage>=this.totalPercentageWithoutCurrent&&(this.totalPercentageWithoutCurrent=this.totalPercentage)}processProgress(e){const a=e?.status||"";let t=.02;if("pulling manifest"===a)t=.01;else if(a.startsWith("downloading")||a.startsWith("pulling")){void 0!==e.total&&void 0!==e.completed&&(!this.pullingMainPart&&e.total>5242880&&(this.pullingMainPart=a),this.pullingMainPart===a&&(t=.89));let n=!1;this.pullingCurrentPart!==a&&(this.pullingCurrentPart=a,n=!0),this.calculatePercentage(e,t,n)}else"success"===a&&(this.totalPercentage=1);this.updateUI&&this.updateUI(this.paramSize,this.totalPercentage)}}const{addToast:Ua}=e(),Wa=r("modelDownloadInfo",{state:()=>({models:c([]),parameterSizes:c([]),downloadSuccessMsg:c(""),cancelDownloadMsg:c(""),fetchAbortControllers:c(new Map)}),actions:{initModelsData(){this.models=[],this.parameterSizes=[]},updateUI(e,a){const t=e.downloadProgress;t&&(t.percent=a,1===a&&(e.installed=!0,this.downloadSuccessMsg&&Ua(this.downloadSuccessMsg,"success")))},onDownloadError(e){console.error("Failed to download model",e);let a=e.message;"BodyStreamBuffer was aborted"===a&&(a=this.cancelDownloadMsg),Ua(a,"error")},async startDownload(e,a){a.nameAndSize=e,a.downloadProgress={nameAndSize:e,percent:0},this.updateUI(a,.01);const t=await(async(e,a,t)=>{const n=new AbortController;return new Va(e,a).download(n).catch((e=>{t&&(console.error("download err",e),t(e))})),n})(a,this.updateUI,this.onDownloadError);this.fetchAbortControllers.set(a.nameAndSize,t)},async cancelDownload(e,a){const t=Ce.genModelNameAndSize(e,a);try{const e=this.fetchAbortControllers.get(t);e?.abort()}catch(n){console.log("cancel err",n)}try{await(async e=>{const a=await fetch(`${Oa}/api/pull`,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e})});if(!a.ok)throw new Error(`HTTP error: ${a.status}`);if(!a.body)throw new Error("No response body");const t=await a.json();t.error?console.error("cancel error",t.error):console.log("cancel done",t)})(t)}catch(n){console.error(n)}finally{a.installed=!1,a.downloadProgress&&(a.downloadProgress.percent=void 0)}},async deleteModel(e,a){const t=Ce.genModelNameAndSize(e,a);try{await(async e=>{const a=await fetch(`${Oa}/api/delete`,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e})});if(!a.ok)throw new Error(`HTTP error: ${a.status}`);if(!a.body)throw new Error("No response body");const t=await a.json();t.error?console.error("del error",t.error):console.log("del done",t)})(t)}catch(n){console.error(n)}finally{a.installed=!1,a.downloadProgress&&(a.downloadProgress.percent=void 0)}}}}),Fa={key:0,class:"text-center py-10",style:{flex:"1"}},za={class:"d-flex flex-row justify-center"},ja={style:{"min-width":"46px",display:"inline-block"}},Ba={style:{"min-width":"60px",display:"inline-block"}},Ha={key:0,class:"installed-chip"},Ga={key:1,class:"not-installed-chip"},Ka=d({__name:"model-download-row-v2",props:{lmAppData:{},installedInstance:{},appEnv:{}},setup(e){const a=Wa(),t=c(!1),n=c(null),l=c(null),s=c(!1),o=c(""),{t:i}=L(),r=e;A((async()=>{d(),a.downloadSuccessMsg=i("AppRunningWindow.ModelDownloadSuccessful"),a.cancelDownloadMsg=i("AppRunningWindowV2.DownloadCanceled"),await S()})),k((()=>r.lmAppData),(()=>{d()})),k((()=>r.installedInstance),(()=>{S()})),k((()=>r.appEnv),(()=>{S()}));const d=()=>{t.value=Te.appIsOllama(r.lmAppData?.installName)};k(n,(()=>{_()}));const _=()=>{const e=n.value,t=a.models.find((a=>a.installName===e)),l=t?.tags||[];a.parameterSizes=l},S=async()=>{const e=r.installedInstance?.installName;if(e&&t.value){a.initModelsData();const t=ua.getDownloadableModels(),l=await Te.mergeModelsList(e,t);if(a.models=l,n.value)_();else{const e=a.models;if(e&&e.length>0){const a=e[0];n.value=a.installName}}}},I=async()=>{n.value&&l.value&&a.deleteModel(n.value,l.value)},x=e=>{const a=e.downloadProgress;return!!(a?.percent&&a.percent<1)},R=e=>{const a=e.tags;if(a&&a.length>0)for(let t=0;t<a.length;t++){if(a[t].installed)return!0}};return(e,i)=>{const r=xa;return w(),p(f,null,[e.lmAppData&&g(t)?(w(),D(ha,{key:0,class:"model-download-panel",showExpandIcon:!0,value:"model-download",title:e.$t("AppRunningWindow.ModelDownload")},{default:b((()=>[v(ee,{class:"model-download-sheet d-flex flex-row"},{default:b((()=>[g(a).models&&0!==g(a).models.length?m("",!0):(w(),p("div",Fa,[v(te,{color:"primary",indeterminate:"",size:"40"})])),g(a).models&&g(a).models.length>0?(w(),D(q,{key:1,style:{"border-right":"1px solid #EBEBF7",flex:"1",padding:"0"},"max-height":"340"},{default:b((()=>[(w(!0),p(f,null,C(g(a).models,((e,a)=>(w(),D(Z,{key:e.installName+a,density:"compact","active-class":"selected-model-item",onClick:a=>{var t;(t=e.installName)!==n.value&&(n.value=t)},active:g(n)===e.installName,title:e.displayName,value:e.installName},{append:b((()=>[R(e)?(w(),D(j,{key:0,class:"downloaded-icon",icon:"mdi-check-bold",size:"18"})):m("",!0)])),_:2},1032,["onClick","active","title","value"])))),128))])),_:1})):m("",!0),g(a).models&&g(a).models.length>0?(w(),D(q,{key:2,style:{flex:"1",padding:"0"}},{default:b((()=>[(w(!0),p(f,null,C(g(a).parameterSizes,((t,i)=>(w(),D(Z,{key:t.parameterSize+i,density:"compact",active:!1,value:t.parameterSize},{default:b((()=>[u("div",za,[u("span",ja,y(t.parameterSize),1),u("span",Ba,[v(X,{density:"compact",class:"mx-1 file-size-chip"},{default:b((()=>[h(y(t.fileSize),1)])),_:2},1024)]),v(K,{style:{flex:"1"}}),t.installed?(w(),p("div",Ha,y(e.$t("AppRunningWindow.ModelDownloaded")),1)):(w(),p(f,{key:1},[x(t)?(w(),D(r,{key:0,"download-info":t.downloadProgress},null,8,["download-info"])):(w(),p("div",Ga,y(e.$t("AppRunningWindow.ModelNotDownloaded")),1))],64)),v(K,{style:{flex:"1"}}),t.installed?(w(),D(P,{key:2,onClick:e=>(e=>{if(!n.value)return;const a=Ce.genModelNameAndSize(n.value,e);l.value=e,s.value=!0,o.value=a})(t),variant:"text",density:"compact",color:"#F2313F"},{default:b((()=>[h(y(e.$t("AppRunningWindow.ModelDeleteBtnLabel")),1)])),_:2},1032,["onClick"])):(w(),p(f,{key:3},[x(t)?(w(),D(P,{key:0,onClick:e=>(async e=>{n.value&&a.cancelDownload(n.value,e)})(t),variant:"text",density:"compact"},{default:b((()=>[h(y(e.$t("AppRunningWindow.Cancel")),1)])),_:2},1032,["onClick"])):(w(),D(P,{key:1,onClick:e=>(async e=>{if(!n.value)return;const t=Ce.genModelNameAndSize(n.value,e);a.startDownload(t,e)})(t),variant:"text",class:"model-download-btn",density:"compact"},{default:b((()=>[h(y(e.$t("AppRunningWindow.ModelDownloadBtnLabel")),1)])),_:2},1032,["onClick"]))],64))])])),_:2},1032,["value"])))),128))])),_:1})):m("",!0)])),_:1}),v(ee,{style:{"border-top":"1px solid #EBEBF7"}},{default:b((()=>[v(Pa,{appEnv:e.appEnv,installedInstance:e.installedInstance},null,8,["appEnv","installedInstance"])])),_:1})])),_:1},8,["title"])):m("",!0),v(ba,{"model-value":g(s),"onUpdate:modelValue":i[0]||(i[0]=e=>s.value=e),"item-name":g(o),onConfirm:I},null,8,["model-value","item-name"])],64)}}}),Ja=d({__name:"app-env-and-access-v2",props:{installedInstance:{},lmAppData:{},isAppRunning:{type:Boolean}},emits:["appEnvSavedAndUpdated"],setup(e,{expose:a,emit:t}){const n=e,l=He(),s=c({}),o=c(["app-access"]),i=c(void 0),r=t;A((async()=>{u(),p()}));const d=S(),p=()=>{d.query.script===re.DOWNLOAD_MODEL&&(o.value=["app-access","model-download"])},u=async()=>{const e=n.installedInstance?.installName;Te.appIsOllama(e)&&(s.value=await ua.getOSEnvObj()||{},f())};a({updateAppEnvData:u}),k((()=>n.installedInstance),(()=>{u()})),k((()=>l.appSettingsSaved),(async e=>{e&&(s.value=null,await u(),r("appEnvSavedAndUpdated",s.value))}));const f=async()=>{const e=s.value;e.OLLAMA_MODELS&&(i.value=await _e(e.OLLAMA_MODELS))};return(e,a)=>{const t=_a;return g(s)&&e.installedInstance?(w(),D(ne,{key:0,multiple:"",elevation:"0",modelValue:g(o),"onUpdate:modelValue":a[0]||(a[0]=e=>R(o)?o.value=e:null),class:"lmd-running-panels"},{default:b((()=>[v(t,{appEnv:g(s),isAppRunning:e.isAppRunning,lmAppData:e.lmAppData,installedInstance:e.installedInstance},null,8,["appEnv","isAppRunning","lmAppData","installedInstance"]),!1===g(i)?(w(),D(B,{key:0,class:"pt-0 mt-0 px-2",style:{color:"red","justify-items":"center","align-items":"center"}},{default:b((()=>[v(j,{style:{opacity:"1"},icon:"mdi-information-slab-circle-outline"}),h(" "+y(e.$t("AppRunningWindowV2.ModelDirNotFound")),1)])),_:1})):m("",!0),v(Ka,{appEnv:g(s),installedInstance:e.installedInstance,lmAppData:e.lmAppData},null,8,["appEnv","installedInstance","lmAppData"]),v(Sa,{appEnv:g(s),installedInstance:e.installedInstance},null,8,["appEnv","installedInstance"])])),_:1},8,["modelValue"])):m("",!0)}}}),qa={class:"d-flex flex-column text-center justify-center align-middle"},Ya={style:{width:"60px",margin:"0 auto"},class:"mt-10"},Qa={class:"d-flex flex-column justify-center"},Za=d({__name:"app-info-left",props:{lmAppData:{},installedInstance:{},isAppRunning:{type:Boolean}},emits:["startApp","stopApp"],setup(e,{emit:a}){const t=e,n=a,{t:l}=L(),s=I((()=>t.installedInstance?.installMethod===ce.DOCKER?l("LMAppDetail.DockerMode"):""));return(e,a)=>(w(),D(ee,{class:"left-app-basic-info"},{default:b((()=>[u("div",qa,[u("div",Ya,[v(N,{src:e.lmAppData?.icon,rounded:"",width:"60",height:"60"},null,8,["src"])]),u("div",Qa,[v(ae,{class:"pt-1 pb-0"},{default:b((()=>[h(y(e.lmAppData?.name),1)])),_:1}),e.installedInstance?.version&&"--"!==e.installedInstance?.version?(w(),D(le,{key:0,class:"py-0"},{default:b((()=>[h(y(e.$t("AppRunningWindow.Version"))+" "+y(e.installedInstance?.version),1)])),_:1})):m("",!0),v(B,null,{default:b((()=>[g(s)?(w(),D(X,{key:0,density:"default",variant:"flat",size:"small",color:"#086dd7"},{default:b((()=>[h(y(g(s)),1)])),_:1})):m("",!0),v(K,{class:"mt-6"}),e.isAppRunning?(w(),D(P,{key:1,variant:"flat",color:"#F2313F",class:"mx-2",width:"80",height:"40",onClick:a[0]||(a[0]=e=>{n("stopApp")})},{default:b((()=>[h(y(e.$t("AppRunningWindow.Stop")),1)])),_:1})):(w(),D(P,{key:2,color:"primary",variant:"flat",class:"mx-2",width:"80",height:"40",onClick:a[1]||(a[1]=e=>{n("startApp")})},{default:b((()=>[h(y(e.$t("AppRunningWindow.Start")),1)])),_:1}))])),_:1})])])])),_:1}))}}),Xa={style:{flex:"1"}},et={class:"pa-6 run-right-content"},at={class:"footer-button-bar"},tt={class:"footer-terminal-content"},nt=d({__name:"app-run",setup(a){const n=S(),l=De(),s=c(null),o=c(),i=c(),r=c(null),d=c(!1),_=c(!1),R=c(""),{t:k}=L(),{addToast:E}=e(),T=He(),M=c(!1);A((async()=>{U();const e=n.params.id,a=await oe(e);r.value=a;const t=a.appId;await l.fetchApp(t),s.value=l.currentLmApp,window.ipcRenderer?.on(pe.STOP_AI_RUNNING_INSTANCE,(()=>{j(),B()})),C()}));const C=()=>{const e=s?.value?.name;document.title=`[${k("LMAppDetail.RunApp")}] ${e}`},$=()=>{console.log("onTerminalReady"),G()},O=I((()=>{if(s.value?.id&&r.value?.id)return ta.genWSUrl(s.value?.id,r.value?.id,la)})),V=I((()=>{if(T.terminals&&T.terminals.length>0)return T.terminals[0]})),U=()=>{const e=k("AppRunningWindow.MainProcessTab");T.initTerminal(e)},W=async()=>{var e;if(e=re.START,R.value=e,T.changeMainTerminalScriptType(e,""),d.value=!0,s.value&&r.value){let e=await(async(e,a)=>{const n=e.installName,l=(await t()).LMD_SCRIPTS_DIR,{repoUrl:s,repoLocalFolderName:o}=Ge.getLMDScriptRepoUrl(e);return`\nexport LMD_BASE_INSTALL_SCRIPT_DIR="${l}/${o}"\n${Ye(s)}\n${await qe.genSetPortCommand(e)}\nsh "$LMD_BASE_INSTALL_SCRIPT_DIR/apps/${n}/${"docker"===a?.installMethod?"start-d.sh":"start.sh"}"`})(s.value,r.value);const a=n.query.module;if(console.log("route.params.module",a),a){e=`\nexport LMD_LAUNCH_APP_MODULE=${a}\n`+e}z(e),window.ipcRenderer?.send(pe.RUNNING_STATUS_CHANGE,!0)}},F=()=>Array.isArray(o.value)?o.value[0]:o.value,z=e=>{const a=F();console.log("run command",a,e),a?.runCommand(e)},j=()=>{d.value=!1,F()?.runStopCommand(),window.ipcRenderer.send(pe.RUNNING_STATUS_CHANGE,!1)},B=()=>{F()?.exitTerminal()},H=e=>{if(se.isWindows())return;j();const a=(e=>{let a="";if(e)for(const t in e)a+=`${t}=${e[t]}\n`;return a})(e);F()?.runCommand(a),W()},G=async()=>{if(W(),Te.needPreStartApp(r.value?.installName))return se.isMacOS()?void setTimeout((()=>{K()}),20):void 0;K()},K=()=>{_.value=!0},J=e=>{console.log("onCommandExecuteEnd",e),e&&E(e,"success"),setTimeout((()=>{i.value?.updateAppEnvData()}),400)},q=e=>{e.includes("lmdevent:docker_run_error")&&E(k("AppRunningWindowV2.docker_run_error"),"error",6e3)};return(e,a)=>(w(),p(f,null,[u("div",Xa,[v(Za,{"lm-app-data":g(s),"is-app-running":g(d),onStopApp:j,onStartApp:W,"installed-instance":g(r)},null,8,["lm-app-data","is-app-running","installed-instance"]),u("div",et,[g(r)&&g(s)&&g(_)?(w(),D(Ja,{key:0,ref_key:"appEnvAndAccessComponent",ref:i,onAppEnvSavedAndUpdated:H,isAppRunning:g(d),lmAppData:g(s),installedInstance:g(r)},null,8,["isAppRunning","lmAppData","installedInstance"])):m("",!0)])]),u("footer",{class:x(["footer-terminal","app-run-footer-terminal",g(M)?"expanded":""])},[u("div",at,[v(P,{variant:"text",style:{position:"absolute",right:"10px",top:"5px"},onClick:a[0]||(a[0]=e=>M.value=!g(M))},{append:b((()=>[v(N,{src:g(M)?"./images/icons/expand-white.svg":"./images/icons/collapse-white.svg",width:"18",height:"18"},null,8,["src"])])),default:b((()=>[h(y(g(M)?e.$t("AppRunningWindowV2.Hide"):e.$t("AppRunningWindowV2.ViewLog"))+" ",1)])),_:1})]),u("div",tt,[g(O)&&g(V)&&"main-process"===g(V).tabName?(w(),D(ea,{key:0,socketURI:g(O),onExecuteEnd:a[1]||(a[1]=e=>{return a=g(V).commandExecuteEndToastMsg,K(),console.log("onMainTerminalCommandEnd"),void J(a);var a}),"command-execute-end-keywords":g(V).commandExecuteEndKeywords,ref_key:"generalTerminal",ref:o,events:["lmdprogress","lmdevent:docker_run_error"],onReady:$,onTerminalEvent:q},null,8,["socketURI","command-execute-end-keywords"])):m("",!0)])],2)],64))}}),lt={class:"app-install-result pt-10 pb-6 px-11 mb-12 mx-10"},st=d({__name:"install-result",props:{lmAppData:{},installedInstance:{}},setup(e){const a=e,t=()=>{a.installedInstance.appInstallPath&&s(a.installedInstance.appInstallPath)};return(e,a)=>(w(),p("div",lt,[v(Y,{class:"gap-2 mb-2"},{default:b((()=>[v(Q,{cols:"12",xs:"12",sm:"6",md:"6",lg:"6",class:"item"},{default:b((()=>[h(y(e.$t("AppRunningWindowV2.AppNameLabel"))+": "+y(e.lmAppData.name),1)])),_:1}),v(Q,{cols:"12",xs:"12",sm:"6",md:"6",lg:"6",class:"item"},{default:b((()=>[h(y(e.$t("AppRunningWindowV2.AppInstallTimeLabel"))+": "+y(g($e).format(e.installedInstance.createTime,!1)),1)])),_:1}),v(Q,{cols:"12",xs:"12",sm:"6",md:"6",lg:"6",class:"item"},{default:b((()=>[h(y(e.$t("AppRunningWindowV2.AppInstallLocationLabel"))+": ",1),u("a",{href:"#",onClick:E(t,["prevent"])},y(e.installedInstance.appInstallPath),1)])),_:1})])),_:1})]))}}),{addToast:ot}=e(),it=r("appInstall",{state:()=>({installPercent:c(0),installSuccessMsg:c(""),installed:c(!1)}),actions:{initModelsData(){this.installPercent=0},updateUI(e){this.installPercent=e,1===e&&(this.installed=!0,this.installSuccessMsg&&ot(this.installSuccessMsg,"success"))},onDownloadError(e){console.error("Failed to download App",e),ot(e.message,"error")}}}),rt={class:"progress-area"},ct={style:{width:"210px"}},dt={key:0,style:{width:"250px"},class:"mt-6"},pt={class:"progress-msg mb-8 mt-6"},ut={class:"progress-msg-title"},mt={class:"progress-msg-title"},vt=d({__name:"install-progress",props:{lmAppData:{},instanceData:{}},setup(e){const t=it(),n=e,{t:l}=L(),s=I((()=>"docker"===n.instanceData?.installMethod?l("LMAppDetail.DockerMode"):""));return(e,l)=>(w(),p("div",rt,[u("div",ct,[v(N,{src:g(t).installed?"./images/app/succes.svg":"./images/app/processing.svg",width:"210",height:"140"},null,8,["src"])]),g(t).installed?m("",!0):(w(),p("div",dt,[v($,{width:"100%",class:"download-progress-bar","bg-color":"#F2F2FA","bg-opacity":"1","buffer-color":"#DFDFEC","buffer-opacity":"1",opacity:"1",color:g(a).PRIMARY_COLOR,height:"14",max:100,min:0,"model-value":g(t).installPercent,rounded:""},null,8,["color","model-value"])])),u("div",pt,[g(t).installed?(w(),p(f,{key:1},[u("div",mt,y(e.$t("AppRunningWindowV2.InstallSuccessTitle")),1),u("div",null,[Te.appIsOllama(n.lmAppData?.installName)?(w(),p(f,{key:0},[h(y(e.$t("AppRunningWindowV2.InstallSuccessNextTipForOllama")),1)],64)):(w(),p(f,{key:1},[h(y(e.$t("AppRunningWindowV2.InstallSuccessNextTip")),1)],64))])],64)):(w(),p(f,{key:0},[u("div",ut,y(e.lmAppData?.name),1),g(s)?(w(),D(X,{key:0,class:"mt-1 mb-3",density:"default",size:"small",color:"#086dd7"},{default:b((()=>[h(y(g(s)),1)])),_:1})):m("",!0),u("div",null,y(e.$t("AppRunningWindowV2.InstallingMsg"))+" "+y(g(t).installPercent)+"% ",1)],64))])]))}}),gt={class:"app-install-container"},ft={class:"install-steps"},ht={class:"pa-6 install-right-content"},yt={class:"footer-button-bar"},wt=d({__name:"app-install",setup(a){const{t:n}=L(),l=He(),s=c(""),o=De(),i=c(null),r=S(),d=c(null),f=c(),_=it(),R=c(!1),{addToast:k}=e();A((async()=>{C();const e=r.params.id,a=await oe(e);d.value=a;const t=a.appId;await o.fetchApp(t),i.value=o.currentLmApp,window.ipcRenderer?.on(pe.STOP_AI_RUNNING_INSTANCE,(()=>{W(),F()})),E()}));const E=()=>{const e=i?.value?.name;document.title=`[${n("LMAppDetail.install")}] ${e}`},T=()=>{console.log("onTerminalReady"),$()},M=I((()=>{if(i.value?.id&&d.value?.id)return ta.genWSUrl(i.value.id,d.value.id,na)})),C=()=>{const e=n("AppRunningWindow.MainProcessTab");l.initTerminal(e)},$=async()=>{var e;if(console.log("installApp"),e=re.INSTALL,s.value=e,console.log("changeMainTerminalScriptType",e,""),l.changeMainTerminalScriptType(e,""),i.value&&d.value){const e=await(async(e,a)=>{const n=e.installName,l=(await t()).LMD_SCRIPTS_DIR,{repoUrl:s,repoLocalFolderName:o}=Ge.getLMDScriptRepoUrl(e),i=Ye(s);return console.log("repoLocalFolderName",o),`\nexport LMD_BASE_INSTALL_SCRIPT_DIR="${l}/${o}"\n${i}\nsh "$LMD_BASE_INSTALL_SCRIPT_DIR/apps/${n}/${"docker"===a?.installMethod?"install-d.sh":"install.sh"}"`})(i.value,d.value);V(e)}Se()},V=e=>{const a=U();console.log("run command",a,e),a?.runCommand(e)},U=()=>Array.isArray(f.value)?f.value[0]:f.value,W=()=>{U()?.runStopCommand(),window.ipcRenderer.send(pe.RUNNING_STATUS_CHANGE,!1)},F=()=>{U()?.exitTerminal()},z=e=>{if(e.includes("lmdevent:docker_run_error"))return void k(n("AppRunningWindowV2.docker_run_error"),"error",6e3);const a=aa.extractProgress(e);a&&(_.installPercent=a,100===a&&(_.installed=!0,Ie()))},j=()=>{console.log("installedInstance",d.value?.id),d.value?.id&&ue(d.value.id)},B=()=>{d.value&&de.goToRunningPage(d.value.id,re.START,d.value.installName)};return(e,a)=>{const t=vt,n=st;return w(),p("div",gt,[u("div",ft,[u("div",ht,[g(i)?(w(),D(t,{key:0,"instance-data":g(d),"lm-app-data":g(i)},null,8,["instance-data","lm-app-data"])):m("",!0),g(d)&&g(i)&&g(_).installed?(w(),D(n,{key:1,lmAppData:g(i),installedInstance:g(d)},null,8,["lmAppData","installedInstance"])):m("",!0),u("div",{class:x(["footer-terminal","app-install-footer-terminal",g(R)?"expanded":""])},[u("div",yt,[v(P,{variant:"text",style:{position:"absolute",right:"10px",top:"5px"},onClick:a[0]||(a[0]=e=>R.value=!g(R))},{append:b((()=>[v(N,{src:g(R)?"./images/icons/expand-white.svg":"./images/icons/collapse-white.svg",width:"18",height:"18"},null,8,["src"])])),default:b((()=>[h(y(g(R)?e.$t("AppRunningWindowV2.Hide"):e.$t("AppRunningWindowV2.ViewLog"))+" ",1)])),_:1})]),g(M)?(w(),D(ea,{key:0,ref_key:"generalTerminal",ref:f,events:["lmdprogress","lmdevent:docker_run_error"],onTerminalEvent:z,onReady:T,socketURI:g(M)},null,8,["socketURI"])):m("",!0)],2)])]),v(O,{style:{"border-top":"1px solid #EBEBF7"},class:"py-6 text-center justify-center"},{default:b((()=>[v(P,{variant:"outlined",onClick:j},{default:b((()=>[h(y(e.$t("Common.close")),1)])),_:1}),Te.appIsOllama(i.value?.installName)?(w(),D(P,{key:0,variant:"flat",disabled:!g(_).installed,onClick:B,color:"primary"},{default:b((()=>[h(y(e.$t("AppRunningWindowV2.NextStep")),1)])),_:1},8,["disabled"])):m("",!0)])),_:1})])}}}),At=d({__name:"AppRunningWindowV2",setup(e){const a=c(""),t=S();return A((()=>{const e=t.query.script;e===re.INSTALL?a.value="install":e===re.START||e===re.DOWNLOAD_MODEL?a.value="run":e===re.REMOVE&&(a.value="remove")})),(e,t)=>{const n=wt,l=nt,s=da;return w(),p(f,null,["install"===g(a)?(w(),D(n,{key:0})):m("",!0),"run"===g(a)?(w(),D(l,{key:1})):m("",!0),"remove"===g(a)?(w(),D(s,{key:2})):m("",!0)],64)}}});export{At as default};
