import{b as e,T as a,g as t,f as n,d as l,o as s,h as o}from"./index.js";import{d as i}from"./pinia.js";import{b as r,e as c,a4 as d,a3 as p,a6 as u,k as m,u as v,F as g,S as f,K as y,a1 as h,H as A,Z as w,ac as _,c as I,a0 as S,a9 as D,a2 as x,j as b,l as R,V as E,m as k,a5 as T,ab as C}from"./vue.js";import{b as M,m as $,G as N,q as L,E as P,n as O,z as V,A as U,O as W,e as F,d as z,D as j,o as B,I as H,J as G,P as K,Q as J,F as Y,R as q,c as Q,w as Z,x as X,a as ee,M as ae,l as te,H as ne,S as le,p as se}from"./vuetify.js";import{O as oe,e as ie,d as re,a as ce,I as de,A as pe}from"./OSUtil.js";import{I as ue,d as me,g as ve,e as ge,s as fe,f as ye,D as he,h as Ae,j as we,a as _e,_ as Ie,k as Se,l as De,m as xe}from"./lmd-system.js";import{u as be}from"./index2.js";import{r as Re,a as Ee,b as ke}from"./xterm.js";import{a as Te,b as Ce,A as Me,O as $e,M as Ne}from"./AppInfoUtil.js";import{p as Le}from"./pretty-bytes.js";import{D as Pe}from"./DateTimeUtil.js";import"./debounce.js";import"./vuei18n.js";import"./lmd-locales.js";import"./dayjs.js";const{addToast:Oe}=e(),Ve=i("appRemove",{state:()=>({removePercent:r(0),removeSuccessMsg:r(""),removed:r(!1)}),actions:{initModelsData(){this.removePercent=0},updateUI(e){this.removePercent=e,1===e&&(this.removed=!0,this.removeSuccessMsg&&Oe(this.removeSuccessMsg,"success"))}}}),Ue={class:"progress-area"},We={style:{width:"210px"}},Fe={key:0,style:{width:"250px"},class:"mt-6"},ze={class:"progress-msg mb-8 mt-6"},je={class:"progress-msg-title"},Be={class:"progress-msg-title"},He={class:"mt-3",style:{"font-size":"14px"}},Ge=c({__name:"remove-progress",props:{lmAppData:{}},setup(e){const t=Ve();return(e,n)=>(h(),d("div",Ue,[p("div",We,[m(M,{src:v(t).removed?"./images/my-ai/del-tip.svg":"./images/app/processing.svg",width:"210",height:"140"},null,8,["src"])]),v(t).removed?u("",!0):(h(),d("div",Fe,[m($,{width:"100%",class:"download-progress-bar","bg-color":"#F2F2FA","bg-opacity":"1","buffer-color":"#DFDFEC","buffer-opacity":"1",opacity:"1",color:v(a).PRIMARY_COLOR,height:"14",max:100,min:0,"model-value":v(t).removePercent,rounded:""},null,8,["color","model-value"])])),p("div",ze,[v(t).removed?(h(),d(g,{key:1},[p("div",Be,y(e.$t("AppRunningWindowV2.DeleteSuccessTitle")),1),p("div",He,y(e.$t("AppRunningWindowV2.DeleteSuccessMsg")),1)],64)):(h(),d(g,{key:0},[p("div",je,y(e.lmAppData?.name),1),f(" "+y(e.$t("AppRunningWindowV2.DeletingMsg"))+" "+y(v(t).removePercent)+"% ",1)],64))])]))}}),Ke=i("runningInstance",{state:()=>({runningInstances:[],appSettingsSaved:!1,terminals:[],currentTerminalTab:""}),actions:{addRunningInstance(e){this.runningInstances.find((a=>a.id===e.id))||this.runningInstances.push(e)},removeRunningInstance(e){const a=this.runningInstances.findIndex((a=>a.id===e.id));-1!=a&&this.runningInstances.splice(a,1)},resetAppSettingsSavedStatus(){this.appSettingsSaved=!1},onAppSettingsSaved(){this.appSettingsSaved=!0},changeMainTerminalScriptType(e,a){try{const t=this.terminals[0];t.commandExecuteEndKeywords=[`lmd ${e} script end.`],t.commandExecuteEndToastMsg=a}catch(t){console.error(t)}},initTerminal(e){const a={icon:"mdi-application-brackets-outline",text:e,tabName:"main-process",closable:!1};this.terminals=[a],this.currentTerminalTab=a.tabName},addTerminal(e){this.terminals.find((a=>a.tabName===e.tabName))||(console.log("addTerminal",e.commandExecuteEndKeywords),this.terminals.push(e)),this.currentTerminalTab=e.tabName},removeTerminal(e,a){this.currentTerminalTab="main-process",this.terminals.splice(a,1)},addInstallModelTerminal(e,a,t,n){const l={text:a,tabName:a,initCommand:t,closable:!0,commandExecuteEndKeywords:["digest","writing manifest","success"],commandExecuteEndToastMsg:n};this.addTerminal(l)},addDeleteModelTerminal(e,a,t,n){const l={text:a,tabName:a,initCommand:t,closable:!0,commandExecuteEndKeywords:[`deleted '${e}'`],commandExecuteEndToastMsg:n};this.addTerminal(l)}}});class Je{static getLMDScriptRepoUrl(e){let a="https://gitee.com/lmdown/lmd-install-scripts";if(e?.downloadInfo&&e?.downloadInfo.length>0){a=e.downloadInfo[0].scriptGitRepoUrl}return{repoUrl:a,repoLocalFolderName:this.getLastPathSegment(a)||"lmd-install-scripts"}}static getLastPathSegment(e){const a=e.match(/[^\/?#]+(?=[/?#]*$)/);return a?a[0]:null}}const Ye="browser";class qe{static async isPortInUse(e){const a=`http://127.0.0.1:${e}`;try{const t=await fetch(a,{method:"get",mode:"no-cors",cache:"no-store"});return console.log(`${e} in use`,t.status),t.ok}catch(t){return console.log(`can not access port ${e}`,t),!1}}static async findAvailablePort(e,a){let t=e;for(let l=1;l<=a;l++)try{if(!(await this.isPortInUse(t)))return t;t++}catch(n){console.error(`check port ${t} err`,n),t++}return console.error("no Available port, use default value"),e}}class Qe{static async genSetPortCommand(e){if(e?.accessInfo.accessType===Ye&&this.needCheckPort(e)&&e.accessInfo.webUrl){e.accessInfo.detectAvailablePortDone=!1;const{url:a,port:t}=await Qe.checkPortInUrl(e.accessInfo.webUrl);if(e.accessInfo.detectAvailablePortDone=!0,t)return e.accessInfo.webUrl=a,`export SERVER_PORT=${t}\nexport GRADIO_SERVER_PORT=${t}`}return""}static needCheckPort(e){return["spark-tts","index-tts","f5-tts","framepack","liveportrait","ace-step","cosyvoice","latentsync","notagen"].includes(e.installName)||e?.accessInfo?.detectAvailablePort}static async checkPortInUrl(e){try{const a=new URL(e),t=parseInt(a.port,10);if(isNaN(t))throw new Error("does not contain a valid port");const n=await qe.findAvailablePort(t,20);return a.port=n.toString(),{url:a.toString(),port:n}}catch(a){return console.log("Invalid URL",a),{url:e}}}}const Ze=e=>"0"===n("UPDATE_INSTALL_SCRIPTS")?"":`\ngit clone --depth=1 ${e} "$LMD_BASE_INSTALL_SCRIPT_DIR"\ncd "$LMD_BASE_INSTALL_SCRIPT_DIR" && git fetch origin master && git reset --hard origin/master`;var Xe=Re(),ea=Ee(),aa=ke();const ta=c({__name:"index",props:{socketURI:{},initCommand:{},commandExecuteEndKeywords:{},events:{}},emits:["executeEnd","terminalEvent","ready"],setup(e,{expose:a,emit:t}){const n=t,s=r([]),o=r(!1),i=e,c=r(null),u=r(null),m=r(null),v=r(null);let g;A((()=>{I(),_()})),w((()=>{c.value?.close(),u.value?.dispose(),g&&v.value&&(g.unobserve(v.value),g.disconnect())}));const f=e=>{console.log("runCommand",e),console.log("runCommand socket.value",c.value),c.value?.send(e+"\n")};a({runCommand:f,runStopCommand:()=>{f(""),f("")},exitTerminal:()=>{f("exit")}});const y=l((e=>{for(const a of e){let e=a.contentRect.height;oe.isMacOS()&&(e-=10),k(a.contentRect.width,e)}}),9),_=()=>{m.value&&(g=new ResizeObserver(y),g.observe(m.value))},I=()=>{c.value=new WebSocket(i.socketURI),x(),D(),b(),S()},S=()=>{c.value&&(c.value.onmessage=e=>{const a=e.data,t=i.events;console.log("event data ",e.data),console.log("props.events ",i.events),t&&t.length>0&&t.forEach((e=>{a.includes(e)&&(console.log("emit terminalEvent",a),n("terminalEvent",a))}));const l=i.commandExecuteEndKeywords;l&&(l.forEach((e=>{a.includes(e)&&!s.value.includes(e)&&s.value.push(e)})),s.value.length===l.length&&(n("executeEnd"),o.value=!0,s.value=[]))})},D=()=>{c.value&&(c.value.onopen=()=>{(()=>{if(!v.value)return;if(!c.value)return;const e=new window.Terminal({fontSize:14,cursorBlink:!0}),a=new ea.AttachAddon(c.value),t=new Xe.FitAddon,n=new aa.WebLinksAddon(((e,a)=>{const t=document.createElement("a");t.setAttribute("href",a),t.setAttribute("target","_blank"),t.setAttribute("id","lmdTempLink");const n=document.getElementById("lmdTempLink");n&&document.body.removeChild(n),document.body.appendChild(t),t.click()}));e.loadAddon(a),e.loadAddon(t),e.loadAddon(n),e.open(v.value),t.fit(),u.value=e})(),i.initCommand&&f(i.initCommand),n("ready")})},x=()=>{c.value&&(c.value.onclose=e=>{console.log("close socket",e)})},b=()=>{c.value&&(c.value.onerror=e=>{console.log("socket err",e)})},R=r(80),E=r(30),k=(e,a)=>{const t=Math.floor(e/8.5),n=Math.round(a/16);if(console.log("cols",e,t),console.log("rows",a,n),0!==n&&0!==t&&(R.value!==t||E.value!==n)){R.value=t,E.value=n,u.value?.resize(t,n);const e=`lmd_action:resize:${t},${n}`;c.value?.send(e)}};return(e,a)=>(h(),d("div",{ref_key:"terminalOutContainer",ref:m,class:"mb-0",style:{height:"100%",width:"100%"}},[p("div",{ref_key:"terminalContainer",ref:v,class:"terminal",style:{height:"300px",width:"100%"}},null,512)],512))}});class na{static extractProgress(e){let a=null;try{const t=/lmdprogress:(\d+)/g;let n;for(;null!==(n=t.exec(e));)a=parseInt(n[1],10)}catch(t){console.error("parse err",t)}return a}}class la{static genWSUrl(e,a,t){return`ws://localhost:19312/?appId=${e}&installedInstanceId=${a}&runningLogType=${t}`}}const sa="install",oa="run",ia="delete",ra={class:"app-install-container"},ca={class:"install-steps"},da={class:"pa-6 install-right-content"},pa={class:"footer-button-bar"},ua=c({__name:"app-remove",setup(a){const{t:n}=N(),l=Ke(),s=r(""),o=be(),i=r(null),c=_(),g=r(null),w=r(),b=Ve(),R=r(!1),{addToast:E}=e();A((async()=>{C();const e=c.params.id;let a;try{a=await ie(e)}catch(s){return console.log(s),void E(n("AppRunningWindowV2.DeleteNotFound"),"error")}g.value=a;const t=a.appId;await o.fetchApp(t),i.value=o.currentLmApp,window.ipcRenderer?.on(ue.STOP_AI_RUNNING_INSTANCE,(()=>{U(),W()}));const l=i?.value.name;document.title=`[${n("LocalApps.Delete")}] ${l}`}));const k=I((()=>{if(i.value?.id&&g.value?.id)return la.genWSUrl(i.value?.id,g.value?.id,ia)})),T=()=>{console.log("onTerminalReady"),$()},C=()=>{const e=n("AppRunningWindow.MainProcessTab");l.initTerminal(e)},$=async()=>{var e;if(e=ce.REMOVE,s.value=e,console.log("changeMainTerminalScriptType",e,""),l.changeMainTerminalScriptType(e,""),i.value&&g.value){const e=await(async(e,a)=>{const n=e.installName,l=(await t()).LMD_SCRIPTS_DIR,{repoUrl:s,repoLocalFolderName:o}=Je.getLMDScriptRepoUrl(e),i=Ze(s);console.log("repoLocalFolderName",o);const r="docker"===a?.installMethod?"remove-d.sh":"remove.sh";let c="";return a.instancesCountOfApp>1&&(c="keepmodels"),`\nexport LMD_BASE_INSTALL_SCRIPT_DIR="${l}/${o}"\n${i}\nsh "$LMD_BASE_INSTALL_SCRIPT_DIR/apps/${n}/${r}" ${c}`})(i.value,g.value);O(e)}},O=e=>{const a=V();console.log("run command",a,e),a?.runCommand(e)},V=()=>Array.isArray(w.value)?w.value[0]:w.value,U=()=>{V()?.runStopCommand(),window.ipcRenderer.send(ue.RUNNING_STATUS_CHANGE,!1)},W=()=>{V()?.exitTerminal()},F=e=>{const a=na.extractProgress(e);a&&(b.removePercent=a,100===a&&(b.removed=!0,g.value?.id&&re(g.value?.id)))},z=()=>{g.value?.id&&me(g.value.id)};return(e,a)=>{const t=Ge;return h(),d("div",ra,[p("div",ca,[p("div",da,[v(i)?(h(),S(t,{key:0,"lm-app-data":v(i)},null,8,["lm-app-data"])):u("",!0),p("div",{class:D(["footer-terminal","app-install-footer-terminal",v(R)?"expanded":""])},[p("div",pa,[m(L,{variant:"text",style:{position:"absolute",right:"10px",top:"5px"},onClick:a[0]||(a[0]=e=>R.value=!v(R))},{append:x((()=>[m(M,{src:v(R)?"./images/icons/expand-white.svg":"./images/icons/collapse-white.svg",width:"18",height:"18"},null,8,["src"])])),default:x((()=>[f(y(v(R)?e.$t("AppRunningWindowV2.Hide"):e.$t("AppRunningWindowV2.ViewLog"))+" ",1)])),_:1})]),v(k)?(h(),S(ta,{key:0,ref_key:"generalTerminal",ref:w,events:["lmdprogress"],onTerminalEvent:F,onReady:T,socketURI:v(k)},null,8,["socketURI"])):u("",!0)],2)])]),m(P,{style:{"border-top":"1px solid #EBEBF7"},class:"py-6 text-center justify-center"},{default:x((()=>[m(L,{variant:"outlined",onClick:z},{default:x((()=>[f(y(e.$t("Common.close")),1)])),_:1})])),_:1})])}}}),ma=c({__name:"copy-link-icon",props:{text:{}},setup(e){const a=e,t=r(!1),n=()=>{t.value=!0,navigator.clipboard.writeText(a.text),setTimeout((()=>{t.value=!1}),1500)};return(e,a)=>(h(),S(M,{width:"16",height:"16",onClick:n,src:"./images/icons/link-copy.svg",style:{cursor:"pointer"}},{default:x((()=>[m(O,{activator:"parent","open-on-hover":!1,location:"bottom",transition:"false",modelValue:v(t),"onUpdate:modelValue":a[0]||(a[0]=e=>b(t)?t.value=e:null)},{default:x((()=>[f(y(e.$t("App.Copied")),1)])),_:1},8,["modelValue"])])),_:1}))}});class va{static async getAppSettings(){const e=await this.getOSEnvObj();return{modelsDir:e.OLLAMA_MODELS,externalAccessHost:e.OLLAMA_HOST,externalAccessPath:e.OLLAMA_ACCESS_PATH_LMD}}static async getOSEnvObj(){return await ve(Ce.DISPLAY_ENV)}static async getAccessHosts(e){const a="11434",t=[`http://127.0.0.1:${a}`];if(e&&"127.0.0.1"!==e){const n=e.split(":"),l=n[0];let s=[l];const o=n[1]||a;"0.0.0.0"===l&&(s=await ge()),s&&s.length>0&&s.forEach((e=>{t.push(`http://${e}:${o}`)}))}else;return t}static async saveAppSettings(e,a){e.modelsDir===a&&(e.modelsDir="");const t={OLLAMA_MODELS:e.modelsDir,OLLAMA_HOST:e.externalAccessHost,OLLAMA_ACCESS_PATH_LMD:e.externalAccessPath};return await fe(t)}static getDownloadableModels(){return JSON.parse(JSON.stringify(Te))}}const ga={style:{"font-size":"12px"}},fa={style:{"font-size":"12px"}},ya=c({__name:"ollama-settings-btn",props:{installedInstance:{}},setup(a){const{t:t}=N(),n=r(!1),l=r(!1),o=r(!1),i=r(!1),c=r(""),w=Ke(),{addToast:_}=e(),D=r({}),T=r(!0),C=a;R((()=>C.installedInstance),(()=>{M()}));const M=()=>{ee()?n.value=!0:n.value=!1};A((()=>{M()}));const $=async()=>{l.value=!0,await B(),await X()};R((()=>l),(()=>{console.log("dialogVisible change: ",l)}));const B=async()=>{const e=await Ae();c.value=e+"/.ollama/models"},H=async()=>{if(!o.value)return;if(!D)return;if(""===c.value){const e=t("AppSettingDialog.DataNotValid");return void _(e,"error")}i.value=!0;const e=Object.assign({},D.value),a=await va.saveAppSettings(e,c.value);console.log("save result ",a);const n=t("Common.saveSuccess");_(n,"success"),i.value=!1,w.onAppSettingsSaved(),setTimeout((()=>{w.resetAppSettingsSavedStatus()}),100),l.value=!1,console.log("hideDialog",l.value),Me.killAppProcessed(C.installedInstance?.installName),setTimeout((()=>{we()}),1500)},G=async()=>{const e=await ye(D.value.modelsDir,!0);e&&e.path&&(D.value.modelsDir=e.path,console.log("dirInfo",e),T.value=he.checkModelsDirValid(e,["blobs"]),console.log("dirValid.value",T.value))},K=()=>{s(D.value.modelsDir)},J=[e=>!!e||t("Common.fieldRequired"),()=>T.value||t("AppSettingDialog.ModelsDirNotValid")],Y=/^(\d{1,3}\.){3}\d{1,3}(:\d{1,5})?$/,q=[e=>""===e||(Y.test(e)||t("AppSettingDialog.HostNotValid"))],Q=async()=>{D.value.modelsDir=c.value},Z=I((()=>{if(ee())return t("AppSettingDialog.OllamaModelsDirInfoIconTip")})),X=async()=>{if(ee()){const e=await va.getAppSettings();console.log("getOSEnvForCurrentApp",e),D.value=Object.assign({},e),""===e.modelsDir&&(console.log("getOSEnvForCurrentApp",e),D.value.modelsDir=c.value)}},ee=()=>Me.appIsOllama(C.installedInstance?.installName);return(e,a)=>(h(),d(g,null,[m(L,{class:"settings-small-btn",variant:"outlined",density:"compact",rounded:"",onClick:E($,["stop"])},{default:x((()=>[f(y(e.$t("AppRunningWindow.Settings")),1)])),_:1}),m(V,{modelValue:v(l),"onUpdate:modelValue":a[5]||(a[5]=e=>b(l)?l.value=e:null),"min-width":"400","max-width":"840"},{default:x((()=>[e.installedInstance?(h(),S(U,{key:0,class:"mx-auto px-0 py-0 window-no-drag",width:"100%",title:e.$t("AppSettingDialog.Title")+e.installedInstance.name},{append:x((()=>[m(L,{icon:"mdi-close",class:"ms-auto",size:"compact",text:"Ok",elevation:"0",onClick:a[0]||(a[0]=e=>l.value=!1)})])),default:x((()=>[v(D)?(h(),S(W,{key:0,class:"pt-0 pb-3 px-6",modelValue:v(o),"onUpdate:modelValue":a[4]||(a[4]=e=>b(o)?o.value=e:null),onSubmit:E(H,["prevent"])},{default:x((()=>[m(F,{modelValue:v(D).modelsDir,"onUpdate:modelValue":a[1]||(a[1]=e=>v(D).modelsDir=e),density:"comfortable",readonly:v(i),rules:J,label:e.$t("AppSettingDialog.ModelsDirLabel")},{append:x((()=>[m(O,{location:"bottom"},{activator:x((({props:e})=>[m(z,k(e,{icon:"mdi-information-slab-circle-outline"}),null,16)])),default:x((()=>[p("pre",null,y(v(Z)),1)])),_:1}),m(L,{class:"ml-1",onClick:G,variant:"outlined"},{default:x((()=>[f(y(e.$t("AppSettingDialog.Browse")),1)])),_:1}),m(L,{class:"ml-1",onClick:K,variant:"outlined"},{default:x((()=>[f(y(e.$t("AppSettingDialog.Open")),1)])),_:1}),m(L,{class:"ml-1",onClick:Q,variant:"outlined"},{default:x((()=>[f(y(e.$t("AppSettingDialog.UseDefaultValue")),1)])),_:1})])),_:1},8,["modelValue","readonly","label"]),m(j,{class:"pt-0"},{default:x((()=>[p("pre",ga,y(t("AppSettingDialog.ModelsDirTip")),1)])),_:1}),m(F,{modelValue:v(D).externalAccessHost,"onUpdate:modelValue":a[2]||(a[2]=e=>v(D).externalAccessHost=e),density:"comfortable",readonly:v(i),rules:q,label:e.$t("AppSettingDialog.ServerHostLabel")},null,8,["modelValue","readonly","label"]),m(j,{class:"pt-0"},{default:x((()=>[p("pre",fa,y(t("AppSettingDialog.ServerHostTip")),1)])),_:1}),m(P,{class:"text-center justify-center"},{default:x((()=>[m(L,{variant:"outlined",onClick:a[3]||(a[3]=e=>l.value=!1)},{default:x((()=>[f(y(e.$t("AppSettingDialog.close")),1)])),_:1}),m(L,{color:"primary",variant:"flat",type:"submit",loading:v(i)},{default:x((()=>[f(y(e.$t("AppSettingDialog.saveConfig")),1)])),_:1},8,["loading"])])),_:1})])),_:1},8,["modelValue"])):u("",!0)])),_:1},8,["title"])):u("",!0)])),_:1},8,["modelValue"])],64))}});class ha{static async getAppEnvData(e){const a=await(async e=>(await _e.get(`/self-manage/ai-app-env/${e}`)).data)(e);return a}static async getAccessHosts(e,a){const t=this.parsePort(e),n=[`http://127.0.0.1:${t}`];if("1"===a.allowExternalAccess){const e=await ge();e&&e.length>0&&e.forEach((e=>{n.push(`http://${e}:${t}`)}))}return n}static parsePort(e){return e.split(":")[2]||"8188"}static async saveAppEnvData(e,a){return await(async(e,a)=>(await _e.post(`/self-manage/ai-app-env/${e}`,{envObj:a})).data)(e,a)}}const Aa={style:{"font-size":"12px"}},wa=c({__name:"app-settings-btn",props:{installedInstance:{}},setup(t){const{t:n}=N(),l=r(!1),s=r(!1),o=r(!1),i=Ke(),{addToast:c}=e(),w=r({}),_=r([{label:n("AppSettingDialog.LocalAccessOnly"),value:"0"},{label:n("AppSettingDialog.AllowLANAccess"),value:"1"}]),I=t;R((()=>I.installedInstance),(()=>{})),A((()=>{}));const D=async()=>{l.value=!0,await C()};R((()=>l),(()=>{console.log("dialogVisible change: ",l)}));const k=async()=>{if(!s.value)return;if(!w)return;if(!I.installedInstance?.appId)return;o.value=!0;const e=Object.assign({},w.value),a=await ha.saveAppEnvData(I.installedInstance?.appId,e);console.log("save result ",a);const t=n("Common.saveSuccess");c(t,"success"),o.value=!1,i.onAppSettingsSaved(),l.value=!1,console.log("hideDialog",l.value),setTimeout((()=>{location.reload()}),1e3)},C=async()=>{if(Me.appIsComfyUI(I.installedInstance?.installName)){const e=await ha.getAppEnvData(I.installedInstance.appId);console.log("envForCurrentApp",e),w.value=Object.assign({allowExternalAccess:"0"},e)}};return(e,t)=>(h(),d(g,null,[m(L,{class:"settings-small-btn",variant:"outlined",density:"compact",rounded:"",onClick:E(D,["stop"])},{default:x((()=>[f(y(e.$t("AppRunningWindow.Settings")),1)])),_:1}),m(V,{modelValue:v(l),"onUpdate:modelValue":t[4]||(t[4]=e=>b(l)?l.value=e:null),"min-width":"400","max-width":"640"},{default:x((()=>[e.installedInstance?(h(),S(U,{key:0,class:"mx-auto px-0 py-0 window-no-drag",width:"100%",title:e.$t("AppSettingDialog.Title")+e.installedInstance.name},{append:x((()=>[m(L,{icon:"mdi-close",class:"ms-auto",size:"compact",text:"Ok",elevation:"0",onClick:t[0]||(t[0]=e=>l.value=!1)})])),default:x((()=>[v(w)?(h(),S(W,{key:0,class:"pt-0 pb-3 px-6",modelValue:v(s),"onUpdate:modelValue":t[3]||(t[3]=e=>b(s)?s.value=e:null),onSubmit:E(k,["prevent"])},{default:x((()=>[m(B,{class:"px-0"},{default:x((()=>[f(y(e.$t("AppSettingDialog.AppLanAccessLabel")),1)])),_:1}),m(H,{modelValue:v(w).allowExternalAccess,"onUpdate:modelValue":t[1]||(t[1]=e=>v(w).allowExternalAccess=e),"hide-details":""},{default:x((()=>[(h(!0),d(g,null,T(v(_),(e=>(h(),S(G,{key:e.value,value:e.value,color:v(a).PRIMARY_COLOR},{label:x((()=>[f(y(e.label),1)])),_:2},1032,["value","color"])))),128))])),_:1},8,["modelValue"]),m(j,{class:"pt-0"},{default:x((()=>[p("pre",Aa,y(e.$t("AppSettingDialog.AppLanAccessTip")),1)])),_:1}),m(P,{class:"text-center justify-center"},{default:x((()=>[m(L,{variant:"outlined",onClick:t[2]||(t[2]=e=>l.value=!1)},{default:x((()=>[f(y(e.$t("AppSettingDialog.close")),1)])),_:1}),m(L,{color:"primary",variant:"flat",type:"submit",loading:v(o)},{default:x((()=>[f(y(e.$t("AppSettingDialog.saveConfig")),1)])),_:1},8,["loading"])])),_:1})])),_:1},8,["modelValue"])):u("",!0)])),_:1},8,["title"])):u("",!0)])),_:1},8,["modelValue"])],64))}}),_a={style:{"font-size":"14px","line-height":"16px"}},Ia=c({__name:"lmd-expansion-panel",props:{title:{default:""},showExpandIcon:{type:Boolean,default:!1},defaultExpanded:{type:Boolean,default:!1}},setup:e=>(A((()=>{})),(e,a)=>(h(),S(K,{dense:""},{default:x((()=>[m(J,{class:"d-flex"},{actions:x((({expanded:a})=>[e.showExpandIcon?(h(),d(g,{key:0},[p("span",_a,y(a?e.$t("AppRunningWindowV2.Collapse"):e.$t("AppRunningWindowV2.Expand")),1),m(M,{src:a?"./images/icons/collapse.svg":"./images/icons/expand.svg",width:"16",height:"16"},null,8,["src"])],64)):u("",!0)])),default:x((()=>[f(y(e.title)+" ",1),m(Y),C(e.$slots,"append")])),_:3}),m(q,{style:{padding:"0"}},{default:x((()=>[C(e.$slots,"default")])),_:3})])),_:3})))});function Sa(){let e=!1;return{callApiWithRetry:async function(a,t={},n=100,l=1e3){return async function s(o){if(e)throw console.log("API call cancelled by user"),new Error("API call cancelled by user");try{console.log(`Attempt ${o}: Calling API...`);return await axios(a,t)}catch(r){if(o<n&&!e)return console.error(`Attempt ${o} failed. Retrying in ${l}ms...`),await(i=l,new Promise((e=>setTimeout(e,i)))),s(o+1);{const a=e?"API call cancelled by user":"Failed to call API after maximum attempts";throw console.error(a),new Error(a)}}var i}(1)},cancel:function(){e=!0}}}class Da{static openBrowser(e){const a=document.createElement("a");a.href=e,a.target="_blank",document.body.appendChild(a),a.click(),document.body.removeChild(a)}}const xa=["href"],ba={style:{color:"#999999"},class:"mx-0 mt-4 mb-0"},Ra=c({__name:"app-access-row-v2",props:{lmAppData:{},installedInstance:{},appEnv:{},isAppRunning:{type:Boolean}},setup(e){const t=e,n=r([]),l=r(!1),s=r(!1),o=r(null),i=r(void 0),c=async()=>{if(t.lmAppData?.accessInfo){const e=t.lmAppData.accessInfo,{accessType:a}=e;if(!a)return!1;if("browser"===a){const e=t.lmAppData.accessInfo?.webUrl;if(Me.appIsComfyUI(t.lmAppData.installName)&&e){const a=await ha.getAppEnvData(t.lmAppData.id);n.value=await ha.getAccessHosts(e,a)}else n.value.push(e||"");return!0}if("exec"===a&&Me.appIsOllama(t.installedInstance?.installName)){if(t.appEnv){const e=t.appEnv[$e];n.value=await va.getAccessHosts(e)}return!0}}return!1};A((async()=>{l.value=await c(),s.value=Me.displayAccessSettingBtn(t.installedInstance?.installName)})),R((()=>t.appEnv),(async()=>{n.value=[],l.value=await c()})),R((()=>t.isAppRunning),(async()=>{o.value?.cancel()})),R((()=>t.lmAppData?.accessInfo.webUrl),(async()=>{n.value=[],l.value=await c()})),R((()=>t.lmAppData?.accessInfo.detectAvailablePortDone),(async e=>{e&&setTimeout((()=>{w()}),100)}));const w=async()=>{const e=t.installedInstance?.installMethod,a=t.lmAppData?.accessInfo,l=n.value?.length;let s;s=e===de.DOCKER?a?.dockerOpenBrowserByLMD&&l>0:a?.openBrowserByLMD&&l>0;const r=a?.showDetectStatus;if(s||r){i.value=!0;const e=n.value[0],{apiCaller:a,promise:t}=(e=>{const a=Sa(),t=a.callApiWithRetry(e,{headers:{"Cache-Control":"no-cache",Pragma:"no-cache",Expires:"0"}},2e3,2e3);return{apiCaller:a,promise:t}})(e);o.value=a,t.then((()=>{i.value=!1,s&&Da.openBrowser(e)})).catch((e=>{console.error(e),a?.cancel()}))}};return(e,l)=>{const s=wa,o=ya,r=ma;return v(n)&&v(n).length>0?(h(),S(Ia,{key:0,title:e.$t("AppRunningWindow.Access"),readonly:"",value:"app-access",showExpandIcon:!1,"default-expanded":!0},{append:x((()=>[Me.appIsComfyUI(t.lmAppData?.installName)?(h(),S(s,{key:0,installedInstance:e.installedInstance},null,8,["installedInstance"])):u("",!0),Me.appIsOllama(t.lmAppData?.installName)?(h(),S(o,{key:1,installedInstance:e.installedInstance},null,8,["installedInstance"])):u("",!0)])),default:x((()=>[m(Q,{class:"pt-1 pb-2",style:{margin:"0 -24px -16px"}},{default:x((()=>[m(Z,{"no-gutters":"",style:{padding:"0px"}},{default:x((()=>[(h(!0),d(g,null,T(v(n),((t,n)=>(h(),S(X,{key:n,class:"px-5 py-2",cols:"12",sm:"6"},{default:x((()=>[m(ee,{style:{background:"#FFF4EA","border-radius":"4px",height:"40px"},density:"compact","min-height":"1.1rem",class:"px-5"},{prepend:x((()=>[m(r,{text:t},null,8,["text"])])),default:x((()=>[(h(),d("a",{class:"mx-2 app-access-link",key:t,href:t,target:"_blank"},y(t),9,xa)),e.isAppRunning&&v(i)?(h(),S(ae,{key:0,size:"small",color:v(a).PRIMARY_COLOR},{default:x((()=>[f(y(e.$t("AppRunningWindow.Starting")),1)])),_:1},8,["color"])):u("",!0)])),_:2},1024)])),_:2},1024)))),128))])),_:1})])),_:1}),p("div",ba,y(e.$t("AppRunningWindowV2.AccessNote")),1)])),_:1},8,["title"])):u("",!0)}}}),Ea=c({__name:"app-env-row-v2",props:{installedInstance:{},appEnv:{}},setup(e){const a=r(null);A((async()=>{a.value=await o()}));const t=e=>"HF_MIRROR"===e?"HF_ENDPOINT":e;return(e,n)=>(h(),S(Ia,{title:e.$t("AppRunningWindow.EnvVars"),showExpandIcon:!0,value:"app-env"},{default:x((()=>[m(te,{class:"my-1 pt-2 pb-0 mx-0"},{default:x((()=>[(h(!0),d(g,null,T(v(a),((e,a)=>(h(),S(ae,{variant:"tonal",size:"small",style:{"min-width":"50px","max-width":"190px","margin-left":"4px"},key:a},{default:x((()=>[f(y(t(a))+" ",1),m(O,{activator:"parent",location:"bottom"},{default:x((()=>[f(y(e),1)])),_:2},1024)])),_:2},1024)))),128)),(h(!0),d(g,null,T(e.appEnv,((e,a)=>(h(),S(ae,{variant:"tonal",color:"orange-darken-4",size:"small",style:{"min-width":"50px","max-width":"220px","margin-left":"4px"},key:a},{default:x((()=>[f(y(a)+" ",1),m(O,{activator:"parent",location:"bottom"},{default:x((()=>[f(y(e),1)])),_:2},1024)])),_:2},1024)))),128))])),_:1})])),_:1},8,["title"]))}}),ka={key:0,style:{width:"84px"},class:"d-flex flex-column justify-center items-center"},Ta={class:"progress-text"},Ca=c({__name:"download-progress",props:{downloadInfo:{}},setup:e=>(e,t)=>e.downloadInfo?(h(),d("div",ka,[m($,{width:"100%",class:"download-progress-bar","bg-color":"#D8D8D8","bg-opacity":"1","buffer-color":"#DFDFEC","buffer-opacity":"1",opacity:"1",color:v(a).PRIMARY_COLOR,height:"3",max:1,min:0,"model-value":e.downloadInfo.percent,rounded:""},null,8,["color","model-value"]),p("div",Ta,[f(y(e.$t("AppRunningWindowV2.Downloading"))+" ",1),e.downloadInfo.percent?(h(),d(g,{key:0},[f(y(Math.floor(100*e.downloadInfo.percent))+"% ",1)],64)):u("",!0)])])):u("",!0)}),Ma=Ie(c({__name:"delete-confirm-dialog",props:{modelValue:{type:Boolean},itemName:{}},emits:["update:modelValue","confirm"],setup(e,{emit:a}){const t=e,n=a,l=r(!1);R((()=>l.value),(e=>{n("update:modelValue",e)})),R((()=>t.modelValue),(e=>{l.value=e}));const s=()=>{l.value=!1},o=async()=>{n("confirm"),s()};return(e,a)=>(h(),S(V,{modelValue:v(l),"onUpdate:modelValue":a[0]||(a[0]=e=>b(l)?l.value=e:null),"max-width":"400"},{default:x((()=>[m(U,null,{default:x((()=>[m(B,{class:"headline"},{default:x((()=>[f(y(e.$t("AppRunningWindow.ConfirmDelete")),1)])),_:1}),m(j,null,{default:x((()=>[f(y(e.$t("AppRunningWindow.ConfirmDeleteMsg"))+" ",1),a[1]||(a[1]=p("br",null,null,-1)),f(" "+y(e.itemName),1)])),_:1}),m(P,{class:"justify-center mb-2"},{default:x((()=>[m(L,{variant:"outlined",onClick:s},{default:x((()=>[f(y(e.$t("AppRunningWindow.Cancel")),1)])),_:1}),m(L,{variant:"flat",color:"#F2313F",onClick:o},{default:x((()=>[f(y(e.$t("AppRunningWindow.ModelDeleteBtnLabel")),1)])),_:1})])),_:1})])),_:1})])),_:1},8,["modelValue"]))}}),[["__scopeId","data-v-2e8b336e"]]),$a={key:0},Na={class:"model-storage-title d-flex flex-row align-baseline"},La={class:""},Pa={class:"justify-center mr-6"},Oa={class:"d-flex"},Va={style:{flex:"1"}},Ua={class:"d-flex"},Wa={class:"d-flex flex-row mt-1",style:{"font-size":"14px"}},Fa={style:{flex:"1"}},za=c({__name:"model-storage",props:{installedInstance:{},appEnv:{}},setup(e){const a=e,t=r(""),n=r(""),l=r(""),o=r(0),i=r(null);A((async()=>{Me.appIsOllama(a.installedInstance?.installName)&&(await w(),_())}));const c=r(null),{t:g}=N(),w=async()=>{const e=await Ae();n.value=e+"/.ollama/models"},_=async()=>{const e=await Me.getModelsDir(a.installedInstance?.installName,a.appEnv);console.log("dir",e),t.value=e||n.value,console.log("modelDir.value",t.value);const l=await Me.getModelFileSize(a.installedInstance?.installName,t.value);l.dirSize&&(c.value=Le(l.dirSize),i.value=l,console.log("dirInfo",l),I())},I=()=>{if(!i.value)return;let e=0;try{e=i.value?.totalSpace-i.value.dirSize-i.value.freeSpace,o.value=i.value?.totalSpace-i.value.freeSpace}catch(s){console.error("calculate error",s)}const a=Le(e),t=Le(i.value.freeSpace),n=`${g("AppRunningWindow.StorageModelsSize")}: ${c.value},\n  ${g("AppRunningWindow.StorageDiskOther")}: ${a},\n  ${g("AppRunningWindow.StorageDiskFreeSpace")}: ${t}\n  `;l.value=n};R((()=>a.appEnv),(e=>{_()})),R((()=>a.installedInstance),(e=>{_()}));const D=async()=>{s(t.value)};return(e,a)=>v(c)?(h(),d("div",$a,[p("div",Na,[p("div",La,y(e.$t("AppRunningWindow.ModelStorageLabel")),1),m(Y),p("div",Pa,[m(ya,{installedInstance:e.installedInstance},null,8,["installedInstance"])])]),m(te,{class:"mt-3 pb-3 px-5"},{default:x((()=>[p("div",Oa,[p("div",null,[m(M,{src:"./images/icons/harddisk.svg",class:"mr-1",width:"72",height:"34"})]),p("div",Va,[p("div",Ua,[m(O,{text:v(l),location:"top"},{activator:x((({props:e})=>[m($,k({class:"custom-progress-bar"},e,{location:null,"bg-color":"#FFFFFF","bg-opacity":"1","buffer-color":"#DFDFEC","buffer-opacity":"1",opacity:"1",color:"#FEF1E5",height:"14",max:v(i)?.totalSpace||10,min:"0","buffer-value":v(o),"model-value":v(i)?.dirSize,rounded:""}),null,16,["max","buffer-value","model-value"])])),_:1},8,["text"])]),p("div",Wa,[p("div",Fa,y(v(i)?.diskName),1),p("a",{href:"#",style:{"text-decoration":"none",color:"rgba(0, 0, 0, 0.75)"},onClick:E(D,["prevent"])},[f(y(v(c))+" > ",1),v(t)?(h(),S(O,{key:0,activator:"parent",location:"top"},{default:x((()=>[f(y(v(t)),1)])),_:1})):u("",!0)])])])])])),_:1})])):u("",!0)}}),ja="http://localhost:11434";class Ba{constructor(e,a){if(this.paramSize=e,this.updateUI=a,!e.nameAndSize)throw new Error("nameAndSize is empty");this.nameAndSize=e.nameAndSize}totalPercentageWithoutCurrent=.01;totalPercentage=.01;pullingMainPart="";pullingCurrentPart="";nameAndSize="";async download(e){const a=e.signal,t=await fetch(`${ja}/api/pull`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:this.nameAndSize,stream:!0}),signal:a});if(!t.ok)throw new Error(`HTTP error: ${t.status}`);if(!t.body)throw new Error("No response body");const n=t.body.getReader(),l=new TextDecoder;let s="";for(;;){const{done:e,value:a}=await n.read();if(e)break;s+=l.decode(a);const t=s.split("\n");s=t.pop()||"";for(const n of t)if(n.trim())try{const e=JSON.parse(n);this.processProgress(e)}catch(o){console.error("Parse error:",o)}}}calculatePercentage(e,a,t){let n=this.totalPercentageWithoutCurrent;if(e&&e.completed&&e.total){n+=e.completed/e.total*a,n>.99&&(n=.99),n>=this.totalPercentage&&(this.totalPercentage=n)}t&&this.totalPercentage>=this.totalPercentageWithoutCurrent&&(this.totalPercentageWithoutCurrent=this.totalPercentage)}processProgress(e){const a=e?.status||"";let t=.02;if("pulling manifest"===a)t=.01;else if(a.startsWith("downloading")||a.startsWith("pulling")){void 0!==e.total&&void 0!==e.completed&&(!this.pullingMainPart&&e.total>5242880&&(this.pullingMainPart=a),this.pullingMainPart===a&&(t=.89));let n=!1;this.pullingCurrentPart!==a&&(this.pullingCurrentPart=a,n=!0),this.calculatePercentage(e,t,n)}else"success"===a&&(this.totalPercentage=1);this.updateUI&&this.updateUI(this.paramSize,this.totalPercentage)}}const{addToast:Ha}=e(),Ga=i("modelDownloadInfo",{state:()=>({models:r([]),parameterSizes:r([]),downloadSuccessMsg:r(""),cancelDownloadMsg:r(""),fetchAbortControllers:r(new Map)}),actions:{initModelsData(){this.models=[],this.parameterSizes=[]},updateUI(e,a){const t=e.downloadProgress;t&&(t.percent=a,1===a&&(e.installed=!0,this.downloadSuccessMsg&&Ha(this.downloadSuccessMsg,"success")))},onDownloadError(e){console.error("Failed to download model",e);let a=e.message;"BodyStreamBuffer was aborted"===a&&(a=this.cancelDownloadMsg),Ha(a,"error")},async startDownload(e,a){a.nameAndSize=e,a.downloadProgress={nameAndSize:e,percent:0},this.updateUI(a,.01);const t=await(async(e,a,t)=>{const n=new AbortController;return new Ba(e,a).download(n).catch((e=>{t&&(console.error("download err",e),t(e))})),n})(a,this.updateUI,this.onDownloadError);this.fetchAbortControllers.set(a.nameAndSize,t)},async cancelDownload(e,a){const t=Ne.genModelNameAndSize(e,a);try{const e=this.fetchAbortControllers.get(t);e?.abort()}catch(n){console.log("cancel err",n)}try{await(async e=>{const a=await fetch(`${ja}/api/pull`,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e})});if(!a.ok)throw new Error(`HTTP error: ${a.status}`);if(!a.body)throw new Error("No response body");const t=await a.json();t.error?console.error("cancel error",t.error):console.log("cancel done",t)})(t)}catch(n){console.error(n)}finally{a.installed=!1,a.downloadProgress&&(a.downloadProgress.percent=void 0)}},async deleteModel(e,a){const t=Ne.genModelNameAndSize(e,a);try{await(async e=>{const a=await fetch(`${ja}/api/delete`,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e})});if(!a.ok)throw new Error(`HTTP error: ${a.status}`);if(!a.body)throw new Error("No response body");const t=await a.json();t.error?console.error("del error",t.error):console.log("del done",t)})(t)}catch(n){console.error(n)}finally{a.installed=!1,a.downloadProgress&&(a.downloadProgress.percent=void 0)}}}}),Ka={key:0,class:"text-center py-10",style:{flex:"1"}},Ja={class:"d-flex flex-row justify-center"},Ya={style:{"min-width":"46px",display:"inline-block"}},qa={style:{"min-width":"60px",display:"inline-block"}},Qa={key:0,class:"installed-chip"},Za={key:1,class:"not-installed-chip"},Xa=c({__name:"model-download-row-v2",props:{lmAppData:{},installedInstance:{},appEnv:{}},setup(e){const a=Ga(),t=r(!1),n=r(null),l=r(null),s=r(!1),o=r(""),{t:i}=N(),c=e;A((async()=>{w(),a.downloadSuccessMsg=i("AppRunningWindow.ModelDownloadSuccessful"),a.cancelDownloadMsg=i("AppRunningWindowV2.DownloadCanceled"),await I()})),R((()=>c.lmAppData),(()=>{w()})),R((()=>c.installedInstance),(()=>{I()})),R((()=>c.appEnv),(()=>{I()}));const w=()=>{t.value=Me.appIsOllama(c.lmAppData?.installName)};R(n,(()=>{_()}));const _=()=>{const e=n.value,t=a.models.find((a=>a.installName===e)),l=t?.tags||[];a.parameterSizes=l},I=async()=>{const e=c.installedInstance?.installName;if(e&&t.value){a.initModelsData();const t=va.getDownloadableModels(),l=await Me.mergeModelsList(e,t);if(a.models=l,n.value)_();else{const e=a.models;if(e&&e.length>0){const a=e[0];n.value=a.installName}}}},D=async()=>{n.value&&l.value&&a.deleteModel(n.value,l.value)},b=e=>{const a=e.downloadProgress;return!!(a?.percent&&a.percent<1)},E=e=>{const a=e.tags;if(a&&a.length>0)for(let t=0;t<a.length;t++){if(a[t].installed)return!0}};return(e,i)=>{const r=Ca;return h(),d(g,null,[e.lmAppData&&v(t)?(h(),S(Ia,{key:0,class:"model-download-panel",showExpandIcon:!0,value:"model-download",title:e.$t("AppRunningWindow.ModelDownload")},{default:x((()=>[m(te,{class:"model-download-sheet d-flex flex-row"},{default:x((()=>[v(a).models&&0!==v(a).models.length?u("",!0):(h(),d("div",Ka,[m(ne,{color:"primary",indeterminate:"",size:"40"})])),v(a).models&&v(a).models.length>0?(h(),S(Q,{key:1,style:{"border-right":"1px solid #EBEBF7",flex:"1",padding:"0"},"max-height":"340"},{default:x((()=>[(h(!0),d(g,null,T(v(a).models,((e,a)=>(h(),S(ee,{key:e.installName+a,density:"compact","active-class":"selected-model-item",onClick:a=>{var t;(t=e.installName)!==n.value&&(n.value=t)},active:v(n)===e.installName,title:e.displayName,value:e.installName},{append:x((()=>[E(e)?(h(),S(z,{key:0,class:"downloaded-icon",icon:"mdi-check-bold",size:"18"})):u("",!0)])),_:2},1032,["onClick","active","title","value"])))),128))])),_:1})):u("",!0),v(a).models&&v(a).models.length>0?(h(),S(Q,{key:2,style:{flex:"1",padding:"0"}},{default:x((()=>[(h(!0),d(g,null,T(v(a).parameterSizes,((t,i)=>(h(),S(ee,{key:t.parameterSize+i,density:"compact",active:!1,value:t.parameterSize},{default:x((()=>[p("div",Ja,[p("span",Ya,y(t.parameterSize),1),p("span",qa,[m(ae,{density:"compact",class:"mx-1 file-size-chip"},{default:x((()=>[f(y(t.fileSize),1)])),_:2},1024)]),m(Y,{style:{flex:"1"}}),t.installed?(h(),d("div",Qa,y(e.$t("AppRunningWindow.ModelDownloaded")),1)):(h(),d(g,{key:1},[b(t)?(h(),S(r,{key:0,"download-info":t.downloadProgress},null,8,["download-info"])):(h(),d("div",Za,y(e.$t("AppRunningWindow.ModelNotDownloaded")),1))],64)),m(Y,{style:{flex:"1"}}),t.installed?(h(),S(L,{key:2,onClick:e=>(e=>{if(!n.value)return;const a=Ne.genModelNameAndSize(n.value,e);l.value=e,s.value=!0,o.value=a})(t),variant:"text",density:"compact",color:"#F2313F"},{default:x((()=>[f(y(e.$t("AppRunningWindow.ModelDeleteBtnLabel")),1)])),_:2},1032,["onClick"])):(h(),d(g,{key:3},[b(t)?(h(),S(L,{key:0,onClick:e=>(async e=>{n.value&&a.cancelDownload(n.value,e)})(t),variant:"text",density:"compact"},{default:x((()=>[f(y(e.$t("AppRunningWindow.Cancel")),1)])),_:2},1032,["onClick"])):(h(),S(L,{key:1,onClick:e=>(async e=>{if(!n.value)return;const t=Ne.genModelNameAndSize(n.value,e);a.startDownload(t,e)})(t),variant:"text",class:"model-download-btn",density:"compact"},{default:x((()=>[f(y(e.$t("AppRunningWindow.ModelDownloadBtnLabel")),1)])),_:2},1032,["onClick"]))],64))])])),_:2},1032,["value"])))),128))])),_:1})):u("",!0)])),_:1}),m(te,{style:{"border-top":"1px solid #EBEBF7"}},{default:x((()=>[m(za,{appEnv:e.appEnv,installedInstance:e.installedInstance},null,8,["appEnv","installedInstance"])])),_:1})])),_:1},8,["title"])):u("",!0),m(Ma,{"model-value":v(s),"onUpdate:modelValue":i[0]||(i[0]=e=>s.value=e),"item-name":v(o),onConfirm:D},null,8,["model-value","item-name"])],64)}}}),et=c({__name:"app-env-and-access-v2",props:{installedInstance:{},lmAppData:{},isAppRunning:{type:Boolean}},emits:["appEnvSavedAndUpdated"],setup(e,{expose:a,emit:t}){const n=e,l=Ke(),s=r({}),o=r(["app-access"]),i=r(void 0),c=t;A((async()=>{g(),p()}));const d=_(),p=()=>{d.query.script===ce.DOWNLOAD_MODEL&&(o.value=["app-access","model-download"])},g=async()=>{const e=n.installedInstance?.installName;Me.appIsOllama(e)?(s.value=await va.getOSEnvObj()||{},w()):Me.appIsComfyUI(e)&&(s.value=await va.getOSEnvObj()||{})};a({updateAppEnvData:g}),R((()=>n.installedInstance),(()=>{g()})),R((()=>l.appSettingsSaved),(async e=>{e&&(s.value=null,await g(),c("appEnvSavedAndUpdated",s.value))}));const w=async()=>{const e=s.value;e.OLLAMA_MODELS&&(i.value=await Se(e.OLLAMA_MODELS))};return(e,a)=>{const t=Ra;return v(s)&&e.installedInstance?(h(),S(le,{key:0,multiple:"",elevation:"0",modelValue:v(o),"onUpdate:modelValue":a[0]||(a[0]=e=>b(o)?o.value=e:null),class:"lmd-running-panels"},{default:x((()=>[m(t,{appEnv:v(s),isAppRunning:e.isAppRunning,lmAppData:e.lmAppData,installedInstance:e.installedInstance},null,8,["appEnv","isAppRunning","lmAppData","installedInstance"]),!1===v(i)?(h(),S(j,{key:0,class:"pt-0 mt-0 px-2",style:{color:"red","justify-items":"center","align-items":"center"}},{default:x((()=>[m(z,{style:{opacity:"1"},icon:"mdi-information-slab-circle-outline"}),f(" "+y(e.$t("AppRunningWindowV2.ModelDirNotFound")),1)])),_:1})):u("",!0),m(Xa,{appEnv:v(s),installedInstance:e.installedInstance,lmAppData:e.lmAppData},null,8,["appEnv","installedInstance","lmAppData"]),m(Ea,{appEnv:v(s),installedInstance:e.installedInstance},null,8,["appEnv","installedInstance"])])),_:1},8,["modelValue"])):u("",!0)}}}),at={class:"d-flex flex-column text-center justify-center align-middle"},tt={style:{width:"60px",margin:"0 auto"},class:"mt-10"},nt={class:"d-flex flex-column justify-center"},lt=c({__name:"app-info-left",props:{lmAppData:{},installedInstance:{},isAppRunning:{type:Boolean}},emits:["startApp","stopApp"],setup(e,{emit:a}){const t=e,n=a,{t:l}=N(),s=I((()=>t.installedInstance?.installMethod===de.DOCKER?l("LMAppDetail.DockerMode"):""));return(e,a)=>(h(),S(te,{class:"left-app-basic-info"},{default:x((()=>[p("div",at,[p("div",tt,[m(M,{src:e.lmAppData?.icon,rounded:"",width:"60",height:"60"},null,8,["src"])]),p("div",nt,[m(B,{class:"pt-1 pb-0"},{default:x((()=>[f(y(e.lmAppData?.name),1)])),_:1}),e.installedInstance?.version&&"--"!==e.installedInstance?.version?(h(),S(se,{key:0,class:"py-0"},{default:x((()=>[f(y(e.$t("AppRunningWindow.Version"))+" "+y(e.installedInstance?.version),1)])),_:1})):u("",!0),m(j,null,{default:x((()=>[v(s)?(h(),S(ae,{key:0,density:"default",variant:"flat",size:"small",color:"#086dd7"},{default:x((()=>[f(y(v(s)),1)])),_:1})):u("",!0),m(Y,{class:"mt-6"}),e.isAppRunning?(h(),S(L,{key:1,variant:"flat",color:"#F2313F",class:"mx-2",width:"80",height:"40",onClick:a[0]||(a[0]=e=>{n("stopApp")})},{default:x((()=>[f(y(e.$t("AppRunningWindow.Stop")),1)])),_:1})):(h(),S(L,{key:2,color:"primary",variant:"flat",class:"mx-2",width:"80",height:"40",onClick:a[1]||(a[1]=e=>{n("startApp")})},{default:x((()=>[f(y(e.$t("AppRunningWindow.Start")),1)])),_:1}))])),_:1})])])])),_:1}))}}),st={style:{flex:"1"}},ot={class:"pa-6 run-right-content"},it={class:"footer-button-bar"},rt={class:"footer-terminal-content"},ct=c({__name:"app-run",setup(a){const n=_(),l=be(),s=r(null),o=r(),i=r(),c=r(null),w=r(!1),b=r(!1),R=r(""),{t:E}=N(),{addToast:k}=e(),T=Ke(),C=r(!1);A((async()=>{U();const e=n.params.id,a=await ie(e);c.value=a;const t=a.appId;await l.fetchApp(t),s.value=l.currentLmApp,window.ipcRenderer?.on(ue.STOP_AI_RUNNING_INSTANCE,(()=>{j(),B()})),$()}));const $=()=>{const e=s?.value?.name;document.title=`[${E("LMAppDetail.RunApp")}] ${e}`},P=()=>{console.log("onTerminalReady"),G()},O=I((()=>{if(s.value?.id&&c.value?.id)return la.genWSUrl(s.value?.id,c.value?.id,oa)})),V=I((()=>{if(T.terminals&&T.terminals.length>0)return T.terminals[0]})),U=()=>{const e=E("AppRunningWindow.MainProcessTab");T.initTerminal(e)},W=async()=>{var e;if(e=ce.START,R.value=e,T.changeMainTerminalScriptType(e,""),w.value=!0,s.value&&c.value){let e=await(async(e,a)=>{const n=e.installName,l=(await t()).LMD_SCRIPTS_DIR,{repoUrl:s,repoLocalFolderName:o}=Je.getLMDScriptRepoUrl(e);return`\nexport LMD_BASE_INSTALL_SCRIPT_DIR="${l}/${o}"\n${Ze(s)}\n${await Qe.genSetPortCommand(e)}\nsh "$LMD_BASE_INSTALL_SCRIPT_DIR/apps/${n}/${"docker"===a?.installMethod?"start-d.sh":"start.sh"}"`})(s.value,c.value);const a=n.query.module;if(console.log("route.params.module",a),a){e=`\nexport LMD_LAUNCH_APP_MODULE=${a}\n`+e}z(e),window.ipcRenderer?.send(ue.RUNNING_STATUS_CHANGE,!0)}},F=()=>Array.isArray(o.value)?o.value[0]:o.value,z=e=>{const a=F();console.log("run command",a,e),a?.runCommand(e)},j=()=>{w.value=!1,F()?.runStopCommand(),window.ipcRenderer.send(ue.RUNNING_STATUS_CHANGE,!1)},B=()=>{F()?.exitTerminal()},H=e=>{if(oe.isWindows())return;j();const a=(e=>{let a="";if(e)for(const t in e)a+=`${t}=${e[t]}\n`;return a})(e);F()?.runCommand(a),W()},G=async()=>{if(W(),Me.needPreStartApp(c.value?.installName))return oe.isMacOS()?void setTimeout((()=>{K()}),20):void 0;K()},K=()=>{b.value=!0},J=e=>{console.log("onCommandExecuteEnd",e),e&&k(e,"success"),setTimeout((()=>{i.value?.updateAppEnvData()}),400)},Y=e=>{e.includes("lmdevent:docker_run_error")&&k(E("AppRunningWindowV2.docker_run_error"),"error",6e3)};return(e,a)=>(h(),d(g,null,[p("div",st,[m(lt,{"lm-app-data":v(s),"is-app-running":v(w),onStopApp:j,onStartApp:W,"installed-instance":v(c)},null,8,["lm-app-data","is-app-running","installed-instance"]),p("div",ot,[v(c)&&v(s)&&v(b)?(h(),S(et,{key:0,ref_key:"appEnvAndAccessComponent",ref:i,onAppEnvSavedAndUpdated:H,isAppRunning:v(w),lmAppData:v(s),installedInstance:v(c)},null,8,["isAppRunning","lmAppData","installedInstance"])):u("",!0)])]),p("footer",{class:D(["footer-terminal","app-run-footer-terminal",v(C)?"expanded":""])},[p("div",it,[m(L,{variant:"text",style:{position:"absolute",right:"10px",top:"5px"},onClick:a[0]||(a[0]=e=>C.value=!v(C))},{append:x((()=>[m(M,{src:v(C)?"./images/icons/expand-white.svg":"./images/icons/collapse-white.svg",width:"18",height:"18"},null,8,["src"])])),default:x((()=>[f(y(v(C)?e.$t("AppRunningWindowV2.Hide"):e.$t("AppRunningWindowV2.ViewLog"))+" ",1)])),_:1})]),p("div",rt,[v(O)&&v(V)&&"main-process"===v(V).tabName?(h(),S(ta,{key:0,socketURI:v(O),onExecuteEnd:a[1]||(a[1]=e=>{return a=v(V).commandExecuteEndToastMsg,K(),console.log("onMainTerminalCommandEnd"),void J(a);var a}),"command-execute-end-keywords":v(V).commandExecuteEndKeywords,ref_key:"generalTerminal",ref:o,events:["lmdprogress","lmdevent:docker_run_error"],onReady:P,onTerminalEvent:Y},null,8,["socketURI","command-execute-end-keywords"])):u("",!0)])],2)],64))}}),dt={class:"app-install-result pt-10 pb-6 px-11 mb-12 mx-10"},pt=c({__name:"install-result",props:{lmAppData:{},installedInstance:{}},setup(e){const a=e,t=()=>{a.installedInstance.appInstallPath&&s(a.installedInstance.appInstallPath)};return(e,a)=>(h(),d("div",dt,[m(Z,{class:"gap-2 mb-2"},{default:x((()=>[m(X,{cols:"12",xs:"12",sm:"6",md:"6",lg:"6",class:"item"},{default:x((()=>[f(y(e.$t("AppRunningWindowV2.AppNameLabel"))+": "+y(e.lmAppData.name),1)])),_:1}),m(X,{cols:"12",xs:"12",sm:"6",md:"6",lg:"6",class:"item"},{default:x((()=>[f(y(e.$t("AppRunningWindowV2.AppInstallTimeLabel"))+": "+y(v(Pe).format(e.installedInstance.createTime,!1)),1)])),_:1}),m(X,{cols:"12",xs:"12",sm:"6",md:"6",lg:"6",class:"item"},{default:x((()=>[f(y(e.$t("AppRunningWindowV2.AppInstallLocationLabel"))+": ",1),p("a",{href:"#",onClick:E(t,["prevent"])},y(e.installedInstance.appInstallPath),1)])),_:1})])),_:1})]))}}),{addToast:ut}=e(),mt=i("appInstall",{state:()=>({installPercent:r(0),installSuccessMsg:r(""),installed:r(!1)}),actions:{initModelsData(){this.installPercent=0},updateUI(e){this.installPercent=e,1===e&&(this.installed=!0,this.installSuccessMsg&&ut(this.installSuccessMsg,"success"))},onDownloadError(e){console.error("Failed to download App",e),ut(e.message,"error")}}}),vt={class:"progress-area"},gt={style:{width:"210px"}},ft={key:0,style:{width:"250px"},class:"mt-6"},yt={class:"progress-msg mb-8 mt-6"},ht={class:"progress-msg-title"},At={class:"progress-msg-title"},wt=c({__name:"install-progress",props:{lmAppData:{},instanceData:{}},setup(e){const t=mt(),n=e,{t:l}=N(),s=I((()=>"docker"===n.instanceData?.installMethod?l("LMAppDetail.DockerMode"):""));return(e,l)=>(h(),d("div",vt,[p("div",gt,[m(M,{src:v(t).installed?"./images/app/succes.svg":"./images/app/processing.svg",width:"210",height:"140"},null,8,["src"])]),v(t).installed?u("",!0):(h(),d("div",ft,[m($,{width:"100%",class:"download-progress-bar","bg-color":"#F2F2FA","bg-opacity":"1","buffer-color":"#DFDFEC","buffer-opacity":"1",opacity:"1",color:v(a).PRIMARY_COLOR,height:"14",max:100,min:0,"model-value":v(t).installPercent,rounded:""},null,8,["color","model-value"])])),p("div",yt,[v(t).installed?(h(),d(g,{key:1},[p("div",At,y(e.$t("AppRunningWindowV2.InstallSuccessTitle")),1),p("div",null,[Me.appIsOllama(n.lmAppData?.installName)?(h(),d(g,{key:0},[f(y(e.$t("AppRunningWindowV2.InstallSuccessNextTipForOllama")),1)],64)):(h(),d(g,{key:1},[f(y(e.$t("AppRunningWindowV2.InstallSuccessNextTip")),1)],64))])],64)):(h(),d(g,{key:0},[p("div",ht,y(e.lmAppData?.name),1),v(s)?(h(),S(ae,{key:0,class:"mt-1 mb-3",density:"default",size:"small",color:"#086dd7"},{default:x((()=>[f(y(v(s)),1)])),_:1})):u("",!0),p("div",null,y(e.$t("AppRunningWindowV2.InstallingMsg"))+" "+y(v(t).installPercent)+"% ",1)],64))])]))}}),_t={class:"app-install-container"},It={class:"install-steps"},St={class:"pa-6 install-right-content"},Dt={class:"footer-button-bar"},xt=c({__name:"app-install",setup(a){const{t:n}=N(),l=Ke(),s=r(""),o=be(),i=r(null),c=_(),g=r(null),w=r(),b=mt(),R=r(!1),{addToast:E}=e();A((async()=>{$();const e=c.params.id,a=await ie(e);g.value=a;const t=a.appId;await o.fetchApp(t),i.value=o.currentLmApp,window.ipcRenderer?.on(ue.STOP_AI_RUNNING_INSTANCE,(()=>{W(),F()})),k()}));const k=()=>{const e=i?.value?.name;document.title=`[${n("LMAppDetail.install")}] ${e}`},T=()=>{console.log("onTerminalReady"),O()},C=I((()=>{if(i.value?.id&&g.value?.id)return la.genWSUrl(i.value.id,g.value.id,sa)})),$=()=>{const e=n("AppRunningWindow.MainProcessTab");l.initTerminal(e)},O=async()=>{var e;if(console.log("installApp"),e=ce.INSTALL,s.value=e,console.log("changeMainTerminalScriptType",e,""),l.changeMainTerminalScriptType(e,""),i.value&&g.value){const e=await(async(e,a)=>{const n=e.installName,l=(await t()).LMD_SCRIPTS_DIR,{repoUrl:s,repoLocalFolderName:o}=Je.getLMDScriptRepoUrl(e),i=Ze(s);return console.log("repoLocalFolderName",o),`\nexport LMD_BASE_INSTALL_SCRIPT_DIR="${l}/${o}"\n${i}\nsh "$LMD_BASE_INSTALL_SCRIPT_DIR/apps/${n}/${"docker"===a?.installMethod?"install-d.sh":"install.sh"}"`})(i.value,g.value);V(e)}De()},V=e=>{const a=U();console.log("run command",a,e),a?.runCommand(e)},U=()=>Array.isArray(w.value)?w.value[0]:w.value,W=()=>{U()?.runStopCommand(),window.ipcRenderer.send(ue.RUNNING_STATUS_CHANGE,!1)},F=()=>{U()?.exitTerminal()},z=e=>{if(e.includes("lmdevent:docker_run_error"))return void E(n("AppRunningWindowV2.docker_run_error"),"error",6e3);const a=na.extractProgress(e);a&&(b.installPercent=a,100===a&&(b.installed=!0,xe()))},j=()=>{console.log("installedInstance",g.value?.id),g.value?.id&&me(g.value.id)},B=()=>{g.value&&pe.goToRunningPage(g.value.id,ce.START,g.value.installName)};return(e,a)=>{const t=wt,n=pt;return h(),d("div",_t,[p("div",It,[p("div",St,[v(i)?(h(),S(t,{key:0,"instance-data":v(g),"lm-app-data":v(i)},null,8,["instance-data","lm-app-data"])):u("",!0),v(g)&&v(i)&&v(b).installed?(h(),S(n,{key:1,lmAppData:v(i),installedInstance:v(g)},null,8,["lmAppData","installedInstance"])):u("",!0),p("div",{class:D(["footer-terminal","app-install-footer-terminal",v(R)?"expanded":""])},[p("div",Dt,[m(L,{variant:"text",style:{position:"absolute",right:"10px",top:"5px"},onClick:a[0]||(a[0]=e=>R.value=!v(R))},{append:x((()=>[m(M,{src:v(R)?"./images/icons/expand-white.svg":"./images/icons/collapse-white.svg",width:"18",height:"18"},null,8,["src"])])),default:x((()=>[f(y(v(R)?e.$t("AppRunningWindowV2.Hide"):e.$t("AppRunningWindowV2.ViewLog"))+" ",1)])),_:1})]),v(C)?(h(),S(ta,{key:0,ref_key:"generalTerminal",ref:w,events:["lmdprogress","lmdevent:docker_run_error"],onTerminalEvent:z,onReady:T,socketURI:v(C)},null,8,["socketURI"])):u("",!0)],2)])]),m(P,{style:{"border-top":"1px solid #EBEBF7"},class:"py-6 text-center justify-center"},{default:x((()=>[m(L,{variant:"outlined",onClick:j},{default:x((()=>[f(y(e.$t("Common.close")),1)])),_:1}),Me.appIsOllama(i.value?.installName)?(h(),S(L,{key:0,variant:"flat",disabled:!v(b).installed,onClick:B,color:"primary"},{default:x((()=>[f(y(e.$t("AppRunningWindowV2.NextStep")),1)])),_:1},8,["disabled"])):u("",!0)])),_:1})])}}}),bt=c({__name:"AppRunningWindowV2",setup(e){const a=r(""),t=_();return A((()=>{const e=t.query.script;e===ce.INSTALL?a.value="install":e===ce.START||e===ce.DOWNLOAD_MODEL?a.value="run":e===ce.REMOVE&&(a.value="remove")})),(e,t)=>{const n=xt,l=ct,s=ua;return h(),d(g,null,["install"===v(a)?(h(),S(n,{key:0})):u("",!0),"run"===v(a)?(h(),S(l,{key:1})):u("",!0),"remove"===v(a)?(h(),S(s,{key:2})):u("",!0)],64)}}});export{bt as default};
