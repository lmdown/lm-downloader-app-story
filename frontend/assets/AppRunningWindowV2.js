import{c as e,T as a,i as n,h as t,o as l}from"./index.js";import{d as s}from"./pinia.js";import{b as o,e as i,a3 as r,a2 as d,a5 as c,k as p,u,F as m,S as v,K as g,a0 as f,H as w,ab as y,$ as h,a8 as A,a1 as x,aa as _,l as I,a4 as S,m as k,Y as D,j as b,c as E}from"./vue.js";import{b as R,m as T,G as M,q as N,E as C,U as P,W,F as $,X as O,c as F,w as z,x as L,a as V,M as j,l as U,n as B,H,d as G,Y,D as J,o as K,p as q}from"./vuetify.js";import{b as X,A as Q,d as Z,O as ee}from"./OSUtil.js";import{I as ae,b as ne,g as te,d as le,s as se,e as oe}from"./lmd-system.js";import"./index2.js";import{u as ie,e as re,d as de,_ as ce,O as pe,a as ue,D as me,g as ve,c as ge,b as fe}from"./delete-confirm-dialog.js";import{u as we}from"./lmapp.js";import{A as ye,O as he,M as Ae}from"./AppInfoUtil.js";import{I as xe,A as _e}from"./InstallType.js";import{p as Ie}from"./pretty-bytes.js";import{D as Se}from"./DateTimeUtil.js";import"./xterm.js";import"./debounce.js";import"./vuei18n.js";import"./lmd-locales.js";import"./dayjs.js";const{addToast:ke}=e(),De=s("appRemove",{state:()=>({removePercent:o(0),removeSuccessMsg:o(""),removed:o(!1)}),actions:{initModelsData(){this.removePercent=0},updateUI(e){this.removePercent=e,1===e&&(this.removed=!0,this.removeSuccessMsg&&ke(this.removeSuccessMsg,"success"))}}}),be={class:"progress-area"},Ee={style:{width:"210px"}},Re={key:0,style:{width:"250px"},class:"mt-6"},Te={class:"progress-msg mb-8 mt-6"},Me={class:"progress-msg-title"},Ne={class:"progress-msg-title"},Ce={class:"mt-3",style:{"font-size":"14px"}},Pe=i({__name:"remove-progress",props:{lmAppData:{}},setup(e){const n=De();return(e,t)=>(f(),r("div",be,[d("div",Ee,[p(R,{src:u(n).removed?"./images/my-ai/del-tip.svg":"./images/app/processing.svg",width:"210",height:"140"},null,8,["src"])]),u(n).removed?c("",!0):(f(),r("div",Re,[p(T,{width:"100%",class:"download-progress-bar","bg-color":"#F2F2FA","bg-opacity":"1","buffer-color":"#DFDFEC","buffer-opacity":"1",opacity:"1",color:u(a).PRIMARY_COLOR,height:"14",max:100,min:0,"model-value":u(n).removePercent,rounded:""},null,8,["color","model-value"])])),d("div",Te,[u(n).removed?(f(),r(m,{key:1},[d("div",Ne,g(e.$t("AppRunningWindowV2.DeleteSuccessTitle")),1),d("div",Ce,g(e.$t("AppRunningWindowV2.DeleteSuccessMsg")),1)],64)):(f(),r(m,{key:0},[d("div",Me,g(e.lmAppData?.name),1),v(" "+g(e.$t("AppRunningWindowV2.DeletingMsg"))+" "+g(u(n).removePercent)+"% ",1)],64))])]))}});class We{static extractProgress(e){let a=null;try{const n=/lmdprogress:(\d+)/g;let t;for(;null!==(t=n.exec(e));)a=parseInt(t[1],10)}catch(n){console.error("parse err",n)}return a}}const $e={class:"app-install-container"},Oe={class:"install-steps"},Fe={class:"pa-6 install-right-content"},ze={class:"footer-button-bar"},Le=i({__name:"app-remove",setup(a){const{t:n}=M(),t=ie(),l=o(""),s=we(),i=o(null),m=y(),_=o(null),I=o(),S=De(),k=o(!1),{addToast:D}=e();w((async()=>{b();const e=m.params.id;let a;try{a=await X(e)}catch(o){return console.log(o),void D(n("AppRunningWindowV2.DeleteNotFound"),"error")}_.value=a;const t=a.appId;await s.fetchApp(t),i.value=s.currentLmApp,window.ipcRenderer?.on(ae.STOP_AI_RUNNING_INSTANCE,(()=>{W(),$()})),E();const l=i?.value.name;document.title=n("LocalApps.Delete")+" "+l}));const b=()=>{const e=n("AppRunningWindow.MainProcessTab");t.initTerminal(e)},E=async()=>{var e;if(e=Q.REMOVE,l.value=e,console.log("changeMainTerminalScriptType",e,""),t.changeMainTerminalScriptType(e,""),i.value&&_.value){const e=await re(i.value,_.value);T(e)}},T=e=>{const a=P();console.log("run command",a,e),a?.runCommand(e)},P=()=>Array.isArray(I.value)?I.value[0]:I.value,W=()=>{P()?.runStopCommand(),window.ipcRenderer.send(ae.RUNNING_STATUS_CHANGE,!1)},$=()=>{P()?.exitTerminal()},O=e=>{const a=We.extractProgress(e);a&&(S.removePercent=a,100===a&&(S.removed=!0,_.value?.id&&Z(_.value?.id)))},F=()=>{_.value?.id&&ne(_.value.id)};return(e,a)=>{const n=Pe;return f(),r("div",$e,[d("div",Oe,[d("div",Fe,[u(i)?(f(),h(n,{key:0,"lm-app-data":u(i)},null,8,["lm-app-data"])):c("",!0),d("div",{class:A(["footer-terminal","app-install-footer-terminal",u(k)?"expanded":""])},[d("div",ze,[p(N,{variant:"text",style:{position:"absolute",right:"10px",top:"5px"},onClick:a[0]||(a[0]=e=>k.value=!u(k))},{append:x((()=>[p(R,{src:u(k)?"./images/icons/expand-white.svg":"./images/icons/collapse-white.svg",width:"18",height:"18"},null,8,["src"])])),default:x((()=>[v(g(u(k)?e.$t("AppRunningWindowV2.Hide"):e.$t("AppRunningWindowV2.ViewLog"))+" ",1)])),_:1})]),p(de,{ref_key:"generalTerminal",ref:I,events:["lmdprogress"],onTerminalEvent:O,socketURI:"ws://localhost:19312"},null,512)],2)])]),p(C,{style:{"border-top":"1px solid #EBEBF7"},class:"py-6 text-center justify-center"},{default:x((()=>[p(N,{variant:"outlined",onClick:F},{default:x((()=>[v(g(e.$t("Common.close")),1)])),_:1})])),_:1})])}}}),Ve={style:{"font-size":"14px","line-height":"16px"}},je=i({__name:"lmd-expansion-panel",props:{title:{default:""},showExpandIcon:{type:Boolean,default:!1},defaultExpanded:{type:Boolean,default:!1}},setup:e=>(w((()=>{})),(e,a)=>(f(),h(P,{dense:""},{default:x((()=>[p(W,{class:"d-flex"},{actions:x((({expanded:a})=>[e.showExpandIcon?(f(),r(m,{key:0},[d("span",Ve,g(a?e.$t("AppRunningWindowV2.Collapse"):e.$t("AppRunningWindowV2.Expand")),1),p(R,{src:a?"./images/icons/collapse.svg":"./images/icons/expand.svg",width:"16",height:"16"},null,8,["src"])],64)):c("",!0)])),default:x((()=>[v(g(e.title)+" ",1),p($),_(e.$slots,"append")])),_:3}),p(O,{style:{padding:"0"}},{default:x((()=>[_(e.$slots,"default")])),_:3})])),_:3})))});class Ue{static openBrowser(e){const a=document.createElement("a");a.href=e,a.target="_blank",document.body.appendChild(a),a.click(),document.body.removeChild(a)}}const Be=["href"],He={style:{color:"#999999"},class:"mx-0 mt-4 mb-0"},Ge=i({__name:"app-access-row-v2",props:{lmAppData:{},installedInstance:{},appEnv:{}},setup(e){const t=e,l=o([]),s=o(!1),i=o(!1),y=o(void 0),A=async()=>{if(t.lmAppData?.accessInfo){const e=t.lmAppData.accessInfo,{accessType:a}=e;if(!a)return!1;if("browser"===a)return l.value.push(t.lmAppData.accessInfo?.webUrl||""),!0;if("exec"===a&&ye.appIsOllama(t.installedInstance?.installName)){if(t.appEnv){const e=t.appEnv[he];l.value=await pe.getAccessHosts(e)}return!0}}return!1};w((async()=>{s.value=await A(),i.value=ye.displayAccessSettingBtn(t.installedInstance?.installName)})),I((()=>t.appEnv),(async()=>{s.value=await A()})),I((()=>t.lmAppData?.accessInfo.webUrl),(async()=>{l.value=[],s.value=await A()})),I((()=>t.lmAppData?.accessInfo.detectAvailablePortDone),(async()=>{setTimeout((()=>{_()}),100)}));const _=async()=>{const e=t.installedInstance?.installMethod,a=t.lmAppData?.accessInfo;let s;if(s=e===xe.DOCKER?a?.dockerOpenBrowserByLMD&&l.value?.length>0:a?.openBrowserByLMD&&l.value?.length>0,s){y.value=!0;const e=l.value[0],a=await(async e=>{try{return await n(e,{headers:{"Cache-Control":"no-cache",Pragma:"no-cache",Expires:"0"}},2e3,2e3),!0}catch(a){return console.log("app check err",a),!1}})(e);console.log("checkRunningStatus result",a),y.value=!1,a&&Ue.openBrowser(e)}};return(e,n)=>{const s=ce,o=ue;return u(l)&&u(l).length>0?(f(),h(je,{key:0,title:e.$t("AppRunningWindow.Access"),readonly:"",value:"app-access",showExpandIcon:!1,"default-expanded":!0},{append:x((()=>[ye.appIsOllama(t.lmAppData?.installName)?(f(),h(s,{key:0,installedInstance:e.installedInstance},null,8,["installedInstance"])):c("",!0)])),default:x((()=>[p(F,{class:"pt-1 pb-2",style:{margin:"0 -24px -16px"}},{default:x((()=>[p(z,{"no-gutters":"",style:{padding:"0px"}},{default:x((()=>[(f(!0),r(m,null,S(u(l),((n,t)=>(f(),h(L,{key:t,class:"px-5 py-2",cols:"12",sm:"6"},{default:x((()=>[p(V,{style:{background:"#FFF4EA","border-radius":"4px",height:"40px"},density:"compact","min-height":"1.1rem",class:"px-5"},{prepend:x((()=>[p(o,{text:n},null,8,["text"])])),default:x((()=>[(f(),r("a",{class:"mx-2 app-access-link",key:n,href:n,target:"_blank"},g(n),9,Be)),u(y)?(f(),h(j,{key:0,size:"small",color:u(a).PRIMARY_COLOR},{default:x((()=>[v(g(e.$t("AppRunningWindow.Starting")),1)])),_:1},8,["color"])):c("",!0)])),_:2},1024)])),_:2},1024)))),128))])),_:1})])),_:1}),d("div",He,g(e.$t("AppRunningWindowV2.AccessNote")),1)])),_:1},8,["title"])):c("",!0)}}}),Ye=i({__name:"app-env-row-v2",props:{installedInstance:{},appEnv:{}},setup(e){const a=o(null);w((async()=>{a.value=await t()}));const n=e=>"HF_MIRROR"===e?"HF_ENDPOINT":e;return(e,t)=>(f(),h(je,{title:e.$t("AppRunningWindow.EnvVars"),showExpandIcon:!0,value:"app-env"},{default:x((()=>[p(U,{class:"my-1 pt-2 pb-0 mx-0"},{default:x((()=>[(f(!0),r(m,null,S(u(a),((e,a)=>(f(),h(j,{variant:"tonal",size:"small",style:{"min-width":"50px","max-width":"190px","margin-left":"4px"},key:a},{default:x((()=>[v(g(n(a))+" ",1),p(B,{activator:"parent",location:"bottom"},{default:x((()=>[v(g(e),1)])),_:2},1024)])),_:2},1024)))),128)),(f(!0),r(m,null,S(e.appEnv,((e,a)=>(f(),h(j,{variant:"tonal",color:"orange-darken-4",size:"small",style:{"min-width":"50px","max-width":"220px","margin-left":"4px"},key:a},{default:x((()=>[v(g(a)+" ",1),p(B,{activator:"parent",location:"bottom"},{default:x((()=>[v(g(e),1)])),_:2},1024)])),_:2},1024)))),128))])),_:1})])),_:1},8,["title"]))}}),Je={key:0,style:{width:"84px"},class:"d-flex flex-column justify-center items-center"},Ke={class:"progress-text"},qe=i({__name:"download-progress",props:{downloadInfo:{}},setup:e=>(e,n)=>e.downloadInfo?(f(),r("div",Je,[p(T,{width:"100%",class:"download-progress-bar","bg-color":"#D8D8D8","bg-opacity":"1","buffer-color":"#DFDFEC","buffer-opacity":"1",opacity:"1",color:u(a).PRIMARY_COLOR,height:"3",max:1,min:0,"model-value":e.downloadInfo.percent,rounded:""},null,8,["color","model-value"]),d("div",Ke,[v(g(e.$t("AppRunningWindowV2.Downloading"))+" ",1),e.downloadInfo.percent?(f(),r(m,{key:0},[v(g(Math.floor(100*e.downloadInfo.percent))+"% ",1)],64)):c("",!0)])])):c("",!0)}),Xe={key:0},Qe={class:"model-storage-title d-flex flex-row align-baseline"},Ze={class:""},ea={class:"justify-center mr-6"},aa={class:"d-flex"},na={style:{flex:"1"}},ta={class:"d-flex"},la={class:"d-flex flex-row mt-1",style:{"font-size":"14px"}},sa={style:{flex:"1"}},oa=i({__name:"model-storage",props:{installedInstance:{},appEnv:{}},setup(e){const a=e,n=o(""),t=o(""),s=o(""),i=o(0),m=o(null);w((async()=>{ye.appIsOllama(a.installedInstance?.installName)&&(await _(),S())}));const y=o(null),{t:A}=M(),_=async()=>{const e=await te();t.value=e+"/.ollama/models"},S=async()=>{const e=await ye.getModelsDir(a.installedInstance?.installName,a.appEnv);console.log("dir",e),n.value=e||t.value,console.log("modelDir.value",n.value);const l=await ye.getModelFileSize(a.installedInstance?.installName,n.value);l.dirSize&&(y.value=Ie(l.dirSize),m.value=l,console.log("dirInfo",l),b())},b=()=>{if(!m.value)return;let e=0;try{e=m.value?.totalSpace-m.value.dirSize-m.value.freeSpace,i.value=m.value?.totalSpace-m.value.freeSpace}catch(l){console.error("calculate error",l)}const a=Ie(e),n=Ie(m.value.freeSpace),t=`${A("AppRunningWindow.StorageModelsSize")}: ${y.value},\n  ${A("AppRunningWindow.StorageDiskOther")}: ${a},\n  ${A("AppRunningWindow.StorageDiskFreeSpace")}: ${n}\n  `;s.value=t};I((()=>a.appEnv),(e=>{S()})),I((()=>a.installedInstance),(e=>{S()}));const E=async()=>{l(n.value)};return(e,a)=>u(y)?(f(),r("div",Xe,[d("div",Qe,[d("div",Ze,g(e.$t("AppRunningWindow.ModelStorageLabel")),1),p($),d("div",ea,[p(ce,{installedInstance:e.installedInstance},null,8,["installedInstance"])])]),p(U,{class:"mt-3 pb-3 px-5"},{default:x((()=>[d("div",aa,[d("div",null,[p(R,{src:"./images/icons/harddisk.svg",class:"mr-1",width:"72",height:"34"})]),d("div",na,[d("div",ta,[p(B,{text:u(s),location:"top"},{activator:x((({props:e})=>[p(T,k({class:"custom-progress-bar"},e,{location:null,"bg-color":"#FFFFFF","bg-opacity":"1","buffer-color":"#DFDFEC","buffer-opacity":"1",opacity:"1",color:"#FEF1E5",height:"14",max:u(m)?.totalSpace||10,min:"0","buffer-value":u(i),"model-value":u(m)?.dirSize,rounded:""}),null,16,["max","buffer-value","model-value"])])),_:1},8,["text"])]),d("div",la,[d("div",sa,g(u(m)?.diskName),1),d("a",{href:"#",style:{"text-decoration":"none",color:"rgba(0, 0, 0, 0.75)"},onClick:D(E,["prevent"])},[v(g(u(y))+" > ",1),u(n)?(f(),h(B,{key:0,activator:"parent",location:"top"},{default:x((()=>[v(g(u(n)),1)])),_:1})):c("",!0)])])])])])),_:1})])):c("",!0)}}),ia="http://localhost:11434";class ra{constructor(e,a){if(this.paramSize=e,this.updateUI=a,!e.nameAndSize)throw new Error("nameAndSize is empty");this.nameAndSize=e.nameAndSize}totalPercentageWithoutCurrent=.01;totalPercentage=.01;pullingMainPart="";pullingCurrentPart="";nameAndSize="";async download(e){const a=e.signal,n=await fetch(`${ia}/api/pull`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:this.nameAndSize,stream:!0}),signal:a});if(!n.ok)throw new Error(`HTTP error: ${n.status}`);if(!n.body)throw new Error("No response body");const t=n.body.getReader(),l=new TextDecoder;let s="";for(;;){const{done:e,value:a}=await t.read();if(e)break;s+=l.decode(a);const n=s.split("\n");s=n.pop()||"";for(const t of n)if(t.trim())try{const e=JSON.parse(t);this.processProgress(e)}catch(o){console.error("Parse error:",o)}}}calculatePercentage(e,a,n){let t=this.totalPercentageWithoutCurrent;if(e&&e.completed&&e.total){t+=e.completed/e.total*a,t>.99&&(t=.99),t>=this.totalPercentage&&(this.totalPercentage=t)}n&&this.totalPercentage>=this.totalPercentageWithoutCurrent&&(this.totalPercentageWithoutCurrent=this.totalPercentage)}processProgress(e){const a=e?.status||"";let n=.02;if("pulling manifest"===a)n=.01;else if(a.startsWith("downloading")||a.startsWith("pulling")){void 0!==e.total&&void 0!==e.completed&&(!this.pullingMainPart&&e.total>5242880&&(this.pullingMainPart=a),this.pullingMainPart===a&&(n=.89));let t=!1;this.pullingCurrentPart!==a&&(this.pullingCurrentPart=a,t=!0),this.calculatePercentage(e,n,t)}else"success"===a&&(this.totalPercentage=1);this.updateUI&&this.updateUI(this.paramSize,this.totalPercentage)}}const{addToast:da}=e(),ca=s("modelDownloadInfo",{state:()=>({models:o([]),parameterSizes:o([]),downloadSuccessMsg:o(""),cancelDownloadMsg:o(""),fetchAbortControllers:o(new Map)}),actions:{initModelsData(){this.models=[],this.parameterSizes=[]},updateUI(e,a){const n=e.downloadProgress;n&&(n.percent=a,1===a&&(e.installed=!0,this.downloadSuccessMsg&&da(this.downloadSuccessMsg,"success")))},onDownloadError(e){console.error("Failed to download model",e);let a=e.message;"BodyStreamBuffer was aborted"===a&&(a=this.cancelDownloadMsg),da(a,"error")},async startDownload(e,a){a.nameAndSize=e,a.downloadProgress={nameAndSize:e,percent:0},this.updateUI(a,.01);const n=await(async(e,a,n)=>{const t=new AbortController;return new ra(e,a).download(t).catch((e=>{n&&(console.error("download err",e),n(e))})),t})(a,this.updateUI,this.onDownloadError);this.fetchAbortControllers.set(a.nameAndSize,n)},async cancelDownload(e,a){const n=Ae.genModelNameAndSize(e,a);try{const e=this.fetchAbortControllers.get(n);e?.abort()}catch(t){console.log("cancel err",t)}try{await(async e=>{const a=await fetch(`${ia}/api/pull`,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e})});if(!a.ok)throw new Error(`HTTP error: ${a.status}`);if(!a.body)throw new Error("No response body");const n=await a.json();n.error?console.error("cancel error",n.error):console.log("cancel done",n)})(n)}catch(t){console.error(t)}finally{a.installed=!1,a.downloadProgress&&(a.downloadProgress.percent=void 0)}},async deleteModel(e,a){const n=Ae.genModelNameAndSize(e,a);try{await(async e=>{const a=await fetch(`${ia}/api/delete`,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e})});if(!a.ok)throw new Error(`HTTP error: ${a.status}`);if(!a.body)throw new Error("No response body");const n=await a.json();n.error?console.error("del error",n.error):console.log("del done",n)})(n)}catch(t){console.error(t)}finally{a.installed=!1,a.downloadProgress&&(a.downloadProgress.percent=void 0)}}}}),pa={key:0,class:"text-center py-10",style:{flex:"1"}},ua={class:"d-flex flex-row justify-center"},ma={style:{"min-width":"46px",display:"inline-block"}},va={style:{"min-width":"60px",display:"inline-block"}},ga={key:0,class:"installed-chip"},fa={key:1,class:"not-installed-chip"},wa=i({__name:"model-download-row-v2",props:{lmAppData:{},installedInstance:{},appEnv:{}},setup(e){const a=ca(),n=o(!1),t=o(null),l=o(null),s=o(!1),i=o(""),{t:y}=M(),A=e;w((async()=>{_(),a.downloadSuccessMsg=y("AppRunningWindow.ModelDownloadSuccessful"),a.cancelDownloadMsg=y("AppRunningWindowV2.DownloadCanceled"),await D()})),I((()=>A.lmAppData),(()=>{_()})),I((()=>A.installedInstance),(()=>{D()})),I((()=>A.appEnv),(()=>{D()}));const _=()=>{n.value=ye.appIsOllama(A.lmAppData?.installName)};I(t,(()=>{k()}));const k=()=>{const e=t.value,n=a.models.find((a=>a.installName===e)),l=n?.tags||[];a.parameterSizes=l},D=async()=>{const e=A.installedInstance?.installName;if(e&&n.value){a.initModelsData();const n=pe.getDownloadableModels(),l=await ye.mergeModelsList(e,n);if(a.models=l,t.value)k();else{const e=a.models;if(e&&e.length>0){const a=e[0];t.value=a.installName}}}},b=async()=>{t.value&&l.value&&a.deleteModel(t.value,l.value)},E=e=>{const a=e.downloadProgress;return!!(a?.percent&&a.percent<1)},R=e=>{const a=e.tags;if(a&&a.length>0)for(let n=0;n<a.length;n++){if(a[n].installed)return!0}};return(e,o)=>{const w=qe;return f(),r(m,null,[e.lmAppData&&u(n)?(f(),h(je,{key:0,class:"model-download-panel",showExpandIcon:!0,value:"model-download",title:e.$t("AppRunningWindow.ModelDownload")},{default:x((()=>[p(U,{class:"model-download-sheet d-flex flex-row"},{default:x((()=>[u(a).models&&0!==u(a).models.length?c("",!0):(f(),r("div",pa,[p(H,{color:"primary",indeterminate:"",size:"40"})])),u(a).models&&u(a).models.length>0?(f(),h(F,{key:1,style:{"border-right":"1px solid #EBEBF7",flex:"1",padding:"0"},"max-height":"340"},{default:x((()=>[(f(!0),r(m,null,S(u(a).models,((e,a)=>(f(),h(V,{key:e.installName+a,density:"compact","active-class":"selected-model-item",onClick:a=>{var n;(n=e.installName)!==t.value&&(t.value=n)},active:u(t)===e.installName,title:e.displayName,value:e.installName},{append:x((()=>[R(e)?(f(),h(G,{key:0,class:"downloaded-icon",icon:"mdi-check-bold",size:"18"})):c("",!0)])),_:2},1032,["onClick","active","title","value"])))),128))])),_:1})):c("",!0),u(a).models&&u(a).models.length>0?(f(),h(F,{key:2,style:{flex:"1",padding:"0"}},{default:x((()=>[(f(!0),r(m,null,S(u(a).parameterSizes,((n,o)=>(f(),h(V,{key:n.parameterSize+o,density:"compact",active:!1,value:n.parameterSize},{default:x((()=>[d("div",ua,[d("span",ma,g(n.parameterSize),1),d("span",va,[p(j,{density:"compact",class:"mx-1 file-size-chip"},{default:x((()=>[v(g(n.fileSize),1)])),_:2},1024)]),p($,{style:{flex:"1"}}),n.installed?(f(),r("div",ga,g(e.$t("AppRunningWindow.ModelDownloaded")),1)):(f(),r(m,{key:1},[E(n)?(f(),h(w,{key:0,"download-info":n.downloadProgress},null,8,["download-info"])):(f(),r("div",fa,g(e.$t("AppRunningWindow.ModelNotDownloaded")),1))],64)),p($,{style:{flex:"1"}}),n.installed?(f(),h(N,{key:2,onClick:e=>(e=>{if(!t.value)return;const a=Ae.genModelNameAndSize(t.value,e);l.value=e,s.value=!0,i.value=a})(n),variant:"text",density:"compact",color:"#F2313F"},{default:x((()=>[v(g(e.$t("AppRunningWindow.ModelDeleteBtnLabel")),1)])),_:2},1032,["onClick"])):(f(),r(m,{key:3},[E(n)?(f(),h(N,{key:0,onClick:e=>(async e=>{t.value&&a.cancelDownload(t.value,e)})(n),variant:"text",density:"compact"},{default:x((()=>[v(g(e.$t("AppRunningWindow.Cancel")),1)])),_:2},1032,["onClick"])):(f(),h(N,{key:1,onClick:e=>(async e=>{if(!t.value)return;const n=Ae.genModelNameAndSize(t.value,e);a.startDownload(n,e)})(n),variant:"text",class:"model-download-btn",density:"compact"},{default:x((()=>[v(g(e.$t("AppRunningWindow.ModelDownloadBtnLabel")),1)])),_:2},1032,["onClick"]))],64))])])),_:2},1032,["value"])))),128))])),_:1})):c("",!0)])),_:1}),p(U,{style:{"border-top":"1px solid #EBEBF7"}},{default:x((()=>[p(oa,{appEnv:e.appEnv,installedInstance:e.installedInstance},null,8,["appEnv","installedInstance"])])),_:1})])),_:1},8,["title"])):c("",!0),p(me,{"model-value":u(s),"onUpdate:modelValue":o[0]||(o[0]=e=>s.value=e),"item-name":u(i),onConfirm:b},null,8,["model-value","item-name"])],64)}}}),ya=i({__name:"app-env-and-access-v2",props:{installedInstance:{},lmAppData:{}},emits:["appEnvSavedAndUpdated"],setup(e,{expose:a,emit:n}){const t=e,l=ie(),s=o({}),i=o(["app-access"]),r=o(void 0),d=n;w((async()=>{_(),A()}));const m=y(),A=()=>{m.query.script===Q.DOWNLOAD_MODEL&&(i.value=["app-access","model-download"])},_=async()=>{const e=t.installedInstance?.installName;ye.appIsOllama(e)&&(s.value=await pe.getOSEnvObj()||{},S())};a({updateAppEnvData:_}),I((()=>t.installedInstance),(()=>{_()})),I((()=>l.appSettingsSaved),(async e=>{e&&(s.value=null,await _(),d("appEnvSavedAndUpdated",s.value))}));const S=async()=>{const e=s.value;e.OLLAMA_MODELS&&(r.value=await le(e.OLLAMA_MODELS))};return(e,a)=>{const n=Ge;return u(s)&&e.installedInstance?(f(),h(Y,{key:0,multiple:"",elevation:"0",modelValue:u(i),"onUpdate:modelValue":a[0]||(a[0]=e=>b(i)?i.value=e:null),class:"lmd-running-panels"},{default:x((()=>[p(n,{appEnv:u(s),lmAppData:e.lmAppData,installedInstance:e.installedInstance},null,8,["appEnv","lmAppData","installedInstance"]),!1===u(r)?(f(),h(J,{key:0,class:"pt-0 mt-0 px-2",style:{color:"red","justify-items":"center","align-items":"center"}},{default:x((()=>[p(G,{style:{opacity:"1"},icon:"mdi-information-slab-circle-outline"}),v(" "+g(e.$t("AppRunningWindowV2.ModelDirNotFound")),1)])),_:1})):c("",!0),p(wa,{appEnv:u(s),installedInstance:e.installedInstance,lmAppData:e.lmAppData},null,8,["appEnv","installedInstance","lmAppData"]),p(Ye,{appEnv:u(s),installedInstance:e.installedInstance},null,8,["appEnv","installedInstance"])])),_:1},8,["modelValue"])):c("",!0)}}}),ha={class:"d-flex flex-column text-center justify-center align-middle"},Aa={style:{width:"60px",margin:"0 auto"},class:"mt-10"},xa={class:"d-flex flex-column justify-center"},_a=i({__name:"app-info-left",props:{lmAppData:{},installedInstance:{},isAppRunning:{type:Boolean}},emits:["startApp","stopApp"],setup(e,{emit:a}){const n=e,t=a,{t:l}=M(),s=E((()=>n.installedInstance?.installMethod===xe.DOCKER?l("LMAppDetail.DockerMode"):""));return(e,a)=>(f(),h(U,{class:"left-app-basic-info"},{default:x((()=>[d("div",ha,[d("div",Aa,[p(R,{src:e.lmAppData?.icon,rounded:"",width:"60",height:"60"},null,8,["src"])]),d("div",xa,[p(K,{class:"pt-1 pb-0"},{default:x((()=>[v(g(e.lmAppData?.name),1)])),_:1}),e.installedInstance?.version&&"--"!==e.installedInstance?.version?(f(),h(q,{key:0,class:"py-0"},{default:x((()=>[v(g(e.$t("AppRunningWindow.Version"))+" "+g(e.installedInstance?.version),1)])),_:1})):c("",!0),p(J,null,{default:x((()=>[u(s)?(f(),h(j,{key:0,density:"default",variant:"flat",size:"small",color:"#086dd7"},{default:x((()=>[v(g(u(s)),1)])),_:1})):c("",!0),p($,{class:"mt-6"}),e.isAppRunning?(f(),h(N,{key:1,variant:"flat",color:"#F2313F",class:"mx-2",width:"80",height:"40",onClick:a[0]||(a[0]=e=>{t("stopApp")})},{default:x((()=>[v(g(e.$t("AppRunningWindow.Stop")),1)])),_:1})):(f(),h(N,{key:2,color:"primary",variant:"flat",class:"mx-2",width:"80",height:"40",onClick:a[1]||(a[1]=e=>{t("startApp")})},{default:x((()=>[v(g(e.$t("AppRunningWindow.Start")),1)])),_:1}))])),_:1})])])])),_:1}))}}),Ia={style:{flex:"1"}},Sa={class:"pa-6 run-right-content"},ka={class:"footer-button-bar"},Da={class:"footer-terminal-content"},ba=i({__name:"app-run",setup(a){const n=y(),t=we(),l=o(null),s=o(),i=o(),_=o(null),I=o(!1),S=o(!1),k=o(""),{t:D}=M(),{addToast:b}=e(),T=ie(),C=o(!1);w((async()=>{W();const e=n.params.id,a=await X(e);_.value=a;const s=a.appId;await t.fetchApp(s),l.value=t.currentLmApp,window.ipcRenderer?.on(ae.STOP_AI_RUNNING_INSTANCE,(()=>{z(),L()})),j();const o=l?.value.name;document.title=o}));const P=E((()=>{if(T.terminals&&T.terminals.length>0)return T.terminals[0]})),W=()=>{const e=D("AppRunningWindow.MainProcessTab");T.initTerminal(e)},$=async()=>{var e;if(e=Q.START,k.value=e,T.changeMainTerminalScriptType(e,""),I.value=!0,l.value&&_.value){const e=await ve(l.value,_.value);F(e),window.ipcRenderer?.send(ae.RUNNING_STATUS_CHANGE,!0)}},O=()=>Array.isArray(s.value)?s.value[0]:s.value,F=e=>{const a=O();console.log("run command",a,e),a?.runCommand(e)},z=()=>{I.value=!1,O()?.runStopCommand(),window.ipcRenderer.send(ae.RUNNING_STATUS_CHANGE,!1)},L=()=>{O()?.exitTerminal()},V=e=>{if(ee.isWindows())return;z();const a=ge(e);O()?.runCommand(a),$()},j=async()=>{if($(),ye.needPreStartApp(_.value?.installName))return ee.isMacOS()?void setTimeout((()=>{U()}),20):void 0;U()},U=()=>{S.value=!0},B=e=>{console.log("onCommandExecuteEnd",e),e&&b(e,"success"),setTimeout((()=>{i.value?.updateAppEnvData()}),400)},H=e=>{e.includes("lmdevent:docker_run_error")&&b(D("AppRunningWindowV2.docker_run_error"),"error",6e3)};return(e,a)=>(f(),r(m,null,[d("div",Ia,[p(_a,{"lm-app-data":u(l),"is-app-running":u(I),onStopApp:z,onStartApp:$,"installed-instance":u(_)},null,8,["lm-app-data","is-app-running","installed-instance"]),d("div",Sa,[u(_)&&u(l)&&u(S)?(f(),h(ya,{key:0,ref_key:"appEnvAndAccessComponent",ref:i,onAppEnvSavedAndUpdated:V,lmAppData:u(l),installedInstance:u(_)},null,8,["lmAppData","installedInstance"])):c("",!0)])]),d("footer",{class:A(["footer-terminal","app-run-footer-terminal",u(C)?"expanded":""])},[d("div",ka,[p(N,{variant:"text",style:{position:"absolute",right:"10px",top:"5px"},onClick:a[0]||(a[0]=e=>C.value=!u(C))},{append:x((()=>[p(R,{src:u(C)?"./images/icons/expand-white.svg":"./images/icons/collapse-white.svg",width:"18",height:"18"},null,8,["src"])])),default:x((()=>[v(g(u(C)?e.$t("AppRunningWindowV2.Hide"):e.$t("AppRunningWindowV2.ViewLog"))+" ",1)])),_:1})]),d("div",Da,[u(P)&&"main-process"===u(P).tabName?(f(),h(de,{key:0,onExecuteEnd:a[1]||(a[1]=e=>{return a=u(P).commandExecuteEndToastMsg,U(),console.log("onMainTerminalCommandEnd"),void B(a);var a}),"command-execute-end-keywords":u(P).commandExecuteEndKeywords,ref_key:"generalTerminal",ref:s,events:["lmdprogress","lmdevent:docker_run_error"],onTerminalEvent:H,socketURI:"ws://localhost:19312"},null,8,["command-execute-end-keywords"])):c("",!0)])],2)],64))}}),Ea={class:"app-install-result pt-10 pb-6 px-11 mb-12 mx-10"},Ra=i({__name:"install-result",props:{lmAppData:{},installedInstance:{}},setup(e){const a=e,n=()=>{a.installedInstance.appInstallPath&&l(a.installedInstance.appInstallPath)};return(e,a)=>(f(),r("div",Ea,[p(z,{class:"gap-2 mb-2"},{default:x((()=>[p(L,{cols:"12",xs:"12",sm:"6",md:"6",lg:"6",class:"item"},{default:x((()=>[v(g(e.$t("AppRunningWindowV2.AppNameLabel"))+": "+g(e.lmAppData.name),1)])),_:1}),p(L,{cols:"12",xs:"12",sm:"6",md:"6",lg:"6",class:"item"},{default:x((()=>[v(g(e.$t("AppRunningWindowV2.AppInstallTimeLabel"))+": "+g(u(Se).format(e.installedInstance.createTime,!1)),1)])),_:1}),p(L,{cols:"12",xs:"12",sm:"6",md:"6",lg:"6",class:"item"},{default:x((()=>[v(g(e.$t("AppRunningWindowV2.AppInstallLocationLabel"))+": ",1),d("a",{href:"#",onClick:D(n,["prevent"])},g(e.installedInstance.appInstallPath),1)])),_:1})])),_:1})]))}}),{addToast:Ta}=e(),Ma=s("appInstall",{state:()=>({installPercent:o(0),installSuccessMsg:o(""),installed:o(!1)}),actions:{initModelsData(){this.installPercent=0},updateUI(e){this.installPercent=e,1===e&&(this.installed=!0,this.installSuccessMsg&&Ta(this.installSuccessMsg,"success"))},onDownloadError(e){console.error("Failed to download App",e),Ta(e.message,"error")}}}),Na={class:"progress-area"},Ca={style:{width:"210px"}},Pa={key:0,style:{width:"250px"},class:"mt-6"},Wa={class:"progress-msg mb-8 mt-6"},$a={class:"progress-msg-title"},Oa={class:"progress-msg-title"},Fa=i({__name:"install-progress",props:{lmAppData:{},instanceData:{}},setup(e){const n=Ma(),t=e,{t:l}=M(),s=E((()=>"docker"===t.instanceData?.installMethod?l("LMAppDetail.DockerMode"):""));return(e,l)=>(f(),r("div",Na,[d("div",Ca,[p(R,{src:u(n).installed?"./images/app/succes.svg":"./images/app/processing.svg",width:"210",height:"140"},null,8,["src"])]),u(n).installed?c("",!0):(f(),r("div",Pa,[p(T,{width:"100%",class:"download-progress-bar","bg-color":"#F2F2FA","bg-opacity":"1","buffer-color":"#DFDFEC","buffer-opacity":"1",opacity:"1",color:u(a).PRIMARY_COLOR,height:"14",max:100,min:0,"model-value":u(n).installPercent,rounded:""},null,8,["color","model-value"])])),d("div",Wa,[u(n).installed?(f(),r(m,{key:1},[d("div",Oa,g(e.$t("AppRunningWindowV2.InstallSuccessTitle")),1),d("div",null,[ye.appIsOllama(t.lmAppData?.installName)?(f(),r(m,{key:0},[v(g(e.$t("AppRunningWindowV2.InstallSuccessNextTipForOllama")),1)],64)):(f(),r(m,{key:1},[v(g(e.$t("AppRunningWindowV2.InstallSuccessNextTip")),1)],64))])],64)):(f(),r(m,{key:0},[d("div",$a,g(e.lmAppData?.name),1),u(s)?(f(),h(j,{key:0,class:"mt-1 mb-3",density:"default",size:"small",color:"#086dd7"},{default:x((()=>[v(g(u(s)),1)])),_:1})):c("",!0),d("div",null,g(e.$t("AppRunningWindowV2.InstallingMsg"))+" "+g(u(n).installPercent)+"% ",1)],64))])]))}}),za={class:"app-install-container"},La={class:"install-steps"},Va={class:"pa-6 install-right-content"},ja={class:"footer-button-bar"},Ua=i({__name:"app-install",setup(a){const{t:n}=M(),t=ie(),l=o(""),s=we(),i=o(null),m=y(),_=o(null),I=o(),S=Ma(),k=o(!1),{addToast:D}=e();w((async()=>{b();const e=m.params.id,a=await X(e);_.value=a;const n=a.appId;await s.fetchApp(n),i.value=s.currentLmApp,window.ipcRenderer?.on(ae.STOP_AI_RUNNING_INSTANCE,(()=>{W(),$()})),E();const t=i?.value.name;document.title=t}));const b=()=>{const e=n("AppRunningWindow.MainProcessTab");t.initTerminal(e)},E=async()=>{var e;if(console.log("installApp"),e=Q.INSTALL,l.value=e,console.log("changeMainTerminalScriptType",e,""),t.changeMainTerminalScriptType(e,""),i.value&&_.value){const e=await fe(i.value,_.value);T(e)}se()},T=e=>{const a=P();console.log("run command",a,e),a?.runCommand(e)},P=()=>Array.isArray(I.value)?I.value[0]:I.value,W=()=>{P()?.runStopCommand(),window.ipcRenderer.send(ae.RUNNING_STATUS_CHANGE,!1)},$=()=>{P()?.exitTerminal()},O=e=>{if(e.includes("lmdevent:docker_run_error"))return void D(n("AppRunningWindowV2.docker_run_error"),"error",6e3);const a=We.extractProgress(e);a&&(S.installPercent=a,100===a&&(S.installed=!0,oe()))},F=()=>{console.log("installedInstance",_.value?.id),_.value?.id&&ne(_.value.id)},z=()=>{_.value&&_e.goToRunningPage(_.value.id,Q.START,_.value.installName)};return(e,a)=>{const n=Fa,t=Ra;return f(),r("div",za,[d("div",La,[d("div",Va,[u(i)?(f(),h(n,{key:0,"instance-data":u(_),"lm-app-data":u(i)},null,8,["instance-data","lm-app-data"])):c("",!0),u(_)&&u(i)&&u(S).installed?(f(),h(t,{key:1,lmAppData:u(i),installedInstance:u(_)},null,8,["lmAppData","installedInstance"])):c("",!0),d("div",{class:A(["footer-terminal","app-install-footer-terminal",u(k)?"expanded":""])},[d("div",ja,[p(N,{variant:"text",style:{position:"absolute",right:"10px",top:"5px"},onClick:a[0]||(a[0]=e=>k.value=!u(k))},{append:x((()=>[p(R,{src:u(k)?"./images/icons/expand-white.svg":"./images/icons/collapse-white.svg",width:"18",height:"18"},null,8,["src"])])),default:x((()=>[v(g(u(k)?e.$t("AppRunningWindowV2.Hide"):e.$t("AppRunningWindowV2.ViewLog"))+" ",1)])),_:1})]),p(de,{ref_key:"generalTerminal",ref:I,events:["lmdprogress","lmdevent:docker_run_error"],onTerminalEvent:O,socketURI:"ws://localhost:19312"},null,512)],2)])]),p(C,{style:{"border-top":"1px solid #EBEBF7"},class:"py-6 text-center justify-center"},{default:x((()=>[p(N,{variant:"outlined",onClick:F},{default:x((()=>[v(g(e.$t("Common.close")),1)])),_:1}),ye.appIsOllama(i.value?.installName)?(f(),h(N,{key:0,variant:"flat",disabled:!u(S).installed,onClick:z,color:"primary"},{default:x((()=>[v(g(e.$t("AppRunningWindowV2.NextStep")),1)])),_:1},8,["disabled"])):c("",!0)])),_:1})])}}}),Ba=i({__name:"AppRunningWindowV2",setup(e){const a=o(""),n=y();return w((()=>{const e=n.query.script;e===Q.INSTALL?a.value="install":e===Q.START||e===Q.DOWNLOAD_MODEL?a.value="run":e===Q.REMOVE&&(a.value="remove")})),(e,n)=>{const t=Ua,l=ba,s=Le;return f(),r(m,null,["install"===u(a)?(f(),h(t,{key:0})):c("",!0),"run"===u(a)?(f(),h(l,{key:1})):c("",!0),"remove"===u(a)?(f(),h(s,{key:2})):c("",!0)],64)}}});export{Ba as default};
