import{r as e,a as t,b as a}from"./xterm.js";import{g as n,l,d as s,c as o,o as i}from"./index.js";import{O as r}from"./OSUtil.js";import{e as c,b as d,H as u,X as m,a3 as p,a2 as g,a0 as v,l as S,c as f,F as h,k as A,Y as _,a1 as D,S as I,K as b,u as L,j as w,$ as T,a5 as y,m as $}from"./vue.js";import{f as E,h as C,j as R,k as x,D as k,g as M,l as N,_ as P}from"./lmd-system.js";import{a as O,b as V,A as U}from"./AppInfoUtil.js";import{d as j}from"./pinia.js";import{G as H,q as B,z as F,A as z,Z as K,e as W,n as G,d as q,D as J,E as Y,b as X,o as Z}from"./vuetify.js";var Q=e(),ee=t(),te=a();class ae{static getLMDScriptRepoUrl(e){let t="https://gitee.com/lmdown/lmd-install-scripts";if(e?.downloadInfo&&e?.downloadInfo.length>0){t=e.downloadInfo[0].scriptGitRepoUrl}return{repoUrl:t,repoLocalFolderName:this.getLastPathSegment(t)||"lmd-install-scripts"}}static getLastPathSegment(e){const t=e.match(/[^\/?#]+(?=[/?#]*$)/);return t?t[0]:null}}const ne="browser";class le{static async isPortInUse(e){const t=`http://127.0.0.1:${e}`;try{const a=await fetch(t,{method:"HEAD",mode:"no-cors",cache:"no-store"});return console.log(`${e} in use`,a.status),a.ok}catch(a){return console.log(`can not access port ${e}`,a),!1}}static async findAvailablePort(e,t){let a=e;for(let l=1;l<=t;l++)try{if(!(await this.isPortInUse(a)))return a;a++}catch(n){console.error(`check port ${a} err`,n),a++}return console.error("no Available port, use default value"),e}}class se{static async genSetPortCommand(e){if(e?.accessInfo.accessType===ne&&this.needCheckPort(e)&&e.accessInfo.webUrl){const{url:t,port:a}=await se.checkPortInUrl(e.accessInfo.webUrl);if(e.accessInfo.detectAvailablePortDone=!0,a)return e.accessInfo.webUrl=t,`export SERVER_PORT=${a}\nexport GRADIO_SERVER_PORT=${a}`}return""}static needCheckPort(e){return["spark-tts","index-tts","f5-tts","framepack","liveportrait","ace-step","cosyvoice","latentsync","notagen"].includes(e.installName)||e?.accessInfo?.detectAvailablePort}static async checkPortInUrl(e){try{const t=new URL(e),a=parseInt(t.port,10);if(isNaN(a))throw new Error("does not contain a valid port");const n=await le.findAvailablePort(a,20);return t.port=n.toString(),a===n?{url:e}:{url:t.toString(),port:n}}catch(t){return console.log("Invalid URL",t),{url:e}}}}const oe=e=>{let t="";if(e)for(const a in e)t+=`${a}=${e[a]}\n`;return t},ie=e=>"0"===l("UPDATE_INSTALL_SCRIPTS")?"":`\ngit clone --depth=1 ${e} "$LMD_BASE_INSTALL_SCRIPT_DIR"\ncd "$LMD_BASE_INSTALL_SCRIPT_DIR" && git fetch origin master && git reset --hard origin/master`,re=async(e,t)=>{const a=e.installName,l=(await n()).LMD_SCRIPTS_DIR,{repoUrl:s,repoLocalFolderName:o}=ae.getLMDScriptRepoUrl(e),i=ie(s);console.log("repoLocalFolderName",o);return`\nexport LMD_BASE_INSTALL_SCRIPT_DIR="${l}/${o}"\n${i}\nsh "$LMD_BASE_INSTALL_SCRIPT_DIR/apps/${a}/${"docker"===t?.installMethod?"install-d.sh":"install.sh"}"`},ce=async(e,t)=>{const a=e.installName,l=(await n()).LMD_SCRIPTS_DIR,{repoUrl:s,repoLocalFolderName:o}=ae.getLMDScriptRepoUrl(e);return`\nexport LMD_BASE_INSTALL_SCRIPT_DIR="${l}/${o}"\n${ie(s)}\n${await se.genSetPortCommand(e)}\nsh "$LMD_BASE_INSTALL_SCRIPT_DIR/apps/${a}/${"docker"===t?.installMethod?"start-d.sh":"start.sh"}"`},de=async(e,t)=>{const a=e.installName,l=(await n()).LMD_SCRIPTS_DIR,{repoUrl:s,repoLocalFolderName:o}=ae.getLMDScriptRepoUrl(e),i=ie(s);console.log("repoLocalFolderName",o);const r="docker"===t?.installMethod?"remove-d.sh":"remove.sh";let c="";t.instancesCountOfApp>1&&(c="keepmodels");return`\nexport LMD_BASE_INSTALL_SCRIPT_DIR="${l}/${o}"\n${i}\nsh "$LMD_BASE_INSTALL_SCRIPT_DIR/apps/${a}/${r}" ${c}`},ue=c({__name:"index",props:{socketURI:{},initCommand:{},commandExecuteEndKeywords:{},events:{}},emits:["executeEnd","terminalEvent"],setup(e,{expose:t,emit:a}){const n=a,l=d([]),o=d(!1),i=e,c=d(null),S=d(null),f=d(null),h=d(null);let A;u((()=>{b(),I()})),m((()=>{c.value?.close(),S.value?.dispose(),A&&h.value&&(A.unobserve(h.value),A.disconnect())}));const _=e=>{console.log("runCommand",e),console.log("runCommand socket.value",c.value),c.value?.send(e+"\n")};t({runCommand:_,runStopCommand:()=>{_("")},exitTerminal:()=>{_("exit")}});const D=s((e=>{for(const t of e){let e=t.contentRect.height;r.isMacOS()&&(e-=10),C(t.contentRect.width,e)}}),9),I=()=>{f.value&&(A=new ResizeObserver(D),A.observe(f.value))},b=()=>{c.value=new WebSocket(i.socketURI),T(),w(),y(),L()},L=()=>{c.value&&(c.value.onmessage=e=>{const t=e.data,a=i.events;console.log("event data ",e.data),console.log("props.events ",i.events),a&&a.length>0&&a.forEach((e=>{t.includes(e)&&(console.log("emit terminalEvent",t),n("terminalEvent",t))}));const s=i.commandExecuteEndKeywords;s&&(s.forEach((e=>{t.includes(e)&&!l.value.includes(e)&&l.value.push(e)})),l.value.length===s.length&&(n("executeEnd"),o.value=!0,l.value=[]))})},w=()=>{c.value&&(c.value.onopen=()=>{(()=>{if(!h.value)return;if(!c.value)return;const e=new window.Terminal({fontSize:14,cursorBlink:!0}),t=new ee.AttachAddon(c.value),a=new Q.FitAddon,n=new te.WebLinksAddon(((e,t)=>{const a=document.createElement("a");a.setAttribute("href",t),a.setAttribute("target","_blank"),a.setAttribute("id","lmdTempLink");const n=document.getElementById("lmdTempLink");n&&document.body.removeChild(n),document.body.appendChild(a),a.click()}));e.loadAddon(t),e.loadAddon(a),e.loadAddon(n),e.open(h.value),a.fit(),S.value=e})(),i.initCommand&&_(i.initCommand)})},T=()=>{c.value&&(c.value.onclose=e=>{console.log("close socket",e)})},y=()=>{c.value&&(c.value.onerror=e=>{console.log("socket err",e)})},$=d(80),E=d(30),C=(e,t)=>{const a=Math.floor(e/8.5),n=Math.round(t/16);if(console.log("cols",e,a),console.log("rows",t,n),0!==n&&0!==a&&($.value!==a||E.value!==n)){$.value=a,E.value=n,S.value?.resize(a,n);const e=`lmd_action:resize:${a},${n}`;c.value?.send(e)}};return(e,t)=>(v(),p("div",{ref_key:"terminalOutContainer",ref:f,class:"mb-0",style:{height:"100%",width:"100%"}},[g("div",{ref_key:"terminalContainer",ref:h,class:"terminal",style:{height:"300px",width:"100%"}},null,512)],512))}});class me{static async getAppSettings(){const e=await this.getOSEnvObj();return{modelsDir:e.OLLAMA_MODELS,externalAccessHost:e.OLLAMA_HOST,externalAccessPath:e.OLLAMA_ACCESS_PATH_LMD}}static async getOSEnvObj(){return await E(V.DISPLAY_ENV)}static async getAccessHosts(e){const t="11434",a=[`http://127.0.0.1:${t}`];if(e&&"127.0.0.1"!==e){const n=e.split(":"),l=n[0];let s=[l];const o=n[1]||t;"0.0.0.0"===l&&(s=await C()),s&&s.length>0&&s.forEach((e=>{a.push(`http://${e}:${o}`)}))}else;return a}static async saveAppSettings(e,t){e.modelsDir===t&&(e.modelsDir="");const a={OLLAMA_MODELS:e.modelsDir,OLLAMA_HOST:e.externalAccessHost,OLLAMA_ACCESS_PATH_LMD:e.externalAccessPath};return await R(a)}static getDownloadableModels(){return JSON.parse(JSON.stringify(O))}}const pe=j("runningInstance",{state:()=>({runningInstances:[],appSettingsSaved:!1,terminals:[],currentTerminalTab:""}),actions:{addRunningInstance(e){this.runningInstances.find((t=>t.id===e.id))||this.runningInstances.push(e)},removeRunningInstance(e){const t=this.runningInstances.findIndex((t=>t.id===e.id));-1!=t&&this.runningInstances.splice(t,1)},resetAppSettingsSavedStatus(){this.appSettingsSaved=!1},onAppSettingsSaved(){this.appSettingsSaved=!0},changeMainTerminalScriptType(e,t){try{const a=this.terminals[0];a.commandExecuteEndKeywords=[`lmd ${e} script end.`],a.commandExecuteEndToastMsg=t}catch(a){console.error(a)}},initTerminal(e){const t={icon:"mdi-application-brackets-outline",text:e,tabName:"main-process",closable:!1};this.terminals=[t],this.currentTerminalTab=t.tabName},addTerminal(e){this.terminals.find((t=>t.tabName===e.tabName))||(console.log("addTerminal",e.commandExecuteEndKeywords),this.terminals.push(e)),this.currentTerminalTab=e.tabName},removeTerminal(e,t){this.currentTerminalTab="main-process",this.terminals.splice(t,1)},addInstallModelTerminal(e,t,a,n){const l={text:t,tabName:t,initCommand:a,closable:!0,commandExecuteEndKeywords:["digest","writing manifest","success"],commandExecuteEndToastMsg:n};this.addTerminal(l)},addDeleteModelTerminal(e,t,a,n){const l={text:t,tabName:t,initCommand:a,closable:!0,commandExecuteEndKeywords:[`deleted '${e}'`],commandExecuteEndToastMsg:n};this.addTerminal(l)}}}),ge={style:{"font-size":"12px"}},ve={style:{"font-size":"12px"}},Se=c({__name:"ollama-settings-btn",props:{installedInstance:{}},setup(e){const{t:t}=H(),a=d(!1),n=d(!1),l=d(!1),s=d(!1),r=d(""),c=pe(),{addToast:m}=o(),E=d({}),C=d(!0),R=e;S((()=>R.installedInstance),(()=>{P()}));const P=()=>{se()?a.value=!0:a.value=!1};u((()=>{P()}));const O=async()=>{n.value=!0,console.log("showDialog1",n.value),await V(),await le(),console.log("showDialog2",n.value)};S((()=>n),(()=>{console.log("dialogVisible change: ",n)}));const V=async()=>{const e=await M();r.value=e+"/.ollama/models"},j=async()=>{if(!l.value)return;if(!E)return;if(""===r.value){const e=t("AppSettingDialog.DataNotValid");return void m(e,"error")}s.value=!0;const e=Object.assign({},E.value),a=await me.saveAppSettings(e,r.value);console.log("save result ",a);const o=t("Common.saveSuccess");m(o,"success"),s.value=!1,c.onAppSettingsSaved(),setTimeout((()=>{c.resetAppSettingsSavedStatus()}),100),n.value=!1,console.log("hideDialog",n.value),U.killAppProcessed(R.installedInstance?.installName),setTimeout((()=>{N()}),1500)},X=async()=>{const e=await x(E.value.modelsDir,!0);e&&e.path&&(E.value.modelsDir=e.path,console.log("dirInfo",e),C.value=k.checkModelsDirValid(e,["blobs"]),console.log("dirValid.value",C.value))},Z=()=>{i(E.value.modelsDir)},Q=[e=>!!e||t("Common.fieldRequired"),()=>C.value||t("AppSettingDialog.ModelsDirNotValid")],ee=/^(\d{1,3}\.){3}\d{1,3}(:\d{1,5})?$/,te=[e=>""===e||(ee.test(e)||t("AppSettingDialog.HostNotValid"))],ae=async()=>{E.value.modelsDir=r.value},ne=f((()=>{if(se())return t("AppSettingDialog.OllamaModelsDirInfoIconTip")})),le=async()=>{if(se()){const e=await me.getAppSettings();console.log("getOSEnvForCurrentApp",e),E.value=Object.assign({},e),""===e.modelsDir&&(console.log("getOSEnvForCurrentApp",e),E.value.modelsDir=r.value)}},se=()=>U.appIsOllama(R.installedInstance?.installName);return(e,a)=>(v(),p(h,null,[A(B,{class:"settings-small-btn",variant:"outlined",density:"compact",rounded:"",onClick:_(O,["stop"])},{default:D((()=>[I(b(e.$t("AppRunningWindow.Settings")),1)])),_:1}),A(F,{modelValue:L(n),"onUpdate:modelValue":a[5]||(a[5]=e=>w(n)?n.value=e:null),"min-width":"400","max-width":"840"},{default:D((()=>[e.installedInstance?(v(),T(z,{key:0,class:"mx-auto px-0 py-0 window-no-drag",width:"100%",title:e.$t("AppSettingDialog.Title")+e.installedInstance.name},{append:D((()=>[A(B,{icon:"mdi-close",class:"ms-auto",size:"compact",text:"Ok",elevation:"0",onClick:a[0]||(a[0]=e=>n.value=!1)})])),default:D((()=>[L(E)?(v(),T(K,{key:0,class:"pt-0 pb-3 px-6",modelValue:L(l),"onUpdate:modelValue":a[4]||(a[4]=e=>w(l)?l.value=e:null),onSubmit:_(j,["prevent"])},{default:D((()=>[A(W,{modelValue:L(E).modelsDir,"onUpdate:modelValue":a[1]||(a[1]=e=>L(E).modelsDir=e),density:"comfortable",readonly:L(s),rules:Q,label:e.$t("AppSettingDialog.ModelsDirLabel")},{append:D((()=>[A(G,{location:"bottom"},{activator:D((({props:e})=>[A(q,$(e,{icon:"mdi-information-slab-circle-outline"}),null,16)])),default:D((()=>[g("pre",null,b(L(ne)),1)])),_:1}),A(B,{class:"ml-1",onClick:X,variant:"outlined"},{default:D((()=>[I(b(e.$t("AppSettingDialog.Browse")),1)])),_:1}),A(B,{class:"ml-1",onClick:Z,variant:"outlined"},{default:D((()=>[I(b(e.$t("AppSettingDialog.Open")),1)])),_:1}),A(B,{class:"ml-1",onClick:ae,variant:"outlined"},{default:D((()=>[I(b(e.$t("AppSettingDialog.UseDefaultValue")),1)])),_:1})])),_:1},8,["modelValue","readonly","label"]),A(J,{class:"pt-0"},{default:D((()=>[g("pre",ge,b(t("AppSettingDialog.ModelsDirTip")),1)])),_:1}),A(W,{modelValue:L(E).externalAccessHost,"onUpdate:modelValue":a[2]||(a[2]=e=>L(E).externalAccessHost=e),density:"comfortable",readonly:L(s),rules:te,label:e.$t("AppSettingDialog.ServerHostLabel")},null,8,["modelValue","readonly","label"]),A(J,{class:"pt-0"},{default:D((()=>[g("pre",ve,b(t("AppSettingDialog.ServerHostTip")),1)])),_:1}),A(Y,{class:"text-center justify-center"},{default:D((()=>[A(B,{variant:"outlined",onClick:a[3]||(a[3]=e=>n.value=!1)},{default:D((()=>[I(b(e.$t("AppSettingDialog.close")),1)])),_:1}),A(B,{color:"primary",variant:"flat",type:"submit",loading:L(s)},{default:D((()=>[I(b(e.$t("AppSettingDialog.saveConfig")),1)])),_:1},8,["loading"])])),_:1})])),_:1},8,["modelValue"])):y("",!0)])),_:1},8,["title"])):y("",!0)])),_:1},8,["modelValue"])],64))}}),fe=c({__name:"copy-link-icon",props:{text:{}},setup(e){const t=e,a=d(!1),n=()=>{a.value=!0,navigator.clipboard.writeText(t.text),setTimeout((()=>{a.value=!1}),1500)};return(e,t)=>(v(),T(X,{width:"16",height:"16",onClick:n,src:"./images/icons/link-copy.svg",style:{cursor:"pointer"}},{default:D((()=>[A(G,{activator:"parent","open-on-hover":!1,location:"bottom",transition:"false",modelValue:L(a),"onUpdate:modelValue":t[0]||(t[0]=e=>w(a)?a.value=e:null)},{default:D((()=>[I(b(e.$t("App.Copied")),1)])),_:1},8,["modelValue"])])),_:1}))}}),he=P(c({__name:"delete-confirm-dialog",props:{modelValue:{type:Boolean},itemName:{}},emits:["update:modelValue","confirm"],setup(e,{emit:t}){const a=e,n=t,l=d(!1);S((()=>l.value),(e=>{n("update:modelValue",e)})),S((()=>a.modelValue),(e=>{l.value=e}));const s=()=>{l.value=!1},o=async()=>{n("confirm"),s()};return(e,t)=>(v(),T(F,{modelValue:L(l),"onUpdate:modelValue":t[0]||(t[0]=e=>w(l)?l.value=e:null),"max-width":"400"},{default:D((()=>[A(z,null,{default:D((()=>[A(Z,{class:"headline"},{default:D((()=>[I(b(e.$t("AppRunningWindow.ConfirmDelete")),1)])),_:1}),A(J,null,{default:D((()=>[I(b(e.$t("AppRunningWindow.ConfirmDeleteMsg"))+" ",1),t[1]||(t[1]=g("br",null,null,-1)),I(" "+b(e.itemName),1)])),_:1}),A(Y,{class:"justify-center mb-2"},{default:D((()=>[A(B,{variant:"outlined",onClick:s},{default:D((()=>[I(b(e.$t("AppRunningWindow.Cancel")),1)])),_:1}),A(B,{variant:"flat",color:"#F2313F",onClick:o},{default:D((()=>[I(b(e.$t("AppRunningWindow.ModelDeleteBtnLabel")),1)])),_:1})])),_:1})])),_:1})])),_:1},8,["modelValue"]))}}),[["__scopeId","data-v-2e8b336e"]]);export{he as D,me as O,Se as _,fe as a,re as b,oe as c,ue as d,de as e,ce as g,pe as u};
